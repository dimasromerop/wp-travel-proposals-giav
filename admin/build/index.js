(()=>{"use strict";var e={n:a=>{var t=a&&a.__esModule?()=>a.default:()=>a;return e.d(t,{a:t}),t},d:(a,t)=>{for(var l in t)e.o(t,l)&&!e.o(a,l)&&Object.defineProperty(a,l,{enumerable:!0,get:t[l]})},o:(e,a)=>Object.prototype.hasOwnProperty.call(e,a)};const a=window.React,t=window.wp.element,l=window.wp.components,n=window.wp.apiFetch;var r=e.n(n);const i=window.WP_TRAVEL_GIAV||window.CASANOVA_GESTION_RESERVAS||{};if(!r().__WP_TRAVEL_GIAV_CONFIGURED){const e=i.nonce||"",a=(e=>{if(e.wpRestRoot)return e.wpRestRoot;const a=e.apiUrl||e.restUrl;return a?a.replace(/\/travel\/v1\/?$/,"/"):"/wp-json/"})(i);a&&r().use(r().createRootURLMiddleware(a)),e&&r().use(r().createNonceMiddleware(e)),r().__WP_TRAVEL_GIAV_CONFIGURED=!0}const o=e=>r()({path:"/travel/v1/proposals",method:"POST",data:e}),s=({orderBy:e="updated_at",order:a="desc",limit:t=50,offset:l=0,search:n,author:i,page:o,per_page:s}={})=>{const c=new URLSearchParams;return c.set("order_by",e),c.set("order",a),c.set("limit",t),c.set("offset",l),void 0!==n&&c.set("search",n),void 0!==i&&c.set("author",i),void 0!==o&&c.set("page",o),void 0!==s&&c.set("per_page",s),r()({path:`/travel/v1/proposals?${c.toString()}`,method:"GET"})},c=e=>r()({path:`/travel/v1/proposals/${e}/detail`,method:"GET"}),u=(e,a)=>r()({path:`/travel/v1/proposals/${e}`,method:"PUT",data:a}),d=e=>r()({path:`/travel/v1/proposals/${e}`,method:"DELETE"}),p=e=>r()({path:"/travel/v1/proposals/bulk-delete",method:"POST",data:{ids:e}}),m=(e,a,t)=>r()({path:`/travel/v1/proposals/${e}/send`,method:"POST",data:{snapshot:a,version_number:t}}),_=(e,a,t)=>r()({path:`/travel/v1/proposals/${e}/versions`,method:"POST",data:{snapshot:a,version_number:t}}),v=(e,a)=>r()({path:`/travel/v1/proposals/${e}/current-version`,method:"POST",data:{version_id:a}}),g=(e,a)=>r()({path:`/travel/v1/proposals/${e}/accept`,method:"POST",data:{version_id:a}}),b=e=>r()({path:`/travel/v1/proposals/${e}/giav-retry`,method:"POST"}),h=({type:e,q:a})=>r()({path:`/travel/v1/catalog/search?type=${encodeURIComponent(e)}&q=${encodeURIComponent(a||"")}`,method:"GET"}),y=({wp_object_type:e,wp_object_id:a})=>r()({path:`/travel/v1/giav-mapping?wp_object_type=${encodeURIComponent(e)}&wp_object_id=${encodeURIComponent(a)}`,method:"GET"}),E=({type:e,q:a,limit:t=50,offset:l=0})=>r()({path:`/travel/v1/giav-mapping/list?type=${encodeURIComponent(e)}&q=${encodeURIComponent(a||"")}&limit=${encodeURIComponent(t)}&offset=${encodeURIComponent(l)}`,method:"GET"}),f=e=>r()({path:"/travel/v1/giav-mapping/upsert",method:"POST",data:e}),N=({wp_object_type:e,giav_supplier_id:a,items:t,status:l="active",match_type:n="batch"})=>r()({path:"/travel/v1/giav-mapping/batch-upsert",method:"POST",data:{wp_object_type:e,giav_supplier_id:a,items:t,status:l,match_type:n}}),S=({status:e,lang:a,form:t,q:l,page:n=1,per_page:i=20}={})=>{const o=new URLSearchParams;return e&&o.set("status",e),a&&o.set("lang",a),t&&o.set("form",t),l&&o.set("q",l),o.set("page",n),o.set("per_page",i),r()({path:`/travel/v1/requests?${o.toString()}`,method:"GET"})},C=e=>r()({path:`/travel/v1/requests/${e}/convert`,method:"POST"}),k=async({q:e,pageSize:a=20,pageIndex:t=0,includeDisabled:l=!1})=>{const n=await r()({path:`/travel/v1/giav/providers/search?q=${encodeURIComponent(e)}&pageSize=${encodeURIComponent(a)}&pageIndex=${encodeURIComponent(t)}&includeDisabled=${encodeURIComponent(l)}`,method:"GET"});return{items:(Array.isArray(n)?n:Array.isArray(n?.items)?n.items:[]).map(e=>{var a,t,l,n,r,i,o,s;return{id:String(null!==(a=null!==(t=null!==(l=null!==(n=e.id)&&void 0!==n?n:e.ID)&&void 0!==l?l:e.Id)&&void 0!==t?t:e.proveedorId)&&void 0!==a?a:""),label:String(null!==(r=null!==(i=null!==(o=null!==(s=e.label)&&void 0!==s?s:e.NombreAlias)&&void 0!==o?o:e.Nombre)&&void 0!==i?i:e.title)&&void 0!==r?r:""),raw:e}}).filter(e=>e.id&&e.label)}},w=async({q:e,email:a,pageSize:t=20,pageIndex:l=0,includeLinked:n=!0,includeBlocked:i=!1})=>{const o=new URLSearchParams;e&&o.set("q",e),a&&o.set("email",a),o.set("pageSize",t),o.set("pageIndex",l),o.set("includeLinked",n?"1":"0"),o.set("includeBlocked",i?"1":"0");const s=await r()({path:`/travel/v1/giav/agents/search?${o.toString()}`,method:"GET"});return{items:(Array.isArray(s)?s:Array.isArray(s?.items)?s.items:[]).map(e=>{var a,t,l,n,r,i,o,s,c;return{id:String(null!==(a=null!==(t=null!==(l=e.id)&&void 0!==l?l:e.ID)&&void 0!==t?t:e.Id)&&void 0!==a?a:""),label:String(null!==(n=null!==(r=null!==(i=null!==(o=e.label)&&void 0!==o?o:e.title)&&void 0!==i?i:e.Nombre)&&void 0!==r?r:e.AliasAgente)&&void 0!==n?n:""),email:String(null!==(s=null!==(c=e.email)&&void 0!==c?c:e.Correo)&&void 0!==s?s:""),raw:e}}).filter(e=>e.id&&e.label)}},x=async e=>{var a,t,l,n,i,o,s,c,u;if(!e)return null;const d=await r()({path:`/travel/v1/giav/agents/${encodeURIComponent(e)}`,method:"GET"});if(!d)return null;const p=String(null!==(a=null!==(t=null!==(l=null!==(n=d.label)&&void 0!==n?n:d.title)&&void 0!==l?l:d.Nombre)&&void 0!==t?t:d.AliasAgente)&&void 0!==a?a:"");return{id:String(null!==(i=null!==(o=null!==(s=d.id)&&void 0!==s?s:d.ID)&&void 0!==o?o:d.Id)&&void 0!==i?i:e),label:p,email:String(null!==(c=null!==(u=d.email)&&void 0!==u?u:d.Correo)&&void 0!==c?c:""),raw:d}},P=()=>r()({path:"/travel/v1/requests/mapping",method:"GET"}),M=e=>r()({path:"/travel/v1/requests/mapping",method:"POST",data:e}),T=(e,a)=>r()({path:`/travel/v1/requests/mapping/${e}`,method:"POST",data:a});function I(e="",a="",t=""){const l=[(e||"").trim(),(a||"").trim()].filter(Boolean).join(" ").trim();return l||(t||"").trim()}function A(e=""){const a=(e||"").trim();if(!a)return{firstName:"",lastName:""};const t=a.split(/\s+/);return{firstName:t.shift()||"",lastName:t.join(" ")}}const B=[{label:"Español",value:"es_ES"},{label:"English (US)",value:"en_US"}],R=[{label:"EUR",value:"EUR"},{label:"USD",value:"USD"},{label:"GBP",value:"GBP"}],D=[{value:"AF",label:"Afghanistan (AF)"},{value:"AL",label:"Albania (AL)"},{value:"DZ",label:"Algeria (DZ)"},{value:"AS",label:"American Samoa (AS)"},{value:"AD",label:"Andorra (AD)"},{value:"AO",label:"Angola (AO)"},{value:"AI",label:"Anguilla (AI)"},{value:"AQ",label:"Antarctica (AQ)"},{value:"AG",label:"Antigua and Barbuda (AG)"},{value:"AR",label:"Argentina (AR)"},{value:"AM",label:"Armenia (AM)"},{value:"AW",label:"Aruba (AW)"},{value:"AU",label:"Australia (AU)"},{value:"AT",label:"Austria (AT)"},{value:"AZ",label:"Azerbaijan (AZ)"},{value:"BS",label:"Bahamas (BS)"},{value:"BH",label:"Bahrain (BH)"},{value:"BD",label:"Bangladesh (BD)"},{value:"BB",label:"Barbados (BB)"},{value:"BY",label:"Belarus (BY)"},{value:"BE",label:"Belgium (BE)"},{value:"BZ",label:"Belize (BZ)"},{value:"BJ",label:"Benin (BJ)"},{value:"BM",label:"Bermuda (BM)"},{value:"BT",label:"Bhutan (BT)"},{value:"BO",label:"Bolivia (BO)"},{value:"BQ",label:"Bonaire, Sint Eustatius and Saba (BQ)"},{value:"BA",label:"Bosnia and Herzegovina (BA)"},{value:"BW",label:"Botswana (BW)"},{value:"BV",label:"Bouvet Island (BV)"},{value:"BR",label:"Brazil (BR)"},{value:"IO",label:"British Indian Ocean Territory (IO)"},{value:"BN",label:"Brunei (BN)"},{value:"BG",label:"Bulgaria (BG)"},{value:"BF",label:"Burkina Faso (BF)"},{value:"BI",label:"Burundi (BI)"},{value:"KH",label:"Cambodia (KH)"},{value:"CM",label:"Cameroon (CM)"},{value:"CA",label:"Canada (CA)"},{value:"CV",label:"Cape Verde (CV)"},{value:"KY",label:"Cayman Islands (KY)"},{value:"CF",label:"Central African Republic (CF)"},{value:"TD",label:"Chad (TD)"},{value:"CL",label:"Chile (CL)"},{value:"CN",label:"China (CN)"},{value:"CX",label:"Christmas Island (CX)"},{value:"CC",label:"Cocos (Keeling) Islands (CC)"},{value:"CO",label:"Colombia (CO)"},{value:"KM",label:"Comoros (KM)"},{value:"CG",label:"Congo (CG)"},{value:"CD",label:"Congo (Democratic Republic) (CD)"},{value:"CK",label:"Cook Islands (CK)"},{value:"CR",label:"Costa Rica (CR)"},{value:"CI",label:"Côte d’Ivoire (CI)"},{value:"HR",label:"Croatia (HR)"},{value:"CU",label:"Cuba (CU)"},{value:"CW",label:"Curaçao (CW)"},{value:"CY",label:"Cyprus (CY)"},{value:"CZ",label:"Czechia (CZ)"},{value:"DK",label:"Denmark (DK)"},{value:"DJ",label:"Djibouti (DJ)"},{value:"DM",label:"Dominica (DM)"},{value:"DO",label:"Dominican Republic (DO)"},{value:"EC",label:"Ecuador (EC)"},{value:"EG",label:"Egypt (EG)"},{value:"SV",label:"El Salvador (SV)"},{value:"GQ",label:"Equatorial Guinea (GQ)"},{value:"ER",label:"Eritrea (ER)"},{value:"EE",label:"Estonia (EE)"},{value:"ET",label:"Ethiopia (ET)"},{value:"FK",label:"Falkland Islands (FK)"},{value:"FO",label:"Faroe Islands (FO)"},{value:"FJ",label:"Fiji (FJ)"},{value:"FI",label:"Finland (FI)"},{value:"FR",label:"France (FR)"},{value:"GF",label:"French Guiana (GF)"},{value:"PF",label:"French Polynesia (PF)"},{value:"TF",label:"French Southern Territories (TF)"},{value:"GA",label:"Gabon (GA)"},{value:"GM",label:"Gambia (GM)"},{value:"GE",label:"Georgia (GE)"},{value:"DE",label:"Germany (DE)"},{value:"GH",label:"Ghana (GH)"},{value:"GI",label:"Gibraltar (GI)"},{value:"GR",label:"Greece (GR)"},{value:"GL",label:"Greenland (GL)"},{value:"GD",label:"Grenada (GD)"},{value:"GP",label:"Guadeloupe (GP)"},{value:"GU",label:"Guam (GU)"},{value:"GT",label:"Guatemala (GT)"},{value:"GG",label:"Guernsey (GG)"},{value:"GN",label:"Guinea (GN)"},{value:"GW",label:"Guinea-Bissau (GW)"},{value:"GY",label:"Guyana (GY)"},{value:"HT",label:"Haiti (HT)"},{value:"HM",label:"Heard Island and McDonald Islands (HM)"},{value:"HN",label:"Honduras (HN)"},{value:"HK",label:"Hong Kong (HK)"},{value:"HU",label:"Hungary (HU)"},{value:"IS",label:"Iceland (IS)"},{value:"IN",label:"India (IN)"},{value:"ID",label:"Indonesia (ID)"},{value:"IR",label:"Iran (IR)"},{value:"IQ",label:"Iraq (IQ)"},{value:"IE",label:"Ireland (IE)"},{value:"IM",label:"Isle of Man (IM)"},{value:"IL",label:"Israel (IL)"},{value:"IT",label:"Italy (IT)"},{value:"JM",label:"Jamaica (JM)"},{value:"JP",label:"Japan (JP)"},{value:"JE",label:"Jersey (JE)"},{value:"JO",label:"Jordan (JO)"},{value:"KZ",label:"Kazakhstan (KZ)"},{value:"KE",label:"Kenya (KE)"},{value:"KI",label:"Kiribati (KI)"},{value:"KP",label:"Korea (North) (KP)"},{value:"KR",label:"Korea (South) (KR)"},{value:"KW",label:"Kuwait (KW)"},{value:"KG",label:"Kyrgyzstan (KG)"},{value:"LA",label:"Laos (LA)"},{value:"LV",label:"Latvia (LV)"},{value:"LB",label:"Lebanon (LB)"},{value:"LS",label:"Lesotho (LS)"},{value:"LR",label:"Liberia (LR)"},{value:"LY",label:"Libya (LY)"},{value:"LI",label:"Liechtenstein (LI)"},{value:"LT",label:"Lithuania (LT)"},{value:"LU",label:"Luxembourg (LU)"},{value:"MO",label:"Macao (MO)"},{value:"MG",label:"Madagascar (MG)"},{value:"MW",label:"Malawi (MW)"},{value:"MY",label:"Malaysia (MY)"},{value:"MV",label:"Maldives (MV)"},{value:"ML",label:"Mali (ML)"},{value:"MT",label:"Malta (MT)"},{value:"MH",label:"Marshall Islands (MH)"},{value:"MQ",label:"Martinique (MQ)"},{value:"MR",label:"Mauritania (MR)"},{value:"MU",label:"Mauritius (MU)"},{value:"YT",label:"Mayotte (YT)"},{value:"MX",label:"Mexico (MX)"},{value:"FM",label:"Micronesia (FM)"},{value:"MD",label:"Moldova (MD)"},{value:"MC",label:"Monaco (MC)"},{value:"MN",label:"Mongolia (MN)"},{value:"ME",label:"Montenegro (ME)"},{value:"MS",label:"Montserrat (MS)"},{value:"MA",label:"Morocco (MA)"},{value:"MZ",label:"Mozambique (MZ)"},{value:"MM",label:"Myanmar (MM)"},{value:"NA",label:"Namibia (NA)"},{value:"NR",label:"Nauru (NR)"},{value:"NP",label:"Nepal (NP)"},{value:"NL",label:"Netherlands (NL)"},{value:"NC",label:"New Caledonia (NC)"},{value:"NZ",label:"New Zealand (NZ)"},{value:"NI",label:"Nicaragua (NI)"},{value:"NE",label:"Niger (NE)"},{value:"NG",label:"Nigeria (NG)"},{value:"NU",label:"Niue (NU)"},{value:"NF",label:"Norfolk Island (NF)"},{value:"MK",label:"North Macedonia (MK)"},{value:"MP",label:"Northern Mariana Islands (MP)"},{value:"NO",label:"Norway (NO)"},{value:"OM",label:"Oman (OM)"},{value:"PK",label:"Pakistan (PK)"},{value:"PW",label:"Palau (PW)"},{value:"PS",label:"Palestine (PS)"},{value:"PA",label:"Panama (PA)"},{value:"PG",label:"Papua New Guinea (PG)"},{value:"PY",label:"Paraguay (PY)"},{value:"PE",label:"Peru (PE)"},{value:"PH",label:"Philippines (PH)"},{value:"PN",label:"Pitcairn (PN)"},{value:"PL",label:"Poland (PL)"},{value:"PT",label:"Portugal (PT)"},{value:"PR",label:"Puerto Rico (PR)"},{value:"QA",label:"Qatar (QA)"},{value:"RE",label:"Réunion (RE)"},{value:"RO",label:"Romania (RO)"},{value:"RU",label:"Russia (RU)"},{value:"RW",label:"Rwanda (RW)"},{value:"BL",label:"Saint Barthélemy (BL)"},{value:"SH",label:"Saint Helena (SH)"},{value:"KN",label:"Saint Kitts and Nevis (KN)"},{value:"LC",label:"Saint Lucia (LC)"},{value:"MF",label:"Saint Martin (MF)"},{value:"PM",label:"Saint Pierre and Miquelon (PM)"},{value:"VC",label:"Saint Vincent and the Grenadines (VC)"},{value:"WS",label:"Samoa (WS)"},{value:"SM",label:"San Marino (SM)"},{value:"ST",label:"São Tomé and Príncipe (ST)"},{value:"SA",label:"Saudi Arabia (SA)"},{value:"SN",label:"Senegal (SN)"},{value:"RS",label:"Serbia (RS)"},{value:"SC",label:"Seychelles (SC)"},{value:"SL",label:"Sierra Leone (SL)"},{value:"SG",label:"Singapore (SG)"},{value:"SX",label:"Sint Maarten (SX)"},{value:"SK",label:"Slovakia (SK)"},{value:"SI",label:"Slovenia (SI)"},{value:"SB",label:"Solomon Islands (SB)"},{value:"SO",label:"Somalia (SO)"},{value:"ZA",label:"South Africa (ZA)"},{value:"GS",label:"South Georgia and the South Sandwich Islands (GS)"},{value:"SS",label:"South Sudan (SS)"},{value:"ES",label:"Spain (ES)"},{value:"LK",label:"Sri Lanka (LK)"},{value:"SD",label:"Sudan (SD)"},{value:"SR",label:"Suriname (SR)"},{value:"SJ",label:"Svalbard and Jan Mayen (SJ)"},{value:"SE",label:"Sweden (SE)"},{value:"CH",label:"Switzerland (CH)"},{value:"SY",label:"Syria (SY)"},{value:"TW",label:"Taiwan (TW)"},{value:"TJ",label:"Tajikistan (TJ)"},{value:"TZ",label:"Tanzania (TZ)"},{value:"TH",label:"Thailand (TH)"},{value:"TL",label:"Timor-Leste (TL)"},{value:"TG",label:"Togo (TG)"},{value:"TK",label:"Tokelau (TK)"},{value:"TO",label:"Tonga (TO)"},{value:"TT",label:"Trinidad and Tobago (TT)"},{value:"TN",label:"Tunisia (TN)"},{value:"TR",label:"Turkey (TR)"},{value:"TM",label:"Turkmenistan (TM)"},{value:"TC",label:"Turks and Caicos Islands (TC)"},{value:"TV",label:"Tuvalu (TV)"},{value:"UG",label:"Uganda (UG)"},{value:"UA",label:"Ukraine (UA)"},{value:"AE",label:"United Arab Emirates (AE)"},{value:"GB",label:"United Kingdom (GB)"},{value:"US",label:"United States (US)"},{value:"UM",label:"United States Minor Outlying Islands (UM)"},{value:"UY",label:"Uruguay (UY)"},{value:"UZ",label:"Uzbekistan (UZ)"},{value:"VU",label:"Vanuatu (VU)"},{value:"VA",label:"Vatican City (VA)"},{value:"VE",label:"Venezuela (VE)"},{value:"VN",label:"Vietnam (VN)"},{value:"VG",label:"Virgin Islands (British) (VG)"},{value:"VI",label:"Virgin Islands (US) (VI)"},{value:"WF",label:"Wallis and Futuna (WF)"},{value:"EH",label:"Western Sahara (EH)"},{value:"YE",label:"Yemen (YE)"},{value:"ZM",label:"Zambia (ZM)"},{value:"ZW",label:"Zimbabwe (ZW)"}];function $(){return(new Date).toISOString().slice(0,10)}function q(e){if(!e)return"";if(e instanceof Date&&!Number.isNaN(e.getTime()))return e.toISOString().slice(0,10);if("string"==typeof e){if(e.includes("/")){const[a,t,l]=e.split("/");if(a&&t&&l)return`${l.padStart(4,"0")}-${t.padStart(2,"0")}-${a.padStart(2,"0")}`}return e.slice(0,10)}return""}function G(e){if(!e)return null;const a="string"==typeof e?e.slice(0,10):e,t=a instanceof Date?a:new Date(`${a}T00:00:00`);return Number.isNaN(t.getTime())?null:(t.setHours(0,0,0,0),t)}function F(){const e=new Date;return e.setHours(0,0,0,0),e}function V({id:e,label:n,value:r,onChange:i,className:o="",fieldRef:s,isInvalidDate:c}){const[u,d]=(0,t.useState)(!1),[p,m]=(0,t.useState)(null),_=function(e){if(!e)return"";const[a,t,l]=e.split("-");return a&&t&&l?`${l}/${t}/${a}`:e}(r);return(0,a.createElement)("div",{className:`proposal-basics__field ${o}`.trim(),ref:e=>{"function"==typeof s&&s(e)}},(0,a.createElement)(l.TextControl,{id:e,label:n,value:_,onClick:e=>{m(e.currentTarget),d(!0)},onFocus:e=>{m(e.currentTarget),d(!0)},readOnly:!0,placeholder:"DD/MM/AAAA"}),u&&p&&(0,a.createElement)(l.Popover,{anchor:p,placement:"bottom-start",className:"proposal-basics__date-popover",onClose:()=>{d(!1),m(null)}},(0,a.createElement)(l.DatePicker,{currentDate:r||$(),onChange:e=>{const a=q(e);a&&i(a),d(!1)},isInvalidDate:c})))}function U({initialValues:e={},onCreated:n,onNext:r,proposalId:i}){var s;const c=(0,t.useMemo)(()=>{var a,t,l,n,r,i;const o={proposal_title:"",customer_name:e.customer_name||"",customer_email:"",customer_country:"",customer_language:"es",start_date:$(),end_date:$(),pax_total:1,players_count:null!==(a=null!==(t=e.players_count)&&void 0!==t?t:e.pax_total)&&void 0!==a?a:1,currency:"EUR",first_name:null!==(l=e.first_name)&&void 0!==l?l:"",last_name:null!==(n=e.last_name)&&void 0!==n?n:"",giav_agent_id:null!==(r=null!==(i=e.giav_agent_id)&&void 0!==i?i:e.agent_id)&&void 0!==r?r:"",...e},s=o.customer_name||e.customer_name||"",c=A(s),u=o.first_name||c.firstName,d=o.last_name||c.lastName;return o.first_name=u,o.last_name=d,o.customer_name=I(u,d,s),void 0!==o.giav_agent_id&&null!==o.giav_agent_id&&(o.giav_agent_id=String(o.giav_agent_id)),o},[e]),[d,p]=(0,t.useState)(c),[m,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(""),[b,h]=(0,t.useState)(""),[y,E]=(0,t.useState)(""),[f,N]=(0,t.useState)(""),[S,C]=(0,t.useState)([]),[k,P]=(0,t.useState)(!1),[M,T]=(0,t.useState)(""),[U,L]=(0,t.useState)(null),j=(0,t.useRef)({}),O=(0,t.useRef)(null),H=(0,t.useRef)(!1),z=!i;(0,t.useEffect)(()=>{p(e=>{const a={...e,...c};return a.customer_name=I(a.first_name,a.last_name,c.customer_name),a})},[c]),(0,t.useEffect)(()=>(window.fillProposalBasics=(e={})=>{p(a=>{var t,l,n;const r="string"==typeof e.name?e.name:a.customer_name,i=A(r),o="string"==typeof e.first_name?e.first_name:i.firstName||a.first_name,s="string"==typeof e.last_name?e.last_name:i.lastName||a.last_name,c=null!==(t=null!==(l=null!==(n=e.giav_agent_id)&&void 0!==n?n:e.agent_id)&&void 0!==l?l:e.agente_comercial_id)&&void 0!==t?t:null,u=null!=c?String(c):a.giav_agent_id;return{...a,proposal_title:"string"==typeof e.title?e.title:a.proposal_title,first_name:o,last_name:s,customer_name:I(o,s,r),customer_email:"string"==typeof e.email?e.email:a.customer_email,customer_country:"string"==typeof e.country?e.country.toUpperCase():a.customer_country,customer_language:"string"==typeof e.language?e.language:a.customer_language,giav_agent_id:u}})},()=>{delete window.fillProposalBasics}),[]);const K=(0,t.useMemo)(()=>{if("undefined"==typeof window)return"";const e=window.CASANOVA_GESTION_RESERVAS?.currentUser?.email,a=window.WP_TRAVEL_GIAV?.currentUser?.email;return e||a||""},[]),W=e=>{var a,t,l,n,r,i,o,s,c;if(!e)return null;const u=String(null!==(a=null!==(t=null!==(l=e.id)&&void 0!==l?l:e.Id)&&void 0!==t?t:e.ID)&&void 0!==a?a:""),d=String(null!==(n=null!==(r=null!==(i=null!==(o=e.label)&&void 0!==o?o:e.title)&&void 0!==i?i:e.Nombre)&&void 0!==r?r:e.AliasAgente)&&void 0!==n?n:"");return u&&d?{value:u,label:d,email:null!==(s=null!==(c=e.email)&&void 0!==c?c:e.Correo)&&void 0!==s?s:""}:null},J=e=>{e&&(L(e),C(a=>{const t=a.filter(a=>a.value!==e.value);return[e,...t]}))};(0,t.useEffect)(()=>{if(H.current)return;if(!K||d.giav_agent_id)return;H.current=!0;let e=!0;return(async()=>{try{const a=await w({email:K,pageSize:5,pageIndex:0,includeLinked:!0,includeBlocked:!1});if(!e)return;const t=a?.items||[];if(0===t.length)return;const l=t.find(e=>(e.email||"").toLowerCase()===K.toLowerCase()),n=W(l||t[0]);if(!n)return;p(e=>e.giav_agent_id?e:{...e,giav_agent_id:n.value}),J(n)}catch(a){e&&T(a?.message||"No se pudo autocompletar el agente.")}})(),()=>{e=!1}},[K,d.giav_agent_id]),(0,t.useEffect)(()=>{const e=d.giav_agent_id?String(d.giav_agent_id):"";if(!e)return void L(null);if(U&&U.value===e)return;const a=S.find(a=>a.value===e);if(a)return void L(a);let t=!0;return(async()=>{try{const a=await x(e);if(!t)return;const l=W(a);l&&J(l)}catch(e){}})(),()=>{t=!1}},[d.giav_agent_id,S,U]);const Z=e=>a=>{p(t=>{const l={...t,[e]:a};if("first_name"===e||"last_name"===e){const n="first_name"===e?a:t.first_name,r="last_name"===e?a:t.last_name;l.customer_name=I(n,r,t.customer_name)}return l}),E(a=>a===e?"":a)},Y=e=>a=>{a&&(j.current[e]=a)},Q=e=>{const a=j.current[e];if(!a)return;a.scrollIntoView({behavior:"smooth",block:"center"});const t=a.querySelector("input, select, textarea, button");t&&"function"==typeof t.focus&&t.focus()},X=()=>{if(!d.first_name?.trim())return{message:"El nombre del cliente es obligatorio.",field:"first_name"};if(!d.start_date)return{message:"La fecha de inicio es obligatoria.",field:"start_date"};if(!d.end_date)return{message:"La fecha de fin es obligatoria.",field:"end_date"};if(d.end_date<d.start_date)return{message:"La fecha fin no puede ser anterior a la fecha inicio.",field:"end_date"};const e=parseInt(d.pax_total,10);if(Number.isNaN(e)||e<1)return{message:"Pax debe ser un numero >= 1.",field:"pax_total"};const a=parseInt(d.players_count,10);return Number.isNaN(a)||a<0?{message:"Jugadores debe ser un numero >= 0.",field:"players_count"}:a>e?{message:"Jugadores no puede ser mayor que Pax.",field:"players_count"}:d.customer_email&&!/^\S+@\S+\.\S+$/.test(d.customer_email)?{message:"El email no parece valido (si lo rellenas, que sea correcto).",field:"customer_email"}:d.customer_country&&2!==d.customer_country.length?{message:"Destino debe ser ISO2 (2 letras) o vacio.",field:"customer_country"}:d.giav_agent_id&&!/^\d+$/.test(String(d.giav_agent_id))?{message:"Agente comercial debe ser un ID valido o vacio.",field:"giav_agent_id"}:null},ee=(0,t.useMemo)(()=>{if(!f)return D;const e=f.toLowerCase();return D.filter(a=>a.label.toLowerCase().includes(e)||a.value.toLowerCase().includes(e))},[f]),ae=(0,t.useMemo)(()=>U?S.some(e=>e.value===U.value)?S:[U,...S]:S,[S,U]),te=M||(k?"Buscando agentes en GIAV...":""),le=parseInt(d.pax_total,10),ne=parseInt(d.players_count,10),re=Number.isFinite(le)?Math.max(0,le-(Number.isFinite(ne)?ne:0)):0;return(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Datos básicos")),(0,a.createElement)(l.CardBody,null,b&&(0,a.createElement)(l.Notice,{status:"success",isDismissible:!0,onRemove:()=>h("")},b),v&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>{g(""),h(""),E("")}},v),(0,a.createElement)("div",{className:"proposal-basics"},(0,a.createElement)("div",{className:"proposal-basics__section"},(0,a.createElement)("div",{className:"proposal-basics__section-title"},"Identidad de la propuesta"),(0,a.createElement)("div",{className:"proposal-basics__grid"},(0,a.createElement)("div",{className:("proposal-basics__field proposal-basics__field--full "+("proposal_title"===y?"is-error":"")).trim(),ref:Y("proposal_title")},(0,a.createElement)(l.TextControl,{label:"Título de la propuesta",value:d.proposal_title,onChange:Z("proposal_title"),placeholder:"Escapada a la Costa del Sol"})),(0,a.createElement)("div",{className:("proposal-basics__field "+("first_name"===y?"is-error":"")).trim(),ref:Y("first_name")},(0,a.createElement)(l.TextControl,{label:"Nombre *",value:d.first_name,onChange:Z("first_name"),placeholder:"John"})),(0,a.createElement)("div",{className:"proposal-basics__field",ref:Y("last_name")},(0,a.createElement)(l.TextControl,{label:"Apellidos",value:d.last_name,onChange:Z("last_name"),placeholder:"Doe"})),(0,a.createElement)("div",{className:("proposal-basics__field "+("customer_email"===y?"is-error":"")).trim(),ref:Y("customer_email")},(0,a.createElement)(l.TextControl,{label:"Email",value:d.customer_email,onChange:Z("customer_email"),placeholder:"john@email.com"})))),(0,a.createElement)("div",{className:"proposal-basics__section"},(0,a.createElement)("div",{className:"proposal-basics__section-title"},"Fechas y pasajeros"),(0,a.createElement)("div",{className:"proposal-basics__grid proposal-basics__grid--dates"},(0,a.createElement)(V,{label:"Fecha inicio *",value:d.start_date,onChange:e=>{p(a=>{const t={...a,start_date:e};return t.end_date&&e&&t.end_date<e&&(t.end_date=e),t}),window.setTimeout(()=>{const e=document.getElementById("wp-travel-end-date");if(e&&(e.focus(),"function"==typeof e.showPicker))try{e.showPicker()}catch(e){}},0)},className:"start_date"===y?"is-error":"",fieldRef:Y("start_date"),isInvalidDate:e=>{if(!z)return!1;const a=G(q(e));return!!a&&a<F()}}),(0,a.createElement)("div",{className:"proposal-basics__date-arrow","aria-hidden":"true"},"→"),(0,a.createElement)(V,{id:"wp-travel-end-date",label:"Fecha fin *",value:d.end_date,onChange:e=>{p(a=>a.start_date&&e&&e<a.start_date?{...a,end_date:a.start_date}:{...a,end_date:e})},className:"end_date"===y?"is-error":"",fieldRef:Y("end_date"),isInvalidDate:e=>{const a=G(q(e));if(!a)return!1;const t=z?G(d.start_date)||F():G(d.start_date);return!!t&&a<t}}),(0,a.createElement)("div",{className:("proposal-basics__field proposal-basics__field--pax "+("pax_total"===y?"is-error":"")).trim(),ref:Y("pax_total")},(0,a.createElement)(l.TextControl,{label:"Pax *",type:"number",min:1,value:String(d.pax_total),onChange:Z("pax_total")})),(0,a.createElement)("div",{className:("proposal-basics__field proposal-basics__field--pax "+("players_count"===y?"is-error":"")).trim(),ref:Y("players_count")},(0,a.createElement)(l.TextControl,{label:"Jugadores",type:"number",min:0,value:String(null!==(s=d.players_count)&&void 0!==s?s:""),onChange:Z("players_count"),help:`No jugadores: ${re}`})))),(0,a.createElement)("div",{className:"proposal-basics__section"},(0,a.createElement)("div",{className:"proposal-basics__section-title"},"Preferencias"),(0,a.createElement)("div",{className:"proposal-basics__grid"},(0,a.createElement)("div",{className:("proposal-basics__field "+("customer_language"===y?"is-error":"")).trim(),ref:Y("customer_language")},(0,a.createElement)(l.SelectControl,{label:"Idioma",value:d.customer_language,options:B,onChange:Z("customer_language")})),(0,a.createElement)("div",{className:("proposal-basics__field "+("customer_country"===y?"is-error":"")).trim(),ref:Y("customer_country")},(0,a.createElement)(l.ComboboxControl,{label:"Destino Viaje",value:d.customer_country,options:ee,onFilterValueChange:N,onChange:e=>Z("customer_country")(e?e.toUpperCase():""),placeholder:"Busca destino o codigo"})),(0,a.createElement)("div",{className:("proposal-basics__field "+("giav_agent_id"===y?"is-error":"")).trim(),ref:Y("giav_agent_id")},(0,a.createElement)(l.ComboboxControl,{label:"Agente Comercial",value:d.giav_agent_id,options:ae,onFilterValueChange:e=>{T(""),O.current&&clearTimeout(O.current),O.current=setTimeout(()=>{(async({query:e="",email:a=""}={})=>{const t=String(e||"").trim(),l=String(a||"").trim(),n=!l&&t.includes("@")?t:"",r=l||n,i=n?"":t;if(i.length<2&&!r)T("");else{P(!0),T("");try{const e=await w({q:i||void 0,email:r||void 0,pageSize:20,pageIndex:0,includeLinked:!0,includeBlocked:!1}),a=(e?.items||[]).map(W).filter(Boolean);C(e=>{const t=[...a];return U&&!t.some(e=>e.value===U.value)&&t.unshift(U),t})}catch(e){T(e?.message||"Error buscando agentes en GIAV")}finally{P(!1)}}})({query:e})},250)},onChange:e=>{const a=e?String(e):"";if(!a)return Z("giav_agent_id")(""),void L(null);const t=ae.find(e=>e.value===a);(t||/^\d+$/.test(a))&&(Z("giav_agent_id")(a),t&&L(t))},placeholder:"Busca por nombre, alias o email",help:te})),(0,a.createElement)("div",{className:("proposal-basics__field "+("currency"===y?"is-error":"")).trim(),ref:Y("currency")},(0,a.createElement)(l.SelectControl,{label:"Moneda",value:d.currency,options:R,onChange:Z("currency")}))))),(0,a.createElement)("div",{className:"proposal-basics__actions"},i&&(0,a.createElement)(l.Button,{variant:"secondary",onClick:async()=>{if(!i)return;const e=X();if(e)return h(""),g(e.message),E(e.field||""),void Q(e.field);_(!0),g(""),h("");const a=I(d.first_name,d.last_name,d.customer_name),t={...d,customer_name:a,pax_total:parseInt(d.pax_total,10),players_count:Math.max(0,parseInt(d.players_count,10)),customer_country:d.customer_country?d.customer_country.toUpperCase():"",giav_agent_id:(()=>{const e=parseInt(d.giav_agent_id,10);return Number.isFinite(e)&&e>0?e:null})()};try{await u(i,t),h("Cambios guardados.")}catch(e){g(e?.message||"Error guardando la propuesta.")}finally{_(!1)}},disabled:m},"Guardar"),(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{const e=X();if(e)return h(""),g(e.message),E(e.field||""),void Q(e.field);_(!0),h(""),g("");const a=I(d.first_name,d.last_name,d.customer_name),t={...d,customer_name:a,pax_total:parseInt(d.pax_total,10),players_count:Math.max(0,parseInt(d.players_count,10)),customer_country:d.customer_country?d.customer_country.toUpperCase():"",giav_agent_id:(()=>{const e=parseInt(d.giav_agent_id,10);return Number.isFinite(e)&&e>0?e:null})()};try{if(i)return await u(i,t),void r?.({basics:t});const e=await o(t);n?.({proposalId:e.proposal_id,basics:t})}catch(e){g(e?.message||"Error creando la propuesta.")}finally{_(!1)}},disabled:m},v?"Revisa los campos marcados":"Continuar"),m&&(0,a.createElement)(l.Spinner,null))))}const L=window.wp.i18n;function j({label:e,type:n,valueTitle:r,onPick:i}){const[o,s]=(0,t.useState)(r||""),[c,u]=(0,t.useState)(!1),[d,p]=(0,t.useState)(!1),[m,_]=(0,t.useState)([]);return(0,t.useEffect)(()=>{s(r||"")},[r]),(0,t.useEffect)(()=>{if(!c)return;let e=!0;return p(!0),h({type:n,q:o}).then(a=>e&&_(Array.isArray(a)?a:[])).catch(()=>e&&_([])).finally(()=>e&&p(!1)),()=>{e=!1}},[o,c,n]),(0,a.createElement)("div",{style:{position:"relative",width:"100%",maxWidth:320,minWidth:0}},(0,a.createElement)(l.TextControl,{label:e,value:o,onChange:e=>{s(e),u(!0)},onFocus:()=>u(!0),placeholder:"hotel"===n?"Buscar hotel…":"Buscar campo…"}),c&&(0,a.createElement)("div",{style:{position:"absolute",zIndex:30,background:"#fff",border:"1px solid #ddd",borderRadius:8,width:"100%",maxHeight:220,overflow:"auto",boxShadow:"0 6px 18px rgba(0,0,0,.08)"}},d&&(0,a.createElement)("div",{style:{padding:8}},(0,a.createElement)(l.Spinner,null)),!d&&0===m.length&&(0,a.createElement)("div",{style:{padding:8,fontSize:12,opacity:.6}},"Sin resultados"),!d&&m.map(e=>(0,a.createElement)("button",{key:e.id,type:"button",onClick:()=>{i(e),u(!1)},style:{display:"block",width:"100%",padding:"8px 10px",border:0,background:"transparent",textAlign:"left",cursor:"pointer"}},e.title))))}function O({valueId:e,valueLabel:t,onSelect:l,disabled:n=!1,placeholder:r="Buscar proveedor en GIAV..."}){const[i,o]=(0,a.useState)(t||""),[s,c]=(0,a.useState)([]),[u,d]=(0,a.useState)(!1),[p,m]=(0,a.useState)(!1),[_,v]=(0,a.useState)(""),g=(0,a.useRef)(null);(0,a.useEffect)(()=>{t&&t!==i&&o(t)},[t]);return(0,a.createElement)("div",{style:{position:"relative"}},(0,a.createElement)("input",{type:"text",value:i,onChange:e=>{return a=e.target.value,o(a),d(!0),clearTimeout(g.current),void(g.current=setTimeout(()=>(async e=>{const a=(e||"").trim();if(a.length<2)return c([]),v(""),void d(!1);m(!0),v("");try{const e=await k({q:a,pageSize:20,pageIndex:0,includeDisabled:!1}),t=(Array.isArray(e)?e:Array.isArray(e?.items)?e.items:[]).map(e=>{var a,t,l,n,r,i,o,s;return{id:String(null!==(a=null!==(t=null!==(l=null!==(n=e.id)&&void 0!==n?n:e.Id)&&void 0!==l?l:e.ID)&&void 0!==t?t:e.proveedorId)&&void 0!==a?a:""),label:String(null!==(r=null!==(i=null!==(o=null!==(s=e.label)&&void 0!==s?s:e.NombreAlias)&&void 0!==o?o:e.Nombre)&&void 0!==i?i:e.title)&&void 0!==r?r:"")}}).filter(e=>e.id&&e.label);c(t),d(t.length>0)}catch(e){v(e?.message||"Error buscando proveedores en GIAV"),c([]),d(!1)}finally{m(!1)}})(a),250));var a},onFocus:()=>{s.length>0&&d(!0)},placeholder:r,disabled:n,style:{width:"100%"}}),(0,a.createElement)("div",{style:{fontSize:12,marginTop:6,opacity:.8}},e?(0,a.createElement)(a.Fragment,null,"ID seleccionado: ",(0,a.createElement)("strong",null,e)):null,p?(0,a.createElement)("span",{style:{marginLeft:10}},"Buscando…"):null,_?(0,a.createElement)("span",{style:{marginLeft:10,color:"crimson"}},_):null),u&&s.length>0&&(0,a.createElement)("div",{style:{position:"absolute",zIndex:20,top:"100%",left:0,right:0,background:"#fff",border:"1px solid #ddd",borderTop:"none",maxHeight:260,overflow:"auto"}},s.map(e=>(0,a.createElement)("div",{key:e.id,onMouseDown:a=>{a.preventDefault(),(e=>{o(e.label),d(!1),c([]),v(""),l?.(e)})(e)},style:{padding:"10px 12px",cursor:"pointer",borderBottom:"1px solid #f0f0f0"}},(0,a.createElement)("div",{style:{fontWeight:600}},e.label),(0,a.createElement)("div",{style:{fontSize:12,opacity:.75}},"ID: ",e.id)))))}const H="1734698",z="Proveedores varios",K=(new Date).toISOString().slice(0,10),W=[{label:"Hotel",value:"hotel"},{label:"Golf",value:"golf"},{label:"Transfer",value:"transfer"},{label:"Extra",value:"extra"},{label:"Paquete",value:"package"}],J=[{label:"Alojamiento y Desayuno",value:"AD"},{label:"Solo Alojamiento",value:"SA"},{label:"Media Pensión",value:"MP"},{label:"Pensión Completa",value:"PC"},{label:"Todo Incluido",value:"TI"},{label:"Según Programa",value:"SP"}];function Z(e){const a=parseFloat(String(e).replace(",","."));return Number.isFinite(a)?a:0}function Y(e,a=1){const t=parseInt(e,10);return Number.isFinite(t)?t:a}function Q(e,a,t){return Number.isFinite(e)?Math.min(t,Math.max(a,e)):a}function X(e){return Math.round(100*(e+Number.EPSILON))/100}function ee(e,a){let t=Math.abs(e),l=Math.abs(a);for(;l;){const e=l;l=t%l,t=e}return t}function ae(e,a){return!a||a<=1?e:Math.ceil(e/a)*a}function te(e,a){if(!e||!a)return 0;const[t,l,n]=String(e).split("-").map(e=>parseInt(e,10)),[r,i,o]=String(a).split("-").map(e=>parseInt(e,10));if(![t,l,n,r,i,o].every(e=>Number.isFinite(e)))return 0;const s=Date.UTC(t,l-1,n),c=Date.UTC(r,i-1,o)-s;return!Number.isFinite(c)||c<=0?0:Math.round(c/864e5)}function le(e,a){if(!e)return"";const[t,l,n]=String(e).split("-").map(e=>parseInt(e,10));if(![t,l,n].every(e=>Number.isFinite(e)))return"";const r=new Date(Date.UTC(t,l-1,n));return r.setUTCDate(r.getUTCDate()+Math.max(0,a)),r.toISOString().slice(0,10)}function ne(e,a,t,l="",n=0){const r=function(e,a,t="",l=0){const n=te(e,a);if(n<=0)return[];const r=[];for(let a=0;a<n;a++)r.push({date:le(e,a),net_price:t,margin_pct:l});return r}(a,t,l,n);if(!r.length)return[];const i=new Map;return(Array.isArray(e)?e:[]).forEach(e=>{const a=e?.date;var t,r,o,s,c;a&&(i.has(a)||i.set(a,{date:a,net_price:null!==(t=null!==(r=null!==(o=e.net_price)&&void 0!==o?o:e.net)&&void 0!==r?r:e.net_price_per_night)&&void 0!==t?t:l,margin_pct:null!==(s=null!==(c=e.margin_pct)&&void 0!==c?c:e.margin)&&void 0!==s?s:n}))}),r.map(e=>{const a=i.get(e.date);return a?{...e,...a}:e})}function re(e,a){return te(e.start_date||a?.start_date||"",e.end_date||a?.end_date||"")}function ie(e=0){return{double:{enabled:!0,rooms:1,pricing_basis:"per_room",net_price_per_night:"",margin_pct:e,pvp_manual_enabled:!1,pvp_price_per_night:"",nights_payable:0,free_nights_applied:0,discount_pct_applied:0,total_net:0,total_pvp:0},single:{enabled:!1,rooms:0,pricing_basis:"per_room",net_price_per_night:"",margin_pct:e,pvp_manual_enabled:!1,pvp_price_per_night:"",nights_payable:0,free_nights_applied:0,discount_pct_applied:0,total_net:0,total_pvp:0}}}function oe(e,a,t){const l=Math.max(0,Y(null!=a?a:0,0)),n=Math.max(0,Y(null!=t?t:0,0));if(l<=0||n<=0||e<=0)return{freeNights:0,nightsPayable:Math.max(0,e)};const r=Math.floor(e/l),i=Math.min(e,r*n);return{freeNights:i,nightsPayable:Math.max(0,e-i)}}function se(e,a){return X(Math.max(0,Z(e))*(1+Math.max(0,Z(a))/100))}function ce(e,a=0){var t,l;const n=e?.start_date||"",r=e?.end_date||"",i=ie(a);return{service_type:"hotel",title:"",start_date:n,end_date:r,hotel_room_type:"",hotel_regimen:"",hotel_rooms:0,hotel_rate_basis:null,hotel_regimen:"",hotel_pricing_mode:"simple",nightly_rates:[],condiciones_cancelacion:"",quantity:1,green_fees_per_person:1,number_of_players:null!==(t=null!==(l=e?.players_count)&&void 0!==l?l:e?.pax_total)&&void 0!==t?t:1,total_green_fees:0,unit_cost_net:"",unit_sell_price:"",use_markup:!0,markup_pct:a,lock_sell_price:!1,notes_public:"",notes_internal:"",package_components_text:"",package_pricing_basis:"per_room",package_discount_percent:0,package_quote_individual:!1,package_individual_mode:"absolute",package_individual_qty:0,package_individual_use_markup:!0,package_individual_markup_pct:a,package_unit_cost_net_individual:"",package_unit_sell_price_individual:"",package_single_supplement_net:"",package_single_supplement_pvp:"",package_individual_count:0,unit_cost_net_individual:"",unit_sell_price_individual:"",package_single_supplement_sell:"",package_quote_single_rooms:!1,package_single_rooms:0,package_single_room_mode:"absolute",unit_cost_net_single_room:"",unit_sell_price_single_room:"",package_single_room_supplement_net:"",package_single_room_supplement_sell:"",display_name:"",use_manual_entry:!1,wp_object_type:null,wp_object_id:null,giav_entity_type:null,giav_entity_id:null,giav_supplier_id:H,giav_supplier_name:z,giav_mapping_status:"needs_review",show_supplier_picker:!1,supplier_override:!1,dates_inherited:!0,room_pricing:i,discounts:{discount_pct:0,free_nights_every:"",free_nights_count:""},giav_pricing:{giav_total_pvp:0,giav_total_net:0,giav_source:"double",giav_locked:!1}}}function ue(e,a,t){var l,n;const r={...e};r.start_date||(r.start_date=a?.start_date||""),r.end_date||(r.end_date=a?.end_date||""),r.quantity=Math.max(1,Y(r.quantity,1)),void 0!==r.hotel_rooms&&(r.hotel_rooms=Math.max(0,Y(r.hotel_rooms,0))),r.unit_cost_net=Math.max(0,Z(r.unit_cost_net));const i=r.use_markup?Math.max(0,Z(null!==(l=null!==(n=r.markup_pct)&&void 0!==n?n:t)&&void 0!==l?l:0)):0;if(r.markup_pct=i,r.lock_sell_price?r.unit_sell_price=Math.max(0,Z(r.unit_sell_price)):r.unit_sell_price=se(r.unit_cost_net,i),"hotel"===r.service_type){const e=re(r,a);r.hotel_nights=e;const t=function(e,a,t){var l,n,r,i,o,s,c,u,d;const p=re(e,a),m=Math.max(0,Y(null!==(l=e.hotel_rooms)&&void 0!==l?l:0,0)),_="per_night"===e.hotel_pricing_mode?"per_night":"simple",v=e.start_date||a?.start_date||"",g=e.end_date||a?.end_date||"",b=function(e={}){var a,t,l;return{discount_pct:Q(Z(null!==(a=e.discount_pct)&&void 0!==a?a:0),0,50),free_nights_every:Math.max(0,Y(null!==(t=e.free_nights_every)&&void 0!==t?t:0,0))||"",free_nights_count:Math.max(0,Y(null!==(l=e.free_nights_count)&&void 0!==l?l:0,0))||""}}(e.discounts),{freeNights:h,nightsPayable:y}=oe(p,b.free_nights_every,b.free_nights_count),E=e.use_markup?Z(null!==(n=null!==(r=e.markup_pct)&&void 0!==r?r:t)&&void 0!==n?n:0):0,f=e.room_pricing||ie(t),N=(e,a)=>{var t,l,n;const r=f?.[e]||{},i=null!==(t=a.net_price_per_night)&&void 0!==t?t:0,o=null!==(l=a.pvp_price_per_night)&&void 0!==l?l:0,s=void 0!==r.net_price_per_night&&""!==r.net_price_per_night,c=void 0!==r.pvp_price_per_night&&""!==r.pvp_price_per_night,u=void 0!==r.margin_pct&&""!==r.margin_pct,d=void 0!==r.rooms&&""!==r.rooms;return{enabled:"boolean"==typeof r.enabled?r.enabled:a.enabled,rooms:d?Math.max(0,Y(null!==(n=r.rooms)&&void 0!==n?n:0,0)):a.rooms,pricing_basis:r.pricing_basis||a.pricing_basis,net_price_per_night:s?Z(r.net_price_per_night):i,margin_pct:u?Z(r.margin_pct):a.margin_pct,pvp_manual_enabled:"boolean"==typeof r.pvp_manual_enabled?r.pvp_manual_enabled:a.pvp_manual_enabled,pvp_price_per_night:c?Z(r.pvp_price_per_night):o,nights_payable:0,free_nights_applied:0,discount_pct_applied:b.discount_pct,total_net:0,total_pvp:0}},S={enabled:!1,rooms:0,pricing_basis:"per_room",net_price_per_night:0,margin_pct:E,pvp_manual_enabled:!1,pvp_price_per_night:0},C={double:N("double",{enabled:!0,rooms:m>0?m:1,pricing_basis:"per_room",net_price_per_night:null!==(i=e.unit_cost_net)&&void 0!==i?i:0,margin_pct:E,pvp_manual_enabled:!!e.lock_sell_price,pvp_price_per_night:null!==(o=e.unit_sell_price)&&void 0!==o?o:0}),single:N("single",S)},k="per_night"===_?ne(e.nightly_rates||e.hotel_nightly_rates||[],v,g,null!==(s=null!==(c=C.double?.net_price_per_night)&&void 0!==c?c:e.unit_cost_net)&&void 0!==s?s:"",null!==(u=null!==(d=e.markup_pct)&&void 0!==d?d:t)&&void 0!==u?u:0):[],w="per_night"===_?function(e=[],a=0,t=0){const l=(Array.isArray(e)?e:[]).map(e=>{var a,t,l,n;return{date:e?.date,net:Math.max(0,Z(null!==(a=null!==(t=e?.net_price)&&void 0!==t?t:e?.net)&&void 0!==a?a:0)),margin:Math.max(0,Z(null!==(l=null!==(n=e?.margin_pct)&&void 0!==n?n:e?.margin)&&void 0!==l?l:0))}}).filter(e=>!!e.date);if(!l.length)return{netSum:0,pvpSum:0};const n=Math.max(0,Y(a,0)),r=l.map((e,a)=>({idx:a,net:e.net})).sort((e,a)=>e.net-a.net).slice(0,n).map(e=>e.idx),i=new Set(r),o=Q(Z(t),0,50)/100;let s=0,c=0;return l.forEach((e,a)=>{if(i.has(a))return;const t=e.net*(1-o);s+=t,c+=t*(1+e.margin/100)}),{netSum:X(s),pvpSum:X(c)}}(k,h,b.discount_pct):null,x=["double","single"].map(e=>{var a,t,l;const n=C[e];if(!n.enabled)return{totalNet:0,totalPvp:0};const r=Math.max(0,Y(null!==(a=n.rooms)&&void 0!==a?a:0,0)),i="double"===e&&n.pricing_basis||"per_room",o="per_person"===i?2*r:r,s="per_night"===_?Math.max(0,null!==(t=w?.netSum)&&void 0!==t?t:0)*o:Math.max(0,n.net_price_per_night)*y*o*(1-b.discount_pct/100),c=n.pvp_manual_enabled?Math.max(0,n.pvp_price_per_night)*y*o:"per_night"===_?Math.max(0,null!==(l=w?.pvpSum)&&void 0!==l?l:0)*o:s*(1+Math.max(0,n.margin_pct)/100);return C[e]={...n,pricing_basis:i,nights_payable:y,free_nights_applied:h,discount_pct_applied:b.discount_pct,total_net:X(s),total_pvp:X(c)},{totalNet:X(s),totalPvp:X(c)}}),P=x.reduce((e,a)=>e+a.totalNet,0),M=x.reduce((e,a)=>e+a.totalPvp,0),T=["double","single"].filter(e=>C[e].enabled),I=1===T.length?T[0]:"custom",A={...e.giav_pricing,giav_total_net:X(P),giav_total_pvp:e.giav_pricing?.giav_locked?X(Z(e.giav_pricing?.giav_total_pvp)):X(M),giav_source:e.giav_pricing?.giav_locked?"custom":I,giav_locked:!!e.giav_pricing?.giav_locked};return{discounts:b,roomPricing:C,nightlyRates:"per_night"===_?k:null,pricingMode:_,giavPricing:A,totals:{nights:p,nightsPayable:y,freeNights:h,totalNet:X(P),totalPvp:X(M)}}}(r,a,i);r.room_pricing=t.roomPricing,r.discounts=t.discounts,r.giav_pricing=t.giavPricing,r.hotel_pricing_mode=t.pricingMode,"per_night"===t.pricingMode&&(r.nightly_rates=Array.isArray(t.nightlyRates)?t.nightlyRates:[]),r.line_cost_net=t.totals.totalNet,r.line_sell_price=t.giavPricing.giav_total_pvp,r.quantity=1,r.unit_cost_net=t.totals.totalNet,r.unit_sell_price=t.giavPricing.giav_total_pvp}else if("golf"===r.service_type){var o;const e=Math.max(0,Y(null!==(o=a?.players_count)&&void 0!==o?o:0,0)),t=e>0?e:1,{greenFeesPerPerson:l,totalGreenFees:n}=function(e={},a=1){var t,l,n;const r=Math.max(1,Y(a,1));let i=Math.max(0,Y(null!==(t=e.green_fees_per_person)&&void 0!==t?t:0,0)),o=Math.max(0,Y(null!==(l=e.total_green_fees)&&void 0!==l?l:0,0));const s=Math.max(0,Y(null!==(n=e.quantity)&&void 0!==n?n:0,0));return i>0?o=i*r:o>0?(i=Math.max(1,Math.round(o/r)),o=i*r):s>0?(o=s,i=Math.max(1,Math.round(o/r)),o=i*r):(i=1,o=i*r),{greenFeesPerPerson:i,totalGreenFees:o}}(r,t);r.number_of_players=e,r.green_fees_per_person=l,r.total_green_fees=n,r.quantity=n,r.line_cost_net=X(n*r.unit_cost_net),r.line_sell_price=X(n*r.unit_sell_price)}else if("package"===r.service_type){var s,c,u,d,p,m;const e="per_room"===r.package_pricing_basis?"per_room":"per_person",l=Math.max(1,Y(null!==(s=a?.pax_total)&&void 0!==s?s:1,1)),n=Q(Z(null!==(c=r.package_discount_percent)&&void 0!==c?c:0),0,100),o=1-n/100;r.package_discount_percent=n;const k="boolean"==typeof r.package_individual_use_markup?r.package_individual_use_markup:r.use_markup,w=r.package_individual_markup_pct,x=null!=w&&""!==w,P=k?Math.max(0,Z(x?w:null!==(u=null!==(d=r.markup_pct)&&void 0!==d?d:t)&&void 0!==u?u:0)):0;if(r.package_individual_use_markup=k,r.package_individual_markup_pct=P,"per_person"===e){var _;const e=l>0?l:1;r.quantity=Math.max(1,Y(null!==(_=r.quantity)&&void 0!==_?_:e,e))}else r.quantity=Math.max(1,Y(r.quantity,1));const M=Math.max(0,Z(r.unit_cost_net)),T=X(M*o);r.unit_cost_net=T;const I=e=>se(e,i),A=e=>se(e,P);let B;B=r.lock_sell_price?X(Math.max(0,Z(r.unit_sell_price))*o):I(T),r.unit_sell_price=B,r.line_cost_net=X(r.quantity*r.unit_cost_net),r.line_sell_price=X(r.quantity*r.unit_sell_price),r.package_pp_double="per_person"===e?B:r.package_pp_double,r.package_room_double="per_room"===e?B:r.package_room_double;const R=!!r.package_quote_individual||"per_room"===e&&!!r.package_quote_single_rooms,D="supplement"===(r.package_individual_mode||("per_room"===e?r.package_single_room_mode:"")||"absolute")?"supplement":"absolute",$="per_person"===e?null!==(p=r.package_individual_qty)&&void 0!==p?p:r.package_individual_count:null!==(m=r.package_individual_qty)&&void 0!==m?m:r.package_single_rooms,q=Math.max(0,Y(null!=$?$:0,0));if(r.package_individual_qty=q,r.package_individual_count="per_person"===e?q:r.package_individual_count,r.package_single_rooms="per_room"===e?q:r.package_single_rooms,r.package_quote_individual=R,"per_room"===e&&(r.package_quote_single_rooms=R),r.package_individual_mode=D,"per_room"===e&&(r.package_single_room_mode=D),R){var v,g,b,h,y,E,f,N,S,C;const a="per_room"===e,t=Math.max(0,Z(a?null!==(v=r.package_single_room_supplement_net)&&void 0!==v?v:0:null!==(g=r.package_single_supplement_net)&&void 0!==g?g:0)),l=Math.max(0,Z(a?null!==(b=r.package_single_room_supplement_sell)&&void 0!==b?b:0:null!==(h=r.package_single_supplement_sell)&&void 0!==h?h:0)),n=Z(a?null!==(y=r.unit_cost_net_single_room)&&void 0!==y?y:"":null!==(E=null!==(f=r.package_unit_cost_net_individual)&&void 0!==f?f:r.unit_cost_net_individual)&&void 0!==E?E:""),i=Math.max(0,Z(a?null!==(N=r.unit_sell_price_single_room)&&void 0!==N?N:0:null!==(S=null!==(C=r.package_unit_sell_price_individual)&&void 0!==C?C:r.unit_sell_price_individual)&&void 0!==S?S:0));if("supplement"===D){const e=X(t*o),n=X(T+e);let s;s=r.lock_sell_price?l>0?X(B+X(l*o)):i>0?X(i*o):B:A(n),r.package_single_supplement=X(s-B),r.package_single_supplement_net=t,r.package_single_supplement_pvp=X(Math.max(0,s-B)),a?(r.package_room_single_supplement=X(s-B),r.package_room_single=s,r.unit_sell_price_single_room=s):(r.package_pp_single=s,r.unit_sell_price_individual=s)}else{const e=""===n||Number.isNaN(n)?M:Math.max(0,n),t=X(e*o);let l;l=r.lock_sell_price?i>0?X(i*o):B:A(t),r.package_unit_cost_net_individual=e,r.package_unit_sell_price_individual=l,a?(r.unit_cost_net_single_room=e,r.package_room_single=l,r.package_room_single_supplement=X(Math.max(0,l-B)),r.unit_sell_price_single_room=l):(r.unit_cost_net_individual=e,r.package_pp_single=l,r.package_single_supplement=X(Math.max(0,l-B)),r.unit_sell_price_individual=l)}}}else r.line_cost_net=X(r.quantity*r.unit_cost_net),r.line_sell_price=X(r.quantity*r.unit_sell_price);return r}function de({item:e,idx:t,updateItem:n,currency:r,pax:i,basics:o,globalMarkupPct:s}){var c,u,d,p,m,_,v;const g=e.room_pricing||ie(s),b=ie(s),h=e=>g[e]||b[e],y=Math.max(0,Y(null!==(c=h("double").rooms)&&void 0!==c?c:0,0)),E=Math.max(0,Y(null!==(u=h("single").rooms)&&void 0!==u?u:0,0)),f=(h("double").enabled?2*y:0)+(h("single").enabled?E:0),N=f-i,S=!!e.hotel_informative_quote,C=N<0?`Faltan ${Math.abs(N)} pax por asignar a habitaciones`:N>0?`Sobran ${N} pax asignados`:"",k=Math.max(0,Y(null!==(d=e.hotel_nights)&&void 0!==d?d:re(e,o),0)),{nightsPayable:w}=oe(k,e.discounts?.free_nights_every,e.discounts?.free_nights_count),x=function(e={}){var a,t,l;const n=Math.max(0,Z(null!==(a=e.discount_pct)&&void 0!==a?a:0)),r=Math.max(0,Y(null!==(t=e.free_nights_every)&&void 0!==t?t:0,0)),i=Math.max(0,Y(null!==(l=e.free_nights_count)&&void 0!==l?l:0,0)),o=[];return n>0&&o.push(`-${X(n)}%`),r>0&&i>0&&o.push(`+${i} gratis cada ${r}`),o.length>0?o.join(" "):"Sin descuentos"}(e.discounts),P=e.notes_public||e.notes_internal?"Ver notas":"Sin notas",M="per_night"==("per_night"===e.hotel_pricing_mode?"per_night":"simple"),T=e.start_date||o?.start_date||"",I=e.end_date||o?.end_date||"",A=(a={})=>{var t,l,n,r,i,o,c,u;const d=Array.isArray(e.nightly_rates)&&e.nightly_rates.length?e.nightly_rates[0]:null,p=null!==(t=null!==(l=null!==(n=null!==(r=a.fallbackNet)&&void 0!==r?r:d?.net_price)&&void 0!==n?n:h("double").net_price_per_night)&&void 0!==l?l:e.unit_cost_net&&k>0?X(Z(e.unit_cost_net)/k):"")&&void 0!==t?t:"",m=null!==(i=null!==(o=a.fallbackMargin)&&void 0!==o?o:d?.margin_pct)&&void 0!==i?i:null!==(c=null!==(u=e.markup_pct)&&void 0!==u?u:s)&&void 0!==c?c:0;return ne(e.nightly_rates,T,I,p,m)},B=(e,a)=>{const l=A().map((t,l)=>l===e?{...t,...a}:t);n(t,{nightly_rates:l})},R=(a,l)=>{const r=e.room_pricing||{},i={...r[a]||{},...l},o={...r,[a]:i};n(t,{room_pricing:o})},D=(a,l)=>{const r=e.discounts||{};n(t,{discounts:{...r,[a]:l}})};return(0,a.createElement)("div",{className:"service-card__hotel-panel"},(0,a.createElement)("div",{className:"service-card__subcard service-card__subcard--nightly"},(0,a.createElement)("div",{className:"service-card__hotel-nightly-toggle"},(0,a.createElement)(l.ToggleControl,{label:"Precio variable por noche",checked:M,onChange:()=>{if(!M){const e=A();return void n(t,{hotel_pricing_mode:"per_night",nightly_rates:e})}n(t,{hotel_pricing_mode:"simple"})}}),M&&(0,a.createElement)("div",{className:"service-card__hotel-nightly-hint"},'El neto y margen se definen por fecha. Los campos "Neto por noche" y "Margen" del modo de habitación se ignoran (salvo PVP manual).')),M&&(0,a.createElement)("details",{className:"service-card__hotel-nightly",open:!0},(0,a.createElement)("summary",{className:"service-card__section-summary"},(0,a.createElement)("span",{className:"service-card__section-summary-title"},"Desglose por noche"),(0,a.createElement)("span",{className:"service-card__section-summary-meta"},te(T,I)," noches")),(0,a.createElement)("div",{className:"service-card__hotel-nightly-table"},(0,a.createElement)("div",{className:"service-card__hotel-nightly-row service-card__hotel-nightly-row--head"},(0,a.createElement)("div",null,"Fecha"),(0,a.createElement)("div",null,"Neto"),(0,a.createElement)("div",null,"Margen (%)")),A().map((e,t)=>{var n,r;return(0,a.createElement)("div",{key:e.date||t,className:"service-card__hotel-nightly-row"},(0,a.createElement)("div",{className:"service-card__hotel-nightly-date"},e.date),(0,a.createElement)(l.TextControl,{value:String(null!==(n=e.net_price)&&void 0!==n?n:""),onChange:e=>B(t,{net_price:e}),placeholder:"120"}),(0,a.createElement)(l.TextControl,{type:"number",min:0,value:String(null!==(r=e.margin_pct)&&void 0!==r?r:""),onChange:e=>B(t,{margin_pct:e}),placeholder:"20"}))})))),(0,a.createElement)("div",{className:"service-card__hotel-occupancy"},["double","single"].map(e=>{var t,n,i,o;const c="double"===e?"Doble":"Individual",u=h(e);return(0,a.createElement)("div",{key:e,className:"service-card__hotel-occupancy-card"},(0,a.createElement)("div",{className:"service-card__hotel-occupancy-header"},(0,a.createElement)(l.ToggleControl,{label:`Cotizar ${c.toLowerCase()}`,checked:!!u.enabled,onChange:()=>R(e,{enabled:!u.enabled})}),(0,a.createElement)("span",{className:"service-card__hotel-occupancy-label"},c)),u.enabled&&(0,a.createElement)("div",{className:"service-card__hotel-occupancy-body"},(0,a.createElement)(l.TextControl,{label:`Habitaciones ${c.toLowerCase()}`,type:"number",min:1,value:String(null!==(t=u.rooms)&&void 0!==t?t:""),onChange:a=>R(e,{rooms:a})}),"double"===e&&(0,a.createElement)(l.SelectControl,{label:"Precio",value:u.pricing_basis||"per_room",options:[{label:"Por habitación",value:"per_room"},{label:"Por persona",value:"per_person"}],onChange:e=>R("double",{pricing_basis:e})}),(0,a.createElement)(l.TextControl,{label:`Neto por noche (${c.toLowerCase()})`,value:String(null!==(n=u.net_price_per_night)&&void 0!==n?n:""),onChange:a=>R(e,{net_price_per_night:a}),placeholder:"120",disabled:M}),(0,a.createElement)("details",{className:"service-card__hotel-mode-details"},(0,a.createElement)("summary",null,"Margen y PVP"),(0,a.createElement)("div",{className:"service-card__hotel-mode-details-grid"},(0,a.createElement)(l.ToggleControl,{label:"PVP manual",checked:!!u.pvp_manual_enabled,onChange:()=>R(e,{pvp_manual_enabled:!u.pvp_manual_enabled})}),u.pvp_manual_enabled?(0,a.createElement)(l.TextControl,{label:`PVP por noche (${c.toLowerCase()})`,value:String(null!==(i=u.pvp_price_per_night)&&void 0!==i?i:""),onChange:a=>R(e,{pvp_price_per_night:a}),placeholder:"165"}):(0,a.createElement)(l.TextControl,{label:M?"Margen (%) (se ignora)":"Margen (%)",type:"number",min:0,value:String(null!==(o=u.margin_pct)&&void 0!==o?o:s),onChange:a=>R(e,{margin_pct:a}),disabled:M}))),(0,a.createElement)("div",{className:"service-card__hotel-total"},"Total hab. ",c.toLowerCase(),": ",r," ",X(u.total_pvp||0).toFixed(2))))})),(0,a.createElement)("div",{className:"service-card__hotel-allocation"},(0,a.createElement)("div",{className:"service-card__hotel-allocation-text"},"Personas asignadas: ",f," de ",i),C&&(0,a.createElement)(l.Notice,{status:S&&N>0?"info":"warning",isDismissible:!1},C),(0,a.createElement)(l.ToggleControl,{label:"Cotización informativa (permitir habitaciones extra)",checked:S,onChange:e=>n(t,{hotel_informative_quote:!!e}),help:"Actívalo si estás cotizando una habitación adicional solo a efectos informativos (no bloquea si sobran pax asignados)."})),(0,a.createElement)("div",{className:"service-card__subcard"},(0,a.createElement)("details",{className:"service-card__hotel-discounts-collapse"},(0,a.createElement)("summary",{className:"service-card__section-summary"},(0,a.createElement)("span",{className:"service-card__section-summary-title"},"Descuentos"),(0,a.createElement)("span",{className:"service-card__section-summary-meta"},x)),(0,a.createElement)("div",{className:"service-card__hotel-discounts"},(0,a.createElement)("div",{className:"service-card__hotel-discounts-grid"},(0,a.createElement)(l.TextControl,{label:"Descuento (%)",type:"number",min:0,max:50,value:String(null!==(p=e.discounts?.discount_pct)&&void 0!==p?p:0),onChange:e=>D("discount_pct",e)}),(0,a.createElement)(l.TextControl,{label:"Noches gratis (cada)",type:"number",min:0,value:String(null!==(m=e.discounts?.free_nights_every)&&void 0!==m?m:""),onChange:e=>D("free_nights_every",e)}),(0,a.createElement)(l.TextControl,{label:"Noches gratis (cantidad)",type:"number",min:0,value:String(null!==(_=e.discounts?.free_nights_count)&&void 0!==_?_:""),onChange:e=>D("free_nights_count",e)})),k>0&&(0,a.createElement)("div",{className:"service-card__hotel-discount-summary"},"Se cobran ",w," noches de ",k)))),(0,a.createElement)("div",{className:"service-card__subcard service-card__subcard--giav"},(0,a.createElement)("div",{className:"service-card__hotel-giav"},(0,a.createElement)("div",{className:"service-card__hotel-subtitle"},"Total para GIAV"),(0,a.createElement)("div",{className:"service-card__hotel-giav-grid"},(0,a.createElement)("div",{className:"service-card__hotel-giav-total"},(0,a.createElement)("div",{className:"service-card__hotel-giav-label"},"Total alojamiento (para GIAV)"),(0,a.createElement)("div",{className:"service-card__hotel-giav-value"},r," ",X(e.giav_pricing?.giav_total_pvp||0).toFixed(2))),(0,a.createElement)(l.ToggleControl,{label:"Editar total para GIAV",checked:!!e.giav_pricing?.giav_locked,onChange:()=>{const a=e.giav_pricing||{};n(t,{giav_pricing:{...a,giav_locked:!a.giav_locked}})}}),(0,a.createElement)(l.TextControl,{label:"Total editable",value:String(null!==(v=e.giav_pricing?.giav_total_pvp)&&void 0!==v?v:""),onChange:a=>(a=>{const l=e.giav_pricing||{};n(t,{giav_pricing:{...l,giav_total_pvp:a}})})(a),disabled:!e.giav_pricing?.giav_locked}),e.giav_pricing?.giav_locked&&(0,a.createElement)(l.Notice,{status:S&&N>0?"info":"warning",isDismissible:!1},"Este total se enviará a GIAV. No se recalculará automáticamente.")))),(0,a.createElement)("div",{className:"service-card__subcard"},(0,a.createElement)("details",{className:"service-card__hotel-notes"},(0,a.createElement)("summary",{className:"service-card__section-summary"},(0,a.createElement)("span",{className:"service-card__section-summary-title"},"Notas"),(0,a.createElement)("span",{className:"service-card__section-summary-meta"},P)),(0,a.createElement)("div",{className:"service-card__hotel-notes-grid"},(0,a.createElement)(l.TextControl,{label:"Notas para el cliente (itinerario)",value:e.notes_public||"",onChange:e=>n(t,{notes_public:e}),placeholder:"Incluye desayuno. Check-in 15:00."}),(0,a.createElement)(l.TextControl,{label:"Notas internas (solo uso interno)",value:e.notes_internal||"",onChange:e=>n(t,{notes_internal:e}),placeholder:"Neto negociado, release 14D."})))))}function pe(e=[],a={}){if(!Array.isArray(e)||!e.length)return e;const t=a?.start_date||"",l=a?.end_date||"";let n=!1;const r=e.map(e=>{if(!e||!e.dates_inherited)return e;if(e.start_date===t&&e.end_date===l)return e;n=!0;const a={...e,start_date:t,end_date:l,dates_inherited:!0};if("hotel"===a.service_type&&"per_night"===a.hotel_pricing_mode){var r,i,o;const e=Array.isArray(a.nightly_rates)&&a.nightly_rates.length?a.nightly_rates[0]:null,n=null!==(r=e?.net_price)&&void 0!==r?r:"",s=null!==(i=e?.margin_pct)&&void 0!==i?i:null!==(o=a.markup_pct)&&void 0!==o?o:0;a.nightly_rates=ne(a.nightly_rates,t,l,n,s)}return a});return n?r:e}function me({item:e,idx:t,updateItem:n,currency:r,pax:i,globalMarkupPct:o}){var s,c,u,d,p,m,_,v,g,b,h,y,E,f,N,S,C,k,w,x,P,M,T;const I="per_person"===e.package_pricing_basis?"per_person":"per_room",A=Q(Z(null!==(s=e.package_discount_percent)&&void 0!==s?s:0),0,100),B=function(e=0){const a=Q(Z(e),0,100);return a>0?`-${X(a)}%`:"Sin descuentos"}(A),R=!!e.lock_sell_price,D="boolean"==typeof e.package_individual_use_markup?e.package_individual_use_markup:e.use_markup,$=null!==(c=null!==(u=e.package_individual_markup_pct)&&void 0!==u?u:e.markup_pct)&&void 0!==c?c:o,q=!!e.package_quote_individual||"per_room"===I&&!!e.package_quote_single_rooms,G="per_room"===I?"supplement"===e.package_single_room_mode?"supplement":"absolute":"supplement"===e.package_individual_mode?"supplement":"absolute",F="per_person"===I?null!==(d=null!==(p=e.package_individual_qty)&&void 0!==p?p:e.package_individual_count)&&void 0!==d?d:0:null!==(m=null!==(_=e.package_individual_qty)&&void 0!==_?_:e.package_single_rooms)&&void 0!==m?m:0;return(0,a.createElement)("div",{className:"service-card__hotel-panel service-card__package-panel"},(0,a.createElement)("div",{className:"service-card__hotel-occupancy"},(0,a.createElement)("div",{className:"service-card__hotel-occupancy-card"},(0,a.createElement)("div",{className:"service-card__hotel-occupancy-header"},(0,a.createElement)("span",{className:"service-card__hotel-occupancy-label"},"Doble")),(0,a.createElement)("div",{className:"service-card__hotel-occupancy-body"},(0,a.createElement)(l.SelectControl,{label:"Precio del paquete",value:I,options:[{label:"Por habitación/paquete",value:"per_room"},{label:"Por persona (en doble)",value:"per_person"}],onChange:e=>{const a="per_person"===e?"per_person":"per_room",l={package_pricing_basis:a};"per_person"===a&&(l.quantity=i),n(t,l)}}),(0,a.createElement)(l.TextControl,{label:"per_person"===I?(0,L.__)("Personas en doble","wp-travel-giav"):"Cantidad (habitaciones/paquetes)",type:"number",min:1,value:String(null!==(v=e.quantity)&&void 0!==v?v:1),onChange:e=>n(t,{quantity:e}),help:"per_person"===I?`${(0,L.__)("Pax total:","wp-travel-giav")} ${i}`:""}),(0,a.createElement)(l.TextControl,{label:"per_person"===I?"Coste neto (por persona en doble)":"Coste neto (hab./paquete doble)",value:String(null!==(g=e.unit_cost_net)&&void 0!==g?g:""),onChange:e=>n(t,{unit_cost_net:e}),placeholder:"120"}),(0,a.createElement)("details",{className:"service-card__hotel-mode-details"},(0,a.createElement)("summary",null,"Margen y PVP"),(0,a.createElement)("div",{className:"service-card__hotel-mode-details-grid"},(0,a.createElement)(l.ToggleControl,{label:"Usar margen",checked:!!e.use_markup,onChange:()=>n(t,{use_markup:!e.use_markup})}),e.use_markup&&(0,a.createElement)(l.TextControl,{label:"Margen (%)",type:"number",min:0,value:String(null!==(b=e.markup_pct)&&void 0!==b?b:o),onChange:e=>n(t,{markup_pct:e})}),(0,a.createElement)(l.ToggleControl,{label:"PVP manual",checked:!!e.lock_sell_price,onChange:()=>n(t,{lock_sell_price:!e.lock_sell_price})}),(0,a.createElement)(l.TextControl,{label:"per_person"===I?"PVP (por persona en doble)":"PVP (hab./paquete doble)",value:String(null!==(h=e.unit_sell_price)&&void 0!==h?h:""),onChange:e=>n(t,{unit_sell_price:e}),placeholder:"165",disabled:!e.lock_sell_price,help:A>0?`Descuento aplicado: -${A}%`:""}))))),(0,a.createElement)("div",{className:"service-card__hotel-occupancy-card"},(0,a.createElement)("div",{className:"service-card__hotel-occupancy-header"},(0,a.createElement)(l.ToggleControl,{label:(0,L.__)("Cotizar individual (informativo)","wp-travel-giav"),checked:q,onChange:()=>{const e=!q,a={package_quote_individual:e};"per_room"===I&&(a.package_quote_single_rooms=e),n(t,a)}}),(0,a.createElement)("span",{className:"service-card__hotel-occupancy-label"},"Individual")),q&&(0,a.createElement)("div",{className:"service-card__hotel-occupancy-body"},(0,a.createElement)(l.TextControl,{label:"per_person"===I?"Personas en individual":"Habitaciones individuales",type:"number",min:0,value:String(null!=F?F:0),onChange:e=>{const a={package_individual_qty:e};"per_person"===I?a.package_individual_count=e:a.package_single_rooms=e,n(t,a)}}),(0,a.createElement)(l.SelectControl,{label:"Modo",value:G,options:[{label:"Precio absoluto",value:"absolute"},{label:"Suplemento sobre doble",value:"supplement"}],onChange:e=>{const a={package_individual_mode:e};"per_room"===I&&(a.package_single_room_mode=e),n(t,a)}}),"supplement"!==G?(0,a.createElement)(l.TextControl,{label:"per_person"===I?"Coste neto (indiv. por persona)":"Coste neto (hab. indiv.)",value:String("per_person"===I?null!==(y=null!==(E=e.package_unit_cost_net_individual)&&void 0!==E?E:e.unit_cost_net_individual)&&void 0!==y?y:"":null!==(f=e.unit_cost_net_single_room)&&void 0!==f?f:""),onChange:e=>n(t,{..."per_person"===I?{package_unit_cost_net_individual:e,unit_cost_net_individual:e}:{unit_cost_net_single_room:e}}),placeholder:"150"}):(0,a.createElement)(l.TextControl,{label:"per_person"===I?"Suplemento neto (por persona)":"Suplemento neto (hab. indiv.)",value:String("per_person"===I?null!==(N=e.package_single_supplement_net)&&void 0!==N?N:"":null!==(S=e.package_single_room_supplement_net)&&void 0!==S?S:""),onChange:e=>n(t,{..."per_person"===I?{package_single_supplement_net:e}:{package_single_room_supplement_net:e}}),placeholder:"30"}),(0,a.createElement)("details",{className:"service-card__hotel-mode-details"},(0,a.createElement)("summary",null,"Margen y PVP"),(0,a.createElement)("div",{className:"service-card__hotel-mode-details-grid"},(0,a.createElement)(l.ToggleControl,{label:"Usar margen",checked:!!D,onChange:()=>n(t,{package_individual_use_markup:!D})}),D&&(0,a.createElement)(l.TextControl,{label:"Margen (%)",type:"number",min:0,value:String($),onChange:e=>n(t,{package_individual_markup_pct:e})}),(0,a.createElement)(l.ToggleControl,{label:"PVP manual",checked:!!e.lock_sell_price,onChange:()=>n(t,{lock_sell_price:!e.lock_sell_price})}),"supplement"!==G?(0,a.createElement)(l.TextControl,{label:"per_person"===I?"PVP (indiv. por persona)":"PVP (hab. indiv.)",value:String("per_person"===I?null!==(C=null!==(k=e.package_unit_sell_price_individual)&&void 0!==k?k:e.unit_sell_price_individual)&&void 0!==C?C:"":null!==(w=e.unit_sell_price_single_room)&&void 0!==w?w:""),onChange:e=>n(t,{..."per_person"===I?{package_unit_sell_price_individual:e,unit_sell_price_individual:e}:{unit_sell_price_single_room:e}}),placeholder:"210",disabled:!R}):(0,a.createElement)(l.TextControl,{label:"per_person"===I?"Suplemento PVP (por persona)":"Suplemento PVP (hab. indiv.)",value:String("per_person"===I?null!==(x=null!==(P=e.package_single_supplement_pvp)&&void 0!==P?P:e.package_single_supplement_sell)&&void 0!==x?x:"":null!==(M=e.package_single_room_supplement_sell)&&void 0!==M?M:""),onChange:e=>n(t,{..."per_person"===I?{package_single_supplement_pvp:e,package_single_supplement_sell:e}:{package_single_room_supplement_sell:e}}),placeholder:"45",disabled:!R})))))),(0,a.createElement)("div",{className:"service-card__subcard"},(0,a.createElement)("details",{className:"service-card__hotel-discounts-collapse"},(0,a.createElement)("summary",{className:"service-card__section-summary"},(0,a.createElement)("span",{className:"service-card__section-summary-title"},"Descuentos"),(0,a.createElement)("span",{className:"service-card__section-summary-meta"},B)),(0,a.createElement)("div",{className:"service-card__hotel-discounts"},(0,a.createElement)("div",{className:"service-card__hotel-discounts-grid"},(0,a.createElement)(l.TextControl,{label:"Descuento (%)",type:"number",min:0,max:100,value:String(null!==(T=e.package_discount_percent)&&void 0!==T?T:0),onChange:e=>n(t,{package_discount_percent:e})}))))))}function _e({proposalId:e,basics:n,initialItems:r=[],onBack:i,onNext:o,onDraftChange:s,requestIntentions:c=null}){var d,p,m,_,v,g,b,h,E,f;const N=n?.currency||"EUR",S=Math.max(1,Y(null!==(d=n?.pax_total)&&void 0!==d?d:1,1)),C=Math.max(0,Y(null!==(p=n?.players_count)&&void 0!==p?p:0,0)),[k,w]=(0,t.useState)(20),[x,P]=(0,t.useState)(!0),[M,T]=(0,t.useState)(""),[A,B]=(0,t.useState)(""),[R,D]=(0,t.useState)(!1),[$,q]=(0,t.useState)(null),[G,F]=(0,t.useState)(null),[V,U]=(0,t.useState)(0),[L,Q]=(0,t.useState)(null),[ie,oe]=(0,t.useState)(!1),[se,_e]=(0,t.useState)([]),ve=(0,t.useRef)(null),[ge,be]=(0,t.useState)(()=>(r.length?r:[ce(n,20)]).map(e=>{const a={...e},t="boolean"==typeof a.dates_inherited,l=a.start_date||n?.start_date||"",r=a.end_date||n?.end_date||"";return a.start_date||(a.start_date=l),a.end_date||(a.end_date=r),a.dates_inherited=t?a.dates_inherited:l===(n?.start_date||"")&&r===(n?.end_date||""),ue(a,n,20)})),he=(0,t.useMemo)(()=>function(e){const a=e.reduce((e,a)=>(e.cost+=a.line_cost_net||0,e.sell+=a.line_sell_price||0,e),{cost:0,sell:0}),t=Math.ceil(X(a.sell)),l=X(t-a.cost),n=t>0?X(l/t*100):0;return{totals_cost_net:X(a.cost),totals_sell_price:t,totals_margin_abs:l,totals_margin_pct:n}}(ge),[ge]),ye=(0,t.useMemo)(()=>function(e,a){var t,l,n,r,i;if(!e)return e;const o=Math.max(0,Y(null!==(t=a?.pax_total)&&void 0!==t?t:0,0)),s=Y(null!==(l=null!==(n=a?.players_count)&&void 0!==n?n:o)&&void 0!==l?l:0,0),c=Math.min(Math.max(s,0),o),u=Math.max(0,o-c),d=c>0&&u>0?ee(c,u):Math.max(c,u);if(!d||d<=1)return e;const p=Math.max(0,Z(null!==(r=e.totals_sell_price)&&void 0!==r?r:0)),m=ae(Math.round(p),d);if(m===p)return e;const _=X(m-Math.max(0,Z(null!==(i=e.totals_cost_net)&&void 0!==i?i:0))),v=m>0?X(_/m*100):0;return{...e,totals_sell_price:m,totals_margin_abs:_,totals_margin_pct:v}}(he,n),[he,n]);(0,t.useEffect)(()=>{if(!s)return;const e=window.setTimeout(()=>{s({items:ge,totals:ye})},200);return()=>window.clearTimeout(e)},[ge,ye,s]);const Ee=(0,t.useMemo)(()=>{var e,a,t;const l=Math.max(0,Y(null!==(e=n?.pax_total)&&void 0!==e?e:0,0)),r=Y(null!==(a=null!==(t=n?.players_count)&&void 0!==t?t:l)&&void 0!==a?a:0,0),i=Math.min(Math.max(r,0),l),o={paxTotal:l,playersCount:i,nonPlayersCount:Math.max(0,l-i),golfTotal:0,totalDouble:0,totalSingle:0,doubleRooms:0,singleRooms:0};ge.forEach(e=>{if("golf"===e.service_type&&(o.golfTotal+=Z(e.line_sell_price||0)),"hotel"===e.service_type){const l=e.room_pricing||{};var a,t;l.double?.enabled&&(o.totalDouble+=Z(l.double?.total_pvp||0),o.doubleRooms+=Math.max(0,Y(null!==(a=l.double?.rooms)&&void 0!==a?a:0,0))),l.single?.enabled&&(o.totalSingle+=Z(l.single?.total_pvp||0),o.singleRooms+=Math.max(0,Y(null!==(t=l.single?.rooms)&&void 0!==t?t:0,0)))}});const s=Z(ye.totals_sell_price||0),c=s,u=o.doubleRooms>0?o.totalDouble/(2*o.doubleRooms):0,d=o.singleRooms>0?o.totalSingle/o.singleRooms:0,p=o.totalDouble||0,m=o.totalSingle||0,_=o.golfTotal||0,v=s-(p+m)-_,g=u+(o.paxTotal>0?v/o.paxTotal:0),b=o.playersCount>0?g+_/o.playersCount:null,h=o.doubleRooms>0&&o.singleRooms>0;let y=null;h&&(y=Math.max(0,d-u));const E=h&&null!==y?Math.round(y):null,f=function({totalTrip:e,playersCount:a,nonPlayersCount:t,pricePlayerRaw:l,priceNonPlayerRaw:n}){const r=Math.max(0,Math.round(e||0)),i=Math.max(0,Y(a,0)),o=Math.max(0,Y(t,0));if(i<=0&&o<=0)return{totalTrip:r,pricePlayer:null,priceNonPlayer:null};const s=ae(r,i>0&&o>0?ee(i,o):Math.max(i,o));if(i>0&&o>0){const e=Math.max(0,Math.round(n||0));let a=null,t=null;const r=Math.max(i+o,10);for(let c=0;c<=r;c+=1){const r=[e+c,e-c];for(const e of r){if(e<0)continue;const r=s-o*e;if(r<0)continue;if(r%i!==0)continue;const c=r/i,u=Math.abs(e-(n||0))+Math.abs(c-(null!=l?l:c));(null===t||u<t)&&(t=u,a={priceNonPlayer:e,pricePlayer:c})}if(0===t)break}if(a)return{totalTrip:s,...a};const c=Math.max(0,e),u=i>0?Math.max(0,Math.round((s-o*c)/i)):null;return{totalTrip:i>0?i*u+o*c:s,pricePlayer:u,priceNonPlayer:c}}return i>0?{totalTrip:s,pricePlayer:s/i,priceNonPlayer:null}:{totalTrip:s,pricePlayer:null,priceNonPlayer:o>0?s/o:null}}({totalTrip:s,playersCount:o.playersCount,nonPlayersCount:o.nonPlayersCount,pricePlayerRaw:b,priceNonPlayerRaw:g});return{...o,totalTrip:s,baseTotal:c,priceNonPlayerDouble:g,pricePlayerDouble:b,supplementSingle:y,hasSingleSupplement:h,displaySupplementSingle:E,displayTotalTrip:f.totalTrip,displayPricePlayer:f.pricePlayer,displayPriceNonPlayer:f.priceNonPlayer}},[n?.pax_total,n?.players_count,ge,ye.totals_sell_price]);(0,t.useEffect)(()=>{be(e=>{const a=pe(e,n);return a===e?e:a.map((a,t)=>a===e[t]?a:ue(a,n,k))})},[n?.start_date,n?.end_date,k,n]),(0,t.useEffect)(()=>{be(e=>e.map(e=>ue(e,n,k)))},[S]),(0,t.useEffect)(()=>{null!=V&&V>=ge.length&&U(ge.length?ge.length-1:null)},[ge.length,V]),(0,t.useEffect)(()=>{if(null==L)return;const e=document.querySelector(`[data-service-index="${L}"]`);if(!e)return;e.scrollIntoView({behavior:"smooth",block:"start"}),((e,a)=>{if(!e)return;if(!a?.service_type){const a=e.querySelector("select");if(a&&"function"==typeof a.focus)return void a.focus()}const t=e.querySelector(".service-card__grid--context input");t&&"function"==typeof t.focus?t.focus():xe(e)})(e,ge[L]),F(L);const a=window.setTimeout(()=>F(null),1200);return Q(null),()=>window.clearTimeout(a)},[L,ge]);const fe=(e,a)=>{be(t=>{const l=[...t],r={...l[e],...a};return l[e]=ue(r,n,k),l})},Ne=(0,t.useMemo)(()=>ge.map((e,a)=>(e=>{const a=[],t={};if((e.title||e.display_name||"").trim()||(a.push("Falta título"),t.title="Completa el título."),"hotel"!==e.service_type&&"golf"!==e.service_type||e.giav_supplier_id||(a.push("Falta proveedor"),t.supplier="Selecciona un proveedor."),"hotel"===e.service_type){var l,r,i;const c=e.room_pricing||{},u="per_night"===e.hotel_pricing_mode,d=!!c.double?.enabled,p=!!c.single?.enabled;d||p||(a.push("Activa doble/individual"),t.pricing="Activa doble y/o individual.");const m=(e,a)=>{var t;const l=c[e]||{};return l.enabled?Y(null!==(t=l.rooms)&&void 0!==t?t:0,0)<1?`Habitaciones ${a} < 1`:!u&&Z(l.net_price_per_night)<=0?`Neto ${a} faltante`:l.pvp_manual_enabled&&Z(l.pvp_price_per_night)<=0?`PVP manual ${a} faltante`:"":""};if(u){var o,s;const l=e.start_date||n?.start_date||"",r=e.end_date||n?.end_date||"",i=te(l,r),c=ne(e.nightly_rates||[],l,r,"",null!==(o=null!==(s=e.markup_pct)&&void 0!==s?s:k)&&void 0!==o?o:0);i<=0?(a.push("Fechas hotel inválidas"),t.pricing="Revisa fechas de hotel."):c.length&&c.length===i?c.some(e=>Z(e.net_price)<=0)&&(a.push("Neto por noche faltante"),t.pricing="Completa neto en todas las noches."):(a.push("Faltan noches"),t.pricing="Completa el desglose por noche.")}const _=m("double","doble"),v=m("single","individual");(_||v)&&(a.push(_||v),t.pricing="Revisa pricing de habitaciones.");const g=d?Math.max(0,Y(null!==(l=c.double?.rooms)&&void 0!==l?l:0,0)):0,b=p?Math.max(0,Y(null!==(r=c.single?.rooms)&&void 0!==r?r:0,0)):0,h=(d?2*g:0)+(p?b:0),y=!!e.hotel_informative_quote;h<S?(a.push("Faltan pax"),t.pricing="Ajusta pax doble/individual."):h>S&&!y&&(a.push("Pax no cuadra"),t.pricing="Ajusta pax doble/individual."),Z(null!==(i=e.giav_pricing?.giav_total_pvp)&&void 0!==i?i:0)<=0&&(a.push("Total GIAV faltante"),t.pricing="Completa total GIAV.")}"golf"===e.service_type&&Y(e.green_fees_per_person,1)<1&&(a.push("Green-fees faltante"),t.greenFees="Define green-fees por jugador."),["transfer","extra","package"].includes(e.service_type)&&Y(e.quantity,1)<1&&(a.push("Cantidad inválida"),t.quantity="Cantidad debe ser >= 1."),Z(e.unit_sell_price)<=0&&(a.push("PVP unitario faltante"),t.unitSell="Define PVP unitario.");const c=("hotel"===e.service_type||"golf"===e.service_type)&&["needs_review","missing"].includes(e.giav_mapping_status);return{issues:a,fieldErrors:t,status:a.length>0?"error":c?"pending":"completed",hasMappingWarning:c}})(e)),[ge,S]),Se=e=>{U(e),q(e),window.setTimeout(()=>{const a=document.querySelector(`[data-service-index="${e}"]`);a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),xe(a))},50)},Ce=e=>{fe(e,{show_supplier_picker:!ge[e].show_supplier_picker})},ke=e=>!!e.show_supplier_picker,we=()=>{const e=[],a=[];return Ne.forEach((e,t)=>{e.issues.length>0&&a.push({index:t,title:`Servicio ${t+1}`,details:e.issues.slice(0,2).join(" · ")})}),ge.some(e=>"golf"===e.service_type)&&C<=0&&e.push('Define "Jugadores" en Datos básicos.'),ye.totals_sell_price<=0&&e.push("El PVP total debe ser > 0."),{errors:e,serviceErrors:a}},xe=e=>{if(!e)return;const a=e.querySelector("input, select, textarea, button");a&&"function"==typeof a.focus&&a.focus()},Pe=(0,t.useMemo)(()=>we(),[Ne,ge,C,ye.totals_sell_price]),Me=Pe.serviceErrors.length>0||Pe.errors.length>0,Te=(e,{missing:t,tooltip:l}={})=>t?(0,a.createElement)("span",{className:"services-summary__value services-summary__value--missing",title:l},"—"):(0,a.createElement)("span",{className:"services-summary__value"},e);return(0,t.useEffect)(()=>{ie&&(Me||(T(""),_e([])))},[ie,Me]),(0,a.createElement)(l.Card,{className:"services-step"},(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"services-step__title"},(0,a.createElement)("strong",null,"Servicios & precios"),(0,a.createElement)("span",{className:"services-step__subtitle"},"Añade servicios con detalle, márgenes y proveedor."))),(0,a.createElement)(l.CardBody,{ref:ve},A&&(0,a.createElement)(l.Notice,{status:"success",isDismissible:!0,onRemove:()=>B("")},A),c&&(0,a.createElement)("div",{className:"services-intention-banner"},(0,a.createElement)("strong",null,"Intenciones detectadas"),c.golf?.requested&&(0,a.createElement)("span",null,"Solicitud indica ",c.golf.green_fees_per_player||"—"," green-fees por jugador."),c.flights?.requested&&(0,a.createElement)("span",null,"Requiere vuelos desde ",c.flights.departure_airport||"—","."),c.package&&(0,a.createElement)("span",null,"Paquete sugerido: ",c.package),c.more_info&&(0,a.createElement)("span",null,"Más info: ",c.more_info)),(0,a.createElement)("div",{className:"services-toolbar"},(0,a.createElement)("div",{className:"services-toolbar__controls"},(0,a.createElement)(l.TextControl,{label:"Margen por defecto (%)",type:"number",min:0,value:String(k),onChange:e=>w(Z(e))}),(0,a.createElement)(l.ToggleControl,{label:"Aplicar a nuevas líneas",checked:x,onChange:()=>P(e=>!e)}),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>{be(e=>e.map(e=>ue({...e,markup_pct:k},n,k)))}},"Aplicar a todas")),(0,a.createElement)("div",{className:"services-toolbar__summary"},(0,a.createElement)("div",{className:"services-toolbar__label"},"PVP total"),(0,a.createElement)("div",{className:"services-toolbar__value"},N," ",ye.totals_sell_price.toFixed(2)))),(0,a.createElement)("div",{className:"services-items"},ge.map((e,t)=>{var r,i,o;const s=V===t,c=Ne[t]||{issues:[],status:"pending",hasMappingWarning:!1,fieldErrors:{}},u=c.status,d=(e=>{const a=e.start_date||n?.start_date||"",t=e.end_date||n?.end_date||"",l=a&&t?`${a} → ${t}`:"Fechas por definir",r=`${N} ${X(e.line_sell_price||0).toFixed(2)}`;return"golf"===e.service_type?`${l} · Jugadores: ${C||S} · ${r}`:"hotel"===e.service_type?`${l} · Pax: ${S} · ${r}`:["transfer","extra","package"].includes(e.service_type)?`Cantidad: ${Y(null!==(i=e.quantity)&&void 0!==i?i:1,1)} · ${r}`:`${l} · ${r}`;var i})(e),p=c.hasMappingWarning?"Proveedor GIAV pendiente":"",m=c.issues.slice(0,2).join(" · "),_=c.fieldErrors||{};return(0,a.createElement)("div",{key:t,className:`service-card service-card--status-${u} ${s?"is-open":""} ${$===t?"is-error":""} ${G===t?"is-highlighted":""}`.trim(),"data-service-index":t},(0,a.createElement)("div",{className:"service-card__header"},(0,a.createElement)("div",{className:"service-card__title"},(0,a.createElement)("div",{className:"service-card__eyebrow"},"Servicio ",t+1),(0,a.createElement)("div",{className:"service-card__name"},W.find(a=>a.value===e.service_type)?.label||"Servicio"," ·"," ",e.title?.trim()||e.display_name?.trim()||"Sin título"),(0,a.createElement)("div",{className:"service-card__summary"},d),"pending"===u&&p&&(0,a.createElement)("div",{className:"service-card__missing"},p),"error"===u&&m&&(0,a.createElement)("div",{className:"service-card__missing"},m)),(0,a.createElement)("div",{className:"service-card__meta"},(0,a.createElement)("div",{className:`service-card__badge service-card__badge--${u}`},"completed"===u&&"✓ OK","pending"===u&&"Pendiente","error"===u&&`${c.issues.length} errores`),(0,a.createElement)(l.Button,{variant:"tertiary",className:"service-card__toggle",onClick:()=>U(s?null:t)},s?"Ocultar":"Ver detalle"),(0,a.createElement)("div",{className:"service-card__total"},(0,a.createElement)("span",null,"Total línea"),(0,a.createElement)("strong",null,N," ",X(e.line_sell_price||0).toFixed(2))),(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>(e=>{be(a=>a.filter((a,t)=>t!==e)),U(a=>null==a?a:a===e?Math.max(0,e-1):a>e?a-1:a)})(t),disabled:1===ge.length},"Eliminar"))),s&&(0,a.createElement)("div",{className:"service-card__content"},(0,a.createElement)("div",{className:"service-card__section"},(0,a.createElement)("div",{className:"service-card__section-title"},"Selección y contexto"),(0,a.createElement)("div",{className:"service-card__grid service-card__grid--context"},(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.SelectControl,{label:"Tipo de servicio",value:e.service_type,options:W,onChange:e=>fe(t,{service_type:e})})),"hotel"===e.service_type||"golf"===e.service_type||"package"===e.service_type?(0,a.createElement)(a.Fragment,null,e.use_manual_entry?(0,a.createElement)("div",{className:"service-card__field "+(_.title?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"hotel"===e.service_type?"Hotel (manual) *":"Campo de golf (manual) *",value:e.display_name||"",onChange:e=>fe(t,{display_name:e,title:e}),placeholder:"hotel"===e.service_type?"Ej: Hotel X (fuera de catálogo)":"Ej: Campo Y (fuera de catálogo)"}),_.title&&(0,a.createElement)("div",{className:"service-card__field-error"},_.title)):(0,a.createElement)("div",{className:"service-card__field "+(_.title?"is-error":"")},(0,a.createElement)(j,{label:"hotel"===e.service_type?"Hotel":"package"===e.service_type?"Hotel (paquete)":"Campo de golf",type:"golf"===e.service_type?"golf":"hotel",valueTitle:e.title,onPick:async a=>{const l="golf"===e.service_type?"course":"hotel";fe(t,{title:a.title,display_name:a.title,wp_object_type:l,wp_object_id:a.id,supplier_override:!1});try{const e=await y({wp_object_type:l,wp_object_id:a.id});var n,r,i,o;e?.status&&"missing"!==e.status?fe(t,{giav_mapping_status:e.status,giav_entity_type:e.giav_entity_type,giav_entity_id:e.giav_entity_id,giav_supplier_id:null!==(n=e.giav_supplier_id)&&void 0!==n?n:H,giav_supplier_name:null!==(r=e.giav_supplier_name)&&void 0!==r?r:z,condiciones_cancelacion:null!==(i=e.condiciones_cancelacion)&&void 0!==i?i:""}):fe(t,{giav_mapping_status:"needs_review",giav_entity_type:"supplier",giav_entity_id:H,giav_supplier_id:H,giav_supplier_name:z,condiciones_cancelacion:null!==(o=e?.condiciones_cancelacion)&&void 0!==o?o:""})}catch{fe(t,{giav_mapping_status:"needs_review",giav_entity_type:"supplier",giav_entity_id:H,giav_supplier_id:H,giav_supplier_name:z,condiciones_cancelacion:""})}}}),_.title&&(0,a.createElement)("div",{className:"service-card__field-error"},_.title)),(0,a.createElement)("div",{className:"service-card__field service-card__field--toggle"},(0,a.createElement)(l.ToggleControl,{label:"Entrada manual (fuera de catálogo)",checked:!!e.use_manual_entry,onChange:()=>{if(e.use_manual_entry)fe(t,{use_manual_entry:!1,wp_object_type:null,wp_object_id:null,show_supplier_picker:!1,giav_mapping_status:"missing",supplier_override:!1,display_name:"",condiciones_cancelacion:""});else{const a=e.display_name||e.title||"";fe(t,{use_manual_entry:!0,wp_object_type:"manual",wp_object_id:0,show_supplier_picker:!0,giav_entity_type:"supplier",giav_entity_id:e.giav_supplier_id||H,giav_mapping_status:e.giav_supplier_id===H?"needs_review":"active",giav_supplier_id:e.giav_supplier_id||H,giav_supplier_name:e.giav_supplier_name||z,supplier_override:!1,display_name:a,title:a,condiciones_cancelacion:""})}}})),(0,a.createElement)("div",{className:"service-card__supplier"},!ke(e)&&(0,a.createElement)("div",{className:"service-card__supplier-actions"},(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>Ce(t)},"Cambiar proveedor")),ke(e)&&(0,a.createElement)(a.Fragment,null,!e.use_manual_entry&&(0,a.createElement)("div",{className:"service-card__field service-card__field--toggle"},(0,a.createElement)(l.ToggleControl,{label:"Proveedor (opcional)",checked:!!e.show_supplier_picker,onChange:()=>Ce(t)})),(0,a.createElement)(O,{selectedId:e.giav_supplier_id||H,selectedLabel:e.giav_supplier_name||z,disabled:!1,onPick:a=>{const l=String(a?.id||""),n=String(a?.label||"");l&&fe(t,{giav_entity_type:"supplier",giav_entity_id:l,giav_supplier_id:l,giav_supplier_name:n,giav_mapping_status:l===H?"needs_review":"active",supplier_override:!e.use_manual_entry})}}),_.supplier&&(0,a.createElement)("div",{className:"service-card__field-error"},_.supplier)))):(0,a.createElement)("div",{className:"service-card__field "+(_.title?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"T├¡tulo / descripci├│n *",value:e.title,onChange:e=>fe(t,{title:e})}),_.title&&(0,a.createElement)("div",{className:"service-card__field-error"},_.title)),"hotel"===e.service_type&&(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Tipo de habitación",value:e.hotel_room_type||"",onChange:e=>fe(t,{hotel_room_type:e}),placeholder:"Deluxe / Sea View..."})),"hotel"===e.service_type&&(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.SelectControl,{label:"Régimen",value:e.hotel_regimen||"",options:[{label:"Seleccionar",value:""},...J],onChange:e=>fe(t,{hotel_regimen:e})})))),(0,a.createElement)("div",{className:"service-card__section"},(0,a.createElement)("div",{className:"service-card__section-title"},"Fechas y ocupación"),(0,a.createElement)("div",{className:"service-card__date-status"},(0,a.createElement)("span",{className:"service-card__date-label "+(e.dates_inherited?"is-inherited":"is-custom")},e.dates_inherited?"Fechas del viaje":"Fechas personalizadas"),!e.dates_inherited&&(0,a.createElement)(l.Button,{variant:"tertiary",className:"service-card__date-reset",onClick:()=>(e=>{fe(e,{start_date:n?.start_date||"",end_date:n?.end_date||"",dates_inherited:!0})})(t)},"Restablecer fechas del viaje")),(0,a.createElement)("div",{className:"service-card__grid service-card__grid--dates"},(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Fecha inicio",type:"date",value:e.start_date,onChange:e=>((e,a)=>{be(t=>{const l=[...t],r=l[e],i=a||"",o=r.end_date&&i&&r.end_date<i?i:r.end_date;return l[e]=ue({...r,start_date:i,end_date:o,dates_inherited:!1},n,k),l}),window.setTimeout(()=>{const a=document.getElementById(`wp-travel-end-date-${e}`);if(a&&(a.focus(),"function"==typeof a.showPicker))try{a.showPicker()}catch(e){}},0)})(t,e),min:K,className:"service-card__date-start"})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{id:`wp-travel-end-date-${t}`,label:"Fecha fin",type:"date",value:e.end_date,onChange:e=>((e,a)=>fe(e,{end_date:a}))(t,e),min:e.start_date||void 0})),"hotel"===e.service_type?(0,a.createElement)(a.Fragment,null,(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Noches",type:"number",min:0,value:String(null!==(r=e.hotel_nights)&&void 0!==r?r:re(e,n)),onChange:e=>((e,a)=>{const t=ge[e].start_date||n?.start_date;if(t){const l=le(t,Y(a,1));fe(e,{end_date:l})}})(t,e)}))):"golf"===e.service_type?(0,a.createElement)(a.Fragment,null,(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Jugadores",type:"number",min:1,value:String(C||S),disabled:!0,help:"Definido en Datos basicos"})),(0,a.createElement)("div",{className:"service-card__field "+(_.greenFees?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"Green-fees por jugador *",type:"number",min:1,value:String(null!==(i=e.green_fees_per_person)&&void 0!==i?i:""),onChange:e=>fe(t,{green_fees_per_person:e})}),_.greenFees&&(0,a.createElement)("div",{className:"service-card__field-error"},_.greenFees)),(0,a.createElement)("div",{className:"service-card__golf-summary"},"Total green-fees (interno): ",Y(C||S,1)," x ",Y(e.green_fees_per_person,0)," ="," ",Y(e.total_green_fees,0))):(0,a.createElement)("div",{className:"service-card__field "+(_.quantity?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"transfer"===e.service_type?"Cantidad (servicios)":"package"===e.service_type?"Cantidad (paquetes)":"Cantidad",type:"number",min:1,value:String(e.quantity),onChange:e=>fe(t,{quantity:e})}),_.quantity&&(0,a.createElement)("div",{className:"service-card__field-error"},_.quantity)))),(0,a.createElement)("div",{className:"service-card__section service-card__section--pricing"},(0,a.createElement)("div",{className:"service-card__section-title"},"Pricing"),_.pricing&&(0,a.createElement)("div",{className:"service-card__field-error service-card__field-error--inline"},_.pricing),"hotel"===e.service_type?(0,a.createElement)(de,{item:e,idx:t,updateItem:fe,currency:N,pax:S,basics:n,globalMarkupPct:k}):"package"===e.service_type?(0,a.createElement)(me,{item:e,idx:t,updateItem:fe,currency:N,pax:S,globalMarkupPct:k}):(0,a.createElement)("div",{className:"service-card__pricing"},(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Coste neto (unit.)",value:String(e.unit_cost_net),onChange:e=>fe(t,{unit_cost_net:e}),placeholder:"120"})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.ToggleControl,{label:"Usar margen",checked:!!e.use_markup,onChange:()=>fe(t,{use_markup:!e.use_markup})})),e.use_markup&&(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Margen (%)",type:"number",min:0,value:String(null!==(o=e.markup_pct)&&void 0!==o?o:k),onChange:e=>fe(t,{markup_pct:e})})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.ToggleControl,{label:"PVP manual",checked:!!e.lock_sell_price,onChange:()=>fe(t,{lock_sell_price:!e.lock_sell_price})})),(0,a.createElement)("div",{className:"service-card__field "+(_.unitSell?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"PVP (unit.)",value:String(e.unit_sell_price),onChange:e=>fe(t,{unit_sell_price:e}),placeholder:"165",disabled:!e.lock_sell_price}),_.unitSell&&(0,a.createElement)("div",{className:"service-card__field-error"},_.unitSell)))),"package"===e.service_type&&(0,a.createElement)("div",{className:"service-card__section service-card__section--package"},(0,a.createElement)("div",{className:"service-card__section-title"},"Detalle del paquete"),(0,a.createElement)("div",{className:"service-card__package"},(0,a.createElement)(l.TextareaControl,{label:"Incluye (una línea por ítem)",value:e.package_components_text||"",onChange:e=>fe(t,{package_components_text:e}),rows:4,placeholder:"3 noches\n2 green-fees\nDesayuno incluido"}))),"hotel"!==e.service_type&&(0,a.createElement)("div",{className:"service-card__section service-card__section--notes"},(0,a.createElement)("div",{className:"service-card__section-title"},"Notas"),(0,a.createElement)("details",{className:"service-card__notes-details"},(0,a.createElement)("summary",null,"Mostrar notas"),(0,a.createElement)("div",{className:"service-card__notes"},(0,a.createElement)(l.TextControl,{label:"Notas para el cliente (itinerario)",value:e.notes_public||"",onChange:e=>fe(t,{notes_public:e}),placeholder:"Incluye desayuno. Check-in 15:00."}),(0,a.createElement)(l.TextControl,{label:"Notas internas (solo uso interno)",value:e.notes_internal||"",onChange:e=>fe(t,{notes_internal:e}),placeholder:"Neto negociado, release 14D."}))))))})),(0,a.createElement)("div",{className:"services-add"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>{const e=ge.length-1,a=e>=0?Ne[e]:null;("error"!==a?.status||window.confirm("Tienes un servicio incompleto. ¿Crear otro igualmente?"))&&be(e=>{const a=[...e,ce(n,k)],t=a.length-1;return U(t),Q(t),a})}},"+ Añadir servicio")),(0,a.createElement)("div",{className:"services-summary"},(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Total viaje"),Te(`${N} ${X(null!==(m=Ee.displayTotalTrip)&&void 0!==m?m:Ee.totalTrip).toFixed(2)}`,{missing:ye.totals_sell_price<=0,tooltip:"Completa servicios para calcular."}),(0,a.createElement)("div",{className:"services-summary__meta"},"Jugadores: ",Ee.playersCount," | No jugadores: ",Ee.nonPlayersCount)),Ee.playersCount>0&&(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Precio jugador en doble"),Te(`${N} ${X(null!==(_=null!==(v=Ee.displayPricePlayer)&&void 0!==v?v:Ee.pricePlayerDouble)&&void 0!==_?_:0).toFixed(2)}`,{missing:Ee.playersCount<=0,tooltip:"Completa jugadores y servicios para calcular."})),Ee.nonPlayersCount>0&&(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Precio no jugador en doble"),Te(`${N} ${X(null!==(g=null!==(b=Ee.displayPriceNonPlayer)&&void 0!==b?b:Ee.priceNonPlayerDouble)&&void 0!==g?g:0).toFixed(2)}`,{missing:Ee.nonPlayersCount<=0,tooltip:"Completa no jugadores para calcular."})),Ee.hasSingleSupplement&&(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Suplemento individual"),Te(`${N} ${X(null!==(h=null!==(E=Ee.displaySupplementSingle)&&void 0!==E?E:Ee.supplementSingle)&&void 0!==h?h:0).toFixed(2)}`,{missing:!Ee.hasSingleSupplement,tooltip:"Completa habitaciones para calcular."}))),(0,a.createElement)("div",{className:"services-footer"},(M||ie&&se.length>0)&&(0,a.createElement)("div",{className:"services-footer__errors"},(0,a.createElement)("div",{className:"services-footer__errors-header"},(0,a.createElement)("span",null,"Error summary"),(0,a.createElement)(l.Button,{variant:"link",onClick:()=>{ve.current&&ve.current.scrollIntoView({behavior:"smooth",block:"start"})}},"Ver arriba")),M&&(0,a.createElement)("div",{className:"services-footer__errors-message"},M),(0,a.createElement)("ul",null,(se.length>0?se:Pe.serviceErrors).slice(0,3).map(e=>(0,a.createElement)("li",{key:e.index},(0,a.createElement)("button",{type:"button",onClick:()=>Se(e.index)},e.title,": ",e.details)))),Pe.serviceErrors.length>3&&(0,a.createElement)("div",{className:"services-footer__errors-more"},"+",Pe.serviceErrors.length-3," más")),(0,a.createElement)("div",{className:"services-footer__bar"},(0,a.createElement)("div",{className:"services-footer__left"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:i},"Volver"),e&&(0,a.createElement)(l.Button,{variant:"secondary",onClick:async()=>{if(e){B(""),D(!0);try{var a,t;const l=I(n?.first_name,n?.last_name,n?.customer_name),r={...n||{},customer_name:l,pax_total:Math.max(1,Y(null!==(a=n?.pax_total)&&void 0!==a?a:1,1)),players_count:Math.max(0,Y(null!==(t=n?.players_count)&&void 0!==t?t:0,0)),customer_country:n?.customer_country?String(n.customer_country).toUpperCase():"",giav_agent_id:(()=>{const e=parseInt(n?.giav_agent_id,10);return Number.isFinite(e)&&e>0?e:null})()};await u(e,r),B("Cambios guardados.")}catch(e){T(e?.message||"Error guardando datos b??sicos.")}finally{D(!1)}}},disabled:R},"Guardar datos básicos")),(0,a.createElement)("div",{className:"services-footer__summary"},(0,a.createElement)("span",null,"Total viaje"),(0,a.createElement)("strong",null,N," ",X(null!==(f=Ee.displayTotalTrip)&&void 0!==f?f:Ee.totalTrip).toFixed(2))),(0,a.createElement)("div",{className:"services-footer__right"},(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>{const{errors:e,serviceErrors:a}=we();if(oe(!0),a.length>0||e.length>0){const t=a.length>0?`Faltan datos en ${a.length} servicios. Te llevo al primero.`:e[0];return T(t),_e(a),void((e,a)=>{if(e.length>0)Se(e[0].index);else if(a.length>0){q(null);const e=document.querySelector(".services-step");e&&(e.scrollIntoView({behavior:"smooth",block:"start"}),xe(e))}})(a,e)}T(""),_e([]),q(null),o({items:ge,totals:ye})},disabled:Me&&ie,title:Me?"Completa los campos obligatorios para continuar.":""},M?"Revisa los campos marcados":"Continuar"))))))}const ve="wp_travel_giav_proposal_id",ge=()=>"undefined"!=typeof window&&void 0!==window.sessionStorage;function be(e){const a=parseFloat(e);return Number.isFinite(a)?Math.round(100*(a+Number.EPSILON))/100:0}function he(e){const a=parseFloat(String(e).replace(",","."));return Number.isFinite(a)?a:0}function ye(e,a=0){const t=parseInt(e,10);return Number.isFinite(t)?t:a}const Ee=[{key:"double",capacity:2},{key:"single",capacity:1}];function fe(e,a,t=!1){const l="single"===e?"Habitaciones individuales":"Habitaciones dobles",n=t?`${l} adicionales`:l;return a>0?`${n} (${a} hab.)`:n}function Ne(e,a,t,l){let n=a;return t>0&&(n+=` — Precio estimado por habitación: ${function(e,a){return`${a||"EUR"} ${be(e).toFixed(2)}`}(t,l)}`),e&&(n=`${e}: ${n}`),n}function Se(e){if(null==e)return"";let a=String(e);return a=a.replace(/\r\n/g,"\n"),a=a.replace(/<br\s*\/?>/gi,"\n"),a=a.replace(/<[^>]+>/g,""),a.trim()}function Ce({proposalId:e,basics:n,items:r,totals:i,onBack:s,onSent:c,onProposalCreated:d,mode:p="create",versionNumber:v=1,initialCancellationTerms:g=""}){var b,h,y,E,f,N,S;const[C,k]=(0,t.useState)(!1),[w,x]=(0,t.useState)(""),[P,M]=(0,t.useState)(""),[T,A]=(0,t.useState)(!1),[B,R]=(0,t.useState)(Boolean(g&&String(g).trim())),[D,$]=(0,t.useState)(g||""),q="undefined"!=typeof window&&window.CASANOVA_GESTION_RESERVAS?"wp-travel-giav-portal":"wp-travel-giav-admin",G=(0,t.useMemo)(()=>function(e=[]){const a=(e||[]).filter(e=>"hotel"===e?.service_type).map(e=>({name:e.display_name||e.title||"Hotel",text:Se(e.condiciones_cancelacion||"")})).filter(e=>e.text);return 0===a.length?"":1===a.length?a[0].text:a.map(e=>`${e.name}:\n${e.text}`).join("\n\n")}(r),[r]);(0,t.useEffect)(()=>{B||$(G)},[G,B]);const F=(0,t.useMemo)(()=>{const e={crm_customer_id:null,first_name:n.first_name,last_name:n.last_name,customer_name:I(n.first_name,n.last_name,n.customer_name),customer_email:n.customer_email,customer_country:n.customer_country,customer_language:n.customer_language,proposal_title:n.proposal_title,start_date:n.start_date,end_date:n.end_date,pax_total:n.pax_total,players_count:n.players_count,giav_agent_id:n.giav_agent_id,currency:n.currency,status:"sent"},a=(r||[]).map((e,a)=>{var t,l,n,r,i,o,s,c,u,d,p,m,_,v,g,b,h,y,E,f,N,S,C,k,w,x,P,M,T,I,A,B,R,D,$,q,G,F,V,U,L,j,O,H,z,K;return{day_index:null!==(t=e.day_index)&&void 0!==t?t:null,service_type:e.service_type,wp_object_type:null!==(l=e.wp_object_type)&&void 0!==l?l:null,wp_object_id:null!==(n=e.wp_object_id)&&void 0!==n?n:null,giav_entity_type:null!==(r=e.giav_entity_type)&&void 0!==r?r:null,giav_entity_id:null!==(i=e.giav_entity_id)&&void 0!==i?i:null,giav_supplier_id:null!==(o=e.giav_supplier_id)&&void 0!==o?o:null,giav_supplier_name:null!==(s=e.giav_supplier_name)&&void 0!==s?s:null,supplier_source:null!==(c=e.supplier_source)&&void 0!==c?c:null,supplier_resolution_chain:Array.isArray(e.supplier_resolution_chain)?e.supplier_resolution_chain:[],preflight_ok:null!==(u=e.preflight_ok)&&void 0!==u?u:null,warnings:Array.isArray(e.warnings)?e.warnings:[],blocking:Array.isArray(e.blocking)?e.blocking:[],supplier_override:!!e.supplier_override,title:null!==(d=e.title)&&void 0!==d?d:`Item ${a+1}`,display_name:null!==(p=e.display_name)&&void 0!==p?p:null,start_date:e.start_date||null,end_date:e.end_date||null,quantity:null!==(m=e.quantity)&&void 0!==m?m:1,pax_quantity:null!==(_=e.pax_quantity)&&void 0!==_?_:null,hotel_rate_basis:null!==(v=e.hotel_rate_basis)&&void 0!==v?v:null,hotel_nights:null!==(g=e.hotel_nights)&&void 0!==g?g:null,hotel_rooms:null!==(b=e.hotel_rooms)&&void 0!==b?b:null,hotel_room_type:null!==(h=e.hotel_room_type)&&void 0!==h?h:"",hotel_regimen:null!==(y=e.hotel_regimen)&&void 0!==y?y:"",hotel_informative_quote:!!e.hotel_informative_quote,hotel_pricing_mode:null!==(E=null!==(f=e.hotel_pricing_mode)&&void 0!==f?f:e.hotel_rate_mode)&&void 0!==E?E:"simple",nightly_rates:Array.isArray(e.nightly_rates)?e.nightly_rates:Array.isArray(e.hotel_nightly_rates)?e.hotel_nightly_rates:null,room_pricing:null!==(N=e.room_pricing)&&void 0!==N?N:null,discounts:null!==(S=e.discounts)&&void 0!==S?S:null,giav_pricing:null!==(C=e.giav_pricing)&&void 0!==C?C:null,package_components:Array.isArray(e.package_components)?e.package_components:[],package_components_text:null!==(k=e.package_components_text)&&void 0!==k?k:"",package_pricing_basis:null!==(w=e.package_pricing_basis)&&void 0!==w?w:null,package_discount_percent:be(null!==(x=e.package_discount_percent)&&void 0!==x?x:0),package_quote_individual:!!e.package_quote_individual,package_individual_mode:null!==(P=e.package_individual_mode)&&void 0!==P?P:null,package_individual_qty:ye(null!==(M=e.package_individual_qty)&&void 0!==M?M:0,0),package_individual_use_markup:!!e.package_individual_use_markup,package_individual_markup_pct:be(null!==(T=e.package_individual_markup_pct)&&void 0!==T?T:0),package_unit_cost_net_individual:be(null!==(I=e.package_unit_cost_net_individual)&&void 0!==I?I:0),package_unit_sell_price_individual:be(null!==(A=e.package_unit_sell_price_individual)&&void 0!==A?A:0),package_single_supplement_net:be(null!==(B=e.package_single_supplement_net)&&void 0!==B?B:0),package_single_supplement_pvp:be(null!==(R=e.package_single_supplement_pvp)&&void 0!==R?R:0),package_pp_double:be(null!==(D=e.package_pp_double)&&void 0!==D?D:0),package_room_double:be(null!==($=e.package_room_double)&&void 0!==$?$:0),package_pp_single:be(null!==(q=e.package_pp_single)&&void 0!==q?q:0),package_room_single:be(null!==(G=e.package_room_single)&&void 0!==G?G:0),package_single_supplement:be(null!==(F=e.package_single_supplement)&&void 0!==F?F:0),package_room_single_supplement:be(null!==(V=e.package_room_single_supplement)&&void 0!==V?V:0),green_fees_per_person:null!==(U=e.green_fees_per_person)&&void 0!==U?U:null,number_of_players:null!==(L=e.number_of_players)&&void 0!==L?L:null,total_green_fees:null!==(j=e.total_green_fees)&&void 0!==j?j:null,unit_cost_net:be(e.unit_cost_net),unit_sell_price:be(e.unit_sell_price),line_cost_net:be(e.line_cost_net),line_sell_price:be(e.line_sell_price),use_markup:!!e.use_markup,markup_pct:be(null!==(O=e.markup_pct)&&void 0!==O?O:0),lock_sell_price:!!e.lock_sell_price,notes_public:null!==(H=e.notes_public)&&void 0!==H?H:"",notes_internal:null!==(z=e.notes_internal)&&void 0!==z?z:"",condiciones_cancelacion:null!==(K=e.condiciones_cancelacion)&&void 0!==K?K:""}}),t=i||{totals_cost_net:0,totals_sell_price:0,totals_margin_abs:0,totals_margin_pct:0};return{header:e,items:a,totals:{totals_cost_net:be(t.totals_cost_net),totals_sell_price:be(t.totals_sell_price),totals_margin_abs:be(t.totals_margin_abs),totals_margin_pct:be(t.totals_margin_pct)},condiciones_cancelacion:String(D||"").trim(),template_id:null,terms_version:null,metadata:{created_at:(new Date).toISOString(),created_by:null,source:q,schema_version:"v2"}}},[n,r,i,D,q]),V=F?.header||{},U=I(V.first_name,V.last_name,V.customer_name),L=F?.totals||{},j=Array.isArray(F?.items)?F.items:[],O=(0,t.useMemo)(()=>!!Array.isArray(r)&&r.some(e=>"hotel"===e?.service_type),[r]),H=(0,t.useMemo)(()=>{let e=0,a=0;return j.forEach(t=>{const l=Array.isArray(t?.warnings)?t.warnings:[],n=Array.isArray(t?.blocking)?t.blocking:[];e+=l.length,a+=n.length}),{warningCount:e,blockingCount:a}},[j]),z=H.blockingCount>0?"error":H.warningCount>0?"warning":"success",K=H.blockingCount>0?`Hay ${H.blockingCount} servicios con errores`:H.warningCount>0?`Hay ${H.warningCount} avisos en servicios`:"Servicios listos para enviar",W=(0,t.useMemo)(()=>{var e,a,t;const l=Math.max(0,ye(null!==(e=V?.pax_total)&&void 0!==e?e:0,0)),n=ye(null!==(a=null!==(t=V?.players_count)&&void 0!==t?t:l)&&void 0!==a?a:0,0),r=Math.min(Math.max(n,0),l),i={paxTotal:l,playersCount:r,nonPlayersCount:Math.max(0,l-r),golfTotal:0,totalDouble:0,totalSingle:0,doubleRooms:0,singleRooms:0};j.forEach(e=>{if("golf"===e.service_type&&(i.golfTotal+=he(e.line_sell_price||0)),"hotel"===e.service_type){const l=e.room_pricing||{};var a,t;l.double?.enabled&&(i.totalDouble+=he(l.double?.total_pvp||0),i.doubleRooms+=Math.max(0,ye(null!==(a=l.double?.rooms)&&void 0!==a?a:0,0))),l.single?.enabled&&(i.totalSingle+=he(l.single?.total_pvp||0),i.singleRooms+=Math.max(0,ye(null!==(t=l.single?.rooms)&&void 0!==t?t:0,0)))}});const o=he(L?.totals_sell_price||0),s=o,c=i.doubleRooms>0?i.totalDouble/(2*i.doubleRooms):0,u=i.singleRooms>0?i.totalSingle/i.singleRooms:0,d=o-(i.totalDouble+i.totalSingle)-i.golfTotal,p=i.paxTotal>0?d/i.paxTotal:0,m=i.doubleRooms>0?"double":i.singleRooms>0?"single":"double",_=("double"===m?c:u)+p,v=i.playersCount>0?_+i.golfTotal/i.playersCount:null,g=i.doubleRooms>0&&i.singleRooms>0;let b=null;g&&(b=Math.max(0,u-c));const h=g&&null!==b?Math.round(b):null,y=function({totalTrip:e,playersCount:a,nonPlayersCount:t,pricePlayerRaw:l,priceNonPlayerRaw:n}){const r=Math.max(0,Math.round(e||0)),i=Math.max(0,ye(a,0)),o=Math.max(0,ye(t,0));if(i<=0&&o<=0)return{totalTrip:r,pricePlayer:null,priceNonPlayer:null};const s=function(e,a){return!a||a<=1?e:Math.ceil(e/a)*a}(r,i>0&&o>0?function(e,a){let t=Math.abs(e),l=Math.abs(a);for(;l;){const e=l;l=t%l,t=e}return t}(i,o):Math.max(i,o));if(i>0&&o>0){const e=Math.max(0,Math.round(n||0));let a=null,t=null;const r=Math.max(i+o,10);for(let c=0;c<=r;c+=1){const r=[e+c,e-c];for(const e of r){if(e<0)continue;const r=s-o*e;if(r<0)continue;if(r%i!==0)continue;const c=r/i,u=Math.abs(e-(n||0))+Math.abs(c-(null!=l?l:c));(null===t||u<t)&&(t=u,a={priceNonPlayer:e,pricePlayer:c})}if(0===t)break}if(a)return{totalTrip:s,...a};const c=Math.max(0,e),u=i>0?Math.max(0,Math.round((s-o*c)/i)):null;return{totalTrip:i>0?i*u+o*c:s,pricePlayer:u,priceNonPlayer:c}}return i>0?{totalTrip:s,pricePlayer:s/i,priceNonPlayer:null}:{totalTrip:s,pricePlayer:null,priceNonPlayer:o>0?s/o:null}}({totalTrip:o,playersCount:i.playersCount,nonPlayersCount:i.nonPlayersCount,pricePlayerRaw:v,priceNonPlayerRaw:_});return{...i,totalTrip:o,baseTotal:s,baseRoomType:m,priceNonPlayerBase:_,pricePlayerBase:v,supplementSingle:b,hasSingleSupplement:g,displaySupplementSingle:h,displayTotalTrip:y.totalTrip,displayPricePlayer:y.pricePlayer,displayPriceNonPlayer:y.priceNonPlayer}},[V?.pax_total,V?.players_count,j,L?.totals_sell_price]),{includeRoomLines:J,informativeExtras:Z}=(0,t.useMemo)(()=>{const e=[],a=[],t=Math.max(0,W.paxTotal),l=V.currency||"EUR";return j.forEach((n,r)=>{if("hotel"!==n.service_type)return;const i=n.display_name||n.title||"Alojamiento",o=function(e={},a=0){let t=Math.max(0,a);const l={types:{},hasExtra:!1};return Ee.forEach(({key:a,capacity:n})=>{var r,i;const o=e[a]||{},s=Boolean(o.enabled)?Math.max(0,ye(null!==(r=o.rooms)&&void 0!==r?r:0,0)):0,c=he(null!==(i=o.total_pvp)&&void 0!==i?i:0),u=s>0?c/s:0;let d=0,p=0;for(let e=0;e<s;e+=1)t>0?(d+=1,t-=n):p+=1;p>0&&(l.hasExtra=!0),l.types[a]={rooms:s,needed:d,extra:p,capacity:n,perRoomPrice:u,totalPvp:c}}),l}(n.room_pricing||{},t),s=o.types.double||{needed:0,extra:0,rooms:0,perRoomPrice:0},c=o.types.single||{needed:0,extra:0,rooms:0,perRoomPrice:0},u=(a,t)=>{e.push({key:`${r}-${a}`,text:i?`${i} · ${t}`:t})};n.hotel_informative_quote?(s.needed>0&&u("double-needed",fe("double",s.needed)),c.needed>0&&u("single-needed",fe("single",c.needed)),o.hasExtra&&(s.extra>0&&a.push({key:`${r}-double-extra`,text:Ne(i,fe("double",s.extra,!0),s.perRoomPrice,l)}),c.extra>0&&a.push({key:`${r}-single-extra`,text:Ne(i,fe("single",c.extra,!0),c.perRoomPrice,l)}))):(s.rooms>0&&u("double-total",fe("double",s.rooms)),c.rooms>0&&u("single-total",fe("single",c.rooms)))}),{includeRoomLines:e,informativeExtras:a}},[j,W.paxTotal,V.currency]),Y=Boolean(V.customer_email),Q="edit"===p?"Guardar nueva versión":Y?"Compartir propuesta":"Crear enlace público",X=()=>{const a=e&&Number(e)>0?Number(e):null;if(a)return a;const t=(()=>{try{const e=window.location.search||"";if(!e)return null;const a=new URLSearchParams(e),t=["proposal_id","id","proposalId","proposalId"];for(let e of t){const t=a.get(e);if(t){const e=parseInt(t,10);if(Number.isFinite(e)&&e>0)return e}}}catch(e){}return null})();if(t)return t;return function(){if(!ge())return null;const e=window.sessionStorage.getItem(ve);if(!e)return null;const a=parseInt(e,10);return Number.isFinite(a)&&a>0?a:null}()||null},ee=e=>{const a=String(e||"es").trim();if(!a)return"es";const t=a.split(/[-_]/)[0]||a;return t?t.slice(0,2):"es"},ae=()=>{var e,a;const t=I(n.first_name,n.last_name,n.customer_name);return{...n,customer_name:t,customer_language:ee(n.customer_language),pax_total:Math.max(1,ye(null!==(e=n.pax_total)&&void 0!==e?e:1,1)),players_count:Math.max(0,ye(null!==(a=n.players_count)&&void 0!==a?a:0,0)),customer_country:n.customer_country?String(n.customer_country).toUpperCase():"",giav_agent_id:(()=>{const e=parseInt(n.giav_agent_id,10);return Number.isFinite(e)&&e>0?e:null})()}},te=async()=>{const e=X();if(e&&Number.isFinite(e)&&e>0)return e;if(!n)return null;const a=ae(),t=await o(a),l=Number(t?.proposal_id||0);return l>0?(d?.({proposalId:l,basics:a}),l):null},le=async()=>{k(!0),x("");const e=await te();try{"undefined"!=typeof process&&process&&process.env}catch(e){}if(!e||Number(e)<=0)return k(!1),void x("No se pudo continuar: falta el identificador de propuesta válido (proposalId).");try{const a=await _(e,F,v);c({versionId:a.version_id,publicToken:a.public_token,publicUrl:a.public_url,status:a.status,snapshot:F})}catch(e){x(e?.message||"Error guardando la versión.")}finally{k(!1)}},ne=async()=>{k(!0),x("");const e=await te();if(!e||Number(e)<=0)return k(!1),void x("No se pudo compartir: falta el identificador de propuesta válido (proposalId).");if(window.confirm("¿Marcar como enviada y generar enlace público? (Esto no envía emails automáticamente)"))try{const a=await m(e,F,v);c({versionId:a.version_id,publicToken:a.public_token,publicUrl:a.public_url,status:a.status||"sent",snapshot:F})}catch(e){x(e?.message||"Error compartiendo la propuesta.")}finally{k(!1)}else k(!1)};return(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Preview y envío")),(0,a.createElement)(l.CardBody,null,P&&(0,a.createElement)(l.Notice,{status:"success",isDismissible:!0,onRemove:()=>M("")},P),w&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>x("")},w),(0,a.createElement)(l.Notice,{status:z,isDismissible:!1},K),(0,a.createElement)(l.Notice,{status:"info",isDismissible:!1},"El cliente vera solo el total del paquete. El desglose por lineas queda guardado internamente en la version."),(0,a.createElement)("div",{className:"proposal-preview"},(0,a.createElement)("div",{className:"proposal-preview__header"},(0,a.createElement)("div",{className:"proposal-preview__name"},U||"—"),(0,a.createElement)("div",{className:"proposal-preview__meta"},V.start_date," - ",V.end_date," | Pax: ",V.pax_total," | Moneda: ",V.currency)),(0,a.createElement)("div",{className:"proposal-preview__includes"},(0,a.createElement)("div",{className:"proposal-preview__includes-title"},"Incluye"),J.length>0&&(0,a.createElement)("div",{className:"proposal-preview__includes-lines"},J.map(e=>(0,a.createElement)("div",{key:e.key,className:"proposal-preview__includes-line"},e.text))),(0,a.createElement)("div",{className:"preview-items"},j.map((e,t)=>{const l=Array.isArray(e?.warnings)?e.warnings:[],n=Array.isArray(e?.blocking)?e.blocking:[],r=e.display_name||e.title||`Item ${t+1}`,i=e.giav_supplier_name||"Proveedor no especificado",o=n.length>0,s=l.length>0;return(0,a.createElement)("div",{key:t,className:"preview-item"},(0,a.createElement)("div",{className:"preview-item__main"},(0,a.createElement)("div",{className:"preview-item__title"},(0,a.createElement)("strong",null,e.service_type?.toUpperCase())," - ",r),(0,a.createElement)("div",{className:"preview-item__supplier"},"Proveedor: ",i),"hotel"===e.service_type&&e.hotel_room_type?(0,a.createElement)("div",{className:"preview-item__meta"},"Habitacion: ",e.hotel_room_type):null,"package"===e.service_type&&e.package_components_text?(0,a.createElement)("div",{className:"preview-item__meta"},"Incluye: ",e.package_components_text.split("\n").filter(Boolean).join(", ")):null,"package"===e.service_type&&"per_person"===(e.package_pricing_basis||"per_person")?((t,l,n,r,i,o)=>{const s=V.currency||"EUR";if("per_room"==("per_room"===e.package_pricing_basis?"per_room":"per_person")){var c,u,d,p,m,_;const t=he(null!==(c=null!==(u=e.package_room_double)&&void 0!==u?u:e.unit_sell_price)&&void 0!==c?c:0),l="supplement"===e.package_single_room_mode?"supplement":"price",n=he(null!==(d=null!==(p=e.package_room_single)&&void 0!==p?p:e.unit_sell_price_single_room)&&void 0!==d?d:0),r=he(null!==(m=null!==(_=e.package_room_single_supplement)&&void 0!==_?_:e.package_single_room_supplement_sell)&&void 0!==m?m:0),i=n>0||"supplement"===l&&r>0;return(0,a.createElement)("div",{className:"preview-item__meta"},"Precio paquete por habitación (doble): ",s," ",be(t).toFixed(2),i&&(0,a.createElement)(a.Fragment,null," · ","supplement"===l?`Suplemento habitación individual: ${s} ${be(r).toFixed(2)}`:`Precio habitación individual: ${s} ${be(n).toFixed(2)}`))}const v=he(null!==(t=null!==(l=e.package_pp_double)&&void 0!==l?l:e.unit_sell_price)&&void 0!==t?t:0),g="supplement"===e.package_individual_mode?"supplement":"price",b=he(null!==(n=null!==(r=e.package_single_supplement)&&void 0!==r?r:e.package_single_supplement_sell)&&void 0!==n?n:0),h="supplement"===g?v+b:he(null!==(i=null!==(o=e.package_pp_single)&&void 0!==o?o:e.unit_sell_price_individual)&&void 0!==i?i:0),y=h>0&&("supplement"!==g||b>=0),E=y?Math.max(0,h-v):null;return(0,a.createElement)("div",{className:"preview-item__meta"},"Precio paquete por persona (doble): ",s," ",be(v).toFixed(2),y&&(0,a.createElement)(a.Fragment,null," · ","supplement"===g?`Suplemento individual: ${s} ${be(E||0).toFixed(2)}`:`Precio en individual: ${s} ${be(h).toFixed(2)}`))})():null,o&&(0,a.createElement)("div",{className:"preview-item__blocking"},(0,a.createElement)("span",{className:"preview-item__badge preview-item__badge--error"},"Error"),"Este servicio impide la confirmacion."),o&&(0,a.createElement)("details",{className:"preview-item__details"},(0,a.createElement)("summary",null,"Ver motivos"),(0,a.createElement)("ul",null,n.map((e,t)=>(0,a.createElement)("li",{key:t},e?.message||"Revision requerida")))),s&&(0,a.createElement)("details",{className:"preview-item__details"},(0,a.createElement)("summary",null,(0,a.createElement)("span",{className:"preview-item__badge preview-item__badge--warning"},"Aviso"),"Ver avisos (",l.length,")"),(0,a.createElement)("ul",null,l.map((e,t)=>(0,a.createElement)("li",{key:t},e?.message||"Aviso"))))))})),Z.length>0&&(0,a.createElement)("div",{className:"proposal-preview__informative-block"},(0,a.createElement)("div",{className:"proposal-preview__informative-title"},"Cotización informativa"),(0,a.createElement)("div",{className:"proposal-preview__informative-lines"},Z.map(e=>(0,a.createElement)("div",{key:e.key,className:"proposal-preview__informative-line"},e.text))))),(0,a.createElement)("div",{className:"proposal-preview__totals"},(0,a.createElement)("div",{className:"proposal-preview__totals-label"},"Total viaje"),(0,a.createElement)("div",{className:"proposal-preview__totals-value"},V.currency," ",be(null!==(b=W.displayTotalTrip)&&void 0!==b?b:W.totalTrip).toFixed(2)),W.playersCount>0&&(0,a.createElement)("div",{className:"proposal-preview__totals-line"},"Precio jugador en ","single"===W.baseRoomType?"individual":"doble",": ",V.currency," ",be(null!==(h=null!==(y=W.displayPricePlayer)&&void 0!==y?y:W.pricePlayerBase)&&void 0!==h?h:0).toFixed(2)),(0,a.createElement)("div",{className:"proposal-preview__totals-line"},"Precio no jugador en ","single"===W.baseRoomType?"individual":"doble",": ",V.currency," ",be(null!==(E=null!==(f=W.displayPriceNonPlayer)&&void 0!==f?f:W.priceNonPlayerBase)&&void 0!==E?E:0).toFixed(2)),W.hasSingleSupplement&&(0,a.createElement)("div",{className:"proposal-preview__totals-line"},"Suplemento individual: ",V.currency," ",be(null!==(N=null!==(S=W.displaySupplementSingle)&&void 0!==S?S:W.supplementSingle)&&void 0!==N?N:0).toFixed(2)),(0,a.createElement)("div",{className:"proposal-preview__totals-note"},W.hasSingleSupplement?"Precios por persona. El suplemento individual aplica por persona alojada en habitación individual.":"single"===W.baseRoomType?"Precios por persona en habitación individual.":"Precios por persona en habitación doble."))),(O||D)&&(0,a.createElement)("div",{className:"proposal-preview__cancellation"},(0,a.createElement)("div",{className:"proposal-preview__cancellation-title"},"Condiciones de cancelación"),(0,a.createElement)(l.TextareaControl,{value:D,onChange:e=>{$(e),R(!0)},rows:6,help:"Este texto se mostrara al cliente antes de aceptar la propuesta."})),(0,a.createElement)("div",{className:"proposal-preview__actions"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:s,disabled:C},"Volver"),X()&&(0,a.createElement)(l.Button,{variant:"secondary",onClick:async()=>{const e=X();if(e){M(""),A(!0);try{const a=ae();await u(e,a),M("Cambios guardados.")}catch(e){x(e?.message||"Error guardando datos básicos.")}finally{A(!1)}}},disabled:C||T},"Guardar datos básicos"),"edit"===p?(0,a.createElement)(a.Fragment,null,(0,a.createElement)(l.Button,{variant:"secondary",onClick:le,disabled:C},"Guardar nueva versión"),(0,a.createElement)(l.Button,{variant:"primary",onClick:ne,disabled:C},"Compartir propuesta")):(0,a.createElement)(a.Fragment,null,Y&&(0,a.createElement)(l.Button,{variant:"secondary",onClick:le,disabled:C},"Guardar borrador"),(0,a.createElement)(l.Button,{variant:"primary",onClick:Y?ne:le,disabled:C},Q)),C&&(0,a.createElement)(l.Spinner,null))))}const ke={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",queued:"En cola",synced:"Sincronizada",error:"Error",revoked:"Revocada",lost:"Perdida"},we=e=>{const a=String(e||"").trim();return a?"es"===a?"es_ES":"en"===a?"en_US":a:"es_ES"},xe=e=>{if(!e)return"-";const a=String(e),t=a.includes("T")?a:a.replace(" ","T"),l=new Date(t);return Number.isNaN(l.getTime())?e:new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short"}).format(l)};function Pe({onExit:e,mode:n="create",initialProposal:r=null,initialSnapshot:i=null,nextVersionNumber:o=1,showStepper:s=!1}){const[c,u]=(0,t.useState)(1),[d,p]=(0,t.useState)(r?.id||null),[m,_]=(0,t.useState)(r?.status||"draft"),[v]=(0,t.useState)(r?.accepted_at||""),[g]=(0,t.useState)(r?.proposal_token||""),[b,h]=(0,t.useState)(r?.public_url||""),[y,E]=(0,t.useState)(null),[f,N]=(0,t.useState)(!1),S="undefined"!=typeof window&&!!window.CASANOVA_GESTION_RESERVAS,C=(0,t.useMemo)(()=>{var e,a,t,l;if(!r&&!i)return null;const n=i?.header||{},o=n.customer_name||"",s=r?.customer_name||"",c=A(o),u=A(s),d=(n.first_name||c.firstName,n.last_name||c.lastName,n.first_name||r?.first_name||c.firstName||u.firstName||""),p=n.last_name||r?.last_name||c.lastName||u.lastName||"";return{proposal_title:n.proposal_title||r?.proposal_title||"",first_name:d,last_name:p,customer_name:I(d,p,n.customer_name||r?.customer_name||""),customer_email:n.customer_email||r?.customer_email||"",customer_country:n.customer_country||r?.customer_country||"",customer_language:we(n.customer_language||r?.customer_language||"es_ES"),start_date:n.start_date||r?.start_date||"",end_date:n.end_date||r?.end_date||"",pax_total:n.pax_total||r?.pax_total||1,players_count:null!==(e=null!==(a=null!==(t=null!==(l=n.players_count)&&void 0!==l?l:r?.players_count)&&void 0!==t?t:n.pax_total)&&void 0!==a?a:r?.pax_total)&&void 0!==e?e:1,giav_agent_id:n.giav_agent_id||r?.giav_agent_id||"",currency:n.currency||r?.currency||"EUR"}},[r,i]),[k,w]=(0,t.useState)(C),x=(0,t.useMemo)(()=>{const e=r?.source_meta_json;if(e)try{const a=JSON.parse(e);if(a?.intentions)return a.intentions}catch(e){}return i?.intentions||null},[r?.source_meta_json,i?.intentions]),[P,M]=(0,t.useState)(i?.items||[]),[T,B]=(0,t.useState)(i?.totals||null),[R,D]=(0,t.useState)(null),[$,q]=(0,t.useState)(null);(0,t.useEffect)(()=>{var e;e=d,ge()&&(e&&Number.isFinite(e)&&e>0?window.sessionStorage.setItem(ve,String(Math.floor(e))):window.sessionStorage.removeItem(ve))},[d]),(0,t.useEffect)(()=>()=>{ge()&&window.sessionStorage.removeItem(ve)},[]);let G=null;if(1===c)G=(0,a.createElement)(U,{initialValues:k||{customer_language:"es_ES",currency:"EUR",pax_total:1},onNext:({basics:e})=>{w(e),M(a=>pe(a,e)),u(2)},onCreated:({proposalId:e,basics:a})=>{p(e),w(a),M(e=>pe(e,a)),u(2)},proposalId:d});else if(2===c)G=(0,a.createElement)(_e,{proposalId:d,basics:k,initialItems:P,onDraftChange:({items:e,totals:a})=>{M(e),B(a)},onBack:()=>u(1),onNext:({items:e,totals:a})=>{M(e),B(a),u(3)},requestIntentions:x});else if(3===c)G=(0,a.createElement)(Ce,{proposalId:d,basics:k,items:P,totals:T,mode:n,versionNumber:o,initialCancellationTerms:i?.condiciones_cancelacion||"",onBack:()=>u(2),onSent:({versionId:e,snapshot:a,publicUrl:t,publicToken:l,status:n})=>{q(e),D(a||null),t&&h(t),l&&E(l),n&&_(n),u(4)},onProposalCreated:({proposalId:e,basics:a})=>{e&&Number.isFinite(e)&&p(e),a&&w(a)}});else if(4===c){const t=b||((e,a)=>{if(!e)return"";const t=`${window.location.origin}/travel-proposal/${e}/`;return a?`${window.location.origin}/travel-proposal/${e}/v/${a}/`:t})(g,y),r=ke[m]||m||"-",i=v?`Aceptada el ${xe(v)}`:"Pendiente",o=(({email:e,name:a,publicUrl:t})=>{if(!e||!t)return"";const l=`${a?`Hola ${a},`:"Hola,"}\n\nAquí tienes el enlace a tu propuesta:\n${t}\n\nQuedamos a tu disposición para cualquier duda.`;return`mailto:${e}?subject=${encodeURIComponent("Tu propuesta de viaje")}&body=${encodeURIComponent(l)}`})({email:k?.customer_email,name:k?.customer_name,publicUrl:t}),s=(e=>{if("undefined"==typeof window)return"";const a=window.CASANOVA_GESTION_RESERVAS;return a?.pageBase&&e?`${a.pageBase.replace(/\/$/,"")}#/propuesta/${e}`:""})(d)||((e={})=>{const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.delete("proposal_id"),a.searchParams.delete("action"),Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t?a.searchParams.set(e,t):a.searchParams.delete(e)}),a.toString()})({proposal_id:d}),c=S?"Ver detalle en portal":"Ir al repositorio / ver detalle",u=async()=>{await async function(e){if(!e)return!1;try{if(navigator.clipboard?.writeText)return await navigator.clipboard.writeText(e),!0}catch(e){}const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.top="-1000px",document.body.appendChild(a),a.focus(),a.select();const t=document.execCommand("copy");return document.body.removeChild(a),t}(t)&&(N(!0),window.setTimeout(()=>N(!1),1500))};G=(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Preview y compartir")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)(l.Notice,{status:"success",isDismissible:!1},"edit"===n?"Nueva versión creada:":"Propuesta compartida (marcada como enviada). Versión creada:"," ",(0,a.createElement)("strong",null,$)),"accepted"===m&&v?(0,a.createElement)(l.Notice,{status:"info",isDismissible:!1},"Aceptada el ",xe(v),"."):null,(0,a.createElement)("div",{className:"proposal-wizard__final-meta"},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Estado:")," ",r),(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Aceptacion:")," ",i),(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"GIAV:")," El expediente se creara tras la aceptacion del cliente.")),(0,a.createElement)("div",{className:"proposal-wizard__final-actions"},"accepted"!==m?(0,a.createElement)(l.Button,{variant:"primary",onClick:u,disabled:!t},f?"Enlace copiado":"Copiar enlace publico"):null,o?(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.location.assign(o)},"Preparar email al cliente"):null,t?(0,a.createElement)(l.Button,{variant:"link",href:t,target:"_blank",rel:"noopener noreferrer"},"Abrir vista publica"):null,s?(0,a.createElement)(l.Button,{variant:"link",href:s},c):null,(0,a.createElement)(l.Button,{variant:"tertiary",onClick:e},"Salir"))))}if(!G)return null;if(!s)return G;const F=c>3?3:c;return(0,a.createElement)("div",{className:"proposal-wizard"},(0,a.createElement)("div",{className:"proposal-wizard__stepper"},[{title:"Datos basicos",subtitle:"Identidad y fechas"},{title:"Servicios y precios",subtitle:"Hotel, golf y extras"},{title:"Vista previa y envio",subtitle:"Resumen final"}].map((e,t)=>{const l=t+1,n=F===l?"is-active":F>l?"is-complete":"is-upcoming";return(0,a.createElement)("div",{key:e.title,className:`proposal-wizard__step ${n}`.trim()},(0,a.createElement)("div",{className:"proposal-wizard__step-index"},l),(0,a.createElement)("div",{className:"proposal-wizard__step-text"},(0,a.createElement)("div",{className:"proposal-wizard__step-title"},e.title),(0,a.createElement)("div",{className:"proposal-wizard__step-subtitle"},e.subtitle)))})),(0,a.createElement)("div",{className:"proposal-wizard__content"},G))}function Me({selectedId:e,selectedLabel:n,onPick:r,disabled:i}){const[o,s]=(0,t.useState)(n||""),[c,u]=(0,t.useState)([]),[d,p]=(0,t.useState)(!1),[m,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(""),b=(0,t.useRef)(null);(0,t.useEffect)(()=>{(n||"")!==o&&n&&s(n)},[n]);const h=e?"Seleccionado: "+(n?`${n} (#${e})`:`#${e}`):"Se valida en GIAV al guardar (Proveedor_GET).";return(0,a.createElement)("div",{style:{position:"relative"}},(0,a.createElement)(l.TextControl,{value:o,onChange:function(e){s(e),clearTimeout(b.current),b.current=setTimeout(()=>async function(e){const a=(e||"").trim();if(a.length<2)return u([]),g(""),void p(!1);_(!0),g("");try{const e=await k({q:a,pageSize:20,pageIndex:0,includeDisabled:!1}),t=(Array.isArray(e)?e:Array.isArray(e?.items)?e.items:[]).map(e=>{var a,t,l,n,r,i,o,s;return{id:String(null!==(a=null!==(t=null!==(l=null!==(n=e.id)&&void 0!==n?n:e.ID)&&void 0!==l?l:e.Id)&&void 0!==t?t:e.proveedorId)&&void 0!==a?a:""),label:String(null!==(r=null!==(i=null!==(o=null!==(s=e.label)&&void 0!==s?s:e.NombreAlias)&&void 0!==o?o:e.Nombre)&&void 0!==i?i:e.title)&&void 0!==r?r:"")}}).filter(e=>e.id&&e.label);u(t),p(t.length>0)}catch(e){g(e?.message||"No se pudo buscar en GIAV."),u([]),p(!1)}finally{_(!1)}}(e),250)},onFocus:()=>{c.length>0&&p(!0)},placeholder:"Busca por nombre (mín. 2 letras)…",disabled:i,help:h}),m&&(0,a.createElement)("div",{style:{marginTop:6}},(0,a.createElement)(l.Spinner,null)),v&&(0,a.createElement)("div",{style:{marginTop:6,color:"#b32d2e",fontSize:12}},v),d&&c.length>0&&(0,a.createElement)("div",{style:{position:"absolute",zIndex:30,left:0,right:0,top:"100%",background:"#fff",border:"1px solid #ddd",borderTop:"none",maxHeight:260,overflow:"auto"}},c.map(e=>(0,a.createElement)("div",{key:e.id,onMouseDown:a=>{a.preventDefault(),function(e){s(e.label),u([]),p(!1),g(""),r?.(e)}(e)},style:{padding:"10px 12px",cursor:"pointer",borderBottom:"1px solid #f0f0f0"}},(0,a.createElement)("div",{style:{fontWeight:600}},e.label),(0,a.createElement)("div",{style:{fontSize:12,opacity:.75}},"ID: ",e.id)))))}function Te({status:e}){let t="⚠️ missing";return"active"===e&&(t="✅ active"),"needs_review"===e&&(t="🟠 needs_review"),"deprecated"===e&&(t="⛔ deprecated"),(0,a.createElement)("span",{style:{whiteSpace:"nowrap"}},t)}const Ie="1734698";function Ae(){const[e,n]=(0,t.useState)("hotel"),[r,i]=(0,t.useState)(""),[o,s]=(0,t.useState)(!1),[c,u]=(0,t.useState)(null),[d,p]=(0,t.useState)({items:[],total:0}),[m,_]=(0,t.useState)(50),[v,g]=(0,t.useState)(0),[b,h]=(0,t.useState)({}),[y,S]=(0,t.useState)(null),[C,k]=(0,t.useState)({}),[w,x]=(0,t.useState)({id:"",label:""}),[P,M]=(0,t.useState)(!1),[T,I]=(0,t.useState)(!1),A=(0,t.useMemo)(()=>d.items||[],[d]),B=(0,t.useMemo)(()=>Object.keys(C).filter(e=>C[e]),[C]),R=(0,t.useMemo)(()=>A.length>0&&A.every(e=>C[L(e)]),[A,C]),D=(0,t.useMemo)(()=>A.reduce((e,a)=>{const t=L(a),l=b[t];return l?.providerId&&e.push({key:t,row:a,edit:l}),e},[]),[A,b]),$=D.length,q=Number(d?.total||0),G=(q>0&&Math.ceil(q/m),0===q?0:v*m+1),F=0===q?0:Math.min(q,(v+1)*m),V=v>0,U=q>0&&(v+1)*m<q;function L(e){return`${e.wp_object_type}:${e.wp_object_id}`}function j(e){var a,t,l;const n=L(e),r=b[n]||{},i=e.mapping||{status:"missing"};return{providerId:null!==(a=r.providerId)&&void 0!==a?a:i.giav_entity_id?String(i.giav_entity_id):"",providerName:null!==(t=r.providerName)&&void 0!==t?t:i.giav_supplier_name?String(i.giav_supplier_name):"",status:null!==(l=r.status)&&void 0!==l?l:i.status||"missing"}}async function O({silent:a=!1,pageIndexOverride:t}={}){s(!0),a||u(null);try{const a=(Number.isInteger(t)?t:v)*m,l=await E({type:e,q:r,limit:m,offset:a});return p(l||{items:[],total:0}),{ok:!0}}catch(e){return a||u({status:"error",message:e?.message||"No se pudo cargar el mapeo."}),p({items:[],total:0}),{ok:!1,error:e}}finally{s(!1)}}return(0,t.useEffect)(()=>{g(0),O({pageIndexOverride:0})},[e]),(0,a.createElement)("div",{style:{maxWidth:1100,margin:"24px auto"}},(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"GIAV Mapping")),(0,a.createElement)(l.CardBody,null,c&&(0,a.createElement)(l.Notice,{status:c.status,isDismissible:!0,onRemove:()=>u(null)},c.message),(0,a.createElement)("div",{style:{display:"flex",gap:12,alignItems:"flex-end",marginBottom:12}},(0,a.createElement)(l.SelectControl,{label:"Tipo",value:e,options:[{label:"Hoteles",value:"hotel"},{label:"Campos",value:"golf"}],onChange:e=>n(e)}),(0,a.createElement)(l.TextControl,{label:"Buscar",value:r,onChange:e=>{i(e),g(0)},placeholder:"hotel"===e?"Nombre del hotel…":"Nombre del campo…"}),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>O(),disabled:o},o?(0,a.createElement)(l.Spinner,null):"Actualizar")),(0,a.createElement)("div",{style:{display:"flex",gap:12,alignItems:"flex-end",marginBottom:12,justifyContent:"space-between"}},(0,a.createElement)(l.SelectControl,{label:"Por página",value:String(m),options:[{label:"25",value:"25"},{label:"50",value:"50"},{label:"100",value:"100"},{label:"200",value:"200"}],onChange:e=>{const a=Math.max(1,Math.min(200,parseInt(e,10)||50));_(a),g(0),O({pageIndexOverride:0})}}),(0,a.createElement)("div",{style:{display:"flex",gap:8,alignItems:"flex-end"}},(0,a.createElement)("div",{style:{fontSize:12,opacity:.8,marginBottom:6}},q>0?`Mostrando ${G}–${F} de ${q}`:"Sin resultados"),(0,a.createElement)(l.Button,{variant:"secondary",disabled:o||!V,onClick:()=>{const e=Math.max(0,v-1);g(e),O({pageIndexOverride:e})}},"←"),(0,a.createElement)(l.Button,{variant:"secondary",disabled:o||!U,onClick:()=>{const e=v+1;g(e),O({pageIndexOverride:e})}},"→"))),(0,a.createElement)("div",{style:{display:"flex",gap:12,alignItems:"flex-end",marginBottom:12}},(0,a.createElement)("div",{style:{flex:1}},(0,a.createElement)("label",{style:{display:"block",fontSize:12,marginBottom:4,opacity:.8}},"Aplicar proveedor a seleccionados"),(0,a.createElement)(Me,{selectedId:w?.id,selectedLabel:w?.label,disabled:P,onPick:({id:e,label:a})=>x({id:e,label:a})})),(0,a.createElement)(l.Button,{variant:"primary",onClick:async function(){const a="hotel"===e?"hotel":"course",t=B;if(w?.id)if(0!==t.length){M(!0),u(null);try{var l,n;const e=t.map(e=>{const a=String(e).split(":");return{wp_object_id:parseInt(a[1],10)}}).filter(e=>e.wp_object_id>0),r=await N({wp_object_type:a,giav_supplier_id:String(w.id),items:e,status:"active",match_type:"batch"}),i=`Mapeo en lote aplicado. Creados: ${null!==(l=r?.created)&&void 0!==l?l:0}, actualizados: ${null!==(n=r?.updated)&&void 0!==n?n:0}${r?.errors?.length?`, errores: ${r.errors.length}`:""}.`;u({status:!1===r?.ok?"warning":"success",message:i}),k({}),await O()}catch(e){u({status:"error",message:e?.message||"No se pudo aplicar el mapeo en lote."})}finally{M(!1)}}else u({status:"warning",message:"Selecciona al menos una fila para aplicar el mapeo en lote."});else u({status:"warning",message:"Selecciona un proveedor para aplicar en lote."})},isBusy:P,disabled:P},"Aplicar en lote (",B.length,")"),(0,a.createElement)(l.Button,{variant:"secondary",onClick:async function(){if(0===$)return void u({status:"warning",message:"Asigna al menos un proveedor antes de guardar."});I(!0),u(null);const e=[],a=[];try{for(const{key:t,row:l,edit:n}of D){const r=String(n.providerId)===Ie;try{await f({wp_object_type:l.wp_object_type,wp_object_id:l.wp_object_id,giav_entity_type:"supplier",giav_entity_id:String(n.providerId),giav_supplier_id:String(n.providerId),giav_supplier_name:n.providerName||null,status:r?"needs_review":"active",match_type:r?"auto_generic":"manual"}),e.push(t)}catch(e){const n=l.title||`${l.wp_object_type} #${l.wp_object_id}`;a.push({key:t,title:n,message:e?.message||"No se pudo guardar el mapeo."})}}h(a=>{const t={...a};return e.forEach(e=>{delete t[e]}),t});const t=await O({silent:!0}),l=e.length,n=a.length;let r;const i=[];if(0===n?(r="success",i.push(`Guardado de ${l} fila${1===l?"":"s"} completado.`)):0===l?(r="error",i.push("No se pudo guardar ninguna fila.")):(r="warning",i.push(`Guardado parcial: ${l} OK, ${n} error(es).`)),n>0){const e=a.map(e=>e.title).join(", ");i.push(`Errores: ${e}.`)}if(!t.ok){const e=t.error?.message?`: ${t.error.message}`:" después del guardado";i.push(`Falló la recarga${e}.`),"success"===r&&(r="warning")}u({status:r,message:i.join(" ")})}catch(e){u({status:"error",message:e?.message||"No se pudieron guardar las asignaciones."})}finally{I(!1)}},isBusy:T,disabled:T||0===$},"Guardar asignaciones (",$,")")),(0,a.createElement)("div",{style:{overflowX:"auto"}},(0,a.createElement)("table",{className:"widefat striped"},(0,a.createElement)("thead",null,(0,a.createElement)("tr",null,(0,a.createElement)("th",{style:{width:30}},(0,a.createElement)("input",{type:"checkbox",checked:R,onChange:e=>function(e){const a={};A.forEach(t=>{a[L(t)]=!!e}),k(a)}(e.target.checked)})),(0,a.createElement)("th",null,"Objeto"),(0,a.createElement)("th",null,"Estado"),(0,a.createElement)("th",null,"Proveedor (GIAV)"),(0,a.createElement)("th",null,"Acción"))),(0,a.createElement)("tbody",null,o&&(0,a.createElement)("tr",null,(0,a.createElement)("td",{colSpan:"4",style:{padding:16,textAlign:"center"}},(0,a.createElement)(l.Spinner,null))),!o&&A.map(e=>{const t=L(e),n=j(e);return(0,a.createElement)("tr",{key:t},(0,a.createElement)("td",null,(0,a.createElement)("input",{type:"checkbox",checked:!!C[t],onChange:a=>function(e,a){const t=L(e);k(e=>({...e,[t]:!!a}))}(e,a.target.checked)})),(0,a.createElement)("td",null,(0,a.createElement)("div",{style:{fontWeight:600}},e.title),(0,a.createElement)("div",{style:{opacity:.7,fontSize:12}},e.wp_object_type," #",e.wp_object_id)),(0,a.createElement)("td",null,(0,a.createElement)(Te,{status:e.mapping?.status||"missing"})),(0,a.createElement)("td",null,(0,a.createElement)(Me,{selectedId:n.providerId,selectedLabel:n.providerName||e.mapping?.giav_supplier_name||"",disabled:y&&y!==t,onPick:({id:a,label:t})=>function(e,a){const t=L(e);h(e=>({...e,[t]:{...e[t]||{},...a}}))}(e,{providerId:a,providerName:t,status:"active"})}),e.mapping?.giav_entity_id&&(0,a.createElement)("div",{style:{opacity:.7,fontSize:12,marginTop:4}},"Actual: #",e.mapping.giav_entity_id," ",e.mapping?.giav_supplier_name?(0,a.createElement)("span",null,"(",e.mapping.giav_supplier_name,")"):null," ","(",e.mapping.status,")")),(0,a.createElement)("td",null,(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>async function(e){const a=L(e),t=j(e);if(!t.providerId)return void u({status:"warning",message:"Selecciona un proveedor de GIAV."});S(a),u(null);const l=String(t.providerId)===Ie;try{await f({wp_object_type:e.wp_object_type,wp_object_id:e.wp_object_id,giav_entity_type:"supplier",giav_entity_id:String(t.providerId),giav_supplier_id:String(t.providerId),giav_supplier_name:t.providerName||null,status:l?"needs_review":"active",match_type:l?"auto_generic":"manual"}),u({status:"success",message:"Mapeo guardado (validado en GIAV)."}),h(e=>{const t={...e};return delete t[a],t}),await O()}catch(e){u({status:"error",message:e?.message||"No se pudo guardar el mapeo."})}finally{S(null)}}(e),isBusy:y===t,disabled:y&&y!==t},"Guardar")))}),!o&&0===(d.items||[]).length&&(0,a.createElement)("tr",null,(0,a.createElement)("td",{colSpan:"4",style:{padding:16,textAlign:"center",opacity:.7}},"Sin resultados."))))))))}const Be=[{key:"package",label:"Paquete"},{key:"first_name",label:"Nombre"},{key:"last_name",label:"Apellido"},{key:"email",label:"Email"},{key:"telefono",label:"Tel�fono"},{key:"fecha_llegada",label:"Fecha llegada"},{key:"fecha_regreso",label:"Fecha regreso"},{key:"green_fees_per_player",label:"Green-fees por jugador"},{key:"jugadores",label:"Jugadores"},{key:"no_jugadores",label:"No jugadores"},{key:"vuelos_checkbox",label:"Checkbox vuelos"},{key:"aeropuerto_salida",label:"Aeropuerto salida"},{key:"mas_info",label:"M�s info"}];function Re(){const[e,n]=(0,t.useState)({es_form_id:"",en_form_id:""}),[r,i]=(0,t.useState)({}),[o,s]=(0,t.useState)({}),[c,u]=(0,t.useState)(!0),[d,p]=(0,t.useState)(null),[m,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(null),b=async()=>{u(!0),p(null);try{const e=await P();n({es_form_id:e.forms?.es_form_id||"",en_form_id:e.forms?.en_form_id||""}),s(e.mappings||{}),i(e.fields||{})}catch(e){p({status:"error",message:e.message||"No se pudo cargar la configuración."})}finally{u(!1)}};(0,t.useEffect)(()=>{b()},[]);const h=(e,a)=>{n(t=>({...t,[e]:a}))},y=(0,t.useMemo)(()=>[{label:"Formulario ES",key:"es_form_id",id:e.es_form_id},{label:"Formulario EN",key:"en_form_id",id:e.en_form_id}],[e]);return(0,a.createElement)("div",{style:{maxWidth:1100,margin:"24px auto"}},(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Solicitudes recibidas (Gravity Forms)")),(0,a.createElement)(l.CardBody,null,d&&(0,a.createElement)(l.Notice,{status:d.status,isDismissible:!0,onRemove:()=>p(null)},d.message),(0,a.createElement)("div",{style:{display:"grid",gap:12,marginBottom:18}},(0,a.createElement)("p",{style:{margin:0,color:"#475569"}},"Configura los IDs de los formularios en español y en inglés para que el plugin pueda sincronizar las entradas."),(0,a.createElement)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:12}},(0,a.createElement)(l.TextControl,{label:"Form ID (ES)",value:e.es_form_id,onChange:e=>h("es_form_id",e),placeholder:"Id del formulario en español"}),(0,a.createElement)(l.TextControl,{label:"Form ID (EN)",value:e.en_form_id,onChange:e=>h("en_form_id",e),placeholder:"Id del formulario en inglés"})),(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{_(!0),p(null);try{await M({es_form_id:e.es_form_id,en_form_id:e.en_form_id}),p({status:"success",message:"IDs guardados correctamente."}),await b()}catch(e){p({status:"error",message:e.message||"No se pudieron guardar los IDs."})}finally{_(!1)}},isBusy:m,disabled:m},"Guardar formularios")),c?(0,a.createElement)("div",{style:{textAlign:"center",padding:32}},(0,a.createElement)(l.Spinner,null)):y.map(e=>{if(!e.id)return(0,a.createElement)("div",{key:e.key,style:{padding:16,border:"1px solid #e5e7eb",borderRadius:12,marginBottom:16}},(0,a.createElement)("strong",null,e.label),(0,a.createElement)("p",{style:{marginTop:4,color:"#6b7280"}},"Configura primero el ID del formulario para ver el mapping."));const t=r[e.id]||[],n=o[e.id]||{};return(0,a.createElement)("div",{key:e.id,style:{marginBottom:24,borderRadius:16,border:"1px solid #e5e7eb",padding:16,background:"#f8fafc"}},(0,a.createElement)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,e.label),(0,a.createElement)("p",{style:{margin:"4px 0 0",color:"#475569"}},"Form ID #",e.id)),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>(async e=>{g(e),p(null);try{const a={};Be.forEach(t=>{o[e]?.[t.key]&&(a[t.key]=o[e][t.key])}),await T(e,a),p({status:"success",message:"Mapeo guardado."}),g(null),await b()}catch(e){p({status:"error",message:e.message||"No se pudo guardar el mapeo."}),g(null)}})(e.id),isBusy:v===e.id,disabled:v===e.id},"Guardar mapeo")),(0,a.createElement)("div",{style:{marginTop:16,display:"grid",gap:12}},Be.map(t=>(0,a.createElement)(l.TextControl,{key:t.key,label:`${t.label} - ID del campo`,value:n[t.key]||"",onChange:a=>((e,a,t)=>{s(l=>({...l,[e]:{...l[e]||{},[a]:t}}))})(e.id,t.key,a),placeholder:`ID del campo ${t.label}`}))),t.length?(0,a.createElement)("details",{style:{marginTop:16}},(0,a.createElement)("summary",{style:{cursor:"pointer",fontWeight:600,color:"#1d4ed8"}},"Campos disponibles (ID / etiqueta)"),(0,a.createElement)("div",{style:{display:"grid",gap:6,marginTop:8}},t.map(t=>(0,a.createElement)("div",{key:`${e.id}-${t.id}`,style:{fontSize:13,color:"#475569"}},"#",t.id," — ",t.label||"Sin etiqueta"," ",(0,a.createElement)("small",null,"(",t.type,")"))))):(0,a.createElement)("p",{style:{marginTop:16,color:"#6b7280"}},"Sin campos registrados para este formulario."))}))))}const De={new:"Nueva",contacted:"Contactado",quoting:"Cotizando",proposal_sent:"Propuesta enviada",won:"Ganada",lost:"Perdida",archived:"Archivada"},$e=e=>{if(!e)return"—";const a=new Date(e);return Number.isNaN(a.getTime())?e:a.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:"numeric"})},qe=e=>{if(!e)return null;const a=String(e).trim();if(!a)return null;const t=a.match(/^(\d{4})-(\d{2})-(\d{2})/);if(t){const[,e,a,l]=t;return Date.UTC(parseInt(e,10),parseInt(a,10)-1,parseInt(l,10))}const l=a.match(/^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})/);if(l){const[,e,a,t]=l,n=2===t.length?2e3+parseInt(t,10):parseInt(t,10);return Date.UTC(n,parseInt(a,10)-1,parseInt(e,10))}const n=new Date(a);return Number.isNaN(n.getTime())?null:n.getTime()},Ge=()=>{const[e,n]=(0,t.useState)({es_form_id:"",en_form_id:""}),[r,i]=(0,t.useState)(!0),[o,s]=(0,t.useState)(!0),[c,u]=(0,t.useState)(""),[d,p]=(0,t.useState)([]),[m,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(""),[b,h]=(0,t.useState)(null),[y,E]=(0,t.useState)({status:"",lang:"",q:"",page:1}),[f,N]=(0,t.useState)({total_pages:1,page:1,total:0}),[k,w]=(0,t.useState)(null),[x,M]=(0,t.useState)("asc"),T=(0,t.useRef)(y),I=Boolean(e.es_form_id||e.en_form_id),A=(0,t.useMemo)(()=>{const e=new URL(window.location.href);return e.searchParams.set("page","wp-travel-giav-requests-settings"),e.toString()},[]);(0,t.useEffect)(()=>{T.current=y},[y]);const B=(0,t.useCallback)(async()=>{s(!0),u("");try{const e=await P();n({es_form_id:e.forms?.es_form_id||"",en_form_id:e.forms?.en_form_id||""}),i(!0)}catch(e){503===e?.status?(i(!1),u("Gravity Forms no está activo o no responde.")):u(e?.message||"No se pudo cargar la configuración.")}finally{s(!1)}},[]);(0,t.useEffect)(()=>{B()},[B]);const R=(0,t.useCallback)(async()=>{if(!m&&r&&I){_(!0),g("");try{const e=T.current,a=await S({status:e.status||void 0,lang:e.lang||void 0,q:e.q?.trim()||void 0,page:e.page,per_page:20}),t=Array.isArray(a?.items)?a.items:[];p(t),N({total_pages:a.total_pages||1,page:a.page||e.page,total:a.total||t.length})}catch(e){g(e?.message||"No se pudieron cargar las solicitudes."),p([])}finally{_(!1)}}},[r,I]);(0,t.useEffect)(()=>{!o&&r&&I&&R()},[o,r,I,R]);const D=(e,a)=>{E(t=>{const l={...t,[e]:a};return"page"!==e&&(l.page=1),T.current=l,l})},$=(0,t.useMemo)(()=>[{value:"",label:"Todos los estados"},...Object.entries(De).map(([e,a])=>({value:e,label:a}))],[]),q=e=>{const a="next"===e?f.page+1:f.page-1;a<1||a>(f.total_pages||1)||(D("page",a),R())},G=(0,t.useMemo)(()=>{const e=[...d];return e.sort((e,a)=>{const t=qe(e?.mapped?.fecha_llegada),l=qe(a?.mapped?.fecha_llegada);return null===t&&null===l?0:null===t?1:null===l?-1:"asc"===x?t-l:l-t}),e},[d,x]);return(0,a.createElement)("div",{className:"wp-travel-giav-app"},(0,a.createElement)("div",{className:"requests-list-admin"},(0,a.createElement)("header",{className:"requests-list-admin__header"},(0,a.createElement)("div",null,(0,a.createElement)("h1",null,"Solicitudes recibidas"),(0,a.createElement)("p",null,"Sincroniza Gravity Forms, filtra y convierte solicitudes en propuestas.")),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>window.location.href=A},"Configurar formularios")),o&&(0,a.createElement)("div",{className:"requests-list-admin__loading"},(0,a.createElement)(l.Spinner,null)),!o&&!r&&(0,a.createElement)(l.Notice,{status:"error"},"Gravity Forms no está activo. Instala o actívalo para continuar.",(0,a.createElement)("div",{style:{marginTop:8}},(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>window.location.href=A},"Configurar formularios"))),!o&&r&&!I&&(0,a.createElement)(l.Notice,{status:"warning"},"No hay formularios configurados. Asigna los IDs ES/EN para sincronizar las solicitudes.",(0,a.createElement)("div",{style:{marginTop:8}},(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>window.location.href=A},"Configurar formularios"))),c&&r&&(0,a.createElement)(l.Notice,{status:"error"},c),b&&(0,a.createElement)(l.Notice,{status:b.status,isDismissible:!0,onRemove:()=>h(null)},b.message),v&&(0,a.createElement)(l.Notice,{status:"error"},v),r&&I&&(0,a.createElement)(a.Fragment,null,(0,a.createElement)("div",{className:"requests-list-admin__filters"},(0,a.createElement)(l.TextControl,{label:"Buscar",value:y.q,onChange:e=>D("q",e),placeholder:"Cliente, email o ID"}),(0,a.createElement)(l.SelectControl,{label:"Estado",value:y.status,options:$,onChange:e=>D("status",e)}),(0,a.createElement)(l.SelectControl,{label:"Idioma",value:y.lang,options:[{value:"",label:"Todos los idiomas"},{value:"es",label:"Español"},{value:"en",label:"English"}],onChange:e=>D("lang",e)}),(0,a.createElement)(l.Button,{variant:"primary",onClick:R,disabled:m},"Actualizar listado")),(0,a.createElement)("div",{className:"requests-list-admin__table"},(0,a.createElement)("div",{className:"requests-list-admin__row requests-list-admin__row--header"},(0,a.createElement)("span",null,"Fecha"),(0,a.createElement)("span",null,"Cliente"),(0,a.createElement)("span",null,"Paquete"),(0,a.createElement)("span",null,"Email"),(0,a.createElement)("button",{type:"button",className:"requests-list-admin__sort-button is-active",onClick:()=>M(e=>"asc"===e?"desc":"asc"),"aria-pressed":"true","aria-label":"Llegada "+("asc"===x?"orden ascendente":"orden descendente")},(0,a.createElement)("span",{className:"requests-list-admin__sort-label"},"Llegada"),(0,a.createElement)("span",{className:"requests-list-admin__sort-icon","data-order":x},(0,a.createElement)("svg",{viewBox:"0 0 12 14",role:"presentation",focusable:"false"},(0,a.createElement)("path",{className:"requests-list-admin__sort-arrow requests-list-admin__sort-arrow--up",d:"M3 8.5L6 5l3 3.5"}),(0,a.createElement)("path",{className:"requests-list-admin__sort-arrow requests-list-admin__sort-arrow--down",d:"M3 5.5L6 9l3-3.5"})))),(0,a.createElement)("span",null,"PAX"),(0,a.createElement)("span",null,"Idioma / Estado"),(0,a.createElement)("span",null,"Acciones")),m&&(0,a.createElement)("div",{className:"requests-list-admin__row requests-list-admin__row--loading"},(0,a.createElement)(l.Spinner,null),(0,a.createElement)("span",null,"Cargando solicitudes…")),!m&&0===d.length&&(0,a.createElement)("div",{className:"requests-list-admin__empty"},"No hay solicitudes registradas para los filtros actuales."),!m&&G.map(e=>{const t=e.mapped||{},n=e.status||"new",r=t.pax_total||(t.jugadores||0)+(t.no_jugadores||0);return(0,a.createElement)("div",{key:e.id,className:"requests-list-admin__row"},(0,a.createElement)("span",null,$e(e.created_at)),(0,a.createElement)("span",null,(0,a.createElement)("strong",null,((e={})=>[e.first_name||e.nombre||"",e.last_name||e.apellido||""].filter(Boolean).join(" ")||(e.customer_name?e.customer_name:"Sin nombre"))(t)),(0,a.createElement)("br",null),(0,a.createElement)("small",null,"ID GF #",e.entry_id)),(0,a.createElement)("span",null,t.package||"—"),(0,a.createElement)("span",null,t.email||"—"),(0,a.createElement)("span",null,$e(t.fecha_llegada)||"—"," - ",$e(t.fecha_regreso)||"—"),(0,a.createElement)("span",null,r),(0,a.createElement)("span",null,(0,a.createElement)("span",{className:`requests-list-admin__status requests-list-admin__status--${n}`},De[n]||n),(0,a.createElement)("br",null),(0,a.createElement)("small",null,e.lang?.toUpperCase()||"ES")),(0,a.createElement)("span",{className:"requests-list-admin__actions"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>(async e=>{w(e),h(null);try{const a=await C(e);if(a?.admin_edit_url)return void window.location.assign(a.admin_edit_url);if(a?.edit_url)return void window.location.assign(a.edit_url);h({status:"success",message:"Propuesta creada correctamente."}),R()}catch(e){h({status:"error",message:e?.message||"No se pudo convertir la solicitud."})}finally{w(null)}})(e.id),disabled:k===e.id,isBusy:k===e.id},"Convertir"),e.proposal_id&&(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>window.location.assign((e=>{if(!e)return"";const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.set("proposal_id",e),a.searchParams.delete("action"),a.toString()})(e.proposal_id))},"Abrir propuesta")))})),(0,a.createElement)("div",{className:"requests-list-admin__pagination"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>q("prev"),disabled:f.page<=1},"Anterior"),(0,a.createElement)("span",null,"Página ",f.page," de ",f.total_pages||1),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>q("next"),disabled:f.page>=(f.total_pages||1)},"Siguiente")))))};function Fe(e){if(!e)return"-";const a=new Date(e);return Number.isNaN(a.getTime())?e:new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short"}).format(a)}const Ve={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",queued:"En cola",synced:"Sincronizada",error:"Error",revoked:"Revocada",lost:"Perdida"},Ue={client:"Cliente",admin:"Admin"},Le={pending:"Pendiente",confirmed:"Confirmada"},je={none:"No iniciado",pending:"En proceso",ok:"Creado",error:"Error"};function Oe(e={}){const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.delete("proposal_id"),a.searchParams.delete("action"),Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t?a.searchParams.set(e,t):a.searchParams.delete(e)}),a.toString()}function He({proposalId:e}){var n;const[r,i]=(0,t.useState)(!1),[o,s]=(0,t.useState)(""),[u,d]=(0,t.useState)(null),[p,m]=(0,t.useState)(!1),[_,h]=(0,t.useState)(null),[y,E]=(0,t.useState)(""),[f,N]=(0,t.useState)(!1),[S,C]=(0,t.useState)(!1),k=async()=>{i(!0),s("");try{const a=await c(e);d(a)}catch(e){s(e?.message||"No se pudo cargar la propuesta.")}finally{i(!1)}};if((0,t.useEffect)(()=>{if(!e)return d(null),void s("Propuesta no encontrada.");k()},[e]),(0,t.useEffect)(()=>{if(u?.proposal){const e=u.proposal.current_version_id;E(e?String(e):"")}},[u?.proposal?.current_version_id]),r&&!u)return(0,a.createElement)(l.Spinner,null);if(!u?.proposal&&o)return(0,a.createElement)("div",{style:{display:"grid",gap:12}},(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>s("")},o),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.location.href=Oe()},"Volver al listado"));if(!u?.proposal)return(0,a.createElement)("div",{style:{display:"grid",gap:12}},(0,a.createElement)(l.Notice,{status:"warning",isDismissible:!1},"Propuesta no encontrada."),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.location.href=Oe()},"Volver al listado"));const{proposal:w,versions:x=[]}=u,P=Le[w.confirmation_status]||("accepted"===w.status?"Pendiente":"-"),M=x.find(e=>Number(e.id)===Number(w.accepted_version_id)),T=x.find(e=>String(e.id)===String(y)),A=x.map(e=>{var a;return{label:`#${null!==(a=e.version_number)&&void 0!==a?a:e.id} · ${Fe(e.created_at)}`,value:String(e.id)}}),B=Ve[w.status]||w.status||"-",R=w.giav_sync_status||"none",D=je[R]||R||"-",$="accepted"===w.status,q=Boolean(w.giav_expediente_id),G="error"===R,F="pending"===R,V=[{label:"ID cliente",value:w.giav_client_id},{label:"ID expediente",value:w.giav_expediente_id},{label:"ID reserva PQ",value:w.giav_pq_reserva_id}].filter(e=>e.value),U=I(w.first_name,w.last_name,w.customer_name)||"-";return(0,a.createElement)("div",{style:{display:"grid",gap:16}},o&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>s("")},o),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-detail__header"},(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__eyebrow"},"Detalle de propuesta · #",w.id),(0,a.createElement)("div",{className:"proposal-detail__title-row"},(0,a.createElement)("h2",{className:"proposal-detail__title"},w.proposal_title||"Propuesta sin título"),(0,a.createElement)("span",{className:`proposal-status proposal-status--${w.status||"draft"} proposal-status--large`},B))),(0,a.createElement)("div",{className:"proposal-detail__actions"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>{window.location.href=Oe({proposal_id:w.id,action:"edit"})}},"Editar propuesta"),w.public_url?(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>window.open(w.public_url,"_blank","noopener")},"Abrir vista pública"):null,(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>{window.location.href=Oe()}},"Volver al listado")))),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{className:"proposal-detail__summary"},(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Cliente"),(0,a.createElement)("div",{className:"proposal-detail__value"},U)),(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Email"),(0,a.createElement)("div",{className:"proposal-detail__value"},w.customer_email||"-")),(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Fechas"),(0,a.createElement)("div",{className:"proposal-detail__value"},w.start_date," - ",w.end_date)),(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Última actualización"),(0,a.createElement)("div",{className:"proposal-detail__value"},Fe(w.updated_at)))))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Enlace para cliente")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{className:"proposal-detail__block"},(0,a.createElement)(l.TextControl,{label:"URL pública",value:w.public_url||"",readOnly:!0}),(0,a.createElement)("p",{className:"proposal-detail__helper"},"Este es el enlace que verá el cliente."),(0,a.createElement)("div",{className:"proposal-detail__button-row"},(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{await async function(e){if(!e)return!1;try{if(navigator.clipboard?.writeText)return await navigator.clipboard.writeText(e),!0}catch(e){}const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.top="-1000px",document.body.appendChild(a),a.focus(),a.select();const t=document.execCommand("copy");return document.body.removeChild(a),t}(w.public_url)&&(m(!0),window.setTimeout(()=>m(!1),1500))}},p?"Enlace copiado":"Copiar"),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.open(w.public_url,"_blank","noopener")},"Abrir"))))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-detail__section-title"},(0,a.createElement)("strong",null,"Estado de aceptación"),(0,a.createElement)("span",{className:"proposal-detail__pill "+($?"proposal-detail__pill--success":"proposal-detail__pill--warning")},$?"Aceptada":"Pendiente de aceptación"))),(0,a.createElement)(l.CardBody,null,$?(0,a.createElement)("div",{className:"proposal-detail__grid"},(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Fecha de aceptación"),(0,a.createElement)("div",{className:"proposal-detail__value"},Fe(w.accepted_at))),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Aceptada por"),(0,a.createElement)("div",{className:"proposal-detail__value"},Ue[w.accepted_by]||"-")),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Versión aceptada"),(0,a.createElement)("div",{className:"proposal-detail__value"},M?`#${null!==(n=M.version_number)&&void 0!==n?n:M.id}`:w.accepted_version_id||"-")),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Confirmación"),(0,a.createElement)("div",{className:"proposal-detail__value"},P))):(0,a.createElement)("div",{className:"proposal-detail__block"},(0,a.createElement)(l.SelectControl,{label:"Versión a aceptar",value:y,options:A,onChange:e=>E(e),disabled:f||0===A.length}),(0,a.createElement)("div",{className:"proposal-detail__button-row"},(0,a.createElement)(l.Button,{variant:"primary",disabled:f||!T,onClick:async()=>{N(!0),s("");try{await g(w.id,T.id),await k()}catch(e){s(e?.message||"No se pudo marcar como aceptada.")}finally{N(!1)}}},"Marcar como aceptada"))))),(w.traveler_full_name||w.traveler_dni)&&(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Datos del viajero")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{style:{display:"grid",gap:8}},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Nombre completo:")," ",w.traveler_full_name||"-"),(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"DNI:")," ",w.traveler_dni||"-")))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-detail__section-title"},(0,a.createElement)("strong",null,"Integración GIAV"),(0,a.createElement)("span",{className:"proposal-detail__pill proposal-detail__pill--"+("ok"===R?"success":"error"===R?"danger":"pending"===R?"warning":"neutral")},D))),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{className:"proposal-detail__block"},V.length>0?(0,a.createElement)("div",{className:"proposal-detail__grid"},V.map(e=>(0,a.createElement)("div",{key:e.label},(0,a.createElement)("div",{className:"proposal-detail__label"},e.label),(0,a.createElement)("div",{className:"proposal-detail__value"},e.value))),w.giav_sync_updated_at?(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Última actualización"),(0,a.createElement)("div",{className:"proposal-detail__value"},Fe(w.giav_sync_updated_at))):null):(0,a.createElement)("p",{className:"proposal-detail__helper"},"Aún no hay identificadores de GIAV vinculados."),w.giav_sync_error?(0,a.createElement)("div",{className:"proposal-detail__error"},(0,a.createElement)("strong",null,"Error:")," ",w.giav_sync_error):null,(0,a.createElement)("div",{className:"proposal-detail__cta"},$?G&&!q?(0,a.createElement)(l.Button,{variant:"primary",disabled:S,onClick:async()=>{C(!0),s("");try{await b(w.id),await k()}catch(e){s(e?.message||"No se pudo reintentar GIAV.")}finally{C(!1)}}},"Reintentar GIAV"):q||F?F?(0,a.createElement)("span",{className:"proposal-detail__helper"},"En proceso de creación en GIAV."):(0,a.createElement)("span",{className:"proposal-detail__helper"},"Expediente creado y sincronizado."):(0,a.createElement)(l.Button,{variant:"primary",disabled:S,onClick:async()=>{C(!0),s("");try{await b(w.id),await k()}catch(e){s(e?.message||"No se pudo crear en GIAV.")}finally{C(!1)}}},"Crear expediente en GIAV"):(0,a.createElement)("span",{className:"proposal-detail__helper"},"Disponible tras aceptación."))))),"accepted"===w.status&&(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Siguiente paso")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("p",{style:{margin:0}},"Confirmar disponibilidad y servicios. Cuando esté confirmada, se invitará al portal (futuro)."))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Versiones")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("details",{className:"proposal-detail__versions",open:!0},(0,a.createElement)("summary",null,"Histórico de versiones (",x.length,")"),(0,a.createElement)("div",{className:"proposal-detail__table"},(0,a.createElement)("table",{className:"wp-list-table widefat fixed striped"},(0,a.createElement)("thead",null,(0,a.createElement)("tr",null,(0,a.createElement)("th",null,"ID"),(0,a.createElement)("th",null,"Versión"),(0,a.createElement)("th",null,"Fecha"),(0,a.createElement)("th",null,"Total comercial"),(0,a.createElement)("th",null,"Estado"),(0,a.createElement)("th",null,"Acciones"))),(0,a.createElement)("tbody",null,0===x.length?(0,a.createElement)("tr",null,(0,a.createElement)("td",{colSpan:6},"No hay versiones.")):x.map(e=>{var t,n;const r=Number(w.current_version_id)===Number(e.id),i=Number(w.accepted_version_id)===Number(e.id);return(0,a.createElement)("tr",{key:e.id,className:i?"proposal-detail__row--accepted":void 0},(0,a.createElement)("td",null,e.id),(0,a.createElement)("td",null,null!==(t=e.version_number)&&void 0!==t?t:"-"),(0,a.createElement)("td",null,Fe(e.created_at)),(0,a.createElement)("td",null,null!==(n=e.totals_sell_price)&&void 0!==n?n:"-"),(0,a.createElement)("td",null,(0,a.createElement)("div",{className:"proposal-detail__version-badges"},r&&(0,a.createElement)("span",{className:"proposal-detail__pill proposal-detail__pill--info"},"Vigente"),i&&(0,a.createElement)("span",{className:"proposal-detail__pill proposal-detail__pill--success"},"Aceptada"),r||i?null:"—")),(0,a.createElement)("td",null,(0,a.createElement)("div",{className:"proposal-detail__action-stack"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.open(e.public_url||w.public_url,"_blank","noopener")},"Ver"),!r&&(0,a.createElement)(l.Button,{variant:"tertiary",disabled:_===e.id,onClick:async()=>{h(e.id);try{await v(w.id,e.id),await k()}catch(e){s(e?.message||"No se pudo actualizar la versión vigente.")}finally{h(null)}}},"Marcar vigente"))))}))))))))}const ze={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",queued:"En cola",synced:"Sincronizada",error:"Error",revoked:"Revocada",lost:"Perdida"},Ke=(e={})=>{const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.delete("proposal_id"),a.searchParams.delete("action"),Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t?a.searchParams.set(e,t):a.searchParams.delete(e)}),a.toString()};function We({page:e=""}={}){const n=new URLSearchParams(window.location.search||""),r=n.get("page")||"",i=e||r,o=n.get("proposal_id"),u=n.get("action");if("wp-travel-giav-requests"===i)return(0,a.createElement)(Ge,null);if("wp-travel-giav-requests-settings"===i)return(0,a.createElement)(Re,null);if("wp-travel-giav-mapping"===i)return(0,a.createElement)(Ae,null);const[m,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(null),[b,h]=(0,t.useState)(!1),[y,E]=(0,t.useState)(""),[f,N]=(0,t.useState)([]),[S,C]=(0,t.useState)(!1),[k,w]=(0,t.useState)(""),[x,P]=(0,t.useState)(""),[M,T]=(0,t.useState)("updated_at"),[A,B]=(0,t.useState)("desc"),[R,D]=(0,t.useState)([]),$=o?parseInt(o,10):null,q=Number.isNaN($)?null:$,G="edit"===u&&q;(0,t.useEffect)(()=>{if(!G)return g(null),void E("");let e=!0;return(async()=>{h(!0),E("");try{const a=await c(q);e&&g(a)}catch(a){e&&E(a?.message||"No se pudo cargar la propuesta para editar.")}finally{e&&h(!1)}})(),()=>{e=!1}},[G,q]);const F=(0,t.useMemo)(()=>v?.proposal?{initialProposal:v.proposal,initialSnapshot:v.current_snapshot,nextVersionNumber:v.next_version_number||1}:null,[v]),V=async({nextSearch:e}={})=>{C(!0),w("");try{const a=void 0!==e?e:x,t=await s({orderBy:M,order:A,limit:50,offset:0,search:a?.trim()?a.trim():void 0}),l=Array.isArray(t?.items)?t.items:Array.isArray(t)?t:[];N(l),D(e=>e.filter(e=>l.some(a=>a.id===e)))}catch(e){w(e?.message||"No se pudo cargar el repositorio."),N([])}finally{C(!1)}};return(0,t.useEffect)(()=>{V()},[M,A]),m?(0,a.createElement)(Pe,{onExit:()=>_(!1)}):G?b?(0,a.createElement)("div",{style:{padding:16}},"Cargando..."):y?(0,a.createElement)("div",{style:{padding:16,color:"#b91c1c"}},y):F?(0,a.createElement)(Pe,{onExit:()=>{const e=new URL(window.location.href);e.searchParams.set("page","travel_proposals"),e.searchParams.set("proposal_id",q),e.searchParams.delete("action"),window.location.href=e.toString()},mode:"edit",...F}):null:q?(0,a.createElement)(He,{proposalId:q}):(0,a.createElement)("div",{className:"wp-travel-giav-app"},(0,a.createElement)(l.Card,{className:"proposal-list"},(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-list__header"},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Repositorio de propuestas"),(0,a.createElement)("div",{className:"proposal-list__subtitle"},"Gestiona propuestas creadas, revisa su estado y accede al detalle.")),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>_(!0)},"Nueva propuesta"))),(0,a.createElement)(l.CardBody,null,k?(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>w("")},k):null,(0,a.createElement)("div",{className:"proposal-list__filters"},(0,a.createElement)("div",{className:"proposal-list__search"},(0,a.createElement)("label",{className:"proposal-list__search-label",htmlFor:"proposal-search"},"Buscar cliente"),(0,a.createElement)("input",{id:"proposal-search",className:"proposal-list__search-input",type:"search",value:x,onChange:e=>P(e.target.value),placeholder:"Cliente, email o token"})),(0,a.createElement)(l.SelectControl,{label:"Ordenar por",value:M,options:[{label:"Última actualización",value:"updated_at"},{label:"ID",value:"id"}],onChange:e=>T(e)}),(0,a.createElement)(l.SelectControl,{label:"Orden",value:A,options:[{label:"Descendente",value:"desc"},{label:"Ascendente",value:"asc"}],onChange:e=>B(e)}),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>V({nextSearch:x}),disabled:S},"Buscar"),(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>{P(""),V({nextSearch:""})},disabled:S},"Limpiar filtros"),(0,a.createElement)(l.Button,{variant:"secondary",isDestructive:!0,onClick:async()=>{if(window.confirm(`¿Seguro que quieres eliminar ${R.length} propuestas?`)){C(!0),w("");try{await p(R),D([]),await V()}catch(e){w(e?.message||"No se pudieron eliminar las propuestas.")}finally{C(!1)}}},disabled:S||0===R.length},"Eliminar seleccionadas (",R.length,")")),(0,a.createElement)("div",{className:"proposal-list__table"},(0,a.createElement)("div",{className:"proposal-list__row proposal-list__row--header"},(0,a.createElement)("div",{className:"proposal-list__select"},(0,a.createElement)(l.CheckboxControl,{checked:R.length===f.length&&f.length>0,onChange:()=>{R.length!==f.length?D(f.map(e=>e.id)):D([])}})),(0,a.createElement)("div",null,"ID"),(0,a.createElement)("div",null,"Título"),(0,a.createElement)("div",null,"Cliente"),(0,a.createElement)("div",null,"Estado"),(0,a.createElement)("div",null,"Última actualización"),(0,a.createElement)("div",null,"Autor"),(0,a.createElement)("div",null,"Acciones")),S?(0,a.createElement)("div",{className:"proposal-list__row proposal-list__row--loading"},(0,a.createElement)(l.Spinner,null),(0,a.createElement)("span",null,"Cargando propuestas…")):null,S||0!==f.length?null:(0,a.createElement)("div",{className:"proposal-list__empty"},"No hay propuestas aún."),!S&&f.map(e=>{const t=ze[e.status]||e.status||"—",n=e.display_title||e.proposal_title||"—";return(0,a.createElement)("div",{key:e.id,className:"proposal-list__row"},(0,a.createElement)("div",{className:"proposal-list__select"},(0,a.createElement)(l.CheckboxControl,{checked:R.includes(e.id),onChange:()=>(e=>{D(a=>a.includes(e)?a.filter(a=>a!==e):[...a,e])})(e.id)})),(0,a.createElement)("div",{className:"proposal-list__id"},"#",e.id),(0,a.createElement)("div",{className:"proposal-list__title"},n),(0,a.createElement)("div",{className:"proposal-list__customer"},(0,a.createElement)("div",{className:"proposal-list__customer-name"},I(e.first_name,e.last_name,e.customer_name)||"—"),(0,a.createElement)("div",{className:"proposal-list__customer-meta"},e.start_date||"—"," - ",e.end_date||"—")),(0,a.createElement)("div",null,(0,a.createElement)("span",{className:`proposal-status proposal-status--${e.status||"draft"}`},t)),(0,a.createElement)("div",null,(e=>{if(!e)return"—";const a=String(e),t=a.includes("T")?a:a.replace(" ","T"),l=new Date(t);return Number.isNaN(l.getTime())?e:l.toLocaleString("es-ES",{dateStyle:"medium",timeStyle:"short"})})(e.updated_at)),(0,a.createElement)("div",null,e.author_name||"—"),(0,a.createElement)("div",{className:"proposal-list__actions"},(0,a.createElement)(l.Button,{variant:"secondary",href:Ke({proposal_id:e.id})},"Ver detalle"),(0,a.createElement)(l.DropdownMenu,{className:"proposal-list__actions-menu",icon:"ellipsis",label:"Más acciones",controls:[{title:"Editar",onClick:()=>{window.location.href=Ke({proposal_id:e.id,action:"edit"})}},...e.public_url?[{title:"Vista pública",onClick:()=>{window.open(e.public_url,"_blank","noopener,noreferrer")}}]:[],{title:"Eliminar",isDestructive:!0,onClick:()=>(async e=>{if(window.confirm("¿Seguro que quieres eliminar esta propuesta?")){C(!0),w("");try{await d(e),D(a=>a.filter(a=>a!==e)),await V()}catch(e){w(e?.message||"No se pudo eliminar la propuesta.")}finally{C(!1)}}})(e.id)}]})))})))))}const Je=document.getElementById("wp-travel-giav-admin"),Ze=document.getElementById("wp-travel-giav-requests"),Ye=document.getElementById("wp-travel-giav-requests-settings"),Qe=(e,l="")=>{e&&(0,t.createRoot)(e).render((0,a.createElement)(We,{page:l}))};Qe(Je),Qe(Ze,"wp-travel-giav-requests"),Qe(Ye,"wp-travel-giav-requests-settings")})();