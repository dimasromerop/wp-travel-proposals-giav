(()=>{"use strict";var e={n:a=>{var t=a&&a.__esModule?()=>a.default:()=>a;return e.d(t,{a:t}),t},d:(a,t)=>{for(var l in t)e.o(t,l)&&!e.o(a,l)&&Object.defineProperty(a,l,{enumerable:!0,get:t[l]})},o:(e,a)=>Object.prototype.hasOwnProperty.call(e,a)};const a=window.React,t=window.wp.element,l=window.wp.components,n=window.wp.apiFetch;var r=e.n(n);r().use(r().createNonceMiddleware(WP_TRAVEL_GIAV.nonce));const i=e=>r()({path:"/travel/v1/proposals",method:"POST",data:e}),o=({orderBy:e="updated_at",order:a="desc",limit:t=50,offset:l=0,search:n,author:i,page:o,per_page:s}={})=>{const c=new URLSearchParams;return c.set("order_by",e),c.set("order",a),c.set("limit",t),c.set("offset",l),void 0!==n&&c.set("search",n),void 0!==i&&c.set("author",i),void 0!==o&&c.set("page",o),void 0!==s&&c.set("per_page",s),r()({path:`/travel/v1/proposals?${c.toString()}`,method:"GET"})},s=e=>r()({path:`/travel/v1/proposals/${e}/detail`,method:"GET"}),c=(e,a)=>r()({path:`/travel/v1/proposals/${e}`,method:"PUT",data:a}),u=e=>r()({path:`/travel/v1/proposals/${e}`,method:"DELETE"}),d=e=>r()({path:"/travel/v1/proposals/bulk-delete",method:"POST",data:{ids:e}}),p=(e,a,t)=>r()({path:`/travel/v1/proposals/${e}/send`,method:"POST",data:{snapshot:a,version_number:t}}),m=(e,a,t)=>r()({path:`/travel/v1/proposals/${e}/versions`,method:"POST",data:{snapshot:a,version_number:t}}),_=(e,a)=>r()({path:`/travel/v1/proposals/${e}/current-version`,method:"POST",data:{version_id:a}}),v=(e,a)=>r()({path:`/travel/v1/proposals/${e}/accept`,method:"POST",data:{version_id:a}}),g=e=>r()({path:`/travel/v1/proposals/${e}/giav-retry`,method:"POST"}),b=({type:e,q:a})=>r()({path:`/travel/v1/catalog/search?type=${encodeURIComponent(e)}&q=${encodeURIComponent(a||"")}`,method:"GET"}),E=({wp_object_type:e,wp_object_id:a})=>r()({path:`/travel/v1/giav-mapping?wp_object_type=${encodeURIComponent(e)}&wp_object_id=${encodeURIComponent(a)}`,method:"GET"}),h=({type:e,q:a,limit:t=50,offset:l=0})=>r()({path:`/travel/v1/giav-mapping/list?type=${encodeURIComponent(e)}&q=${encodeURIComponent(a||"")}&limit=${encodeURIComponent(t)}&offset=${encodeURIComponent(l)}`,method:"GET"}),y=e=>r()({path:"/travel/v1/giav-mapping/upsert",method:"POST",data:e}),f=({wp_object_type:e,giav_supplier_id:a,items:t,status:l="active",match_type:n="batch"})=>r()({path:"/travel/v1/giav-mapping/batch-upsert",method:"POST",data:{wp_object_type:e,giav_supplier_id:a,items:t,status:l,match_type:n}}),N=async({q:e,pageSize:a=20,pageIndex:t=0,includeDisabled:l=!1})=>{const n=await r()({path:`/travel/v1/giav/providers/search?q=${encodeURIComponent(e)}&pageSize=${encodeURIComponent(a)}&pageIndex=${encodeURIComponent(t)}&includeDisabled=${encodeURIComponent(l)}`,method:"GET"});return{items:(Array.isArray(n)?n:Array.isArray(n?.items)?n.items:[]).map(e=>{var a,t,l,n,r,i,o,s;return{id:String(null!==(a=null!==(t=null!==(l=null!==(n=e.id)&&void 0!==n?n:e.ID)&&void 0!==l?l:e.Id)&&void 0!==t?t:e.proveedorId)&&void 0!==a?a:""),label:String(null!==(r=null!==(i=null!==(o=null!==(s=e.label)&&void 0!==s?s:e.NombreAlias)&&void 0!==o?o:e.Nombre)&&void 0!==i?i:e.title)&&void 0!==r?r:""),raw:e}}).filter(e=>e.id&&e.label)}},C=[{label:"Español",value:"es"},{label:"English",value:"en"}],S=[{label:"EUR",value:"EUR"},{label:"USD",value:"USD"},{label:"GBP",value:"GBP"}],w=[{value:"AF",label:"Afghanistan (AF)"},{value:"AL",label:"Albania (AL)"},{value:"DZ",label:"Algeria (DZ)"},{value:"AS",label:"American Samoa (AS)"},{value:"AD",label:"Andorra (AD)"},{value:"AO",label:"Angola (AO)"},{value:"AI",label:"Anguilla (AI)"},{value:"AQ",label:"Antarctica (AQ)"},{value:"AG",label:"Antigua and Barbuda (AG)"},{value:"AR",label:"Argentina (AR)"},{value:"AM",label:"Armenia (AM)"},{value:"AW",label:"Aruba (AW)"},{value:"AU",label:"Australia (AU)"},{value:"AT",label:"Austria (AT)"},{value:"AZ",label:"Azerbaijan (AZ)"},{value:"BS",label:"Bahamas (BS)"},{value:"BH",label:"Bahrain (BH)"},{value:"BD",label:"Bangladesh (BD)"},{value:"BB",label:"Barbados (BB)"},{value:"BY",label:"Belarus (BY)"},{value:"BE",label:"Belgium (BE)"},{value:"BZ",label:"Belize (BZ)"},{value:"BJ",label:"Benin (BJ)"},{value:"BM",label:"Bermuda (BM)"},{value:"BT",label:"Bhutan (BT)"},{value:"BO",label:"Bolivia (BO)"},{value:"BQ",label:"Bonaire, Sint Eustatius and Saba (BQ)"},{value:"BA",label:"Bosnia and Herzegovina (BA)"},{value:"BW",label:"Botswana (BW)"},{value:"BV",label:"Bouvet Island (BV)"},{value:"BR",label:"Brazil (BR)"},{value:"IO",label:"British Indian Ocean Territory (IO)"},{value:"BN",label:"Brunei (BN)"},{value:"BG",label:"Bulgaria (BG)"},{value:"BF",label:"Burkina Faso (BF)"},{value:"BI",label:"Burundi (BI)"},{value:"KH",label:"Cambodia (KH)"},{value:"CM",label:"Cameroon (CM)"},{value:"CA",label:"Canada (CA)"},{value:"CV",label:"Cape Verde (CV)"},{value:"KY",label:"Cayman Islands (KY)"},{value:"CF",label:"Central African Republic (CF)"},{value:"TD",label:"Chad (TD)"},{value:"CL",label:"Chile (CL)"},{value:"CN",label:"China (CN)"},{value:"CX",label:"Christmas Island (CX)"},{value:"CC",label:"Cocos (Keeling) Islands (CC)"},{value:"CO",label:"Colombia (CO)"},{value:"KM",label:"Comoros (KM)"},{value:"CG",label:"Congo (CG)"},{value:"CD",label:"Congo (Democratic Republic) (CD)"},{value:"CK",label:"Cook Islands (CK)"},{value:"CR",label:"Costa Rica (CR)"},{value:"CI",label:"Côte d’Ivoire (CI)"},{value:"HR",label:"Croatia (HR)"},{value:"CU",label:"Cuba (CU)"},{value:"CW",label:"Curaçao (CW)"},{value:"CY",label:"Cyprus (CY)"},{value:"CZ",label:"Czechia (CZ)"},{value:"DK",label:"Denmark (DK)"},{value:"DJ",label:"Djibouti (DJ)"},{value:"DM",label:"Dominica (DM)"},{value:"DO",label:"Dominican Republic (DO)"},{value:"EC",label:"Ecuador (EC)"},{value:"EG",label:"Egypt (EG)"},{value:"SV",label:"El Salvador (SV)"},{value:"GQ",label:"Equatorial Guinea (GQ)"},{value:"ER",label:"Eritrea (ER)"},{value:"EE",label:"Estonia (EE)"},{value:"ET",label:"Ethiopia (ET)"},{value:"FK",label:"Falkland Islands (FK)"},{value:"FO",label:"Faroe Islands (FO)"},{value:"FJ",label:"Fiji (FJ)"},{value:"FI",label:"Finland (FI)"},{value:"FR",label:"France (FR)"},{value:"GF",label:"French Guiana (GF)"},{value:"PF",label:"French Polynesia (PF)"},{value:"TF",label:"French Southern Territories (TF)"},{value:"GA",label:"Gabon (GA)"},{value:"GM",label:"Gambia (GM)"},{value:"GE",label:"Georgia (GE)"},{value:"DE",label:"Germany (DE)"},{value:"GH",label:"Ghana (GH)"},{value:"GI",label:"Gibraltar (GI)"},{value:"GR",label:"Greece (GR)"},{value:"GL",label:"Greenland (GL)"},{value:"GD",label:"Grenada (GD)"},{value:"GP",label:"Guadeloupe (GP)"},{value:"GU",label:"Guam (GU)"},{value:"GT",label:"Guatemala (GT)"},{value:"GG",label:"Guernsey (GG)"},{value:"GN",label:"Guinea (GN)"},{value:"GW",label:"Guinea-Bissau (GW)"},{value:"GY",label:"Guyana (GY)"},{value:"HT",label:"Haiti (HT)"},{value:"HM",label:"Heard Island and McDonald Islands (HM)"},{value:"HN",label:"Honduras (HN)"},{value:"HK",label:"Hong Kong (HK)"},{value:"HU",label:"Hungary (HU)"},{value:"IS",label:"Iceland (IS)"},{value:"IN",label:"India (IN)"},{value:"ID",label:"Indonesia (ID)"},{value:"IR",label:"Iran (IR)"},{value:"IQ",label:"Iraq (IQ)"},{value:"IE",label:"Ireland (IE)"},{value:"IM",label:"Isle of Man (IM)"},{value:"IL",label:"Israel (IL)"},{value:"IT",label:"Italy (IT)"},{value:"JM",label:"Jamaica (JM)"},{value:"JP",label:"Japan (JP)"},{value:"JE",label:"Jersey (JE)"},{value:"JO",label:"Jordan (JO)"},{value:"KZ",label:"Kazakhstan (KZ)"},{value:"KE",label:"Kenya (KE)"},{value:"KI",label:"Kiribati (KI)"},{value:"KP",label:"Korea (North) (KP)"},{value:"KR",label:"Korea (South) (KR)"},{value:"KW",label:"Kuwait (KW)"},{value:"KG",label:"Kyrgyzstan (KG)"},{value:"LA",label:"Laos (LA)"},{value:"LV",label:"Latvia (LV)"},{value:"LB",label:"Lebanon (LB)"},{value:"LS",label:"Lesotho (LS)"},{value:"LR",label:"Liberia (LR)"},{value:"LY",label:"Libya (LY)"},{value:"LI",label:"Liechtenstein (LI)"},{value:"LT",label:"Lithuania (LT)"},{value:"LU",label:"Luxembourg (LU)"},{value:"MO",label:"Macao (MO)"},{value:"MG",label:"Madagascar (MG)"},{value:"MW",label:"Malawi (MW)"},{value:"MY",label:"Malaysia (MY)"},{value:"MV",label:"Maldives (MV)"},{value:"ML",label:"Mali (ML)"},{value:"MT",label:"Malta (MT)"},{value:"MH",label:"Marshall Islands (MH)"},{value:"MQ",label:"Martinique (MQ)"},{value:"MR",label:"Mauritania (MR)"},{value:"MU",label:"Mauritius (MU)"},{value:"YT",label:"Mayotte (YT)"},{value:"MX",label:"Mexico (MX)"},{value:"FM",label:"Micronesia (FM)"},{value:"MD",label:"Moldova (MD)"},{value:"MC",label:"Monaco (MC)"},{value:"MN",label:"Mongolia (MN)"},{value:"ME",label:"Montenegro (ME)"},{value:"MS",label:"Montserrat (MS)"},{value:"MA",label:"Morocco (MA)"},{value:"MZ",label:"Mozambique (MZ)"},{value:"MM",label:"Myanmar (MM)"},{value:"NA",label:"Namibia (NA)"},{value:"NR",label:"Nauru (NR)"},{value:"NP",label:"Nepal (NP)"},{value:"NL",label:"Netherlands (NL)"},{value:"NC",label:"New Caledonia (NC)"},{value:"NZ",label:"New Zealand (NZ)"},{value:"NI",label:"Nicaragua (NI)"},{value:"NE",label:"Niger (NE)"},{value:"NG",label:"Nigeria (NG)"},{value:"NU",label:"Niue (NU)"},{value:"NF",label:"Norfolk Island (NF)"},{value:"MK",label:"North Macedonia (MK)"},{value:"MP",label:"Northern Mariana Islands (MP)"},{value:"NO",label:"Norway (NO)"},{value:"OM",label:"Oman (OM)"},{value:"PK",label:"Pakistan (PK)"},{value:"PW",label:"Palau (PW)"},{value:"PS",label:"Palestine (PS)"},{value:"PA",label:"Panama (PA)"},{value:"PG",label:"Papua New Guinea (PG)"},{value:"PY",label:"Paraguay (PY)"},{value:"PE",label:"Peru (PE)"},{value:"PH",label:"Philippines (PH)"},{value:"PN",label:"Pitcairn (PN)"},{value:"PL",label:"Poland (PL)"},{value:"PT",label:"Portugal (PT)"},{value:"PR",label:"Puerto Rico (PR)"},{value:"QA",label:"Qatar (QA)"},{value:"RE",label:"Réunion (RE)"},{value:"RO",label:"Romania (RO)"},{value:"RU",label:"Russia (RU)"},{value:"RW",label:"Rwanda (RW)"},{value:"BL",label:"Saint Barthélemy (BL)"},{value:"SH",label:"Saint Helena (SH)"},{value:"KN",label:"Saint Kitts and Nevis (KN)"},{value:"LC",label:"Saint Lucia (LC)"},{value:"MF",label:"Saint Martin (MF)"},{value:"PM",label:"Saint Pierre and Miquelon (PM)"},{value:"VC",label:"Saint Vincent and the Grenadines (VC)"},{value:"WS",label:"Samoa (WS)"},{value:"SM",label:"San Marino (SM)"},{value:"ST",label:"São Tomé and Príncipe (ST)"},{value:"SA",label:"Saudi Arabia (SA)"},{value:"SN",label:"Senegal (SN)"},{value:"RS",label:"Serbia (RS)"},{value:"SC",label:"Seychelles (SC)"},{value:"SL",label:"Sierra Leone (SL)"},{value:"SG",label:"Singapore (SG)"},{value:"SX",label:"Sint Maarten (SX)"},{value:"SK",label:"Slovakia (SK)"},{value:"SI",label:"Slovenia (SI)"},{value:"SB",label:"Solomon Islands (SB)"},{value:"SO",label:"Somalia (SO)"},{value:"ZA",label:"South Africa (ZA)"},{value:"GS",label:"South Georgia and the South Sandwich Islands (GS)"},{value:"SS",label:"South Sudan (SS)"},{value:"ES",label:"Spain (ES)"},{value:"LK",label:"Sri Lanka (LK)"},{value:"SD",label:"Sudan (SD)"},{value:"SR",label:"Suriname (SR)"},{value:"SJ",label:"Svalbard and Jan Mayen (SJ)"},{value:"SE",label:"Sweden (SE)"},{value:"CH",label:"Switzerland (CH)"},{value:"SY",label:"Syria (SY)"},{value:"TW",label:"Taiwan (TW)"},{value:"TJ",label:"Tajikistan (TJ)"},{value:"TZ",label:"Tanzania (TZ)"},{value:"TH",label:"Thailand (TH)"},{value:"TL",label:"Timor-Leste (TL)"},{value:"TG",label:"Togo (TG)"},{value:"TK",label:"Tokelau (TK)"},{value:"TO",label:"Tonga (TO)"},{value:"TT",label:"Trinidad and Tobago (TT)"},{value:"TN",label:"Tunisia (TN)"},{value:"TR",label:"Turkey (TR)"},{value:"TM",label:"Turkmenistan (TM)"},{value:"TC",label:"Turks and Caicos Islands (TC)"},{value:"TV",label:"Tuvalu (TV)"},{value:"UG",label:"Uganda (UG)"},{value:"UA",label:"Ukraine (UA)"},{value:"AE",label:"United Arab Emirates (AE)"},{value:"GB",label:"United Kingdom (GB)"},{value:"US",label:"United States (US)"},{value:"UM",label:"United States Minor Outlying Islands (UM)"},{value:"UY",label:"Uruguay (UY)"},{value:"UZ",label:"Uzbekistan (UZ)"},{value:"VU",label:"Vanuatu (VU)"},{value:"VA",label:"Vatican City (VA)"},{value:"VE",label:"Venezuela (VE)"},{value:"VN",label:"Vietnam (VN)"},{value:"VG",label:"Virgin Islands (British) (VG)"},{value:"VI",label:"Virgin Islands (US) (VI)"},{value:"WF",label:"Wallis and Futuna (WF)"},{value:"EH",label:"Western Sahara (EH)"},{value:"YE",label:"Yemen (YE)"},{value:"ZM",label:"Zambia (ZM)"},{value:"ZW",label:"Zimbabwe (ZW)"}];function x(){return(new Date).toISOString().slice(0,10)}function T({id:e,label:n,value:r,onChange:i}){const[o,s]=(0,t.useState)(!1),c=(0,t.useRef)(null),u=function(e){if(!e)return"";const[a,t,l]=e.split("-");return a&&t&&l?`${l}/${t}/${a}`:e}(r);return(0,a.createElement)("div",{className:"proposal-basics__field",ref:c},(0,a.createElement)(l.TextControl,{id:e,label:n,value:u,onClick:()=>s(!0),onFocus:()=>s(!0),readOnly:!0,placeholder:"DD/MM/AAAA"}),o&&(0,a.createElement)(l.Popover,{anchorRef:c,placement:"bottom-start",className:"proposal-basics__date-popover",onClose:()=>s(!1)},(0,a.createElement)(l.DatePicker,{currentDate:r||x(),onChange:e=>{const a=function(e){if(!e)return"";if(e instanceof Date&&!Number.isNaN(e.getTime()))return e.toISOString().slice(0,10);if("string"==typeof e){if(e.includes("/")){const[a,t,l]=e.split("/");if(a&&t&&l)return`${l.padStart(4,"0")}-${t.padStart(2,"0")}-${a.padStart(2,"0")}`}return e.slice(0,10)}return""}(e);a&&i(a),s(!1)}})))}function k({initialValues:e={},onCreated:n,onNext:r,proposalId:o}){var s;const u=(0,t.useMemo)(()=>{var a,t;return{proposal_title:"",customer_name:"",customer_email:"",customer_country:"",customer_language:"es",start_date:x(),end_date:x(),pax_total:1,players_count:null!==(a=null!==(t=e.players_count)&&void 0!==t?t:e.pax_total)&&void 0!==a?a:1,currency:"EUR",...e}},[e]),[d,p]=(0,t.useState)(u),[m,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(""),[b,E]=(0,t.useState)("");(0,t.useEffect)(()=>{p(e=>({...e,...u}))},[u]),(0,t.useEffect)(()=>(window.fillProposalBasics=(e={})=>{p(a=>({...a,proposal_title:"string"==typeof e.title?e.title:a.proposal_title,customer_name:"string"==typeof e.name?e.name:a.customer_name,customer_email:"string"==typeof e.email?e.email:a.customer_email,customer_country:"string"==typeof e.country?e.country.toUpperCase():a.customer_country,customer_language:"string"==typeof e.language?e.language:a.customer_language}))},()=>{delete window.fillProposalBasics}),[]);const h=e=>a=>p(t=>({...t,[e]:a})),y=(0,t.useMemo)(()=>{if(!b)return w;const e=b.toLowerCase();return w.filter(a=>a.label.toLowerCase().includes(e)||a.value.toLowerCase().includes(e))},[b]),f=parseInt(d.pax_total,10),N=parseInt(d.players_count,10),k=Number.isFinite(f)?Math.max(0,f-(Number.isFinite(N)?N:0)):0;return(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Datos básicos")),(0,a.createElement)(l.CardBody,null,v&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>g("")},v),(0,a.createElement)("div",{className:"proposal-basics"},(0,a.createElement)("div",{className:"proposal-basics__section"},(0,a.createElement)("div",{className:"proposal-basics__section-title"},"Identidad de la propuesta"),(0,a.createElement)("div",{className:"proposal-basics__grid"},(0,a.createElement)("div",{className:"proposal-basics__field proposal-basics__field--full"},(0,a.createElement)(l.TextControl,{label:"Título de la propuesta",value:d.proposal_title,onChange:h("proposal_title"),placeholder:"Escapada a la Costa del Sol"})),(0,a.createElement)("div",{className:"proposal-basics__field"},(0,a.createElement)(l.TextControl,{label:"Nombre del cliente *",value:d.customer_name,onChange:h("customer_name"),placeholder:"John Smith"})),(0,a.createElement)("div",{className:"proposal-basics__field"},(0,a.createElement)(l.TextControl,{label:"Email",value:d.customer_email,onChange:h("customer_email"),placeholder:"john@email.com"})))),(0,a.createElement)("div",{className:"proposal-basics__section"},(0,a.createElement)("div",{className:"proposal-basics__section-title"},"Fechas y pasajeros"),(0,a.createElement)("div",{className:"proposal-basics__grid proposal-basics__grid--dates"},(0,a.createElement)(T,{label:"Fecha inicio *",value:d.start_date,onChange:e=>{p(a=>{const t={...a,start_date:e};return t.end_date&&e&&t.end_date<e&&(t.end_date=e),t}),window.setTimeout(()=>{const e=document.getElementById("wp-travel-end-date");if(e&&(e.focus(),"function"==typeof e.showPicker))try{e.showPicker()}catch(e){}},0)}}),(0,a.createElement)("div",{className:"proposal-basics__date-arrow","aria-hidden":"true"},"→"),(0,a.createElement)(T,{id:"wp-travel-end-date",label:"Fecha fin *",value:d.end_date,onChange:e=>{p(a=>a.start_date&&e&&e<a.start_date?{...a,end_date:a.start_date}:{...a,end_date:e})}}),(0,a.createElement)("div",{className:"proposal-basics__field proposal-basics__field--pax"},(0,a.createElement)(l.TextControl,{label:"Pax *",type:"number",min:1,value:String(d.pax_total),onChange:h("pax_total")})),(0,a.createElement)("div",{className:"proposal-basics__field proposal-basics__field--pax"},(0,a.createElement)(l.TextControl,{label:"Jugadores",type:"number",min:0,value:String(null!==(s=d.players_count)&&void 0!==s?s:""),onChange:h("players_count"),help:`No jugadores: ${k}`})))),(0,a.createElement)("div",{className:"proposal-basics__section"},(0,a.createElement)("div",{className:"proposal-basics__section-title"},"Preferencias"),(0,a.createElement)("div",{className:"proposal-basics__grid"},(0,a.createElement)("div",{className:"proposal-basics__field"},(0,a.createElement)(l.SelectControl,{label:"Idioma",value:d.customer_language,options:C,onChange:h("customer_language")})),(0,a.createElement)("div",{className:"proposal-basics__field"},(0,a.createElement)(l.ComboboxControl,{label:"País",value:d.customer_country,options:y,onFilterValueChange:E,onChange:e=>h("customer_country")(e?e.toUpperCase():""),placeholder:"Busca país o código"})),(0,a.createElement)("div",{className:"proposal-basics__field"},(0,a.createElement)(l.SelectControl,{label:"Moneda",value:d.currency,options:S,onChange:h("currency")}))))),(0,a.createElement)("div",{style:{marginTop:16,display:"flex",gap:12,alignItems:"center"}},(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{const e=(()=>{if(!d.customer_name?.trim())return"El nombre del cliente es obligatorio.";if(!d.start_date)return"La fecha de inicio es obligatoria.";if(!d.end_date)return"La fecha de fin es obligatoria.";if(d.end_date<d.start_date)return"La fecha fin no puede ser anterior a la fecha inicio.";const e=parseInt(d.pax_total,10);if(Number.isNaN(e)||e<1)return"Pax debe ser un número >= 1.";const a=parseInt(d.players_count,10);return Number.isNaN(a)||a<0?"Jugadores debe ser un número >= 0.":a>e?"Jugadores no puede ser mayor que Pax.":d.customer_email&&!/^\S+@\S+\.\S+$/.test(d.customer_email)?"El email no parece válido (si lo rellenas, que sea correcto).":d.customer_country&&2!==d.customer_country.length?"País debe ser ISO2 (2 letras) o vacío.":""})();if(e)return void g(e);_(!0),g("");const a={...d,pax_total:parseInt(d.pax_total,10),players_count:Math.max(0,parseInt(d.players_count,10)),customer_country:d.customer_country?d.customer_country.toUpperCase():""};try{if(o)return await c(o,a),void r?.({basics:a});const e=await i(a);n?.({proposalId:e.proposal_id,basics:a})}catch(e){g(e?.message||"Error creando la propuesta.")}finally{_(!1)}},disabled:m},"Continuar"),m&&(0,a.createElement)(l.Spinner,null))))}function M({label:e,type:n,valueTitle:r,onPick:i}){const[o,s]=(0,t.useState)(r||""),[c,u]=(0,t.useState)(!1),[d,p]=(0,t.useState)(!1),[m,_]=(0,t.useState)([]);return(0,t.useEffect)(()=>{s(r||"")},[r]),(0,t.useEffect)(()=>{if(!c)return;let e=!0;return p(!0),b({type:n,q:o}).then(a=>e&&_(Array.isArray(a)?a:[])).catch(()=>e&&_([])).finally(()=>e&&p(!1)),()=>{e=!1}},[o,c,n]),(0,a.createElement)("div",{style:{position:"relative",minWidth:320}},(0,a.createElement)(l.TextControl,{label:e,value:o,onChange:e=>{s(e),u(!0)},onFocus:()=>u(!0),placeholder:"hotel"===n?"Buscar hotel…":"Buscar campo…"}),c&&(0,a.createElement)("div",{style:{position:"absolute",zIndex:30,background:"#fff",border:"1px solid #ddd",borderRadius:8,width:"100%",maxHeight:220,overflow:"auto",boxShadow:"0 6px 18px rgba(0,0,0,.08)"}},d&&(0,a.createElement)("div",{style:{padding:8}},(0,a.createElement)(l.Spinner,null)),!d&&0===m.length&&(0,a.createElement)("div",{style:{padding:8,fontSize:12,opacity:.6}},"Sin resultados"),!d&&m.map(e=>(0,a.createElement)("button",{key:e.id,type:"button",onClick:()=>{i(e),u(!1)},style:{display:"block",width:"100%",padding:"8px 10px",border:0,background:"transparent",textAlign:"left",cursor:"pointer"}},e.title))))}function I({valueId:e,valueLabel:t,onSelect:l,disabled:n=!1,placeholder:r="Buscar proveedor en GIAV..."}){const[i,o]=(0,a.useState)(t||""),[s,c]=(0,a.useState)([]),[u,d]=(0,a.useState)(!1),[p,m]=(0,a.useState)(!1),[_,v]=(0,a.useState)(""),g=(0,a.useRef)(null);(0,a.useEffect)(()=>{t&&t!==i&&o(t)},[t]);return(0,a.createElement)("div",{style:{position:"relative"}},(0,a.createElement)("input",{type:"text",value:i,onChange:e=>{return a=e.target.value,o(a),d(!0),clearTimeout(g.current),void(g.current=setTimeout(()=>(async e=>{const a=(e||"").trim();if(a.length<2)return c([]),v(""),void d(!1);m(!0),v("");try{const e=await N({q:a,pageSize:20,pageIndex:0,includeDisabled:!1}),t=(Array.isArray(e)?e:Array.isArray(e?.items)?e.items:[]).map(e=>{var a,t,l,n,r,i,o,s;return{id:String(null!==(a=null!==(t=null!==(l=null!==(n=e.id)&&void 0!==n?n:e.Id)&&void 0!==l?l:e.ID)&&void 0!==t?t:e.proveedorId)&&void 0!==a?a:""),label:String(null!==(r=null!==(i=null!==(o=null!==(s=e.label)&&void 0!==s?s:e.NombreAlias)&&void 0!==o?o:e.Nombre)&&void 0!==i?i:e.title)&&void 0!==r?r:"")}}).filter(e=>e.id&&e.label);c(t),d(t.length>0)}catch(e){v(e?.message||"Error buscando proveedores en GIAV"),c([]),d(!1)}finally{m(!1)}})(a),250));var a},onFocus:()=>{s.length>0&&d(!0)},placeholder:r,disabled:n,style:{width:"100%"}}),(0,a.createElement)("div",{style:{fontSize:12,marginTop:6,opacity:.8}},e?(0,a.createElement)(a.Fragment,null,"ID seleccionado: ",(0,a.createElement)("strong",null,e)):null,p?(0,a.createElement)("span",{style:{marginLeft:10}},"Buscando…"):null,_?(0,a.createElement)("span",{style:{marginLeft:10,color:"crimson"}},_):null),u&&s.length>0&&(0,a.createElement)("div",{style:{position:"absolute",zIndex:20,top:"100%",left:0,right:0,background:"#fff",border:"1px solid #ddd",borderTop:"none",maxHeight:260,overflow:"auto"}},s.map(e=>(0,a.createElement)("div",{key:e.id,onMouseDown:a=>{a.preventDefault(),(e=>{o(e.label),d(!1),c([]),v(""),l?.(e)})(e)},style:{padding:"10px 12px",cursor:"pointer",borderBottom:"1px solid #f0f0f0"}},(0,a.createElement)("div",{style:{fontWeight:600}},e.label),(0,a.createElement)("div",{style:{fontSize:12,opacity:.75}},"ID: ",e.id)))))}const P="1734698",A="Proveedores varios",B=[{label:"Hotel",value:"hotel"},{label:"Golf",value:"golf"},{label:"Transfer",value:"transfer"},{label:"Extra",value:"extra"},{label:"Paquete",value:"package"}],G=[{label:"Alojamiento y Desayuno",value:"AD"},{label:"Solo Alojamiento",value:"SA"},{label:"Media Pensión",value:"MP"},{label:"Pensión Completa",value:"PC"},{label:"Todo Incluido",value:"TI"},{label:"Según Programa",value:"SP"}];function D(e){const a=parseFloat(String(e).replace(",","."));return Number.isFinite(a)?a:0}function R(e,a=1){const t=parseInt(e,10);return Number.isFinite(t)?t:a}function F(e){return Math.round(100*(e+Number.EPSILON))/100}function L(e,a){return function(e,a){if(!e||!a)return 0;const t=new Date(`${e}T00:00:00`),l=new Date(`${a}T00:00:00`)-t;return!Number.isFinite(l)||l<=0?0:Math.round(l/864e5)}(e.start_date||a?.start_date||"",e.end_date||a?.end_date||"")}function V(e=0){return{double:{enabled:!0,rooms:1,pricing_basis:"per_room",net_price_per_night:"",margin_pct:e,pvp_manual_enabled:!1,pvp_price_per_night:"",nights_payable:0,free_nights_applied:0,discount_pct_applied:0,total_net:0,total_pvp:0},single:{enabled:!1,rooms:0,pricing_basis:"per_room",net_price_per_night:"",margin_pct:e,pvp_manual_enabled:!1,pvp_price_per_night:"",nights_payable:0,free_nights_applied:0,discount_pct_applied:0,total_net:0,total_pvp:0}}}function $(e,a,t){const l=Math.max(0,R(null!=a?a:0,0)),n=Math.max(0,R(null!=t?t:0,0));if(l<=0||n<=0||e<=0)return{freeNights:0,nightsPayable:Math.max(0,e)};const r=Math.floor(e/l),i=Math.min(e,r*n);return{freeNights:i,nightsPayable:Math.max(0,e-i)}}function U(e,a=0){var t;const l=e?.start_date||"",n=e?.end_date||"",r=V(a);return{service_type:"hotel",title:"",start_date:l,end_date:n,hotel_room_type:"",hotel_regimen:"",hotel_rooms:0,hotel_rate_basis:null,hotel_regimen:"",quantity:1,green_fees_per_person:1,number_of_players:null!==(t=e?.pax_total)&&void 0!==t?t:1,total_green_fees:0,unit_cost_net:"",unit_sell_price:"",use_markup:!0,markup_pct:a,lock_sell_price:!1,notes_public:"",notes_internal:"",package_components_text:"",display_name:"",use_manual_entry:!1,wp_object_type:null,wp_object_id:null,giav_entity_type:null,giav_entity_id:null,giav_supplier_id:P,giav_supplier_name:A,giav_mapping_status:"needs_review",show_supplier_picker:!1,supplier_override:!1,dates_inherited:!0,room_pricing:r,discounts:{discount_pct:0,free_nights_every:"",free_nights_count:""},giav_pricing:{giav_total_pvp:0,giav_total_net:0,giav_source:"double",giav_locked:!1}}}function H(e,a,t){var l,n;const r={...e};r.start_date||(r.start_date=a?.start_date||""),r.end_date||(r.end_date=a?.end_date||""),r.quantity=Math.max(1,R(r.quantity,1)),void 0!==r.hotel_rooms&&(r.hotel_rooms=Math.max(0,R(r.hotel_rooms,0))),r.unit_cost_net=Math.max(0,D(r.unit_cost_net));const i=r.use_markup?Math.max(0,D(null!==(l=null!==(n=r.markup_pct)&&void 0!==n?n:t)&&void 0!==l?l:0)):0;var o,s;if(r.markup_pct=i,r.lock_sell_price?r.unit_sell_price=Math.max(0,D(r.unit_sell_price)):r.unit_sell_price=(o=r.unit_cost_net,s=i,F(Math.max(0,D(o))*(1+Math.max(0,D(s))/100))),"hotel"===r.service_type){const e=L(r,a);r.hotel_nights=e;const t=function(e,a,t){var l,n,r,i,o;const s=L(e,a),c=Math.max(0,R(null!==(l=e.hotel_rooms)&&void 0!==l?l:0,0)),u=function(e={}){var a,t,l,n;return{discount_pct:(n=D(null!==(a=e.discount_pct)&&void 0!==a?a:0),Number.isFinite(n)?Math.min(50,Math.max(0,n)):0),free_nights_every:Math.max(0,R(null!==(t=e.free_nights_every)&&void 0!==t?t:0,0))||"",free_nights_count:Math.max(0,R(null!==(l=e.free_nights_count)&&void 0!==l?l:0,0))||""}}(e.discounts),{freeNights:d,nightsPayable:p}=$(s,u.free_nights_every,u.free_nights_count),m=e.use_markup?D(null!==(n=null!==(r=e.markup_pct)&&void 0!==r?r:t)&&void 0!==n?n:0):0,_=e.room_pricing||V(t),v=(e,a)=>{var t,l,n;const r=_?.[e]||{},i=null!==(t=a.net_price_per_night)&&void 0!==t?t:0,o=null!==(l=a.pvp_price_per_night)&&void 0!==l?l:0,s=void 0!==r.net_price_per_night&&""!==r.net_price_per_night,c=void 0!==r.pvp_price_per_night&&""!==r.pvp_price_per_night,d=void 0!==r.margin_pct&&""!==r.margin_pct,p=void 0!==r.rooms&&""!==r.rooms;return{enabled:"boolean"==typeof r.enabled?r.enabled:a.enabled,rooms:p?Math.max(0,R(null!==(n=r.rooms)&&void 0!==n?n:0,0)):a.rooms,pricing_basis:r.pricing_basis||a.pricing_basis,net_price_per_night:s?D(r.net_price_per_night):i,margin_pct:d?D(r.margin_pct):a.margin_pct,pvp_manual_enabled:"boolean"==typeof r.pvp_manual_enabled?r.pvp_manual_enabled:a.pvp_manual_enabled,pvp_price_per_night:c?D(r.pvp_price_per_night):o,nights_payable:0,free_nights_applied:0,discount_pct_applied:u.discount_pct,total_net:0,total_pvp:0}},g={enabled:!1,rooms:0,pricing_basis:"per_room",net_price_per_night:0,margin_pct:m,pvp_manual_enabled:!1,pvp_price_per_night:0},b={double:v("double",{enabled:!0,rooms:c>0?c:1,pricing_basis:"per_room",net_price_per_night:null!==(i=e.unit_cost_net)&&void 0!==i?i:0,margin_pct:m,pvp_manual_enabled:!!e.lock_sell_price,pvp_price_per_night:null!==(o=e.unit_sell_price)&&void 0!==o?o:0}),single:v("single",g)},E=["double","single"].map(e=>{var a;const t=b[e];if(!t.enabled)return{totalNet:0,totalPvp:0};const l=Math.max(0,R(null!==(a=t.rooms)&&void 0!==a?a:0,0)),n="double"===e&&t.pricing_basis||"per_room",r="per_person"===n?2*l:l,i=Math.max(0,t.net_price_per_night)*p*r*(1-u.discount_pct/100),o=t.pvp_manual_enabled?Math.max(0,t.pvp_price_per_night)*p*r:i*(1+Math.max(0,t.margin_pct)/100);return b[e]={...t,pricing_basis:n,nights_payable:p,free_nights_applied:d,discount_pct_applied:u.discount_pct,total_net:F(i),total_pvp:F(o)},{totalNet:F(i),totalPvp:F(o)}}),h=E.reduce((e,a)=>e+a.totalNet,0),y=E.reduce((e,a)=>e+a.totalPvp,0),f=["double","single"].filter(e=>b[e].enabled),N=1===f.length?f[0]:"custom",C={...e.giav_pricing,giav_total_net:F(h),giav_total_pvp:e.giav_pricing?.giav_locked?F(D(e.giav_pricing?.giav_total_pvp)):F(y),giav_source:e.giav_pricing?.giav_locked?"custom":N,giav_locked:!!e.giav_pricing?.giav_locked};return{discounts:u,roomPricing:b,giavPricing:C,totals:{nights:s,nightsPayable:p,freeNights:d,totalNet:F(h),totalPvp:F(y)}}}(r,a,i);r.room_pricing=t.roomPricing,r.discounts=t.discounts,r.giav_pricing=t.giavPricing,r.line_cost_net=t.totals.totalNet,r.line_sell_price=t.giavPricing.giav_total_pvp,r.quantity=1,r.unit_cost_net=t.totals.totalNet,r.unit_sell_price=t.giavPricing.giav_total_pvp}else if("golf"===r.service_type){var c;const e=Math.max(0,R(null!==(c=a?.players_count)&&void 0!==c?c:0,0)),t=e>0?e:1,{greenFeesPerPerson:l,totalGreenFees:n}=function(e={},a=1){var t,l,n;const r=Math.max(1,R(a,1));let i=Math.max(0,R(null!==(t=e.green_fees_per_person)&&void 0!==t?t:0,0)),o=Math.max(0,R(null!==(l=e.total_green_fees)&&void 0!==l?l:0,0));const s=Math.max(0,R(null!==(n=e.quantity)&&void 0!==n?n:0,0));return i>0?o=i*r:o>0?(i=Math.max(1,Math.round(o/r)),o=i*r):s>0?(o=s,i=Math.max(1,Math.round(o/r)),o=i*r):(i=1,o=i*r),{greenFeesPerPerson:i,totalGreenFees:o}}(r,t);r.number_of_players=e,r.green_fees_per_person=l,r.total_green_fees=n,r.quantity=n,r.line_cost_net=F(n*r.unit_cost_net),r.line_sell_price=F(n*r.unit_sell_price)}else r.line_cost_net=F(r.quantity*r.unit_cost_net),r.line_sell_price=F(r.quantity*r.unit_sell_price);return r}function j({item:e,idx:t,updateItem:n,currency:r,pax:i,basics:o,globalMarkupPct:s}){var c,u,d,p,m,_,v;const g=e.room_pricing||V(s),b=V(s),E=e=>g[e]||b[e],h=Math.max(0,R(null!==(c=E("double").rooms)&&void 0!==c?c:0,0)),y=Math.max(0,R(null!==(u=E("single").rooms)&&void 0!==u?u:0,0)),f=(E("double").enabled?2*h:0)+(E("single").enabled?y:0),N=f-i,C=N<0?`Faltan ${Math.abs(N)} pax por asignar a habitaciones`:N>0?`Sobran ${N} pax asignados`:"",S=Math.max(0,R(null!==(d=e.hotel_nights)&&void 0!==d?d:L(e,o),0)),{nightsPayable:w}=$(S,e.discounts?.free_nights_every,e.discounts?.free_nights_count),x=function(e={}){var a,t,l;const n=Math.max(0,D(null!==(a=e.discount_pct)&&void 0!==a?a:0)),r=Math.max(0,R(null!==(t=e.free_nights_every)&&void 0!==t?t:0,0)),i=Math.max(0,R(null!==(l=e.free_nights_count)&&void 0!==l?l:0,0)),o=[];return n>0&&o.push(`-${F(n)}%`),r>0&&i>0&&o.push(`+${i} gratis cada ${r}`),o.length>0?o.join(" "):"Sin descuentos"}(e.discounts),T=e.notes_public||e.notes_internal?"Ver notas":"Sin notas",k=(a,l)=>{const r=e.room_pricing||{},i={...r[a]||{},...l},o={...r,[a]:i};n(t,{room_pricing:o})},M=(a,l)=>{const r=e.discounts||{};n(t,{discounts:{...r,[a]:l}})};return(0,a.createElement)("div",{className:"service-card__hotel-panel"},(0,a.createElement)("div",{className:"service-card__hotel-occupancy"},["double","single"].map(e=>{var t,n,i,o;const c="double"===e?"Doble":"Individual",u=E(e);return(0,a.createElement)("div",{key:e,className:"service-card__hotel-occupancy-card"},(0,a.createElement)("div",{className:"service-card__hotel-occupancy-header"},(0,a.createElement)(l.ToggleControl,{label:`Cotizar ${c.toLowerCase()}`,checked:!!u.enabled,onChange:()=>k(e,{enabled:!u.enabled})}),(0,a.createElement)("span",{className:"service-card__hotel-occupancy-label"},c)),u.enabled&&(0,a.createElement)("div",{className:"service-card__hotel-occupancy-body"},(0,a.createElement)(l.TextControl,{label:`Habitaciones ${c.toLowerCase()}`,type:"number",min:1,value:String(null!==(t=u.rooms)&&void 0!==t?t:""),onChange:a=>k(e,{rooms:a})}),"double"===e&&(0,a.createElement)(l.SelectControl,{label:"Precio",value:u.pricing_basis||"per_room",options:[{label:"Por habitación",value:"per_room"},{label:"Por persona",value:"per_person"}],onChange:e=>k("double",{pricing_basis:e})}),(0,a.createElement)(l.TextControl,{label:`Neto por noche (${c.toLowerCase()})`,value:String(null!==(n=u.net_price_per_night)&&void 0!==n?n:""),onChange:a=>k(e,{net_price_per_night:a}),placeholder:"120"}),(0,a.createElement)("details",{className:"service-card__hotel-mode-details"},(0,a.createElement)("summary",null,"Margen y PVP"),(0,a.createElement)("div",{className:"service-card__hotel-mode-details-grid"},(0,a.createElement)(l.ToggleControl,{label:"PVP manual",checked:!!u.pvp_manual_enabled,onChange:()=>k(e,{pvp_manual_enabled:!u.pvp_manual_enabled})}),u.pvp_manual_enabled?(0,a.createElement)(l.TextControl,{label:`PVP por noche (${c.toLowerCase()})`,value:String(null!==(i=u.pvp_price_per_night)&&void 0!==i?i:""),onChange:a=>k(e,{pvp_price_per_night:a}),placeholder:"165"}):(0,a.createElement)(l.TextControl,{label:"Margen (%)",type:"number",min:0,value:String(null!==(o=u.margin_pct)&&void 0!==o?o:s),onChange:a=>k(e,{margin_pct:a})}))),(0,a.createElement)("div",{className:"service-card__hotel-total"},"Total hab. ",c.toLowerCase(),": ",r," ",F(u.total_pvp||0).toFixed(2))))})),(0,a.createElement)("div",{className:"service-card__hotel-allocation"},(0,a.createElement)("div",{className:"service-card__hotel-allocation-text"},"Personas asignadas: ",f," de ",i),C&&(0,a.createElement)(l.Notice,{status:"warning",isDismissible:!1},C)),(0,a.createElement)("details",{className:"service-card__hotel-discounts-collapse"},(0,a.createElement)("summary",null,(0,a.createElement)("span",null,"Descuentos"),(0,a.createElement)("span",{className:"service-card__hotel-discounts-summary"},x)),(0,a.createElement)("div",{className:"service-card__hotel-discounts"},(0,a.createElement)("div",{className:"service-card__hotel-discounts-grid"},(0,a.createElement)(l.TextControl,{label:"Descuento (%)",type:"number",min:0,max:50,value:String(null!==(p=e.discounts?.discount_pct)&&void 0!==p?p:0),onChange:e=>M("discount_pct",e)}),(0,a.createElement)(l.TextControl,{label:"Noches gratis (cada)",type:"number",min:0,value:String(null!==(m=e.discounts?.free_nights_every)&&void 0!==m?m:""),onChange:e=>M("free_nights_every",e)}),(0,a.createElement)(l.TextControl,{label:"Noches gratis (cantidad)",type:"number",min:0,value:String(null!==(_=e.discounts?.free_nights_count)&&void 0!==_?_:""),onChange:e=>M("free_nights_count",e)})),S>0&&(0,a.createElement)("div",{className:"service-card__hotel-discount-summary"},"Se cobran ",w," noches de ",S))),(0,a.createElement)("div",{className:"service-card__hotel-giav"},(0,a.createElement)("div",{className:"service-card__hotel-subtitle"},"Total para GIAV"),(0,a.createElement)("div",{className:"service-card__hotel-giav-grid"},(0,a.createElement)("div",{className:"service-card__hotel-giav-total"},"Total alojamiento (para GIAV): ",r," ",F(e.giav_pricing?.giav_total_pvp||0).toFixed(2)),(0,a.createElement)(l.ToggleControl,{label:"Editar total para GIAV",checked:!!e.giav_pricing?.giav_locked,onChange:()=>{const a=e.giav_pricing||{};n(t,{giav_pricing:{...a,giav_locked:!a.giav_locked}})}}),(0,a.createElement)(l.TextControl,{label:"Total editable",value:String(null!==(v=e.giav_pricing?.giav_total_pvp)&&void 0!==v?v:""),onChange:a=>(a=>{const l=e.giav_pricing||{};n(t,{giav_pricing:{...l,giav_total_pvp:a}})})(a),disabled:!e.giav_pricing?.giav_locked}),e.giav_pricing?.giav_locked&&(0,a.createElement)(l.Notice,{status:"warning",isDismissible:!1},"Este total se enviará a GIAV. No se recalculará automáticamente."))),(0,a.createElement)("details",{className:"service-card__hotel-notes"},(0,a.createElement)("summary",null,(0,a.createElement)("span",null,"Notas"),(0,a.createElement)("span",{className:"service-card__hotel-discounts-summary"},T)),(0,a.createElement)("div",{className:"service-card__hotel-notes-grid"},(0,a.createElement)(l.TextControl,{label:"Notas para el cliente (itinerario)",value:e.notes_public||"",onChange:e=>n(t,{notes_public:e}),placeholder:"Incluye desayuno. Check-in 15:00."}),(0,a.createElement)(l.TextControl,{label:"Notas internas (solo uso interno)",value:e.notes_internal||"",onChange:e=>n(t,{notes_internal:e}),placeholder:"Neto negociado, release 14D."}))))}function O(e=[],a={}){if(!Array.isArray(e)||!e.length)return e;const t=a?.start_date||"",l=a?.end_date||"";let n=!1;const r=e.map(e=>e&&e.dates_inherited?e.start_date===t&&e.end_date===l?e:(n=!0,{...e,start_date:t,end_date:l,dates_inherited:!0}):e);return n?r:e}function q({basics:e,initialItems:n=[],onBack:r,onNext:i,onDraftChange:o}){var s;const c=e?.currency||"EUR",u=Math.max(1,R(null!==(s=e?.pax_total)&&void 0!==s?s:1,1)),[d,p]=(0,t.useState)(20),[m,_]=(0,t.useState)(!0),[v,g]=(0,t.useState)(""),[b,h]=(0,t.useState)(""),y=(0,t.useRef)(null),[f,N]=(0,t.useState)(()=>(n.length?n:[U(e,20)]).map(a=>{const t={...a},l="boolean"==typeof t.dates_inherited,n=t.start_date||e?.start_date||"",r=t.end_date||e?.end_date||"";return t.start_date||(t.start_date=n),t.end_date||(t.end_date=r),t.dates_inherited=l?t.dates_inherited:n===(e?.start_date||"")&&r===(e?.end_date||""),H(t,e,20)})),C=(0,t.useMemo)(()=>function(e){const a=e.reduce((e,a)=>(e.cost+=a.line_cost_net||0,e.sell+=a.line_sell_price||0,e),{cost:0,sell:0}),t=F(a.sell-a.cost),l=a.sell>0?F(t/a.sell*100):0;return{totals_cost_net:F(a.cost),totals_sell_price:F(a.sell),totals_margin_abs:t,totals_margin_pct:l}}(f),[f]);(0,t.useEffect)(()=>{if(!o)return;const e=window.setTimeout(()=>{o({items:f,totals:C})},200);return()=>window.clearTimeout(e)},[f,C,o]);const S=(0,t.useMemo)(()=>{var a,t,l;const n=Math.max(0,R(null!==(a=e?.pax_total)&&void 0!==a?a:0,0)),r=R(null!==(t=null!==(l=e?.players_count)&&void 0!==l?l:n)&&void 0!==t?t:0,0),i=Math.min(Math.max(r,0),n),o={paxTotal:n,playersCount:i,nonPlayersCount:Math.max(0,n-i),golfTotal:0,totalDouble:0,totalSingle:0,doubleRooms:0,singleRooms:0};f.forEach(e=>{if("golf"===e.service_type&&(o.golfTotal+=D(e.line_sell_price||0)),"hotel"===e.service_type){const l=e.room_pricing||{};var a,t;l.double?.enabled&&(o.totalDouble+=D(l.double?.total_pvp||0),o.doubleRooms+=Math.max(0,R(null!==(a=l.double?.rooms)&&void 0!==a?a:0,0))),l.single?.enabled&&(o.totalSingle+=D(l.single?.total_pvp||0),o.singleRooms+=Math.max(0,R(null!==(t=l.single?.rooms)&&void 0!==t?t:0,0)))}});const s=D(C.totals_sell_price||0),c=s,u=o.doubleRooms>0?o.totalDouble/(2*o.doubleRooms):0,d=o.singleRooms>0?o.totalSingle/o.singleRooms:0,p=o.totalDouble||0,m=o.totalSingle||0,_=o.golfTotal||0,v=s-(p+m)-_,g=u+(o.paxTotal>0?v/o.paxTotal:0),b=o.playersCount>0?g+_/o.playersCount:null,E=o.doubleRooms>0&&o.singleRooms>0;let h=null;return E&&(h=Math.max(0,d-u)),{...o,totalTrip:s,baseTotal:c,priceNonPlayerDouble:g,pricePlayerDouble:b,supplementSingle:h,hasSingleSupplement:E}},[e?.pax_total,e?.players_count,f,C.totals_sell_price]);(0,t.useEffect)(()=>{N(a=>{const t=O(a,e);return t===a?a:t.map((t,l)=>t===a[l]?t:H(t,e,d))})},[e?.start_date,e?.end_date,d,e]),(0,t.useEffect)(()=>{N(a=>a.map(a=>H(a,e,d)))},[u]);const w=(a,t)=>{N(l=>{const n=[...l],r={...n[a],...t};return n[a]=H(r,e,d),n})},x=e=>{w(e,{show_supplier_picker:!f[e].show_supplier_picker})},T=e=>!!e.show_supplier_picker,k=e=>{if(!e)return;const a=e.querySelector("input, select, textarea, button");a&&"function"==typeof a.focus&&a.focus()},V=e=>{window.setTimeout(()=>{const a=e.match(/Línea\s+(\d+)/i);if(a){const e=Math.max(0,parseInt(a[1],10)-1),t=document.querySelector(`[data-service-index="${e}"]`);if(t)return t.scrollIntoView({behavior:"smooth",block:"center"}),void k(t)}const t=document.querySelector(".services-step");t&&(t.scrollIntoView({behavior:"smooth",block:"start"}),k(t))},50)};return(0,a.createElement)(l.Card,{className:"services-step"},(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"services-step__title"},(0,a.createElement)("strong",null,"Servicios & precios"),(0,a.createElement)("span",{className:"services-step__subtitle"},"Añade servicios con detalle, márgenes y proveedor."))),(0,a.createElement)(l.CardBody,{ref:y},v&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>{g(""),h("")}},v),(0,a.createElement)("div",{className:"services-toolbar"},(0,a.createElement)("div",{className:"services-toolbar__controls"},(0,a.createElement)(l.TextControl,{label:"Margen por defecto (%)",type:"number",min:0,value:String(d),onChange:e=>p(D(e))}),(0,a.createElement)(l.ToggleControl,{label:"Aplicar a nuevas líneas",checked:m,onChange:()=>_(e=>!e)}),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>{N(a=>a.map(a=>H({...a,markup_pct:d},e,d)))}},"Aplicar a todas")),(0,a.createElement)("div",{className:"services-toolbar__summary"},(0,a.createElement)("div",{className:"services-toolbar__label"},"PVP total"),(0,a.createElement)("div",{className:"services-toolbar__value"},c," ",C.totals_sell_price.toFixed(2)))),(0,a.createElement)("div",{className:"services-items"},f.map((t,n)=>{var r,i,o,s,p;return(0,a.createElement)("div",{key:n,className:"service-card","data-service-index":n},(0,a.createElement)("div",{className:"service-card__header"},(0,a.createElement)("div",{className:"service-card__title"},(0,a.createElement)("div",{className:"service-card__eyebrow"},"Servicio ",n+1),(0,a.createElement)("div",{className:"service-card__name"},B.find(e=>e.value===t.service_type)?.label||"Servicio"," ·"," ",t.title?.trim()||"Sin título")),(0,a.createElement)("div",{className:"service-card__meta"},("hotel"===t.service_type||"golf"===t.service_type)&&(0,a.createElement)("div",{className:`service-card__badge service-card__badge--${t.giav_mapping_status}`},"active"===t.giav_mapping_status?String(t.giav_supplier_id||"")===P?"Proveedor genérico (GIAV)":"OK":"needs_review"===t.giav_mapping_status?"Pendiente de revisar":"Sin mapeo GIAV"),(0,a.createElement)("div",{className:"service-card__total"},(0,a.createElement)("span",null,"Total línea"),(0,a.createElement)("strong",null,c," ",F(t.line_sell_price||0).toFixed(2))),(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>(e=>{N(a=>a.filter((a,t)=>t!==e))})(n),disabled:1===f.length},"Eliminar"))),(0,a.createElement)("div",{className:"service-card__section"},(0,a.createElement)("div",{className:"service-card__section-title"},"Selección y contexto"),(0,a.createElement)("div",{className:"service-card__grid service-card__grid--context"},(0,a.createElement)(l.SelectControl,{label:"Tipo de servicio",value:t.service_type,options:B,onChange:e=>w(n,{service_type:e})}),"hotel"===t.service_type||"golf"===t.service_type?(0,a.createElement)(a.Fragment,null,(0,a.createElement)(l.ToggleControl,{label:"Entrada manual (fuera de catálogo)",checked:!!t.use_manual_entry,onChange:()=>{if(t.use_manual_entry)w(n,{use_manual_entry:!1,wp_object_type:null,wp_object_id:null,show_supplier_picker:!1,giav_mapping_status:"missing",supplier_override:!1,display_name:""});else{const e=t.display_name||t.title||"";w(n,{use_manual_entry:!0,wp_object_type:"manual",wp_object_id:0,show_supplier_picker:!0,giav_entity_type:"supplier",giav_entity_id:t.giav_supplier_id||P,giav_mapping_status:t.giav_supplier_id===P?"needs_review":"active",giav_supplier_id:t.giav_supplier_id||P,giav_supplier_name:t.giav_supplier_name||A,supplier_override:!1,display_name:e,title:e})}}}),t.use_manual_entry?(0,a.createElement)(l.TextControl,{label:"hotel"===t.service_type?"Hotel (manual) *":"Campo de golf (manual) *",value:t.display_name||"",onChange:e=>w(n,{display_name:e,title:e}),placeholder:"hotel"===t.service_type?"Ej: Hotel X (fuera de cat├ílogo)":"Ej: Campo Y (fuera de cat├ílogo)"}):(0,a.createElement)(M,{label:"hotel"===t.service_type?"Hotel":"Campo de golf",type:"hotel"===t.service_type?"hotel":"golf",valueTitle:t.title,onPick:async e=>{const a="hotel"===t.service_type?"hotel":"course";w(n,{title:e.title,display_name:e.title,wp_object_type:a,wp_object_id:e.id,supplier_override:!1});try{const t=await E({wp_object_type:a,wp_object_id:e.id});var l,r;t?.status&&"missing"!==t.status?w(n,{giav_mapping_status:t.status,giav_entity_type:t.giav_entity_type,giav_entity_id:t.giav_entity_id,giav_supplier_id:null!==(l=t.giav_supplier_id)&&void 0!==l?l:P,giav_supplier_name:null!==(r=t.giav_supplier_name)&&void 0!==r?r:A}):w(n,{giav_mapping_status:"needs_review",giav_entity_type:"supplier",giav_entity_id:P,giav_supplier_id:P,giav_supplier_name:A})}catch{w(n,{giav_mapping_status:"needs_review",giav_entity_type:"supplier",giav_entity_id:P,giav_supplier_id:P,giav_supplier_name:A})}}}),(0,a.createElement)("div",{className:"service-card__supplier"},!T(t)&&(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>x(n)},"Cambiar proveedor"),T(t)&&(0,a.createElement)(a.Fragment,null,!t.use_manual_entry&&(0,a.createElement)(l.ToggleControl,{label:"Proveedor (opcional)",checked:!!t.show_supplier_picker,onChange:()=>x(n)}),(0,a.createElement)(I,{selectedId:t.giav_supplier_id||P,selectedLabel:t.giav_supplier_name||A,disabled:!1,onPick:e=>{const a=String(e?.id||""),l=String(e?.label||"");a&&w(n,{giav_entity_type:"supplier",giav_entity_id:a,giav_supplier_id:a,giav_supplier_name:l,giav_mapping_status:a===P?"needs_review":"active",supplier_override:!t.use_manual_entry})}})))):(0,a.createElement)(l.TextControl,{label:"T├¡tulo / descripci├│n *",value:t.title,onChange:e=>w(n,{title:e})}),"hotel"===t.service_type&&(0,a.createElement)(l.TextControl,{label:"Tipo de habitación",value:t.hotel_room_type||"",onChange:e=>w(n,{hotel_room_type:e}),placeholder:"Deluxe / Sea View..."}),"hotel"===t.service_type&&(0,a.createElement)(l.SelectControl,{label:"Régimen",value:t.hotel_regimen||"",options:[{label:"Seleccionar",value:""},...G],onChange:e=>w(n,{hotel_regimen:e})}))),(0,a.createElement)("div",{className:"service-card__section"},(0,a.createElement)("div",{className:"service-card__section-title"},"Fechas y ocupación"),(0,a.createElement)("div",{className:"service-card__date-status"},(0,a.createElement)("span",{className:"service-card__date-label "+(t.dates_inherited?"is-inherited":"is-custom")},t.dates_inherited?"Fechas del viaje":"Fechas personalizadas"),!t.dates_inherited&&(0,a.createElement)(l.Button,{variant:"tertiary",className:"service-card__date-reset",onClick:()=>(a=>{w(a,{start_date:e?.start_date||"",end_date:e?.end_date||"",dates_inherited:!0})})(n)},"Restablecer fechas del viaje")),(0,a.createElement)("div",{className:"service-card__grid service-card__grid--dates"},(0,a.createElement)(l.TextControl,{label:"Fecha inicio",type:"date",value:t.start_date,onChange:a=>((a,t)=>{N(l=>{const n=[...l],r=n[a],i=t||"",o=r.end_date&&i&&r.end_date<i?i:r.end_date;return n[a]=H({...r,start_date:i,end_date:o,dates_inherited:!1},e,d),n}),window.setTimeout(()=>{const e=document.getElementById(`wp-travel-end-date-${a}`);if(e&&(e.focus(),"function"==typeof e.showPicker))try{e.showPicker()}catch(e){}},0)})(n,a)}),(0,a.createElement)(l.TextControl,{id:`wp-travel-end-date-${n}`,label:"Fecha fin",type:"date",value:t.end_date,onChange:e=>((e,a)=>w(e,{end_date:a}))(n,e),min:t.start_date||void 0}),"hotel"===t.service_type?(0,a.createElement)(a.Fragment,null,(0,a.createElement)(l.TextControl,{label:"Noches",type:"number",min:0,value:String(null!==(r=t.hotel_nights)&&void 0!==r?r:L(t,e)),onChange:a=>((a,t)=>{const l=f[a].start_date||e?.start_date;if(l){const e=function(e,a){if(!e)return"";const t=new Date(`${e}T00:00:00`);return Number.isFinite(t.getTime())?(t.setDate(t.getDate()+Math.max(0,a)),t.toISOString().slice(0,10)):""}(l,R(t,1));w(a,{end_date:e})}})(n,a)})):"golf"===t.service_type?(0,a.createElement)(a.Fragment,null,(0,a.createElement)(l.TextControl,{label:"Jugadores",type:"number",min:1,value:String(null!==(i=t.number_of_players)&&void 0!==i?i:u),onChange:e=>w(n,{number_of_players:e})}),(0,a.createElement)(l.TextControl,{label:"Green-fees por jugador *",type:"number",min:1,value:String(null!==(o=t.green_fees_per_person)&&void 0!==o?o:""),onChange:e=>w(n,{green_fees_per_person:e})}),(0,a.createElement)("div",{className:"service-card__golf-summary"},"Total green-fees (interno): ",R(null!==(s=t.number_of_players)&&void 0!==s?s:u,1)," x ",R(t.green_fees_per_person,0)," ="," ",R(t.total_green_fees,0)),R(t.green_fees_per_person,0)<1&&(0,a.createElement)(l.Notice,{status:"warning",isDismissible:!1},"Pendiente de revisar: completa los green-fees por jugador.")):(0,a.createElement)(l.TextControl,{label:"transfer"===t.service_type?"Cantidad (servicios)":"package"===t.service_type?"Cantidad (paquetes)":"Cantidad",type:"number",min:1,value:String(t.quantity),onChange:e=>w(n,{quantity:e})}))),(0,a.createElement)("div",{className:"service-card__section service-card__section--pricing"},(0,a.createElement)("div",{className:"service-card__section-title"},"Pricing"),"hotel"===t.service_type?(0,a.createElement)(j,{item:t,idx:n,updateItem:w,currency:c,pax:u,basics:e,globalMarkupPct:d}):(0,a.createElement)("div",{className:"service-card__pricing"},(0,a.createElement)(l.TextControl,{label:"Coste neto (unit.)",value:String(t.unit_cost_net),onChange:e=>w(n,{unit_cost_net:e}),placeholder:"120"}),(0,a.createElement)(l.ToggleControl,{label:"Usar margen",checked:!!t.use_markup,onChange:()=>w(n,{use_markup:!t.use_markup})}),t.use_markup&&(0,a.createElement)(l.TextControl,{label:"Margen (%)",type:"number",min:0,value:String(null!==(p=t.markup_pct)&&void 0!==p?p:d),onChange:e=>w(n,{markup_pct:e})}),(0,a.createElement)(l.ToggleControl,{label:"PVP manual",checked:!!t.lock_sell_price,onChange:()=>w(n,{lock_sell_price:!t.lock_sell_price})}),(0,a.createElement)(l.TextControl,{label:"PVP (unit.)",value:String(t.unit_sell_price),onChange:e=>w(n,{unit_sell_price:e}),placeholder:"165",disabled:!t.lock_sell_price}))),"package"===t.service_type&&(0,a.createElement)("div",{className:"service-card__package"},(0,a.createElement)(l.TextControl,{label:"Incluye (una l├¡nea por item)",value:t.package_components_text||"",onChange:e=>w(n,{package_components_text:e}),placeholder:"3 noches\n2 green-fees\nDesayuno incluido"})),(0,a.createElement)("div",{className:"service-card__section service-card__section--notes"},(0,a.createElement)("div",{className:"service-card__section-title"},"Notas"),(0,a.createElement)("div",{className:"service-card__notes"},(0,a.createElement)(l.TextControl,{label:"Notas para el cliente (itinerario)",value:t.notes_public||"",onChange:e=>w(n,{notes_public:e}),placeholder:"Incluye desayuno. Check-in 15:00."}),(0,a.createElement)(l.TextControl,{label:"Notas internas (solo uso interno)",value:t.notes_internal||"",onChange:e=>w(n,{notes_internal:e}),placeholder:"Neto negociado, release 14D."}))))})),(0,a.createElement)("div",{className:"services-add"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>{N(a=>[...a,U(e,d)])}},"+ Añadir servicio")),(0,a.createElement)("div",{className:"services-summary"},(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Total viaje"),(0,a.createElement)("div",{className:"services-summary__value"},c," ",F(S.totalTrip).toFixed(2)),(0,a.createElement)("div",{className:"services-summary__meta"},"Jugadores: ",S.playersCount," | No jugadores: ",S.nonPlayersCount)),S.playersCount>0&&(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Precio jugador en doble"),(0,a.createElement)("div",{className:"services-summary__value"},c," ",F(S.pricePlayerDouble||0).toFixed(2))),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Precio no jugador en doble"),(0,a.createElement)("div",{className:"services-summary__value"},c," ",F(S.priceNonPlayerDouble||0).toFixed(2))),S.hasSingleSupplement&&(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Suplemento individual"),(0,a.createElement)("div",{className:"services-summary__value"},c," ",F(S.supplementSingle||0).toFixed(2))),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Coste total"),(0,a.createElement)("div",{className:"services-summary__value"},c," ",C.totals_cost_net.toFixed(2))),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Margen"),(0,a.createElement)("div",{className:"services-summary__value"},c," ",C.totals_margin_abs.toFixed(2)," (",C.totals_margin_pct.toFixed(2),"%)"))),(0,a.createElement)("div",{className:"services-actions"},b&&(0,a.createElement)("div",{className:"services-actions__notice"},(0,a.createElement)(l.Notice,{status:"error",isDismissible:!1},(0,a.createElement)("div",{style:{display:"flex",justifyContent:"space-between",gap:12,alignItems:"center"}},(0,a.createElement)("span",null,b),(0,a.createElement)(l.Button,{variant:"link",onClick:()=>{y.current&&y.current.scrollIntoView({behavior:"smooth",block:"start"})}},"Ver errores")))),(0,a.createElement)(l.Button,{variant:"secondary",onClick:r},"Volver"),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>{var a;const t=(()=>{for(let a=0;a<f.length;a++){const t=f[a];if(!t.title&&!t.display_name)return`Línea ${a+1}: falta título.`;if("hotel"===t.service_type){var e;const l=t.room_pricing||{},n=(e,t)=>{var n;const r=l[e];return r.enabled?R(null!==(n=r.rooms)&&void 0!==n?n:0,0)<1?`Línea ${a+1} (Hotel): habitaciones ${t} debe ser >= 1.`:D(r.net_price_per_night)<=0?`Línea ${a+1} (Hotel): neto por noche (${t}) debe ser > 0.`:r.pvp_manual_enabled&&D(r.pvp_price_per_night)<=0?`Línea ${a+1} (Hotel): PVP manual (${t}) debe ser > 0.`:"":""},r=n("double","doble");if(r)return r;const i=n("single","individual");if(i)return i;if(D(null!==(e=t.giav_pricing?.giav_total_pvp)&&void 0!==e?e:0)<=0)return`Línea ${a+1} (Hotel): total para GIAV debe ser > 0.`}else if("golf"===t.service_type){if(R(t.green_fees_per_person,1)<1)return`Línea ${a+1} (Golf): green-fees por jugador debe ser >= 1.`}else if(R(t.quantity,1)<1)return`Línea ${a+1}: cantidad debe ser >= 1.`;if(D(t.unit_sell_price)<=0)return`Línea ${a+1}: PVP unitario debe ser > 0.`}return C.totals_sell_price<=0?"El PVP total debe ser > 0.":""})(),l=f.some(e=>"golf"===e.service_type),n=Math.max(0,R(null!==(a=e?.players_count)&&void 0!==a?a:0,0));if(l&&n<=0){const e='Hay servicios de golf pero "Jugadores" en Datos básicos está vacío o a 0. Define el número de jugadores en Datos básicos.';return g(e),h("No se puede continuar. Revisa 1 error."),void V(e)}if(t)return g(t),h("No se puede continuar. Revisa 1 error."),void V(t);g(""),h(""),i({items:f,totals:C})}},"Continuar"))))}function K(e){const a=parseFloat(e);return Number.isFinite(a)?Math.round(100*(a+Number.EPSILON))/100:0}function z(e){const a=parseFloat(String(e).replace(",","."));return Number.isFinite(a)?a:0}function W(e,a=0){const t=parseInt(e,10);return Number.isFinite(t)?t:a}function J({proposalId:e,basics:n,items:r,totals:i,onBack:o,onSent:s,mode:c="create",versionNumber:u=1}){const[d,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(""),b=(0,t.useMemo)(()=>{const e={crm_customer_id:null,customer_name:n.customer_name,customer_email:n.customer_email,customer_country:n.customer_country,customer_language:n.customer_language,proposal_title:n.proposal_title,start_date:n.start_date,end_date:n.end_date,pax_total:n.pax_total,players_count:n.players_count,currency:n.currency,status:"sent"},a=(r||[]).map((e,a)=>{var t,l,n,r,i,o,s,c,u,d,p,m,_,v,g,b,E,h,y,f,N,C,S,w,x,T,k,M;return{day_index:null!==(t=e.day_index)&&void 0!==t?t:null,service_type:e.service_type,wp_object_type:null!==(l=e.wp_object_type)&&void 0!==l?l:null,wp_object_id:null!==(n=e.wp_object_id)&&void 0!==n?n:null,giav_entity_type:null!==(r=e.giav_entity_type)&&void 0!==r?r:null,giav_entity_id:null!==(i=e.giav_entity_id)&&void 0!==i?i:null,giav_supplier_id:null!==(o=e.giav_supplier_id)&&void 0!==o?o:null,giav_supplier_name:null!==(s=e.giav_supplier_name)&&void 0!==s?s:null,supplier_source:null!==(c=e.supplier_source)&&void 0!==c?c:null,supplier_resolution_chain:Array.isArray(e.supplier_resolution_chain)?e.supplier_resolution_chain:[],preflight_ok:null!==(u=e.preflight_ok)&&void 0!==u?u:null,warnings:Array.isArray(e.warnings)?e.warnings:[],blocking:Array.isArray(e.blocking)?e.blocking:[],supplier_override:!!e.supplier_override,title:null!==(d=e.title)&&void 0!==d?d:`Item ${a+1}`,display_name:null!==(p=e.display_name)&&void 0!==p?p:null,start_date:e.start_date||null,end_date:e.end_date||null,quantity:null!==(m=e.quantity)&&void 0!==m?m:1,pax_quantity:null!==(_=e.pax_quantity)&&void 0!==_?_:null,hotel_rate_basis:null!==(v=e.hotel_rate_basis)&&void 0!==v?v:null,hotel_nights:null!==(g=e.hotel_nights)&&void 0!==g?g:null,hotel_rooms:null!==(b=e.hotel_rooms)&&void 0!==b?b:null,hotel_room_type:null!==(E=e.hotel_room_type)&&void 0!==E?E:"",hotel_regimen:null!==(h=e.hotel_regimen)&&void 0!==h?h:"",room_pricing:null!==(y=e.room_pricing)&&void 0!==y?y:null,discounts:null!==(f=e.discounts)&&void 0!==f?f:null,giav_pricing:null!==(N=e.giav_pricing)&&void 0!==N?N:null,package_components:Array.isArray(e.package_components)?e.package_components:[],package_components_text:null!==(C=e.package_components_text)&&void 0!==C?C:"",green_fees_per_person:null!==(S=e.green_fees_per_person)&&void 0!==S?S:null,number_of_players:null!==(w=e.number_of_players)&&void 0!==w?w:null,total_green_fees:null!==(x=e.total_green_fees)&&void 0!==x?x:null,unit_cost_net:K(e.unit_cost_net),unit_sell_price:K(e.unit_sell_price),line_cost_net:K(e.line_cost_net),line_sell_price:K(e.line_sell_price),use_markup:!!e.use_markup,markup_pct:K(null!==(T=e.markup_pct)&&void 0!==T?T:0),lock_sell_price:!!e.lock_sell_price,notes_public:null!==(k=e.notes_public)&&void 0!==k?k:"",notes_internal:null!==(M=e.notes_internal)&&void 0!==M?M:""}}),t=i||{totals_cost_net:0,totals_sell_price:0,totals_margin_abs:0,totals_margin_pct:0};return{header:e,items:a,totals:{totals_cost_net:K(t.totals_cost_net),totals_sell_price:K(t.totals_sell_price),totals_margin_abs:K(t.totals_margin_abs),totals_margin_pct:K(t.totals_margin_pct)},template_id:null,terms_version:null,metadata:{created_at:(new Date).toISOString(),created_by:null,source:"wp-travel-giav-admin",schema_version:"v2"}}},[n,r,i]),E=b?.header||{},h=b?.totals||{},y=Array.isArray(b?.items)?b.items:[],f=(0,t.useMemo)(()=>{let e=0,a=0;return y.forEach(t=>{const l=Array.isArray(t?.warnings)?t.warnings:[],n=Array.isArray(t?.blocking)?t.blocking:[];e+=l.length,a+=n.length}),{warningCount:e,blockingCount:a}},[y]),N=f.blockingCount>0?"error":f.warningCount>0?"warning":"success",C=f.blockingCount>0?`Hay ${f.blockingCount} servicios con errores`:f.warningCount>0?`Hay ${f.warningCount} avisos en servicios`:"Servicios listos para enviar",S=(0,t.useMemo)(()=>{var e,a,t;const l=Math.max(0,W(null!==(e=E?.pax_total)&&void 0!==e?e:0,0)),n=W(null!==(a=null!==(t=E?.players_count)&&void 0!==t?t:l)&&void 0!==a?a:0,0),r=Math.min(Math.max(n,0),l),i=Math.max(0,l-r);let o=0,s=0,c=0,u=0,d=0;y.forEach(e=>{if("golf"===e.service_type&&(o+=z(e.line_sell_price||0)),"hotel"===e.service_type){const l=e.room_pricing||{};var a,t;l.double?.enabled&&(s+=z(l.double?.total_pvp||0),u+=Math.max(0,W(null!==(a=l.double?.rooms)&&void 0!==a?a:0,0))),l.single?.enabled&&(c+=z(l.single?.total_pvp||0),d+=Math.max(0,W(null!==(t=l.single?.rooms)&&void 0!==t?t:0,0)))}});const p=z(h?.totals_sell_price||0),m=l>0?(p-o)/l:0,_=r>0?m+o/r:null,v=u>0&&d>0;let g=null;if(v){const e=s/(2*u),a=c/d;g=Math.max(0,a-e)}return{paxTotal:l,playersCount:r,nonPlayersCount:i,totalTrip:p,priceNonPlayerDouble:m,pricePlayerDouble:_,supplementSingle:g,hasSingleSupplement:v}},[E?.pax_total,E?.players_count,y,h?.totals_sell_price]),w="edit"===c?"Guardar nueva versión":E.customer_email?"Enviar propuesta":"Crear enlace";return(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Preview y envío")),(0,a.createElement)(l.CardBody,null,v&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>g("")},v),(0,a.createElement)(l.Notice,{status:N,isDismissible:!1},C),(0,a.createElement)(l.Notice,{status:"info",isDismissible:!1},"El cliente vera solo el total del paquete. El desglose por lineas queda guardado internamente en la version."),(0,a.createElement)("div",{style:{marginTop:12,padding:12,border:"1px solid #e5e5e5",borderRadius:10,background:"#fff"}},(0,a.createElement)("div",{style:{fontWeight:800}},E.customer_name),(0,a.createElement)("div",{style:{opacity:.8}},E.start_date," - ",E.end_date," | Pax: ",E.pax_total," | Moneda: ",E.currency),(0,a.createElement)("div",{style:{marginTop:10,display:"grid",gap:10}},y.map((e,t)=>{const l=Array.isArray(e?.warnings)?e.warnings:[],n=Array.isArray(e?.blocking)?e.blocking:[],r=e.display_name||e.title||`Item ${t+1}`,i=e.giav_supplier_name||"Proveedor no especificado",o=n.length>0,s=l.length>0;return(0,a.createElement)("div",{key:t,className:"preview-item"},(0,a.createElement)("div",{className:"preview-item__main"},(0,a.createElement)("div",{className:"preview-item__title"},(0,a.createElement)("strong",null,e.service_type?.toUpperCase())," - ",r),(0,a.createElement)("div",{className:"preview-item__supplier"},"Proveedor: ",i),"hotel"===e.service_type&&e.hotel_room_type?(0,a.createElement)("div",{className:"preview-item__meta"},"Habitacion: ",e.hotel_room_type):null,"package"===e.service_type&&e.package_components_text?(0,a.createElement)("div",{className:"preview-item__meta"},"Incluye: ",e.package_components_text.split("\\n").filter(Boolean).join(", ")):null,o&&(0,a.createElement)("div",{className:"preview-item__blocking"},(0,a.createElement)("span",{className:"preview-item__badge preview-item__badge--error"},"Error"),"Este servicio impide la confirmacion."),o&&(0,a.createElement)("details",{className:"preview-item__details"},(0,a.createElement)("summary",null,"Ver motivos"),(0,a.createElement)("ul",null,n.map((e,t)=>(0,a.createElement)("li",{key:t},e?.message||"Revision requerida")))),s&&(0,a.createElement)("details",{className:"preview-item__details"},(0,a.createElement)("summary",null,(0,a.createElement)("span",{className:"preview-item__badge preview-item__badge--warning"},"Aviso"),"Ver avisos (",l.length,")"),(0,a.createElement)("ul",null,l.map((e,t)=>(0,a.createElement)("li",{key:t},e?.message||"Aviso"))))),(0,a.createElement)("div",{className:"preview-item__price"},E.currency," ",K(e.line_sell_price||0).toFixed(2)))})),(0,a.createElement)("div",{style:{marginTop:12,borderTop:"1px solid #eee",paddingTop:12}},(0,a.createElement)("div",{style:{fontSize:12,opacity:.7}},"Total paquete"),(0,a.createElement)("div",{style:{fontSize:20,fontWeight:900}},E.currency," ",K(S.totalTrip).toFixed(2)),S.playersCount>0&&(0,a.createElement)("div",{style:{marginTop:6,fontSize:12,opacity:.85}},"Precio jugador en doble: ",E.currency," ",K(S.pricePlayerDouble||0).toFixed(2)),(0,a.createElement)("div",{style:{marginTop:6,fontSize:12,opacity:.85}},"Precio no jugador en doble: ",E.currency," ",K(S.priceNonPlayerDouble||0).toFixed(2)),S.hasSingleSupplement&&(0,a.createElement)("div",{style:{marginTop:6,fontSize:12,opacity:.85}},"Suplemento individual: ",E.currency," ",K(S.supplementSingle||0).toFixed(2)),(0,a.createElement)("div",{style:{marginTop:8,fontSize:11,opacity:.7}},"Precios por persona. El suplemento individual aplica por persona alojada en habitación individual."))),(0,a.createElement)("div",{style:{marginTop:16,display:"flex",gap:8,alignItems:"center"}},(0,a.createElement)(l.Button,{variant:"secondary",onClick:o,disabled:d},"Volver"),(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{_(!0),g("");const a=function(){const a=e&&Number(e)>0?Number(e):null;if(a)return a;return(()=>{try{const e=window.location.search||"";if(!e)return null;const a=new URLSearchParams(e),t=["proposal_id","id","proposalId","proposalId"];for(let e of t){const t=a.get(e);if(t){const e=parseInt(t,10);if(Number.isFinite(e)&&e>0)return e}}}catch(e){}return null})()||null}();try{"undefined"!=typeof process&&process&&process.env}catch(e){}if(!a||Number(a)<=0)return _(!1),void g("No se pudo enviar: falta el identificador de propuesta válido (proposalId).");try{const e="edit"===c?await m(a,b,u):await p(a,b,u);s({versionId:e.version_id,publicToken:e.public_token,publicUrl:e.public_url,status:e.status,snapshot:b})}catch(e){g(e?.message||"Error enviando la propuesta.")}finally{_(!1)}},disabled:d},w),d&&(0,a.createElement)(l.Spinner,null))))}const Z={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",queued:"En cola",synced:"Sincronizada",error:"Error",revoked:"Revocada",lost:"Perdida"},Y=e=>{if(!e)return"-";const a=String(e),t=a.includes("T")?a:a.replace(" ","T"),l=new Date(t);return Number.isNaN(l.getTime())?e:new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short"}).format(l)},Q=(e={})=>{const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.delete("proposal_id"),a.searchParams.delete("action"),Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t?a.searchParams.set(e,t):a.searchParams.delete(e)}),a.toString()};function X({onExit:e,mode:n="create",initialProposal:r=null,initialSnapshot:i=null,nextVersionNumber:o=1}){const[s,c]=(0,t.useState)(1),[u,d]=(0,t.useState)(r?.id||null),[p,m]=(0,t.useState)(r?.status||"draft"),[_]=(0,t.useState)(r?.accepted_at||""),[v]=(0,t.useState)(r?.proposal_token||""),[g,b]=(0,t.useState)(r?.public_url||""),[E,h]=(0,t.useState)(null),[y,f]=(0,t.useState)(!1),N=(0,t.useMemo)(()=>{if(!r&&!i)return null;const e=i?.header||{};return{proposal_title:e.proposal_title||r?.proposal_title||"",customer_name:e.customer_name||r?.customer_name||"",customer_email:e.customer_email||r?.customer_email||"",customer_country:e.customer_country||r?.customer_country||"",customer_language:e.customer_language||r?.customer_language||"en",start_date:e.start_date||r?.start_date||"",end_date:e.end_date||r?.end_date||"",pax_total:e.pax_total||r?.pax_total||1,currency:e.currency||r?.currency||"EUR"}},[r,i]),[C,S]=(0,t.useState)(N),[w,x]=(0,t.useState)(i?.items||[]),[T,M]=(0,t.useState)(i?.totals||null),[I,P]=(0,t.useState)(null),[A,B]=(0,t.useState)(null);if(1===s)return(0,a.createElement)(k,{initialValues:C||{customer_language:"en",currency:"EUR",pax_total:1},onNext:({basics:e})=>{S(e),x(a=>O(a,e)),c(2)},onCreated:({proposalId:e,basics:a})=>{d(e),S(a),x(e=>O(e,a)),c(2)},proposalId:u});if(2===s)return(0,a.createElement)(q,{basics:C,initialItems:w,onDraftChange:({items:e,totals:a})=>{x(e),M(a)},onBack:()=>c(1),onNext:({items:e,totals:a})=>{x(e),M(a),c(3)}});if(3===s)return(0,a.createElement)(J,{proposalId:u,basics:C,items:w,totals:T,mode:n,versionNumber:o,onBack:()=>c(2),onSent:({versionId:e,snapshot:a,publicUrl:t,publicToken:l,status:n})=>{B(e),P(a||null),t&&b(t),l&&h(l),n&&m(n),c(4)}});if(4===s){const t=g||((e,a)=>{if(!e)return"";const t=`${window.location.origin}/travel-proposal/${e}/`;return a?`${window.location.origin}/travel-proposal/${e}/v/${a}/`:t})(v,E),r=Z[p]||p||"-",i=_?`Aceptada el ${Y(_)}`:"Pendiente",o=(({email:e,name:a,publicUrl:t})=>{if(!e||!t)return"";const l=`${a?`Hola ${a},`:"Hola,"}\n\nAquí tienes el enlace a tu propuesta:\n${t}\n\nQuedamos a tu disposición para cualquier duda.`;return`mailto:${e}?subject=${encodeURIComponent("Tu propuesta de viaje")}&body=${encodeURIComponent(l)}`})({email:C?.customer_email,name:C?.customer_name,publicUrl:t}),s=async()=>{await async function(e){if(!e)return!1;try{if(navigator.clipboard?.writeText)return await navigator.clipboard.writeText(e),!0}catch(e){}const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.top="-1000px",document.body.appendChild(a),a.focus(),a.select();const t=document.execCommand("copy");return document.body.removeChild(a),t}(t)&&(f(!0),window.setTimeout(()=>f(!1),1500))};return(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Preview y envío")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)(l.Notice,{status:"success",isDismissible:!1},"edit"===n?"Nueva versión creada:":"Propuesta enviada. Versión creada:"," ",(0,a.createElement)("strong",null,A)),"accepted"===p&&_?(0,a.createElement)(l.Notice,{status:"info",isDismissible:!1},"Aceptada el ",Y(_),"."):null,(0,a.createElement)("div",{style:{marginTop:16,display:"grid",gap:8}},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Estado:")," ",r),(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Aceptación:")," ",i),(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"GIAV:")," El expediente se creará tras la aceptación del cliente.")),(0,a.createElement)("div",{style:{marginTop:16,display:"flex",gap:8,flexWrap:"wrap",alignItems:"center"}},"accepted"!==p?(0,a.createElement)(l.Button,{variant:"primary",onClick:s,disabled:!t},y?"Enlace copiado":"Copiar enlace público"):null,o?(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.location.assign(o)},"Enviar email al cliente"):null,t?(0,a.createElement)(l.Button,{variant:"link",href:t,target:"_blank",rel:"noopener noreferrer"},"Abrir vista pública"):null,(0,a.createElement)(l.Button,{variant:"link",href:Q({proposal_id:u})},"Ir al repositorio / ver detalle"),(0,a.createElement)(l.Button,{variant:"tertiary",onClick:e},"Salir"))))}return null}function ee({selectedId:e,selectedLabel:n,onPick:r,disabled:i}){const[o,s]=(0,t.useState)(n||""),[c,u]=(0,t.useState)([]),[d,p]=(0,t.useState)(!1),[m,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(""),b=(0,t.useRef)(null);(0,t.useEffect)(()=>{(n||"")!==o&&n&&s(n)},[n]);const E=e?"Seleccionado: "+(n?`${n} (#${e})`:`#${e}`):"Se valida en GIAV al guardar (Proveedor_GET).";return(0,a.createElement)("div",{style:{position:"relative"}},(0,a.createElement)(l.TextControl,{value:o,onChange:function(e){s(e),clearTimeout(b.current),b.current=setTimeout(()=>async function(e){const a=(e||"").trim();if(a.length<2)return u([]),g(""),void p(!1);_(!0),g("");try{const e=await N({q:a,pageSize:20,pageIndex:0,includeDisabled:!1}),t=(Array.isArray(e)?e:Array.isArray(e?.items)?e.items:[]).map(e=>{var a,t,l,n,r,i,o,s;return{id:String(null!==(a=null!==(t=null!==(l=null!==(n=e.id)&&void 0!==n?n:e.ID)&&void 0!==l?l:e.Id)&&void 0!==t?t:e.proveedorId)&&void 0!==a?a:""),label:String(null!==(r=null!==(i=null!==(o=null!==(s=e.label)&&void 0!==s?s:e.NombreAlias)&&void 0!==o?o:e.Nombre)&&void 0!==i?i:e.title)&&void 0!==r?r:"")}}).filter(e=>e.id&&e.label);u(t),p(t.length>0)}catch(e){g(e?.message||"No se pudo buscar en GIAV."),u([]),p(!1)}finally{_(!1)}}(e),250)},onFocus:()=>{c.length>0&&p(!0)},placeholder:"Busca por nombre (mín. 2 letras)…",disabled:i,help:E}),m&&(0,a.createElement)("div",{style:{marginTop:6}},(0,a.createElement)(l.Spinner,null)),v&&(0,a.createElement)("div",{style:{marginTop:6,color:"#b32d2e",fontSize:12}},v),d&&c.length>0&&(0,a.createElement)("div",{style:{position:"absolute",zIndex:30,left:0,right:0,top:"100%",background:"#fff",border:"1px solid #ddd",borderTop:"none",maxHeight:260,overflow:"auto"}},c.map(e=>(0,a.createElement)("div",{key:e.id,onMouseDown:a=>{a.preventDefault(),function(e){s(e.label),u([]),p(!1),g(""),r?.(e)}(e)},style:{padding:"10px 12px",cursor:"pointer",borderBottom:"1px solid #f0f0f0"}},(0,a.createElement)("div",{style:{fontWeight:600}},e.label),(0,a.createElement)("div",{style:{fontSize:12,opacity:.75}},"ID: ",e.id)))))}function ae({status:e}){let t="⚠️ missing";return"active"===e&&(t="✅ active"),"needs_review"===e&&(t="🟠 needs_review"),"deprecated"===e&&(t="⛔ deprecated"),(0,a.createElement)("span",{style:{whiteSpace:"nowrap"}},t)}function te(){const[e,n]=(0,t.useState)("hotel"),[r,i]=(0,t.useState)(""),[o,s]=(0,t.useState)(!1),[c,u]=(0,t.useState)(null),[d,p]=(0,t.useState)({items:[],total:0}),[m,_]=(0,t.useState)({}),[v,g]=(0,t.useState)(null),[b,E]=(0,t.useState)({}),[N,C]=(0,t.useState)({id:"",label:""}),[S,w]=(0,t.useState)(!1),x=(0,t.useMemo)(()=>d.items||[],[d]),T=(0,t.useMemo)(()=>Object.keys(b).filter(e=>b[e]),[b]),k=(0,t.useMemo)(()=>x.length>0&&x.every(e=>b[M(e)]),[x,b]);function M(e){return`${e.wp_object_type}:${e.wp_object_id}`}function I(e){var a,t,l;const n=M(e),r=m[n]||{},i=e.mapping||{status:"missing"};return{providerId:null!==(a=r.providerId)&&void 0!==a?a:i.giav_entity_id?String(i.giav_entity_id):"",providerName:null!==(t=r.providerName)&&void 0!==t?t:i.giav_supplier_name?String(i.giav_supplier_name):"",status:null!==(l=r.status)&&void 0!==l?l:i.status||"missing"}}async function P(){s(!0),u(null);try{const a=await h({type:e,q:r});p(a||{items:[],total:0})}catch(e){u({status:"error",message:e?.message||"No se pudo cargar el mapeo."}),p({items:[],total:0})}finally{s(!1)}}return(0,t.useEffect)(()=>{P()},[e]),(0,a.createElement)("div",{style:{maxWidth:1100,margin:"24px auto"}},(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"GIAV Mapping")),(0,a.createElement)(l.CardBody,null,c&&(0,a.createElement)(l.Notice,{status:c.status,isDismissible:!0,onRemove:()=>u(null)},c.message),(0,a.createElement)("div",{style:{display:"flex",gap:12,alignItems:"flex-end",marginBottom:12}},(0,a.createElement)(l.SelectControl,{label:"Tipo",value:e,options:[{label:"Hoteles",value:"hotel"},{label:"Campos",value:"golf"}],onChange:e=>n(e)}),(0,a.createElement)(l.TextControl,{label:"Buscar",value:r,onChange:e=>i(e),placeholder:"hotel"===e?"Nombre del hotel…":"Nombre del campo…"}),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>P(),disabled:o},o?(0,a.createElement)(l.Spinner,null):"Actualizar")),(0,a.createElement)("div",{style:{display:"flex",gap:12,alignItems:"flex-end",marginBottom:12}},(0,a.createElement)("div",{style:{flex:1}},(0,a.createElement)("label",{style:{display:"block",fontSize:12,marginBottom:4,opacity:.8}},"Aplicar proveedor a seleccionados"),(0,a.createElement)(ee,{selectedId:N?.id,selectedLabel:N?.label,disabled:S,onPick:({id:e,label:a})=>C({id:e,label:a})})),(0,a.createElement)(l.Button,{variant:"primary",onClick:async function(){const a="hotel"===e?"hotel":"course",t=T;if(N?.id)if(0!==t.length){w(!0),u(null);try{var l,n;const e=t.map(e=>{const a=String(e).split(":");return{wp_object_id:parseInt(a[1],10)}}).filter(e=>e.wp_object_id>0),r=await f({wp_object_type:a,giav_supplier_id:String(N.id),items:e,status:"active",match_type:"batch"}),i=`Mapeo en lote aplicado. Creados: ${null!==(l=r?.created)&&void 0!==l?l:0}, actualizados: ${null!==(n=r?.updated)&&void 0!==n?n:0}${r?.errors?.length?`, errores: ${r.errors.length}`:""}.`;u({status:!1===r?.ok?"warning":"success",message:i}),E({}),await P()}catch(e){u({status:"error",message:e?.message||"No se pudo aplicar el mapeo en lote."})}finally{w(!1)}}else u({status:"warning",message:"Selecciona al menos una fila para aplicar el mapeo en lote."});else u({status:"warning",message:"Selecciona un proveedor para aplicar en lote."})},isBusy:S,disabled:S},"Aplicar en lote (",T.length,")")),(0,a.createElement)("div",{style:{overflowX:"auto"}},(0,a.createElement)("table",{className:"widefat striped"},(0,a.createElement)("thead",null,(0,a.createElement)("tr",null,(0,a.createElement)("th",{style:{width:30}},(0,a.createElement)("input",{type:"checkbox",checked:k,onChange:e=>function(e){const a={};x.forEach(t=>{a[M(t)]=!!e}),E(a)}(e.target.checked)})),(0,a.createElement)("th",null,"Objeto"),(0,a.createElement)("th",null,"Estado"),(0,a.createElement)("th",null,"Proveedor (GIAV)"),(0,a.createElement)("th",null,"Acción"))),(0,a.createElement)("tbody",null,o&&(0,a.createElement)("tr",null,(0,a.createElement)("td",{colSpan:"4",style:{padding:16,textAlign:"center"}},(0,a.createElement)(l.Spinner,null))),!o&&x.map(e=>{const t=M(e),n=I(e);return(0,a.createElement)("tr",{key:t},(0,a.createElement)("td",null,(0,a.createElement)("input",{type:"checkbox",checked:!!b[t],onChange:a=>function(e,a){const t=M(e);E(e=>({...e,[t]:!!a}))}(e,a.target.checked)})),(0,a.createElement)("td",null,(0,a.createElement)("div",{style:{fontWeight:600}},e.title),(0,a.createElement)("div",{style:{opacity:.7,fontSize:12}},e.wp_object_type," #",e.wp_object_id)),(0,a.createElement)("td",null,(0,a.createElement)(ae,{status:e.mapping?.status||"missing"})),(0,a.createElement)("td",null,(0,a.createElement)(ee,{selectedId:n.providerId,selectedLabel:n.providerName||e.mapping?.giav_supplier_name||"",disabled:v&&v!==t,onPick:({id:a,label:t})=>function(e,a){const t=M(e);_(e=>({...e,[t]:{...e[t]||{},...a}}))}(e,{providerId:a,providerName:t,status:"active"})}),e.mapping?.giav_entity_id&&(0,a.createElement)("div",{style:{opacity:.7,fontSize:12,marginTop:4}},"Actual: #",e.mapping.giav_entity_id," ",e.mapping?.giav_supplier_name?(0,a.createElement)("span",null,"(",e.mapping.giav_supplier_name,")"):null," ","(",e.mapping.status,")")),(0,a.createElement)("td",null,(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>async function(e){const a=M(e),t=I(e);if(!t.providerId)return void u({status:"warning",message:"Selecciona un proveedor de GIAV."});g(a),u(null);const l="1734698"===String(t.providerId);try{await y({wp_object_type:e.wp_object_type,wp_object_id:e.wp_object_id,giav_entity_type:"supplier",giav_entity_id:String(t.providerId),giav_supplier_id:String(t.providerId),giav_supplier_name:t.providerName||null,status:l?"needs_review":"active",match_type:l?"auto_generic":"manual"}),u({status:"success",message:"Mapeo guardado (validado en GIAV)."}),_(e=>{const t={...e};return delete t[a],t}),await P()}catch(e){u({status:"error",message:e?.message||"No se pudo guardar el mapeo."})}finally{g(null)}}(e),isBusy:v===t,disabled:v&&v!==t},"Guardar")))}),!o&&0===(d.items||[]).length&&(0,a.createElement)("tr",null,(0,a.createElement)("td",{colSpan:"4",style:{padding:16,textAlign:"center",opacity:.7}},"Sin resultados."))))))))}function le(e){if(!e)return"-";const a=new Date(e);return Number.isNaN(a.getTime())?e:new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short"}).format(a)}const ne={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",queued:"En cola",synced:"Sincronizada",error:"Error",revoked:"Revocada",lost:"Perdida"},re={client:"Cliente",admin:"Admin"},ie={pending:"Pendiente",confirmed:"Confirmada"},oe={none:"No iniciado",pending:"En proceso",ok:"Creado",error:"Error"};function se(e={}){const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.delete("proposal_id"),a.searchParams.delete("action"),Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t?a.searchParams.set(e,t):a.searchParams.delete(e)}),a.toString()}function ce({proposalId:e}){var n;const[r,i]=(0,t.useState)(!1),[o,c]=(0,t.useState)(""),[u,d]=(0,t.useState)(null),[p,m]=(0,t.useState)(!1),[b,E]=(0,t.useState)(null),[h,y]=(0,t.useState)(""),[f,N]=(0,t.useState)(!1),[C,S]=(0,t.useState)(!1),w=async()=>{i(!0),c("");try{const a=await s(e);d(a)}catch(e){c(e?.message||"No se pudo cargar la propuesta.")}finally{i(!1)}};if((0,t.useEffect)(()=>{if(!e)return d(null),void c("Propuesta no encontrada.");w()},[e]),(0,t.useEffect)(()=>{if(u?.proposal){const e=u.proposal.current_version_id;y(e?String(e):"")}},[u?.proposal?.current_version_id]),r&&!u)return(0,a.createElement)(l.Spinner,null);if(!u?.proposal&&o)return(0,a.createElement)("div",{style:{display:"grid",gap:12}},(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>c("")},o),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.location.href=se()},"Volver al listado"));if(!u?.proposal)return(0,a.createElement)("div",{style:{display:"grid",gap:12}},(0,a.createElement)(l.Notice,{status:"warning",isDismissible:!1},"Propuesta no encontrada."),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.location.href=se()},"Volver al listado"));const{proposal:x,versions:T=[]}=u,k=ie[x.confirmation_status]||("accepted"===x.status?"Pendiente":"-"),M=T.find(e=>Number(e.id)===Number(x.accepted_version_id)),I=T.find(e=>String(e.id)===String(h)),P=T.map(e=>{var a;return{label:`#${null!==(a=e.version_number)&&void 0!==a?a:e.id} · ${le(e.created_at)}`,value:String(e.id)}}),A=ne[x.status]||x.status||"-",B=x.giav_sync_status||"none",G=oe[B]||B||"-",D="accepted"===x.status,R=Boolean(x.giav_expediente_id),F="error"===B,L="pending"===B,V=[{label:"ID cliente",value:x.giav_client_id},{label:"ID expediente",value:x.giav_expediente_id},{label:"ID reserva PQ",value:x.giav_pq_reserva_id}].filter(e=>e.value);return(0,a.createElement)("div",{style:{display:"grid",gap:16}},o&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>c("")},o),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-detail__header"},(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__eyebrow"},"Detalle de propuesta · #",x.id),(0,a.createElement)("div",{className:"proposal-detail__title-row"},(0,a.createElement)("h2",{className:"proposal-detail__title"},x.proposal_title||"Propuesta sin título"),(0,a.createElement)("span",{className:`proposal-status proposal-status--${x.status||"draft"} proposal-status--large`},A))),(0,a.createElement)("div",{className:"proposal-detail__actions"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>{window.location.href=se({proposal_id:x.id,action:"edit"})}},"Editar propuesta"),x.public_url?(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>window.open(x.public_url,"_blank","noopener")},"Abrir vista pública"):null,(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>{window.location.href=se()}},"Volver al listado")))),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{className:"proposal-detail__summary"},(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Cliente"),(0,a.createElement)("div",{className:"proposal-detail__value"},x.customer_name||"-")),(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Email"),(0,a.createElement)("div",{className:"proposal-detail__value"},x.customer_email||"-")),(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Fechas"),(0,a.createElement)("div",{className:"proposal-detail__value"},x.start_date," - ",x.end_date)),(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Última actualización"),(0,a.createElement)("div",{className:"proposal-detail__value"},le(x.updated_at)))))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Enlace para cliente")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{className:"proposal-detail__block"},(0,a.createElement)(l.TextControl,{label:"URL pública",value:x.public_url||"",readOnly:!0}),(0,a.createElement)("p",{className:"proposal-detail__helper"},"Este es el enlace que verá el cliente."),(0,a.createElement)("div",{className:"proposal-detail__button-row"},(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{await async function(e){if(!e)return!1;try{if(navigator.clipboard?.writeText)return await navigator.clipboard.writeText(e),!0}catch(e){}const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.top="-1000px",document.body.appendChild(a),a.focus(),a.select();const t=document.execCommand("copy");return document.body.removeChild(a),t}(x.public_url)&&(m(!0),window.setTimeout(()=>m(!1),1500))}},p?"Enlace copiado":"Copiar"),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.open(x.public_url,"_blank","noopener")},"Abrir"))))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-detail__section-title"},(0,a.createElement)("strong",null,"Estado de aceptación"),(0,a.createElement)("span",{className:"proposal-detail__pill "+(D?"proposal-detail__pill--success":"proposal-detail__pill--warning")},D?"Aceptada":"Pendiente de aceptación"))),(0,a.createElement)(l.CardBody,null,D?(0,a.createElement)("div",{className:"proposal-detail__grid"},(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Fecha de aceptación"),(0,a.createElement)("div",{className:"proposal-detail__value"},le(x.accepted_at))),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Aceptada por"),(0,a.createElement)("div",{className:"proposal-detail__value"},re[x.accepted_by]||"-")),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Versión aceptada"),(0,a.createElement)("div",{className:"proposal-detail__value"},M?`#${null!==(n=M.version_number)&&void 0!==n?n:M.id}`:x.accepted_version_id||"-")),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Confirmación"),(0,a.createElement)("div",{className:"proposal-detail__value"},k))):(0,a.createElement)("div",{className:"proposal-detail__block"},(0,a.createElement)(l.SelectControl,{label:"Versión a aceptar",value:h,options:P,onChange:e=>y(e),disabled:f||0===P.length}),(0,a.createElement)("div",{className:"proposal-detail__button-row"},(0,a.createElement)(l.Button,{variant:"primary",disabled:f||!I,onClick:async()=>{N(!0),c("");try{await v(x.id,I.id),await w()}catch(e){c(e?.message||"No se pudo marcar como aceptada.")}finally{N(!1)}}},"Marcar como aceptada"))))),(x.traveler_full_name||x.traveler_dni)&&(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Datos del viajero")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{style:{display:"grid",gap:8}},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Nombre completo:")," ",x.traveler_full_name||"-"),(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"DNI:")," ",x.traveler_dni||"-")))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-detail__section-title"},(0,a.createElement)("strong",null,"Integración GIAV"),(0,a.createElement)("span",{className:"proposal-detail__pill proposal-detail__pill--"+("ok"===B?"success":"error"===B?"danger":"pending"===B?"warning":"neutral")},G))),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{className:"proposal-detail__block"},V.length>0?(0,a.createElement)("div",{className:"proposal-detail__grid"},V.map(e=>(0,a.createElement)("div",{key:e.label},(0,a.createElement)("div",{className:"proposal-detail__label"},e.label),(0,a.createElement)("div",{className:"proposal-detail__value"},e.value))),x.giav_sync_updated_at?(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Última actualización"),(0,a.createElement)("div",{className:"proposal-detail__value"},le(x.giav_sync_updated_at))):null):(0,a.createElement)("p",{className:"proposal-detail__helper"},"Aún no hay identificadores de GIAV vinculados."),x.giav_sync_error?(0,a.createElement)("div",{className:"proposal-detail__error"},(0,a.createElement)("strong",null,"Error:")," ",x.giav_sync_error):null,(0,a.createElement)("div",{className:"proposal-detail__cta"},D?F&&!R?(0,a.createElement)(l.Button,{variant:"primary",disabled:C,onClick:async()=>{S(!0),c("");try{await g(x.id),await w()}catch(e){c(e?.message||"No se pudo reintentar GIAV.")}finally{S(!1)}}},"Reintentar GIAV"):R||L?L?(0,a.createElement)("span",{className:"proposal-detail__helper"},"En proceso de creación en GIAV."):(0,a.createElement)("span",{className:"proposal-detail__helper"},"Expediente creado y sincronizado."):(0,a.createElement)(l.Button,{variant:"primary",disabled:C,onClick:async()=>{S(!0),c("");try{await g(x.id),await w()}catch(e){c(e?.message||"No se pudo crear en GIAV.")}finally{S(!1)}}},"Crear expediente en GIAV"):(0,a.createElement)("span",{className:"proposal-detail__helper"},"Disponible tras aceptación."))))),"accepted"===x.status&&(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Siguiente paso")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("p",{style:{margin:0}},"Confirmar disponibilidad y servicios. Cuando esté confirmada, se invitará al portal (futuro)."))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Versiones")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("details",{className:"proposal-detail__versions",open:!0},(0,a.createElement)("summary",null,"Histórico de versiones (",T.length,")"),(0,a.createElement)("div",{className:"proposal-detail__table"},(0,a.createElement)("table",{className:"wp-list-table widefat fixed striped"},(0,a.createElement)("thead",null,(0,a.createElement)("tr",null,(0,a.createElement)("th",null,"ID"),(0,a.createElement)("th",null,"Versión"),(0,a.createElement)("th",null,"Fecha"),(0,a.createElement)("th",null,"Total comercial"),(0,a.createElement)("th",null,"Estado"),(0,a.createElement)("th",null,"Acciones"))),(0,a.createElement)("tbody",null,0===T.length?(0,a.createElement)("tr",null,(0,a.createElement)("td",{colSpan:6},"No hay versiones.")):T.map(e=>{var t,n;const r=Number(x.current_version_id)===Number(e.id),i=Number(x.accepted_version_id)===Number(e.id);return(0,a.createElement)("tr",{key:e.id,className:i?"proposal-detail__row--accepted":void 0},(0,a.createElement)("td",null,e.id),(0,a.createElement)("td",null,null!==(t=e.version_number)&&void 0!==t?t:"-"),(0,a.createElement)("td",null,le(e.created_at)),(0,a.createElement)("td",null,null!==(n=e.totals_sell_price)&&void 0!==n?n:"-"),(0,a.createElement)("td",null,(0,a.createElement)("div",{className:"proposal-detail__version-badges"},r&&(0,a.createElement)("span",{className:"proposal-detail__pill proposal-detail__pill--info"},"Vigente"),i&&(0,a.createElement)("span",{className:"proposal-detail__pill proposal-detail__pill--success"},"Aceptada"),r||i?null:"—")),(0,a.createElement)("td",null,(0,a.createElement)("div",{className:"proposal-detail__action-stack"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.open(e.public_url||x.public_url,"_blank","noopener")},"Ver"),!r&&(0,a.createElement)(l.Button,{variant:"tertiary",disabled:b===e.id,onClick:async()=>{E(e.id);try{await _(x.id,e.id),await w()}catch(e){c(e?.message||"No se pudo actualizar la versión vigente.")}finally{E(null)}}},"Marcar vigente"))))}))))))))}const ue={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",queued:"En cola",synced:"Sincronizada",error:"Error",revoked:"Revocada",lost:"Perdida"},de=(e={})=>{const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.delete("proposal_id"),a.searchParams.delete("action"),Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t?a.searchParams.set(e,t):a.searchParams.delete(e)}),a.toString()},pe=document.getElementById("wp-travel-giav-admin");pe&&(0,t.createRoot)(pe).render((0,a.createElement)(function(){const e=new URLSearchParams(window.location.search||""),n=e.get("page")||"",r=e.get("proposal_id"),i=e.get("action");if("wp-travel-giav-mapping"===n)return(0,a.createElement)(te,null);const[c,p]=(0,t.useState)(!1),[m,_]=(0,t.useState)(null),[v,g]=(0,t.useState)(!1),[b,E]=(0,t.useState)(""),[h,y]=(0,t.useState)([]),[f,N]=(0,t.useState)(!1),[C,S]=(0,t.useState)(""),[w,x]=(0,t.useState)(""),[T,k]=(0,t.useState)("updated_at"),[M,I]=(0,t.useState)("desc"),[P,A]=(0,t.useState)([]),B=r?parseInt(r,10):null,G=Number.isNaN(B)?null:B,D="edit"===i&&G;(0,t.useEffect)(()=>{if(!D)return _(null),void E("");let e=!0;return(async()=>{g(!0),E("");try{const a=await s(G);e&&_(a)}catch(a){e&&E(a?.message||"No se pudo cargar la propuesta para editar.")}finally{e&&g(!1)}})(),()=>{e=!1}},[D,G]);const R=(0,t.useMemo)(()=>m?.proposal?{initialProposal:m.proposal,initialSnapshot:m.current_snapshot,nextVersionNumber:m.next_version_number||1}:null,[m]),F=async({nextSearch:e}={})=>{N(!0),S("");try{const a=void 0!==e?e:w,t=await o({orderBy:T,order:M,limit:50,offset:0,search:a?.trim()?a.trim():void 0}),l=Array.isArray(t?.items)?t.items:Array.isArray(t)?t:[];y(l),A(e=>e.filter(e=>l.some(a=>a.id===e)))}catch(e){S(e?.message||"No se pudo cargar el repositorio."),y([])}finally{N(!1)}};return(0,t.useEffect)(()=>{F()},[T,M]),c?(0,a.createElement)(X,{onExit:()=>p(!1)}):D?v?(0,a.createElement)("div",{style:{padding:16}},"Cargando..."):b?(0,a.createElement)("div",{style:{padding:16,color:"#b91c1c"}},b):R?(0,a.createElement)(X,{onExit:()=>{const e=new URL(window.location.href);e.searchParams.set("page","travel_proposals"),e.searchParams.set("proposal_id",G),e.searchParams.delete("action"),window.location.href=e.toString()},mode:"edit",...R}):null:G?(0,a.createElement)(ce,{proposalId:G}):(0,a.createElement)("div",{className:"wp-travel-giav-app"},(0,a.createElement)(l.Card,{className:"proposal-list"},(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-list__header"},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Repositorio de propuestas"),(0,a.createElement)("div",{className:"proposal-list__subtitle"},"Gestiona propuestas creadas, revisa su estado y accede al detalle.")),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>p(!0)},"Nueva propuesta"))),(0,a.createElement)(l.CardBody,null,C?(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>S("")},C):null,(0,a.createElement)("div",{className:"proposal-list__filters"},(0,a.createElement)("div",{className:"proposal-list__search"},(0,a.createElement)("label",{className:"proposal-list__search-label",htmlFor:"proposal-search"},"Buscar cliente"),(0,a.createElement)("input",{id:"proposal-search",className:"proposal-list__search-input",type:"search",value:w,onChange:e=>x(e.target.value),placeholder:"Cliente, email o token"})),(0,a.createElement)(l.SelectControl,{label:"Ordenar por",value:T,options:[{label:"Última actualización",value:"updated_at"},{label:"ID",value:"id"}],onChange:e=>k(e)}),(0,a.createElement)(l.SelectControl,{label:"Orden",value:M,options:[{label:"Descendente",value:"desc"},{label:"Ascendente",value:"asc"}],onChange:e=>I(e)}),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>F({nextSearch:w}),disabled:f},"Buscar"),(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>{x(""),F({nextSearch:""})},disabled:f},"Limpiar filtros"),(0,a.createElement)(l.Button,{variant:"secondary",isDestructive:!0,onClick:async()=>{if(window.confirm(`¿Seguro que quieres eliminar ${P.length} propuestas?`)){N(!0),S("");try{await d(P),A([]),await F()}catch(e){S(e?.message||"No se pudieron eliminar las propuestas.")}finally{N(!1)}}},disabled:f||0===P.length},"Eliminar seleccionadas (",P.length,")")),(0,a.createElement)("div",{className:"proposal-list__table"},(0,a.createElement)("div",{className:"proposal-list__row proposal-list__row--header"},(0,a.createElement)("div",{className:"proposal-list__select"},(0,a.createElement)(l.CheckboxControl,{checked:P.length===h.length&&h.length>0,onChange:()=>{P.length!==h.length?A(h.map(e=>e.id)):A([])}})),(0,a.createElement)("div",null,"ID"),(0,a.createElement)("div",null,"Título"),(0,a.createElement)("div",null,"Cliente"),(0,a.createElement)("div",null,"Estado"),(0,a.createElement)("div",null,"Última actualización"),(0,a.createElement)("div",null,"Autor"),(0,a.createElement)("div",null,"Acciones")),f?(0,a.createElement)("div",{className:"proposal-list__row proposal-list__row--loading"},(0,a.createElement)(l.Spinner,null),(0,a.createElement)("span",null,"Cargando propuestas…")):null,f||0!==h.length?null:(0,a.createElement)("div",{className:"proposal-list__empty"},"No hay propuestas aún."),!f&&h.map(e=>{const t=ue[e.status]||e.status||"—",n=e.display_title||e.proposal_title||"—";return(0,a.createElement)("div",{key:e.id,className:"proposal-list__row"},(0,a.createElement)("div",{className:"proposal-list__select"},(0,a.createElement)(l.CheckboxControl,{checked:P.includes(e.id),onChange:()=>(e=>{A(a=>a.includes(e)?a.filter(a=>a!==e):[...a,e])})(e.id)})),(0,a.createElement)("div",{className:"proposal-list__id"},"#",e.id),(0,a.createElement)("div",{className:"proposal-list__title"},n),(0,a.createElement)("div",{className:"proposal-list__customer"},(0,a.createElement)("div",{className:"proposal-list__customer-name"},e.customer_name||"—"),(0,a.createElement)("div",{className:"proposal-list__customer-meta"},e.start_date||"—"," - ",e.end_date||"—")),(0,a.createElement)("div",null,(0,a.createElement)("span",{className:`proposal-status proposal-status--${e.status||"draft"}`},t)),(0,a.createElement)("div",null,(e=>{if(!e)return"—";const a=String(e),t=a.includes("T")?a:a.replace(" ","T"),l=new Date(t);return Number.isNaN(l.getTime())?e:l.toLocaleString("es-ES",{dateStyle:"medium",timeStyle:"short"})})(e.updated_at)),(0,a.createElement)("div",null,e.author_name||"—"),(0,a.createElement)("div",{className:"proposal-list__actions"},(0,a.createElement)(l.Button,{variant:"secondary",href:de({proposal_id:e.id})},"Ver detalle"),(0,a.createElement)(l.DropdownMenu,{className:"proposal-list__actions-menu",icon:"ellipsis",label:"Más acciones",controls:[{title:"Editar",onClick:()=>{window.location.href=de({proposal_id:e.id,action:"edit"})}},...e.public_url?[{title:"Vista pública",onClick:()=>{window.open(e.public_url,"_blank","noopener,noreferrer")}}]:[],{title:"Eliminar",isDestructive:!0,onClick:()=>(async e=>{if(window.confirm("¿Seguro que quieres eliminar esta propuesta?")){N(!0),S("");try{await u(e),A(a=>a.filter(a=>a!==e)),await F()}catch(e){S(e?.message||"No se pudo eliminar la propuesta.")}finally{N(!1)}}})(e.id)}]})))})))))},null))})();