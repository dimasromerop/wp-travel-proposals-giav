(()=>{"use strict";var e={n:a=>{var t=a&&a.__esModule?()=>a.default:()=>a;return e.d(t,{a:t}),t},d:(a,t)=>{for(var l in t)e.o(t,l)&&!e.o(a,l)&&Object.defineProperty(a,l,{enumerable:!0,get:t[l]})},o:(e,a)=>Object.prototype.hasOwnProperty.call(e,a)};const a=window.React,t=window.wp.element,l=window.wp.components,n=window.wp.apiFetch;var r=e.n(n);const i=window.WP_TRAVEL_GIAV||window.CASANOVA_GESTION_RESERVAS||{};if(!r().__WP_TRAVEL_GIAV_CONFIGURED){const e=i.nonce||"",a=(e=>{if(e.wpRestRoot)return e.wpRestRoot;const a=e.apiUrl||e.restUrl;return a?a.replace(/\/travel\/v1\/?$/,"/"):"/wp-json/"})(i);a&&r().use(r().createRootURLMiddleware(a)),e&&r().use(r().createNonceMiddleware(e)),r().__WP_TRAVEL_GIAV_CONFIGURED=!0}const s=e=>r()({path:"/travel/v1/proposals",method:"POST",data:e}),o=({orderBy:e="updated_at",order:a="desc",limit:t=50,offset:l=0,search:n,author:i,page:s,per_page:o}={})=>{const c=new URLSearchParams;return c.set("order_by",e),c.set("order",a),c.set("limit",t),c.set("offset",l),void 0!==n&&c.set("search",n),void 0!==i&&c.set("author",i),void 0!==s&&c.set("page",s),void 0!==o&&c.set("per_page",o),r()({path:`/travel/v1/proposals?${c.toString()}`,method:"GET"})},c=e=>r()({path:`/travel/v1/proposals/${e}/detail`,method:"GET"}),u=(e,a)=>r()({path:`/travel/v1/proposals/${e}`,method:"PUT",data:a}),d=e=>r()({path:`/travel/v1/proposals/${e}`,method:"DELETE"}),m=e=>r()({path:"/travel/v1/proposals/bulk-delete",method:"POST",data:{ids:e}}),p=(e,a,t)=>r()({path:`/travel/v1/proposals/${e}/send`,method:"POST",data:{snapshot:a,version_number:t}}),_=(e,a,t)=>r()({path:`/travel/v1/proposals/${e}/versions`,method:"POST",data:{snapshot:a,version_number:t}}),v=(e,a)=>r()({path:`/travel/v1/proposals/${e}/current-version`,method:"POST",data:{version_id:a}}),g=(e,a)=>r()({path:`/travel/v1/proposals/${e}/accept`,method:"POST",data:{version_id:a}}),b=e=>r()({path:`/travel/v1/proposals/${e}/giav-retry`,method:"POST"}),h=({type:e,q:a})=>r()({path:`/travel/v1/catalog/search?type=${encodeURIComponent(e)}&q=${encodeURIComponent(a||"")}`,method:"GET"}),E=({wp_object_type:e,wp_object_id:a})=>r()({path:`/travel/v1/giav-mapping?wp_object_type=${encodeURIComponent(e)}&wp_object_id=${encodeURIComponent(a)}`,method:"GET"}),y=({type:e,q:a,limit:t=50,offset:l=0})=>r()({path:`/travel/v1/giav-mapping/list?type=${encodeURIComponent(e)}&q=${encodeURIComponent(a||"")}&limit=${encodeURIComponent(t)}&offset=${encodeURIComponent(l)}`,method:"GET"}),f=e=>r()({path:"/travel/v1/giav-mapping/upsert",method:"POST",data:e}),N=({wp_object_type:e,giav_supplier_id:a,items:t,status:l="active",match_type:n="batch"})=>r()({path:"/travel/v1/giav-mapping/batch-upsert",method:"POST",data:{wp_object_type:e,giav_supplier_id:a,items:t,status:l,match_type:n}}),C=({status:e,lang:a,form:t,q:l,page:n=1,per_page:i=20}={})=>{const s=new URLSearchParams;return e&&s.set("status",e),a&&s.set("lang",a),t&&s.set("form",t),l&&s.set("q",l),s.set("page",n),s.set("per_page",i),r()({path:`/travel/v1/requests?${s.toString()}`,method:"GET"})},S=e=>r()({path:`/travel/v1/requests/${e}/convert`,method:"POST"}),w=async({q:e,pageSize:a=20,pageIndex:t=0,includeDisabled:l=!1})=>{const n=await r()({path:`/travel/v1/giav/providers/search?q=${encodeURIComponent(e)}&pageSize=${encodeURIComponent(a)}&pageIndex=${encodeURIComponent(t)}&includeDisabled=${encodeURIComponent(l)}`,method:"GET"});return{items:(Array.isArray(n)?n:Array.isArray(n?.items)?n.items:[]).map(e=>{var a,t,l,n,r,i,s,o;return{id:String(null!==(a=null!==(t=null!==(l=null!==(n=e.id)&&void 0!==n?n:e.ID)&&void 0!==l?l:e.Id)&&void 0!==t?t:e.proveedorId)&&void 0!==a?a:""),label:String(null!==(r=null!==(i=null!==(s=null!==(o=e.label)&&void 0!==o?o:e.NombreAlias)&&void 0!==s?s:e.Nombre)&&void 0!==i?i:e.title)&&void 0!==r?r:""),raw:e}}).filter(e=>e.id&&e.label)}},k=()=>r()({path:"/travel/v1/requests/mapping",method:"GET"}),x=e=>r()({path:"/travel/v1/requests/mapping",method:"POST",data:e}),T=(e,a)=>r()({path:`/travel/v1/requests/mapping/${e}`,method:"POST",data:a});function I(e="",a="",t=""){const l=[(e||"").trim(),(a||"").trim()].filter(Boolean).join(" ").trim();return l||(t||"").trim()}function P(e=""){const a=(e||"").trim();if(!a)return{firstName:"",lastName:""};const t=a.split(/\s+/);return{firstName:t.shift()||"",lastName:t.join(" ")}}const M=[{label:"Español",value:"es_ES"},{label:"English (US)",value:"en_US"}],A=[{label:"EUR",value:"EUR"},{label:"USD",value:"USD"},{label:"GBP",value:"GBP"}],B=[{value:"AF",label:"Afghanistan (AF)"},{value:"AL",label:"Albania (AL)"},{value:"DZ",label:"Algeria (DZ)"},{value:"AS",label:"American Samoa (AS)"},{value:"AD",label:"Andorra (AD)"},{value:"AO",label:"Angola (AO)"},{value:"AI",label:"Anguilla (AI)"},{value:"AQ",label:"Antarctica (AQ)"},{value:"AG",label:"Antigua and Barbuda (AG)"},{value:"AR",label:"Argentina (AR)"},{value:"AM",label:"Armenia (AM)"},{value:"AW",label:"Aruba (AW)"},{value:"AU",label:"Australia (AU)"},{value:"AT",label:"Austria (AT)"},{value:"AZ",label:"Azerbaijan (AZ)"},{value:"BS",label:"Bahamas (BS)"},{value:"BH",label:"Bahrain (BH)"},{value:"BD",label:"Bangladesh (BD)"},{value:"BB",label:"Barbados (BB)"},{value:"BY",label:"Belarus (BY)"},{value:"BE",label:"Belgium (BE)"},{value:"BZ",label:"Belize (BZ)"},{value:"BJ",label:"Benin (BJ)"},{value:"BM",label:"Bermuda (BM)"},{value:"BT",label:"Bhutan (BT)"},{value:"BO",label:"Bolivia (BO)"},{value:"BQ",label:"Bonaire, Sint Eustatius and Saba (BQ)"},{value:"BA",label:"Bosnia and Herzegovina (BA)"},{value:"BW",label:"Botswana (BW)"},{value:"BV",label:"Bouvet Island (BV)"},{value:"BR",label:"Brazil (BR)"},{value:"IO",label:"British Indian Ocean Territory (IO)"},{value:"BN",label:"Brunei (BN)"},{value:"BG",label:"Bulgaria (BG)"},{value:"BF",label:"Burkina Faso (BF)"},{value:"BI",label:"Burundi (BI)"},{value:"KH",label:"Cambodia (KH)"},{value:"CM",label:"Cameroon (CM)"},{value:"CA",label:"Canada (CA)"},{value:"CV",label:"Cape Verde (CV)"},{value:"KY",label:"Cayman Islands (KY)"},{value:"CF",label:"Central African Republic (CF)"},{value:"TD",label:"Chad (TD)"},{value:"CL",label:"Chile (CL)"},{value:"CN",label:"China (CN)"},{value:"CX",label:"Christmas Island (CX)"},{value:"CC",label:"Cocos (Keeling) Islands (CC)"},{value:"CO",label:"Colombia (CO)"},{value:"KM",label:"Comoros (KM)"},{value:"CG",label:"Congo (CG)"},{value:"CD",label:"Congo (Democratic Republic) (CD)"},{value:"CK",label:"Cook Islands (CK)"},{value:"CR",label:"Costa Rica (CR)"},{value:"CI",label:"Côte d’Ivoire (CI)"},{value:"HR",label:"Croatia (HR)"},{value:"CU",label:"Cuba (CU)"},{value:"CW",label:"Curaçao (CW)"},{value:"CY",label:"Cyprus (CY)"},{value:"CZ",label:"Czechia (CZ)"},{value:"DK",label:"Denmark (DK)"},{value:"DJ",label:"Djibouti (DJ)"},{value:"DM",label:"Dominica (DM)"},{value:"DO",label:"Dominican Republic (DO)"},{value:"EC",label:"Ecuador (EC)"},{value:"EG",label:"Egypt (EG)"},{value:"SV",label:"El Salvador (SV)"},{value:"GQ",label:"Equatorial Guinea (GQ)"},{value:"ER",label:"Eritrea (ER)"},{value:"EE",label:"Estonia (EE)"},{value:"ET",label:"Ethiopia (ET)"},{value:"FK",label:"Falkland Islands (FK)"},{value:"FO",label:"Faroe Islands (FO)"},{value:"FJ",label:"Fiji (FJ)"},{value:"FI",label:"Finland (FI)"},{value:"FR",label:"France (FR)"},{value:"GF",label:"French Guiana (GF)"},{value:"PF",label:"French Polynesia (PF)"},{value:"TF",label:"French Southern Territories (TF)"},{value:"GA",label:"Gabon (GA)"},{value:"GM",label:"Gambia (GM)"},{value:"GE",label:"Georgia (GE)"},{value:"DE",label:"Germany (DE)"},{value:"GH",label:"Ghana (GH)"},{value:"GI",label:"Gibraltar (GI)"},{value:"GR",label:"Greece (GR)"},{value:"GL",label:"Greenland (GL)"},{value:"GD",label:"Grenada (GD)"},{value:"GP",label:"Guadeloupe (GP)"},{value:"GU",label:"Guam (GU)"},{value:"GT",label:"Guatemala (GT)"},{value:"GG",label:"Guernsey (GG)"},{value:"GN",label:"Guinea (GN)"},{value:"GW",label:"Guinea-Bissau (GW)"},{value:"GY",label:"Guyana (GY)"},{value:"HT",label:"Haiti (HT)"},{value:"HM",label:"Heard Island and McDonald Islands (HM)"},{value:"HN",label:"Honduras (HN)"},{value:"HK",label:"Hong Kong (HK)"},{value:"HU",label:"Hungary (HU)"},{value:"IS",label:"Iceland (IS)"},{value:"IN",label:"India (IN)"},{value:"ID",label:"Indonesia (ID)"},{value:"IR",label:"Iran (IR)"},{value:"IQ",label:"Iraq (IQ)"},{value:"IE",label:"Ireland (IE)"},{value:"IM",label:"Isle of Man (IM)"},{value:"IL",label:"Israel (IL)"},{value:"IT",label:"Italy (IT)"},{value:"JM",label:"Jamaica (JM)"},{value:"JP",label:"Japan (JP)"},{value:"JE",label:"Jersey (JE)"},{value:"JO",label:"Jordan (JO)"},{value:"KZ",label:"Kazakhstan (KZ)"},{value:"KE",label:"Kenya (KE)"},{value:"KI",label:"Kiribati (KI)"},{value:"KP",label:"Korea (North) (KP)"},{value:"KR",label:"Korea (South) (KR)"},{value:"KW",label:"Kuwait (KW)"},{value:"KG",label:"Kyrgyzstan (KG)"},{value:"LA",label:"Laos (LA)"},{value:"LV",label:"Latvia (LV)"},{value:"LB",label:"Lebanon (LB)"},{value:"LS",label:"Lesotho (LS)"},{value:"LR",label:"Liberia (LR)"},{value:"LY",label:"Libya (LY)"},{value:"LI",label:"Liechtenstein (LI)"},{value:"LT",label:"Lithuania (LT)"},{value:"LU",label:"Luxembourg (LU)"},{value:"MO",label:"Macao (MO)"},{value:"MG",label:"Madagascar (MG)"},{value:"MW",label:"Malawi (MW)"},{value:"MY",label:"Malaysia (MY)"},{value:"MV",label:"Maldives (MV)"},{value:"ML",label:"Mali (ML)"},{value:"MT",label:"Malta (MT)"},{value:"MH",label:"Marshall Islands (MH)"},{value:"MQ",label:"Martinique (MQ)"},{value:"MR",label:"Mauritania (MR)"},{value:"MU",label:"Mauritius (MU)"},{value:"YT",label:"Mayotte (YT)"},{value:"MX",label:"Mexico (MX)"},{value:"FM",label:"Micronesia (FM)"},{value:"MD",label:"Moldova (MD)"},{value:"MC",label:"Monaco (MC)"},{value:"MN",label:"Mongolia (MN)"},{value:"ME",label:"Montenegro (ME)"},{value:"MS",label:"Montserrat (MS)"},{value:"MA",label:"Morocco (MA)"},{value:"MZ",label:"Mozambique (MZ)"},{value:"MM",label:"Myanmar (MM)"},{value:"NA",label:"Namibia (NA)"},{value:"NR",label:"Nauru (NR)"},{value:"NP",label:"Nepal (NP)"},{value:"NL",label:"Netherlands (NL)"},{value:"NC",label:"New Caledonia (NC)"},{value:"NZ",label:"New Zealand (NZ)"},{value:"NI",label:"Nicaragua (NI)"},{value:"NE",label:"Niger (NE)"},{value:"NG",label:"Nigeria (NG)"},{value:"NU",label:"Niue (NU)"},{value:"NF",label:"Norfolk Island (NF)"},{value:"MK",label:"North Macedonia (MK)"},{value:"MP",label:"Northern Mariana Islands (MP)"},{value:"NO",label:"Norway (NO)"},{value:"OM",label:"Oman (OM)"},{value:"PK",label:"Pakistan (PK)"},{value:"PW",label:"Palau (PW)"},{value:"PS",label:"Palestine (PS)"},{value:"PA",label:"Panama (PA)"},{value:"PG",label:"Papua New Guinea (PG)"},{value:"PY",label:"Paraguay (PY)"},{value:"PE",label:"Peru (PE)"},{value:"PH",label:"Philippines (PH)"},{value:"PN",label:"Pitcairn (PN)"},{value:"PL",label:"Poland (PL)"},{value:"PT",label:"Portugal (PT)"},{value:"PR",label:"Puerto Rico (PR)"},{value:"QA",label:"Qatar (QA)"},{value:"RE",label:"Réunion (RE)"},{value:"RO",label:"Romania (RO)"},{value:"RU",label:"Russia (RU)"},{value:"RW",label:"Rwanda (RW)"},{value:"BL",label:"Saint Barthélemy (BL)"},{value:"SH",label:"Saint Helena (SH)"},{value:"KN",label:"Saint Kitts and Nevis (KN)"},{value:"LC",label:"Saint Lucia (LC)"},{value:"MF",label:"Saint Martin (MF)"},{value:"PM",label:"Saint Pierre and Miquelon (PM)"},{value:"VC",label:"Saint Vincent and the Grenadines (VC)"},{value:"WS",label:"Samoa (WS)"},{value:"SM",label:"San Marino (SM)"},{value:"ST",label:"São Tomé and Príncipe (ST)"},{value:"SA",label:"Saudi Arabia (SA)"},{value:"SN",label:"Senegal (SN)"},{value:"RS",label:"Serbia (RS)"},{value:"SC",label:"Seychelles (SC)"},{value:"SL",label:"Sierra Leone (SL)"},{value:"SG",label:"Singapore (SG)"},{value:"SX",label:"Sint Maarten (SX)"},{value:"SK",label:"Slovakia (SK)"},{value:"SI",label:"Slovenia (SI)"},{value:"SB",label:"Solomon Islands (SB)"},{value:"SO",label:"Somalia (SO)"},{value:"ZA",label:"South Africa (ZA)"},{value:"GS",label:"South Georgia and the South Sandwich Islands (GS)"},{value:"SS",label:"South Sudan (SS)"},{value:"ES",label:"Spain (ES)"},{value:"LK",label:"Sri Lanka (LK)"},{value:"SD",label:"Sudan (SD)"},{value:"SR",label:"Suriname (SR)"},{value:"SJ",label:"Svalbard and Jan Mayen (SJ)"},{value:"SE",label:"Sweden (SE)"},{value:"CH",label:"Switzerland (CH)"},{value:"SY",label:"Syria (SY)"},{value:"TW",label:"Taiwan (TW)"},{value:"TJ",label:"Tajikistan (TJ)"},{value:"TZ",label:"Tanzania (TZ)"},{value:"TH",label:"Thailand (TH)"},{value:"TL",label:"Timor-Leste (TL)"},{value:"TG",label:"Togo (TG)"},{value:"TK",label:"Tokelau (TK)"},{value:"TO",label:"Tonga (TO)"},{value:"TT",label:"Trinidad and Tobago (TT)"},{value:"TN",label:"Tunisia (TN)"},{value:"TR",label:"Turkey (TR)"},{value:"TM",label:"Turkmenistan (TM)"},{value:"TC",label:"Turks and Caicos Islands (TC)"},{value:"TV",label:"Tuvalu (TV)"},{value:"UG",label:"Uganda (UG)"},{value:"UA",label:"Ukraine (UA)"},{value:"AE",label:"United Arab Emirates (AE)"},{value:"GB",label:"United Kingdom (GB)"},{value:"US",label:"United States (US)"},{value:"UM",label:"United States Minor Outlying Islands (UM)"},{value:"UY",label:"Uruguay (UY)"},{value:"UZ",label:"Uzbekistan (UZ)"},{value:"VU",label:"Vanuatu (VU)"},{value:"VA",label:"Vatican City (VA)"},{value:"VE",label:"Venezuela (VE)"},{value:"VN",label:"Vietnam (VN)"},{value:"VG",label:"Virgin Islands (British) (VG)"},{value:"VI",label:"Virgin Islands (US) (VI)"},{value:"WF",label:"Wallis and Futuna (WF)"},{value:"EH",label:"Western Sahara (EH)"},{value:"YE",label:"Yemen (YE)"},{value:"ZM",label:"Zambia (ZM)"},{value:"ZW",label:"Zimbabwe (ZW)"}];function R(){return(new Date).toISOString().slice(0,10)}function D(e){if(!e)return"";if(e instanceof Date&&!Number.isNaN(e.getTime()))return e.toISOString().slice(0,10);if("string"==typeof e){if(e.includes("/")){const[a,t,l]=e.split("/");if(a&&t&&l)return`${l.padStart(4,"0")}-${t.padStart(2,"0")}-${a.padStart(2,"0")}`}return e.slice(0,10)}return""}function $(e){if(!e)return null;const a="string"==typeof e?e.slice(0,10):e,t=a instanceof Date?a:new Date(`${a}T00:00:00`);return Number.isNaN(t.getTime())?null:(t.setHours(0,0,0,0),t)}function G(){const e=new Date;return e.setHours(0,0,0,0),e}function F({id:e,label:n,value:r,onChange:i,className:s="",fieldRef:o,isInvalidDate:c}){const[u,d]=(0,t.useState)(!1),[m,p]=(0,t.useState)(null),_=function(e){if(!e)return"";const[a,t,l]=e.split("-");return a&&t&&l?`${l}/${t}/${a}`:e}(r);return(0,a.createElement)("div",{className:`proposal-basics__field ${s}`.trim(),ref:e=>{"function"==typeof o&&o(e)}},(0,a.createElement)(l.TextControl,{id:e,label:n,value:_,onClick:e=>{p(e.currentTarget),d(!0)},onFocus:e=>{p(e.currentTarget),d(!0)},readOnly:!0,placeholder:"DD/MM/AAAA"}),u&&m&&(0,a.createElement)(l.Popover,{anchor:m,placement:"bottom-start",className:"proposal-basics__date-popover",onClose:()=>{d(!1),p(null)}},(0,a.createElement)(l.DatePicker,{currentDate:r||R(),onChange:e=>{const a=D(e);a&&i(a),d(!1)},isInvalidDate:c})))}function q({initialValues:e={},onCreated:n,onNext:r,proposalId:i}){var o;const c=(0,t.useMemo)(()=>{var a,t,l,n;const r={proposal_title:"",customer_name:e.customer_name||"",customer_email:"",customer_country:"",customer_language:"es",start_date:R(),end_date:R(),pax_total:1,players_count:null!==(a=null!==(t=e.players_count)&&void 0!==t?t:e.pax_total)&&void 0!==a?a:1,currency:"EUR",first_name:null!==(l=e.first_name)&&void 0!==l?l:"",last_name:null!==(n=e.last_name)&&void 0!==n?n:"",...e},i=r.customer_name||e.customer_name||"",s=P(i),o=r.first_name||s.firstName,c=r.last_name||s.lastName;return r.first_name=o,r.last_name=c,r.customer_name=I(o,c,i),r},[e]),[d,m]=(0,t.useState)(c),[p,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(""),[b,h]=(0,t.useState)(""),[E,y]=(0,t.useState)(""),[f,N]=(0,t.useState)(""),C=(0,t.useRef)({}),S=!i;(0,t.useEffect)(()=>{m(e=>{const a={...e,...c};return a.customer_name=I(a.first_name,a.last_name,c.customer_name),a})},[c]),(0,t.useEffect)(()=>(window.fillProposalBasics=(e={})=>{m(a=>{const t="string"==typeof e.name?e.name:a.customer_name,l=P(t),n="string"==typeof e.first_name?e.first_name:l.firstName||a.first_name,r="string"==typeof e.last_name?e.last_name:l.lastName||a.last_name;return{...a,proposal_title:"string"==typeof e.title?e.title:a.proposal_title,first_name:n,last_name:r,customer_name:I(n,r,t),customer_email:"string"==typeof e.email?e.email:a.customer_email,customer_country:"string"==typeof e.country?e.country.toUpperCase():a.customer_country,customer_language:"string"==typeof e.language?e.language:a.customer_language}})},()=>{delete window.fillProposalBasics}),[]);const w=e=>a=>{m(t=>{const l={...t,[e]:a};if("first_name"===e||"last_name"===e){const n="first_name"===e?a:t.first_name,r="last_name"===e?a:t.last_name;l.customer_name=I(n,r,t.customer_name)}return l}),y(a=>a===e?"":a)},k=e=>a=>{a&&(C.current[e]=a)},x=e=>{const a=C.current[e];if(!a)return;a.scrollIntoView({behavior:"smooth",block:"center"});const t=a.querySelector("input, select, textarea, button");t&&"function"==typeof t.focus&&t.focus()},T=()=>{if(!d.first_name?.trim())return{message:"El nombre del cliente es obligatorio.",field:"first_name"};if(!d.start_date)return{message:"La fecha de inicio es obligatoria.",field:"start_date"};if(!d.end_date)return{message:"La fecha de fin es obligatoria.",field:"end_date"};if(d.end_date<d.start_date)return{message:"La fecha fin no puede ser anterior a la fecha inicio.",field:"end_date"};const e=parseInt(d.pax_total,10);if(Number.isNaN(e)||e<1)return{message:"Pax debe ser un numero >= 1.",field:"pax_total"};const a=parseInt(d.players_count,10);return Number.isNaN(a)||a<0?{message:"Jugadores debe ser un numero >= 0.",field:"players_count"}:a>e?{message:"Jugadores no puede ser mayor que Pax.",field:"players_count"}:d.customer_email&&!/^\S+@\S+\.\S+$/.test(d.customer_email)?{message:"El email no parece valido (si lo rellenas, que sea correcto).",field:"customer_email"}:d.customer_country&&2!==d.customer_country.length?{message:"Pais debe ser ISO2 (2 letras) o vacio.",field:"customer_country"}:null},q=(0,t.useMemo)(()=>{if(!f)return B;const e=f.toLowerCase();return B.filter(a=>a.label.toLowerCase().includes(e)||a.value.toLowerCase().includes(e))},[f]),V=parseInt(d.pax_total,10),U=parseInt(d.players_count,10),j=Number.isFinite(V)?Math.max(0,V-(Number.isFinite(U)?U:0)):0;return(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Datos básicos")),(0,a.createElement)(l.CardBody,null,b&&(0,a.createElement)(l.Notice,{status:"success",isDismissible:!0,onRemove:()=>h("")},b),v&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>{g(""),h(""),y("")}},v),(0,a.createElement)("div",{className:"proposal-basics"},(0,a.createElement)("div",{className:"proposal-basics__section"},(0,a.createElement)("div",{className:"proposal-basics__section-title"},"Identidad de la propuesta"),(0,a.createElement)("div",{className:"proposal-basics__grid"},(0,a.createElement)("div",{className:("proposal-basics__field proposal-basics__field--full "+("proposal_title"===E?"is-error":"")).trim(),ref:k("proposal_title")},(0,a.createElement)(l.TextControl,{label:"Título de la propuesta",value:d.proposal_title,onChange:w("proposal_title"),placeholder:"Escapada a la Costa del Sol"})),(0,a.createElement)("div",{className:("proposal-basics__field "+("first_name"===E?"is-error":"")).trim(),ref:k("first_name")},(0,a.createElement)(l.TextControl,{label:"Nombre *",value:d.first_name,onChange:w("first_name"),placeholder:"John"})),(0,a.createElement)("div",{className:"proposal-basics__field",ref:k("last_name")},(0,a.createElement)(l.TextControl,{label:"Apellidos",value:d.last_name,onChange:w("last_name"),placeholder:"Doe"})),(0,a.createElement)("div",{className:("proposal-basics__field "+("customer_email"===E?"is-error":"")).trim(),ref:k("customer_email")},(0,a.createElement)(l.TextControl,{label:"Email",value:d.customer_email,onChange:w("customer_email"),placeholder:"john@email.com"})))),(0,a.createElement)("div",{className:"proposal-basics__section"},(0,a.createElement)("div",{className:"proposal-basics__section-title"},"Fechas y pasajeros"),(0,a.createElement)("div",{className:"proposal-basics__grid proposal-basics__grid--dates"},(0,a.createElement)(F,{label:"Fecha inicio *",value:d.start_date,onChange:e=>{m(a=>{const t={...a,start_date:e};return t.end_date&&e&&t.end_date<e&&(t.end_date=e),t}),window.setTimeout(()=>{const e=document.getElementById("wp-travel-end-date");if(e&&(e.focus(),"function"==typeof e.showPicker))try{e.showPicker()}catch(e){}},0)},className:"start_date"===E?"is-error":"",fieldRef:k("start_date"),isInvalidDate:e=>{if(!S)return!1;const a=$(D(e));return!!a&&a<G()}}),(0,a.createElement)("div",{className:"proposal-basics__date-arrow","aria-hidden":"true"},"→"),(0,a.createElement)(F,{id:"wp-travel-end-date",label:"Fecha fin *",value:d.end_date,onChange:e=>{m(a=>a.start_date&&e&&e<a.start_date?{...a,end_date:a.start_date}:{...a,end_date:e})},className:"end_date"===E?"is-error":"",fieldRef:k("end_date"),isInvalidDate:e=>{const a=$(D(e));if(!a)return!1;const t=S?$(d.start_date)||G():$(d.start_date);return!!t&&a<t}}),(0,a.createElement)("div",{className:("proposal-basics__field proposal-basics__field--pax "+("pax_total"===E?"is-error":"")).trim(),ref:k("pax_total")},(0,a.createElement)(l.TextControl,{label:"Pax *",type:"number",min:1,value:String(d.pax_total),onChange:w("pax_total")})),(0,a.createElement)("div",{className:("proposal-basics__field proposal-basics__field--pax "+("players_count"===E?"is-error":"")).trim(),ref:k("players_count")},(0,a.createElement)(l.TextControl,{label:"Jugadores",type:"number",min:0,value:String(null!==(o=d.players_count)&&void 0!==o?o:""),onChange:w("players_count"),help:`No jugadores: ${j}`})))),(0,a.createElement)("div",{className:"proposal-basics__section"},(0,a.createElement)("div",{className:"proposal-basics__section-title"},"Preferencias"),(0,a.createElement)("div",{className:"proposal-basics__grid"},(0,a.createElement)("div",{className:("proposal-basics__field "+("customer_language"===E?"is-error":"")).trim(),ref:k("customer_language")},(0,a.createElement)(l.SelectControl,{label:"Idioma",value:d.customer_language,options:M,onChange:w("customer_language")})),(0,a.createElement)("div",{className:("proposal-basics__field "+("customer_country"===E?"is-error":"")).trim(),ref:k("customer_country")},(0,a.createElement)(l.ComboboxControl,{label:"País",value:d.customer_country,options:q,onFilterValueChange:N,onChange:e=>w("customer_country")(e?e.toUpperCase():""),placeholder:"Busca país o código"})),(0,a.createElement)("div",{className:("proposal-basics__field "+("currency"===E?"is-error":"")).trim(),ref:k("currency")},(0,a.createElement)(l.SelectControl,{label:"Moneda",value:d.currency,options:A,onChange:w("currency")}))))),(0,a.createElement)("div",{className:"proposal-basics__actions"},i&&(0,a.createElement)(l.Button,{variant:"secondary",onClick:async()=>{if(!i)return;const e=T();if(e)return h(""),g(e.message),y(e.field||""),void x(e.field);_(!0),g(""),h("");const a=I(d.first_name,d.last_name,d.customer_name),t={...d,customer_name:a,pax_total:parseInt(d.pax_total,10),players_count:Math.max(0,parseInt(d.players_count,10)),customer_country:d.customer_country?d.customer_country.toUpperCase():""};try{await u(i,t),h("Cambios guardados.")}catch(e){g(e?.message||"Error guardando la propuesta.")}finally{_(!1)}},disabled:p},"Guardar"),(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{const e=T();if(e)return h(""),g(e.message),y(e.field||""),void x(e.field);_(!0),h(""),g("");const a=I(d.first_name,d.last_name,d.customer_name),t={...d,customer_name:a,pax_total:parseInt(d.pax_total,10),players_count:Math.max(0,parseInt(d.players_count,10)),customer_country:d.customer_country?d.customer_country.toUpperCase():""};try{if(i)return await u(i,t),void r?.({basics:t});const e=await s(t);n?.({proposalId:e.proposal_id,basics:t})}catch(e){g(e?.message||"Error creando la propuesta.")}finally{_(!1)}},disabled:p},v?"Revisa los campos marcados":"Continuar"),p&&(0,a.createElement)(l.Spinner,null))))}function V({label:e,type:n,valueTitle:r,onPick:i}){const[s,o]=(0,t.useState)(r||""),[c,u]=(0,t.useState)(!1),[d,m]=(0,t.useState)(!1),[p,_]=(0,t.useState)([]);return(0,t.useEffect)(()=>{o(r||"")},[r]),(0,t.useEffect)(()=>{if(!c)return;let e=!0;return m(!0),h({type:n,q:s}).then(a=>e&&_(Array.isArray(a)?a:[])).catch(()=>e&&_([])).finally(()=>e&&m(!1)),()=>{e=!1}},[s,c,n]),(0,a.createElement)("div",{style:{position:"relative",width:"100%",maxWidth:320,minWidth:0}},(0,a.createElement)(l.TextControl,{label:e,value:s,onChange:e=>{o(e),u(!0)},onFocus:()=>u(!0),placeholder:"hotel"===n?"Buscar hotel…":"Buscar campo…"}),c&&(0,a.createElement)("div",{style:{position:"absolute",zIndex:30,background:"#fff",border:"1px solid #ddd",borderRadius:8,width:"100%",maxHeight:220,overflow:"auto",boxShadow:"0 6px 18px rgba(0,0,0,.08)"}},d&&(0,a.createElement)("div",{style:{padding:8}},(0,a.createElement)(l.Spinner,null)),!d&&0===p.length&&(0,a.createElement)("div",{style:{padding:8,fontSize:12,opacity:.6}},"Sin resultados"),!d&&p.map(e=>(0,a.createElement)("button",{key:e.id,type:"button",onClick:()=>{i(e),u(!1)},style:{display:"block",width:"100%",padding:"8px 10px",border:0,background:"transparent",textAlign:"left",cursor:"pointer"}},e.title))))}function U({valueId:e,valueLabel:t,onSelect:l,disabled:n=!1,placeholder:r="Buscar proveedor en GIAV..."}){const[i,s]=(0,a.useState)(t||""),[o,c]=(0,a.useState)([]),[u,d]=(0,a.useState)(!1),[m,p]=(0,a.useState)(!1),[_,v]=(0,a.useState)(""),g=(0,a.useRef)(null);(0,a.useEffect)(()=>{t&&t!==i&&s(t)},[t]);return(0,a.createElement)("div",{style:{position:"relative"}},(0,a.createElement)("input",{type:"text",value:i,onChange:e=>{return a=e.target.value,s(a),d(!0),clearTimeout(g.current),void(g.current=setTimeout(()=>(async e=>{const a=(e||"").trim();if(a.length<2)return c([]),v(""),void d(!1);p(!0),v("");try{const e=await w({q:a,pageSize:20,pageIndex:0,includeDisabled:!1}),t=(Array.isArray(e)?e:Array.isArray(e?.items)?e.items:[]).map(e=>{var a,t,l,n,r,i,s,o;return{id:String(null!==(a=null!==(t=null!==(l=null!==(n=e.id)&&void 0!==n?n:e.Id)&&void 0!==l?l:e.ID)&&void 0!==t?t:e.proveedorId)&&void 0!==a?a:""),label:String(null!==(r=null!==(i=null!==(s=null!==(o=e.label)&&void 0!==o?o:e.NombreAlias)&&void 0!==s?s:e.Nombre)&&void 0!==i?i:e.title)&&void 0!==r?r:"")}}).filter(e=>e.id&&e.label);c(t),d(t.length>0)}catch(e){v(e?.message||"Error buscando proveedores en GIAV"),c([]),d(!1)}finally{p(!1)}})(a),250));var a},onFocus:()=>{o.length>0&&d(!0)},placeholder:r,disabled:n,style:{width:"100%"}}),(0,a.createElement)("div",{style:{fontSize:12,marginTop:6,opacity:.8}},e?(0,a.createElement)(a.Fragment,null,"ID seleccionado: ",(0,a.createElement)("strong",null,e)):null,m?(0,a.createElement)("span",{style:{marginLeft:10}},"Buscando…"):null,_?(0,a.createElement)("span",{style:{marginLeft:10,color:"crimson"}},_):null),u&&o.length>0&&(0,a.createElement)("div",{style:{position:"absolute",zIndex:20,top:"100%",left:0,right:0,background:"#fff",border:"1px solid #ddd",borderTop:"none",maxHeight:260,overflow:"auto"}},o.map(e=>(0,a.createElement)("div",{key:e.id,onMouseDown:a=>{a.preventDefault(),(e=>{s(e.label),d(!1),c([]),v(""),l?.(e)})(e)},style:{padding:"10px 12px",cursor:"pointer",borderBottom:"1px solid #f0f0f0"}},(0,a.createElement)("div",{style:{fontWeight:600}},e.label),(0,a.createElement)("div",{style:{fontSize:12,opacity:.75}},"ID: ",e.id)))))}const j="1734698",L="Proveedores varios",O=(new Date).toISOString().slice(0,10),H=[{label:"Hotel",value:"hotel"},{label:"Golf",value:"golf"},{label:"Transfer",value:"transfer"},{label:"Extra",value:"extra"},{label:"Paquete",value:"package"}],z=[{label:"Alojamiento y Desayuno",value:"AD"},{label:"Solo Alojamiento",value:"SA"},{label:"Media Pensión",value:"MP"},{label:"Pensión Completa",value:"PC"},{label:"Todo Incluido",value:"TI"},{label:"Según Programa",value:"SP"}];function K(e){const a=parseFloat(String(e).replace(",","."));return Number.isFinite(a)?a:0}function W(e,a=1){const t=parseInt(e,10);return Number.isFinite(t)?t:a}function J(e,a,t){return Number.isFinite(e)?Math.min(t,Math.max(a,e)):a}function Z(e){return Math.round(100*(e+Number.EPSILON))/100}function Y(e,a){if(!e||!a)return 0;const[t,l,n]=String(e).split("-").map(e=>parseInt(e,10)),[r,i,s]=String(a).split("-").map(e=>parseInt(e,10));if(![t,l,n,r,i,s].every(e=>Number.isFinite(e)))return 0;const o=Date.UTC(t,l-1,n),c=Date.UTC(r,i-1,s)-o;return!Number.isFinite(c)||c<=0?0:Math.round(c/864e5)}function Q(e,a){if(!e)return"";const[t,l,n]=String(e).split("-").map(e=>parseInt(e,10));if(![t,l,n].every(e=>Number.isFinite(e)))return"";const r=new Date(Date.UTC(t,l-1,n));return r.setUTCDate(r.getUTCDate()+Math.max(0,a)),r.toISOString().slice(0,10)}function X(e,a,t,l="",n=0){const r=function(e,a,t="",l=0){const n=Y(e,a);if(n<=0)return[];const r=[];for(let a=0;a<n;a++)r.push({date:Q(e,a),net_price:t,margin_pct:l});return r}(a,t,l,n);if(!r.length)return[];const i=new Map;return(Array.isArray(e)?e:[]).forEach(e=>{const a=e?.date;var t,r,s,o,c;a&&(i.has(a)||i.set(a,{date:a,net_price:null!==(t=null!==(r=null!==(s=e.net_price)&&void 0!==s?s:e.net)&&void 0!==r?r:e.net_price_per_night)&&void 0!==t?t:l,margin_pct:null!==(o=null!==(c=e.margin_pct)&&void 0!==c?c:e.margin)&&void 0!==o?o:n}))}),r.map(e=>{const a=i.get(e.date);return a?{...e,...a}:e})}function ee(e,a){return Y(e.start_date||a?.start_date||"",e.end_date||a?.end_date||"")}function ae(e=0){return{double:{enabled:!0,rooms:1,pricing_basis:"per_room",net_price_per_night:"",margin_pct:e,pvp_manual_enabled:!1,pvp_price_per_night:"",nights_payable:0,free_nights_applied:0,discount_pct_applied:0,total_net:0,total_pvp:0},single:{enabled:!1,rooms:0,pricing_basis:"per_room",net_price_per_night:"",margin_pct:e,pvp_manual_enabled:!1,pvp_price_per_night:"",nights_payable:0,free_nights_applied:0,discount_pct_applied:0,total_net:0,total_pvp:0}}}function te(e,a,t){const l=Math.max(0,W(null!=a?a:0,0)),n=Math.max(0,W(null!=t?t:0,0));if(l<=0||n<=0||e<=0)return{freeNights:0,nightsPayable:Math.max(0,e)};const r=Math.floor(e/l),i=Math.min(e,r*n);return{freeNights:i,nightsPayable:Math.max(0,e-i)}}function le(e,a){return Z(Math.max(0,K(e))*(1+Math.max(0,K(a))/100))}function ne(e,a=0){var t,l;const n=e?.start_date||"",r=e?.end_date||"",i=ae(a);return{service_type:"hotel",title:"",start_date:n,end_date:r,hotel_room_type:"",hotel_regimen:"",hotel_rooms:0,hotel_rate_basis:null,hotel_regimen:"",hotel_pricing_mode:"simple",nightly_rates:[],quantity:1,green_fees_per_person:1,number_of_players:null!==(t=null!==(l=e?.players_count)&&void 0!==l?l:e?.pax_total)&&void 0!==t?t:1,total_green_fees:0,unit_cost_net:"",unit_sell_price:"",use_markup:!0,markup_pct:a,lock_sell_price:!1,notes_public:"",notes_internal:"",package_components_text:"",package_pricing_basis:"per_room",package_quote_individual:!1,package_individual_count:0,package_individual_mode:"absolute",unit_cost_net_individual:"",unit_sell_price_individual:"",package_single_supplement_net:"",package_single_supplement_sell:"",package_quote_single_rooms:!1,package_single_rooms:0,package_single_room_mode:"absolute",unit_cost_net_single_room:"",unit_sell_price_single_room:"",package_single_room_supplement_net:"",package_single_room_supplement_sell:"",display_name:"",use_manual_entry:!1,wp_object_type:null,wp_object_id:null,giav_entity_type:null,giav_entity_id:null,giav_supplier_id:j,giav_supplier_name:L,giav_mapping_status:"needs_review",show_supplier_picker:!1,supplier_override:!1,dates_inherited:!0,room_pricing:i,discounts:{discount_pct:0,free_nights_every:"",free_nights_count:""},giav_pricing:{giav_total_pvp:0,giav_total_net:0,giav_source:"double",giav_locked:!1}}}function re(e,a,t){var l,n;const r={...e};r.start_date||(r.start_date=a?.start_date||""),r.end_date||(r.end_date=a?.end_date||""),r.quantity=Math.max(1,W(r.quantity,1)),void 0!==r.hotel_rooms&&(r.hotel_rooms=Math.max(0,W(r.hotel_rooms,0))),r.unit_cost_net=Math.max(0,K(r.unit_cost_net));const i=r.use_markup?Math.max(0,K(null!==(l=null!==(n=r.markup_pct)&&void 0!==n?n:t)&&void 0!==l?l:0)):0;if(r.markup_pct=i,r.lock_sell_price?r.unit_sell_price=Math.max(0,K(r.unit_sell_price)):r.unit_sell_price=le(r.unit_cost_net,i),"hotel"===r.service_type){const e=ee(r,a);r.hotel_nights=e;const t=function(e,a,t){var l,n,r,i,s,o,c,u,d;const m=ee(e,a),p=Math.max(0,W(null!==(l=e.hotel_rooms)&&void 0!==l?l:0,0)),_="per_night"===e.hotel_pricing_mode?"per_night":"simple",v=e.start_date||a?.start_date||"",g=e.end_date||a?.end_date||"",b=function(e={}){var a,t,l;return{discount_pct:J(K(null!==(a=e.discount_pct)&&void 0!==a?a:0),0,50),free_nights_every:Math.max(0,W(null!==(t=e.free_nights_every)&&void 0!==t?t:0,0))||"",free_nights_count:Math.max(0,W(null!==(l=e.free_nights_count)&&void 0!==l?l:0,0))||""}}(e.discounts),{freeNights:h,nightsPayable:E}=te(m,b.free_nights_every,b.free_nights_count),y=e.use_markup?K(null!==(n=null!==(r=e.markup_pct)&&void 0!==r?r:t)&&void 0!==n?n:0):0,f=e.room_pricing||ae(t),N=(e,a)=>{var t,l,n;const r=f?.[e]||{},i=null!==(t=a.net_price_per_night)&&void 0!==t?t:0,s=null!==(l=a.pvp_price_per_night)&&void 0!==l?l:0,o=void 0!==r.net_price_per_night&&""!==r.net_price_per_night,c=void 0!==r.pvp_price_per_night&&""!==r.pvp_price_per_night,u=void 0!==r.margin_pct&&""!==r.margin_pct,d=void 0!==r.rooms&&""!==r.rooms;return{enabled:"boolean"==typeof r.enabled?r.enabled:a.enabled,rooms:d?Math.max(0,W(null!==(n=r.rooms)&&void 0!==n?n:0,0)):a.rooms,pricing_basis:r.pricing_basis||a.pricing_basis,net_price_per_night:o?K(r.net_price_per_night):i,margin_pct:u?K(r.margin_pct):a.margin_pct,pvp_manual_enabled:"boolean"==typeof r.pvp_manual_enabled?r.pvp_manual_enabled:a.pvp_manual_enabled,pvp_price_per_night:c?K(r.pvp_price_per_night):s,nights_payable:0,free_nights_applied:0,discount_pct_applied:b.discount_pct,total_net:0,total_pvp:0}},C={enabled:!1,rooms:0,pricing_basis:"per_room",net_price_per_night:0,margin_pct:y,pvp_manual_enabled:!1,pvp_price_per_night:0},S={double:N("double",{enabled:!0,rooms:p>0?p:1,pricing_basis:"per_room",net_price_per_night:null!==(i=e.unit_cost_net)&&void 0!==i?i:0,margin_pct:y,pvp_manual_enabled:!!e.lock_sell_price,pvp_price_per_night:null!==(s=e.unit_sell_price)&&void 0!==s?s:0}),single:N("single",C)},w="per_night"===_?X(e.nightly_rates||e.hotel_nightly_rates||[],v,g,null!==(o=null!==(c=S.double?.net_price_per_night)&&void 0!==c?c:e.unit_cost_net)&&void 0!==o?o:"",null!==(u=null!==(d=e.markup_pct)&&void 0!==d?d:t)&&void 0!==u?u:0):[],k="per_night"===_?function(e=[],a=0,t=0){const l=(Array.isArray(e)?e:[]).map(e=>{var a,t,l,n;return{date:e?.date,net:Math.max(0,K(null!==(a=null!==(t=e?.net_price)&&void 0!==t?t:e?.net)&&void 0!==a?a:0)),margin:Math.max(0,K(null!==(l=null!==(n=e?.margin_pct)&&void 0!==n?n:e?.margin)&&void 0!==l?l:0))}}).filter(e=>!!e.date);if(!l.length)return{netSum:0,pvpSum:0};const n=Math.max(0,W(a,0)),r=l.map((e,a)=>({idx:a,net:e.net})).sort((e,a)=>e.net-a.net).slice(0,n).map(e=>e.idx),i=new Set(r),s=J(K(t),0,50)/100;let o=0,c=0;return l.forEach((e,a)=>{if(i.has(a))return;const t=e.net*(1-s);o+=t,c+=t*(1+e.margin/100)}),{netSum:Z(o),pvpSum:Z(c)}}(w,h,b.discount_pct):null,x=["double","single"].map(e=>{var a,t,l;const n=S[e];if(!n.enabled)return{totalNet:0,totalPvp:0};const r=Math.max(0,W(null!==(a=n.rooms)&&void 0!==a?a:0,0)),i="double"===e&&n.pricing_basis||"per_room",s="per_person"===i?2*r:r,o="per_night"===_?Math.max(0,null!==(t=k?.netSum)&&void 0!==t?t:0)*s:Math.max(0,n.net_price_per_night)*E*s*(1-b.discount_pct/100),c=n.pvp_manual_enabled?Math.max(0,n.pvp_price_per_night)*E*s:"per_night"===_?Math.max(0,null!==(l=k?.pvpSum)&&void 0!==l?l:0)*s:o*(1+Math.max(0,n.margin_pct)/100);return S[e]={...n,pricing_basis:i,nights_payable:E,free_nights_applied:h,discount_pct_applied:b.discount_pct,total_net:Z(o),total_pvp:Z(c)},{totalNet:Z(o),totalPvp:Z(c)}}),T=x.reduce((e,a)=>e+a.totalNet,0),I=x.reduce((e,a)=>e+a.totalPvp,0),P=["double","single"].filter(e=>S[e].enabled),M=1===P.length?P[0]:"custom",A={...e.giav_pricing,giav_total_net:Z(T),giav_total_pvp:e.giav_pricing?.giav_locked?Z(K(e.giav_pricing?.giav_total_pvp)):Z(I),giav_source:e.giav_pricing?.giav_locked?"custom":M,giav_locked:!!e.giav_pricing?.giav_locked};return{discounts:b,roomPricing:S,nightlyRates:"per_night"===_?w:null,pricingMode:_,giavPricing:A,totals:{nights:m,nightsPayable:E,freeNights:h,totalNet:Z(T),totalPvp:Z(I)}}}(r,a,i);r.room_pricing=t.roomPricing,r.discounts=t.discounts,r.giav_pricing=t.giavPricing,r.hotel_pricing_mode=t.pricingMode,"per_night"===t.pricingMode&&(r.nightly_rates=Array.isArray(t.nightlyRates)?t.nightlyRates:[]),r.line_cost_net=t.totals.totalNet,r.line_sell_price=t.giavPricing.giav_total_pvp,r.quantity=1,r.unit_cost_net=t.totals.totalNet,r.unit_sell_price=t.giavPricing.giav_total_pvp}else if("golf"===r.service_type){var s;const e=Math.max(0,W(null!==(s=a?.players_count)&&void 0!==s?s:0,0)),t=e>0?e:1,{greenFeesPerPerson:l,totalGreenFees:n}=function(e={},a=1){var t,l,n;const r=Math.max(1,W(a,1));let i=Math.max(0,W(null!==(t=e.green_fees_per_person)&&void 0!==t?t:0,0)),s=Math.max(0,W(null!==(l=e.total_green_fees)&&void 0!==l?l:0,0));const o=Math.max(0,W(null!==(n=e.quantity)&&void 0!==n?n:0,0));return i>0?s=i*r:s>0?(i=Math.max(1,Math.round(s/r)),s=i*r):o>0?(s=o,i=Math.max(1,Math.round(s/r)),s=i*r):(i=1,s=i*r),{greenFeesPerPerson:i,totalGreenFees:s}}(r,t);r.number_of_players=e,r.green_fees_per_person=l,r.total_green_fees=n,r.quantity=n,r.line_cost_net=Z(n*r.unit_cost_net),r.line_sell_price=Z(n*r.unit_sell_price)}else if("package"===r.service_type){var o,c,u,d;const e="per_person"===r.package_pricing_basis?"per_person":"per_room",t=Math.max(1,W(null!==(o=a?.pax_total)&&void 0!==o?o:1,1)),l=J(K(null!==(c=r.discounts?.discount_pct)&&void 0!==c?c:0),0,50)/100;r.quantity="per_person"===e?t:Math.max(1,W(r.quantity,1));const n=Z(Math.max(0,K(r.unit_cost_net))*(1-l)),s=le(n,i);if(r.unit_cost_net=n,r.lock_sell_price){const e=Math.max(0,K(r.unit_sell_price));r.unit_sell_price=Z(e*(1-l))}else r.unit_sell_price=s;r.line_cost_net=Z(r.quantity*r.unit_cost_net),r.line_sell_price=Z(r.quantity*r.unit_sell_price),r.package_individual_count=Math.max(0,W(null!==(u=r.package_individual_count)&&void 0!==u?u:0,0)),r.package_single_rooms=Math.max(0,W(null!==(d=r.package_single_rooms)&&void 0!==d?d:0,0))}else r.line_cost_net=Z(r.quantity*r.unit_cost_net),r.line_sell_price=Z(r.quantity*r.unit_sell_price);return r}function ie({item:e,idx:t,updateItem:n,currency:r,pax:i,basics:s,globalMarkupPct:o}){var c,u,d,m,p,_,v;const g=e.room_pricing||ae(o),b=ae(o),h=e=>g[e]||b[e],E=Math.max(0,W(null!==(c=h("double").rooms)&&void 0!==c?c:0,0)),y=Math.max(0,W(null!==(u=h("single").rooms)&&void 0!==u?u:0,0)),f=(h("double").enabled?2*E:0)+(h("single").enabled?y:0),N=f-i,C=!!e.hotel_informative_quote,S=N<0?`Faltan ${Math.abs(N)} pax por asignar a habitaciones`:N>0?`Sobran ${N} pax asignados`:"",w=Math.max(0,W(null!==(d=e.hotel_nights)&&void 0!==d?d:ee(e,s),0)),{nightsPayable:k}=te(w,e.discounts?.free_nights_every,e.discounts?.free_nights_count),x=function(e={}){var a,t,l;const n=Math.max(0,K(null!==(a=e.discount_pct)&&void 0!==a?a:0)),r=Math.max(0,W(null!==(t=e.free_nights_every)&&void 0!==t?t:0,0)),i=Math.max(0,W(null!==(l=e.free_nights_count)&&void 0!==l?l:0,0)),s=[];return n>0&&s.push(`-${Z(n)}%`),r>0&&i>0&&s.push(`+${i} gratis cada ${r}`),s.length>0?s.join(" "):"Sin descuentos"}(e.discounts),T=e.notes_public||e.notes_internal?"Ver notas":"Sin notas",I="per_night"==("per_night"===e.hotel_pricing_mode?"per_night":"simple"),P=e.start_date||s?.start_date||"",M=e.end_date||s?.end_date||"",A=(a={})=>{var t,l,n,r,i,s,c,u;const d=Array.isArray(e.nightly_rates)&&e.nightly_rates.length?e.nightly_rates[0]:null,m=null!==(t=null!==(l=null!==(n=null!==(r=a.fallbackNet)&&void 0!==r?r:d?.net_price)&&void 0!==n?n:h("double").net_price_per_night)&&void 0!==l?l:e.unit_cost_net&&w>0?Z(K(e.unit_cost_net)/w):"")&&void 0!==t?t:"",p=null!==(i=null!==(s=a.fallbackMargin)&&void 0!==s?s:d?.margin_pct)&&void 0!==i?i:null!==(c=null!==(u=e.markup_pct)&&void 0!==u?u:o)&&void 0!==c?c:0;return X(e.nightly_rates,P,M,m,p)},B=(e,a)=>{const l=A().map((t,l)=>l===e?{...t,...a}:t);n(t,{nightly_rates:l})},R=(a,l)=>{const r=e.room_pricing||{},i={...r[a]||{},...l},s={...r,[a]:i};n(t,{room_pricing:s})},D=(a,l)=>{const r=e.discounts||{};n(t,{discounts:{...r,[a]:l}})};return(0,a.createElement)("div",{className:"service-card__hotel-panel"},(0,a.createElement)("div",{className:"service-card__subcard service-card__subcard--nightly"},(0,a.createElement)("div",{className:"service-card__hotel-nightly-toggle"},(0,a.createElement)(l.ToggleControl,{label:"Precio variable por noche",checked:I,onChange:()=>{if(!I){const e=A();return void n(t,{hotel_pricing_mode:"per_night",nightly_rates:e})}n(t,{hotel_pricing_mode:"simple"})}}),I&&(0,a.createElement)("div",{className:"service-card__hotel-nightly-hint"},'El neto y margen se definen por fecha. Los campos "Neto por noche" y "Margen" del modo de habitación se ignoran (salvo PVP manual).')),I&&(0,a.createElement)("details",{className:"service-card__hotel-nightly",open:!0},(0,a.createElement)("summary",{className:"service-card__section-summary"},(0,a.createElement)("span",{className:"service-card__section-summary-title"},"Desglose por noche"),(0,a.createElement)("span",{className:"service-card__section-summary-meta"},Y(P,M)," noches")),(0,a.createElement)("div",{className:"service-card__hotel-nightly-table"},(0,a.createElement)("div",{className:"service-card__hotel-nightly-row service-card__hotel-nightly-row--head"},(0,a.createElement)("div",null,"Fecha"),(0,a.createElement)("div",null,"Neto"),(0,a.createElement)("div",null,"Margen (%)")),A().map((e,t)=>{var n,r;return(0,a.createElement)("div",{key:e.date||t,className:"service-card__hotel-nightly-row"},(0,a.createElement)("div",{className:"service-card__hotel-nightly-date"},e.date),(0,a.createElement)(l.TextControl,{value:String(null!==(n=e.net_price)&&void 0!==n?n:""),onChange:e=>B(t,{net_price:e}),placeholder:"120"}),(0,a.createElement)(l.TextControl,{type:"number",min:0,value:String(null!==(r=e.margin_pct)&&void 0!==r?r:""),onChange:e=>B(t,{margin_pct:e}),placeholder:"20"}))})))),(0,a.createElement)("div",{className:"service-card__hotel-occupancy"},["double","single"].map(e=>{var t,n,i,s;const c="double"===e?"Doble":"Individual",u=h(e);return(0,a.createElement)("div",{key:e,className:"service-card__hotel-occupancy-card"},(0,a.createElement)("div",{className:"service-card__hotel-occupancy-header"},(0,a.createElement)(l.ToggleControl,{label:`Cotizar ${c.toLowerCase()}`,checked:!!u.enabled,onChange:()=>R(e,{enabled:!u.enabled})}),(0,a.createElement)("span",{className:"service-card__hotel-occupancy-label"},c)),u.enabled&&(0,a.createElement)("div",{className:"service-card__hotel-occupancy-body"},(0,a.createElement)(l.TextControl,{label:`Habitaciones ${c.toLowerCase()}`,type:"number",min:1,value:String(null!==(t=u.rooms)&&void 0!==t?t:""),onChange:a=>R(e,{rooms:a})}),"double"===e&&(0,a.createElement)(l.SelectControl,{label:"Precio",value:u.pricing_basis||"per_room",options:[{label:"Por habitación",value:"per_room"},{label:"Por persona",value:"per_person"}],onChange:e=>R("double",{pricing_basis:e})}),(0,a.createElement)(l.TextControl,{label:`Neto por noche (${c.toLowerCase()})`,value:String(null!==(n=u.net_price_per_night)&&void 0!==n?n:""),onChange:a=>R(e,{net_price_per_night:a}),placeholder:"120",disabled:I}),(0,a.createElement)("details",{className:"service-card__hotel-mode-details"},(0,a.createElement)("summary",null,"Margen y PVP"),(0,a.createElement)("div",{className:"service-card__hotel-mode-details-grid"},(0,a.createElement)(l.ToggleControl,{label:"PVP manual",checked:!!u.pvp_manual_enabled,onChange:()=>R(e,{pvp_manual_enabled:!u.pvp_manual_enabled})}),u.pvp_manual_enabled?(0,a.createElement)(l.TextControl,{label:`PVP por noche (${c.toLowerCase()})`,value:String(null!==(i=u.pvp_price_per_night)&&void 0!==i?i:""),onChange:a=>R(e,{pvp_price_per_night:a}),placeholder:"165"}):(0,a.createElement)(l.TextControl,{label:I?"Margen (%) (se ignora)":"Margen (%)",type:"number",min:0,value:String(null!==(s=u.margin_pct)&&void 0!==s?s:o),onChange:a=>R(e,{margin_pct:a}),disabled:I}))),(0,a.createElement)("div",{className:"service-card__hotel-total"},"Total hab. ",c.toLowerCase(),": ",r," ",Z(u.total_pvp||0).toFixed(2))))})),(0,a.createElement)("div",{className:"service-card__hotel-allocation"},(0,a.createElement)("div",{className:"service-card__hotel-allocation-text"},"Personas asignadas: ",f," de ",i),S&&(0,a.createElement)(l.Notice,{status:C&&N>0?"info":"warning",isDismissible:!1},S),(0,a.createElement)(l.ToggleControl,{label:"Cotización informativa (permitir habitaciones extra)",checked:C,onChange:e=>n(t,{hotel_informative_quote:!!e}),help:"Actívalo si estás cotizando una habitación adicional solo a efectos informativos (no bloquea si sobran pax asignados)."})),(0,a.createElement)("div",{className:"service-card__subcard"},(0,a.createElement)("details",{className:"service-card__hotel-discounts-collapse"},(0,a.createElement)("summary",{className:"service-card__section-summary"},(0,a.createElement)("span",{className:"service-card__section-summary-title"},"Descuentos"),(0,a.createElement)("span",{className:"service-card__section-summary-meta"},x)),(0,a.createElement)("div",{className:"service-card__hotel-discounts"},(0,a.createElement)("div",{className:"service-card__hotel-discounts-grid"},(0,a.createElement)(l.TextControl,{label:"Descuento (%)",type:"number",min:0,max:50,value:String(null!==(m=e.discounts?.discount_pct)&&void 0!==m?m:0),onChange:e=>D("discount_pct",e)}),(0,a.createElement)(l.TextControl,{label:"Noches gratis (cada)",type:"number",min:0,value:String(null!==(p=e.discounts?.free_nights_every)&&void 0!==p?p:""),onChange:e=>D("free_nights_every",e)}),(0,a.createElement)(l.TextControl,{label:"Noches gratis (cantidad)",type:"number",min:0,value:String(null!==(_=e.discounts?.free_nights_count)&&void 0!==_?_:""),onChange:e=>D("free_nights_count",e)})),w>0&&(0,a.createElement)("div",{className:"service-card__hotel-discount-summary"},"Se cobran ",k," noches de ",w)))),(0,a.createElement)("div",{className:"service-card__subcard service-card__subcard--giav"},(0,a.createElement)("div",{className:"service-card__hotel-giav"},(0,a.createElement)("div",{className:"service-card__hotel-subtitle"},"Total para GIAV"),(0,a.createElement)("div",{className:"service-card__hotel-giav-grid"},(0,a.createElement)("div",{className:"service-card__hotel-giav-total"},(0,a.createElement)("div",{className:"service-card__hotel-giav-label"},"Total alojamiento (para GIAV)"),(0,a.createElement)("div",{className:"service-card__hotel-giav-value"},r," ",Z(e.giav_pricing?.giav_total_pvp||0).toFixed(2))),(0,a.createElement)(l.ToggleControl,{label:"Editar total para GIAV",checked:!!e.giav_pricing?.giav_locked,onChange:()=>{const a=e.giav_pricing||{};n(t,{giav_pricing:{...a,giav_locked:!a.giav_locked}})}}),(0,a.createElement)(l.TextControl,{label:"Total editable",value:String(null!==(v=e.giav_pricing?.giav_total_pvp)&&void 0!==v?v:""),onChange:a=>(a=>{const l=e.giav_pricing||{};n(t,{giav_pricing:{...l,giav_total_pvp:a}})})(a),disabled:!e.giav_pricing?.giav_locked}),e.giav_pricing?.giav_locked&&(0,a.createElement)(l.Notice,{status:C&&N>0?"info":"warning",isDismissible:!1},"Este total se enviará a GIAV. No se recalculará automáticamente.")))),(0,a.createElement)("div",{className:"service-card__subcard"},(0,a.createElement)("details",{className:"service-card__hotel-notes"},(0,a.createElement)("summary",{className:"service-card__section-summary"},(0,a.createElement)("span",{className:"service-card__section-summary-title"},"Notas"),(0,a.createElement)("span",{className:"service-card__section-summary-meta"},T)),(0,a.createElement)("div",{className:"service-card__hotel-notes-grid"},(0,a.createElement)(l.TextControl,{label:"Notas para el cliente (itinerario)",value:e.notes_public||"",onChange:e=>n(t,{notes_public:e}),placeholder:"Incluye desayuno. Check-in 15:00."}),(0,a.createElement)(l.TextControl,{label:"Notas internas (solo uso interno)",value:e.notes_internal||"",onChange:e=>n(t,{notes_internal:e}),placeholder:"Neto negociado, release 14D."})))))}function se(e=[],a={}){if(!Array.isArray(e)||!e.length)return e;const t=a?.start_date||"",l=a?.end_date||"";let n=!1;const r=e.map(e=>{if(!e||!e.dates_inherited)return e;if(e.start_date===t&&e.end_date===l)return e;n=!0;const a={...e,start_date:t,end_date:l,dates_inherited:!0};if("hotel"===a.service_type&&"per_night"===a.hotel_pricing_mode){var r,i,s;const e=Array.isArray(a.nightly_rates)&&a.nightly_rates.length?a.nightly_rates[0]:null,n=null!==(r=e?.net_price)&&void 0!==r?r:"",o=null!==(i=e?.margin_pct)&&void 0!==i?i:null!==(s=a.markup_pct)&&void 0!==s?s:0;a.nightly_rates=X(a.nightly_rates,t,l,n,o)}return a});return n?r:e}function oe({item:e,idx:t,updateItem:n,currency:r,pax:i,globalMarkupPct:s}){var o,c,u,d,m,p,_,v,g,b,h,E,y,f,N;const C="per_person"===e.package_pricing_basis?"per_person":"per_room",S=J(K(null!==(o=e.discounts?.discount_pct)&&void 0!==o?o:0),0,50),w=!!e.lock_sell_price;return(0,a.createElement)("div",{className:"service-card__pricing service-card__pricing--package"},(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.SelectControl,{label:"Precio del paquete",value:C,options:[{label:"Por habitación/paquete",value:"per_room"},{label:"Por persona (en doble)",value:"per_person"}],onChange:e=>{const a="per_person"===e?"per_person":"per_room",l={package_pricing_basis:a};"per_person"===a&&(l.quantity=i),n(t,l)}})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"per_person"===C?"Personas (auto)":"Cantidad (habitaciones/paquetes)",type:"number",min:1,value:String(null!==(c=e.quantity)&&void 0!==c?c:1),onChange:e=>n(t,{quantity:e}),disabled:"per_person"===C,help:"per_person"===C?"Se calcula desde Datos básicos (pax total).":""})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"per_person"===C?"Coste neto (por persona en doble)":"Coste neto (hab./paquete doble)",value:String(null!==(u=e.unit_cost_net)&&void 0!==u?u:""),onChange:e=>n(t,{unit_cost_net:e}),placeholder:"120"})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.ToggleControl,{label:"Usar margen",checked:!!e.use_markup,onChange:()=>n(t,{use_markup:!e.use_markup})})),e.use_markup&&(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Margen (%)",type:"number",min:0,value:String(null!==(d=e.markup_pct)&&void 0!==d?d:s),onChange:e=>n(t,{markup_pct:e})})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.ToggleControl,{label:"PVP manual",checked:!!e.lock_sell_price,onChange:()=>n(t,{lock_sell_price:!e.lock_sell_price})})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"per_person"===C?"PVP (por persona en doble)":"PVP (hab./paquete doble)",value:String(null!==(m=e.unit_sell_price)&&void 0!==m?m:""),onChange:e=>n(t,{unit_sell_price:e}),placeholder:"165",disabled:!e.lock_sell_price,help:S>0?`Descuento aplicado: -${S}%`:""})),"per_person"===C?(0,a.createElement)("div",{className:"service-card__subcard"},(0,a.createElement)("details",{className:"service-card__hotel-discounts-collapse"},(0,a.createElement)("summary",{className:"service-card__section-summary"},(0,a.createElement)("span",{className:"service-card__section-summary-title"},"Individual (informativo)"),(0,a.createElement)("span",{className:"service-card__section-summary-meta"},e.package_quote_individual?"Activado":"")),(0,a.createElement)("div",{className:"service-card__hotel-discounts"},(0,a.createElement)("div",{className:"service-card__hotel-discounts-grid"},(0,a.createElement)(l.ToggleControl,{label:"Cotizar individual",checked:!!e.package_quote_individual,onChange:()=>n(t,{package_quote_individual:!e.package_quote_individual})}),e.package_quote_individual&&(0,a.createElement)(a.Fragment,null,(0,a.createElement)(l.TextControl,{label:"Personas en individual",type:"number",min:0,max:i,value:String(null!==(p=e.package_individual_count)&&void 0!==p?p:0),onChange:e=>n(t,{package_individual_count:e})}),(0,a.createElement)(l.SelectControl,{label:"Modo",value:"supplement"===e.package_individual_mode?"supplement":"absolute",options:[{label:"Precio absoluto",value:"absolute"},{label:"Suplemento sobre doble",value:"supplement"}],onChange:e=>n(t,{package_individual_mode:e})}),"supplement"!==e.package_individual_mode?(0,a.createElement)(a.Fragment,null,(0,a.createElement)(l.TextControl,{label:"Coste neto (indiv. por persona)",value:String(null!==(_=e.unit_cost_net_individual)&&void 0!==_?_:""),onChange:e=>n(t,{unit_cost_net_individual:e}),placeholder:"150"}),(0,a.createElement)(l.TextControl,{label:"PVP (indiv. por persona)",value:String(null!==(v=e.unit_sell_price_individual)&&void 0!==v?v:""),onChange:e=>n(t,{unit_sell_price_individual:e}),placeholder:"210",disabled:!w})):(0,a.createElement)(a.Fragment,null,(0,a.createElement)(l.TextControl,{label:"Suplemento neto (por persona)",value:String(null!==(g=e.package_single_supplement_net)&&void 0!==g?g:""),onChange:e=>n(t,{package_single_supplement_net:e}),placeholder:"30"}),(0,a.createElement)(l.TextControl,{label:"Suplemento PVP (por persona)",value:String(null!==(b=e.package_single_supplement_sell)&&void 0!==b?b:""),onChange:e=>n(t,{package_single_supplement_sell:e}),placeholder:"45",disabled:!w}))))))):(0,a.createElement)("div",{className:"service-card__subcard"},(0,a.createElement)("details",{className:"service-card__hotel-discounts-collapse"},(0,a.createElement)("summary",{className:"service-card__section-summary"},(0,a.createElement)("span",{className:"service-card__section-summary-title"},"Habitación individual (informativo)"),(0,a.createElement)("span",{className:"service-card__section-summary-meta"},e.package_quote_single_rooms?"Activado":"")),(0,a.createElement)("div",{className:"service-card__hotel-discounts"},(0,a.createElement)("div",{className:"service-card__hotel-discounts-grid"},(0,a.createElement)(l.ToggleControl,{label:"Cotizar hab. individual",checked:!!e.package_quote_single_rooms,onChange:()=>n(t,{package_quote_single_rooms:!e.package_quote_single_rooms})}),e.package_quote_single_rooms&&(0,a.createElement)(a.Fragment,null,(0,a.createElement)(l.TextControl,{label:"Habitaciones individuales",type:"number",min:0,value:String(null!==(h=e.package_single_rooms)&&void 0!==h?h:0),onChange:e=>n(t,{package_single_rooms:e})}),(0,a.createElement)(l.SelectControl,{label:"Modo",value:"supplement"===e.package_single_room_mode?"supplement":"absolute",options:[{label:"Precio absoluto",value:"absolute"},{label:"Suplemento sobre doble",value:"supplement"}],onChange:e=>n(t,{package_single_room_mode:e})}),"supplement"!==e.package_single_room_mode?(0,a.createElement)(a.Fragment,null,(0,a.createElement)(l.TextControl,{label:"Coste neto (hab. indiv.)",value:String(null!==(E=e.unit_cost_net_single_room)&&void 0!==E?E:""),onChange:e=>n(t,{unit_cost_net_single_room:e}),placeholder:"150"}),(0,a.createElement)(l.TextControl,{label:"PVP (hab. indiv.)",value:String(null!==(y=e.unit_sell_price_single_room)&&void 0!==y?y:""),onChange:e=>n(t,{unit_sell_price_single_room:e}),placeholder:"210",disabled:!w})):(0,a.createElement)(a.Fragment,null,(0,a.createElement)(l.TextControl,{label:"Suplemento neto (hab. indiv.)",value:String(null!==(f=e.package_single_room_supplement_net)&&void 0!==f?f:""),onChange:e=>n(t,{package_single_room_supplement_net:e}),placeholder:"30"}),(0,a.createElement)(l.TextControl,{label:"Suplemento PVP (hab. indiv.)",value:String(null!==(N=e.package_single_room_supplement_sell)&&void 0!==N?N:""),onChange:e=>n(t,{package_single_room_supplement_sell:e}),placeholder:"45",disabled:!w}))))))))}function ce({proposalId:e,basics:n,initialItems:r=[],onBack:i,onNext:s,onDraftChange:o,requestIntentions:c=null}){var d,m;const p=n?.currency||"EUR",_=Math.max(1,W(null!==(d=n?.pax_total)&&void 0!==d?d:1,1)),v=Math.max(0,W(null!==(m=n?.players_count)&&void 0!==m?m:0,0)),[g,b]=(0,t.useState)(20),[h,y]=(0,t.useState)(!0),[f,N]=(0,t.useState)(""),[C,S]=(0,t.useState)(""),[w,k]=(0,t.useState)(!1),[x,T]=(0,t.useState)(null),[I,P]=(0,t.useState)(null),[M,A]=(0,t.useState)(0),[B,R]=(0,t.useState)(null),[D,$]=(0,t.useState)(!1),[G,F]=(0,t.useState)([]),q=(0,t.useRef)(null),[J,ae]=(0,t.useState)(()=>(r.length?r:[ne(n,20)]).map(e=>{const a={...e},t="boolean"==typeof a.dates_inherited,l=a.start_date||n?.start_date||"",r=a.end_date||n?.end_date||"";return a.start_date||(a.start_date=l),a.end_date||(a.end_date=r),a.dates_inherited=t?a.dates_inherited:l===(n?.start_date||"")&&r===(n?.end_date||""),re(a,n,20)})),te=(0,t.useMemo)(()=>function(e){const a=e.reduce((e,a)=>(e.cost+=a.line_cost_net||0,e.sell+=a.line_sell_price||0,e),{cost:0,sell:0}),t=Z(a.sell-a.cost),l=a.sell>0?Z(t/a.sell*100):0;return{totals_cost_net:Z(a.cost),totals_sell_price:Z(a.sell),totals_margin_abs:t,totals_margin_pct:l}}(J),[J]);(0,t.useEffect)(()=>{if(!o)return;const e=window.setTimeout(()=>{o({items:J,totals:te})},200);return()=>window.clearTimeout(e)},[J,te,o]);const le=(0,t.useMemo)(()=>{var e,a,t;const l=Math.max(0,W(null!==(e=n?.pax_total)&&void 0!==e?e:0,0)),r=W(null!==(a=null!==(t=n?.players_count)&&void 0!==t?t:l)&&void 0!==a?a:0,0),i=Math.min(Math.max(r,0),l),s={paxTotal:l,playersCount:i,nonPlayersCount:Math.max(0,l-i),golfTotal:0,totalDouble:0,totalSingle:0,doubleRooms:0,singleRooms:0};J.forEach(e=>{if("golf"===e.service_type&&(s.golfTotal+=K(e.line_sell_price||0)),"hotel"===e.service_type){const l=e.room_pricing||{};var a,t;l.double?.enabled&&(s.totalDouble+=K(l.double?.total_pvp||0),s.doubleRooms+=Math.max(0,W(null!==(a=l.double?.rooms)&&void 0!==a?a:0,0))),l.single?.enabled&&(s.totalSingle+=K(l.single?.total_pvp||0),s.singleRooms+=Math.max(0,W(null!==(t=l.single?.rooms)&&void 0!==t?t:0,0)))}});const o=K(te.totals_sell_price||0),c=o,u=s.doubleRooms>0?s.totalDouble/(2*s.doubleRooms):0,d=s.singleRooms>0?s.totalSingle/s.singleRooms:0,m=s.totalDouble||0,p=s.totalSingle||0,_=s.golfTotal||0,v=o-(m+p)-_,g=u+(s.paxTotal>0?v/s.paxTotal:0),b=s.playersCount>0?g+_/s.playersCount:null,h=s.doubleRooms>0&&s.singleRooms>0;let E=null;return h&&(E=Math.max(0,d-u)),{...s,totalTrip:o,baseTotal:c,priceNonPlayerDouble:g,pricePlayerDouble:b,supplementSingle:E,hasSingleSupplement:h}},[n?.pax_total,n?.players_count,J,te.totals_sell_price]);(0,t.useEffect)(()=>{ae(e=>{const a=se(e,n);return a===e?e:a.map((a,t)=>a===e[t]?a:re(a,n,g))})},[n?.start_date,n?.end_date,g,n]),(0,t.useEffect)(()=>{ae(e=>e.map(e=>re(e,n,g)))},[_]),(0,t.useEffect)(()=>{null!=M&&M>=J.length&&A(J.length?J.length-1:null)},[J.length,M]),(0,t.useEffect)(()=>{if(null==B)return;const e=document.querySelector(`[data-service-index="${B}"]`);if(!e)return;e.scrollIntoView({behavior:"smooth",block:"start"}),((e,a)=>{if(!e)return;if(!a?.service_type){const a=e.querySelector("select");if(a&&"function"==typeof a.focus)return void a.focus()}const t=e.querySelector(".service-card__grid--context input");t&&"function"==typeof t.focus?t.focus():ve(e)})(e,J[B]),P(B);const a=window.setTimeout(()=>P(null),1200);return R(null),()=>window.clearTimeout(a)},[B,J]);const ce=(e,a)=>{ae(t=>{const l=[...t],r={...l[e],...a};return l[e]=re(r,n,g),l})},ue=(0,t.useMemo)(()=>J.map((e,a)=>(e=>{const a=[],t={};if((e.title||e.display_name||"").trim()||(a.push("Falta título"),t.title="Completa el título."),"hotel"!==e.service_type&&"golf"!==e.service_type||e.giav_supplier_id||(a.push("Falta proveedor"),t.supplier="Selecciona un proveedor."),"hotel"===e.service_type){var l,r,i;const c=e.room_pricing||{},u="per_night"===e.hotel_pricing_mode,d=!!c.double?.enabled,m=!!c.single?.enabled;d||m||(a.push("Activa doble/individual"),t.pricing="Activa doble y/o individual.");const p=(e,a)=>{var t;const l=c[e]||{};return l.enabled?W(null!==(t=l.rooms)&&void 0!==t?t:0,0)<1?`Habitaciones ${a} < 1`:!u&&K(l.net_price_per_night)<=0?`Neto ${a} faltante`:l.pvp_manual_enabled&&K(l.pvp_price_per_night)<=0?`PVP manual ${a} faltante`:"":""};if(u){var s,o;const l=e.start_date||n?.start_date||"",r=e.end_date||n?.end_date||"",i=Y(l,r),c=X(e.nightly_rates||[],l,r,"",null!==(s=null!==(o=e.markup_pct)&&void 0!==o?o:g)&&void 0!==s?s:0);i<=0?(a.push("Fechas hotel inválidas"),t.pricing="Revisa fechas de hotel."):c.length&&c.length===i?c.some(e=>K(e.net_price)<=0)&&(a.push("Neto por noche faltante"),t.pricing="Completa neto en todas las noches."):(a.push("Faltan noches"),t.pricing="Completa el desglose por noche.")}const v=p("double","doble"),b=p("single","individual");(v||b)&&(a.push(v||b),t.pricing="Revisa pricing de habitaciones.");const h=d?Math.max(0,W(null!==(l=c.double?.rooms)&&void 0!==l?l:0,0)):0,E=m?Math.max(0,W(null!==(r=c.single?.rooms)&&void 0!==r?r:0,0)):0,y=(d?2*h:0)+(m?E:0),f=!!e.hotel_informative_quote;y<_?(a.push("Faltan pax"),t.pricing="Ajusta pax doble/individual."):y>_&&!f&&(a.push("Pax no cuadra"),t.pricing="Ajusta pax doble/individual."),K(null!==(i=e.giav_pricing?.giav_total_pvp)&&void 0!==i?i:0)<=0&&(a.push("Total GIAV faltante"),t.pricing="Completa total GIAV.")}"golf"===e.service_type&&W(e.green_fees_per_person,1)<1&&(a.push("Green-fees faltante"),t.greenFees="Define green-fees por jugador."),["transfer","extra","package"].includes(e.service_type)&&W(e.quantity,1)<1&&(a.push("Cantidad inválida"),t.quantity="Cantidad debe ser >= 1."),K(e.unit_sell_price)<=0&&(a.push("PVP unitario faltante"),t.unitSell="Define PVP unitario.");const c=("hotel"===e.service_type||"golf"===e.service_type)&&["needs_review","missing"].includes(e.giav_mapping_status);return{issues:a,fieldErrors:t,status:a.length>0?"error":c?"pending":"completed",hasMappingWarning:c}})(e)),[J,_]),de=e=>{A(e),T(e),window.setTimeout(()=>{const a=document.querySelector(`[data-service-index="${e}"]`);a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),ve(a))},50)},me=e=>{ce(e,{show_supplier_picker:!J[e].show_supplier_picker})},pe=e=>!!e.show_supplier_picker,_e=()=>{const e=[],a=[];return ue.forEach((e,t)=>{e.issues.length>0&&a.push({index:t,title:`Servicio ${t+1}`,details:e.issues.slice(0,2).join(" · ")})}),J.some(e=>"golf"===e.service_type)&&v<=0&&e.push('Define "Jugadores" en Datos básicos.'),te.totals_sell_price<=0&&e.push("El PVP total debe ser > 0."),{errors:e,serviceErrors:a}},ve=e=>{if(!e)return;const a=e.querySelector("input, select, textarea, button");a&&"function"==typeof a.focus&&a.focus()},ge=(0,t.useMemo)(()=>_e(),[ue,J,v,te.totals_sell_price]),be=ge.serviceErrors.length>0||ge.errors.length>0,he=(e,{missing:t,tooltip:l}={})=>t?(0,a.createElement)("span",{className:"services-summary__value services-summary__value--missing",title:l},"—"):(0,a.createElement)("span",{className:"services-summary__value"},e);return(0,t.useEffect)(()=>{D&&(be||(N(""),F([])))},[D,be]),(0,a.createElement)(l.Card,{className:"services-step"},(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"services-step__title"},(0,a.createElement)("strong",null,"Servicios & precios"),(0,a.createElement)("span",{className:"services-step__subtitle"},"Añade servicios con detalle, márgenes y proveedor."))),(0,a.createElement)(l.CardBody,{ref:q},C&&(0,a.createElement)(l.Notice,{status:"success",isDismissible:!0,onRemove:()=>S("")},C),c&&(0,a.createElement)("div",{className:"services-intention-banner"},(0,a.createElement)("strong",null,"Intenciones detectadas"),c.golf?.requested&&(0,a.createElement)("span",null,"Solicitud indica ",c.golf.green_fees_per_player||"—"," green-fees por jugador."),c.flights?.requested&&(0,a.createElement)("span",null,"Requiere vuelos desde ",c.flights.departure_airport||"—","."),c.package&&(0,a.createElement)("span",null,"Paquete sugerido: ",c.package),c.more_info&&(0,a.createElement)("span",null,"Más info: ",c.more_info)),(0,a.createElement)("div",{className:"services-toolbar"},(0,a.createElement)("div",{className:"services-toolbar__controls"},(0,a.createElement)(l.TextControl,{label:"Margen por defecto (%)",type:"number",min:0,value:String(g),onChange:e=>b(K(e))}),(0,a.createElement)(l.ToggleControl,{label:"Aplicar a nuevas líneas",checked:h,onChange:()=>y(e=>!e)}),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>{ae(e=>e.map(e=>re({...e,markup_pct:g},n,g)))}},"Aplicar a todas")),(0,a.createElement)("div",{className:"services-toolbar__summary"},(0,a.createElement)("div",{className:"services-toolbar__label"},"PVP total"),(0,a.createElement)("div",{className:"services-toolbar__value"},p," ",te.totals_sell_price.toFixed(2)))),(0,a.createElement)("div",{className:"services-items"},J.map((e,t)=>{var r,i,s;const o=M===t,c=ue[t]||{issues:[],status:"pending",hasMappingWarning:!1,fieldErrors:{}},u=c.status,d=(e=>{const a=e.start_date||n?.start_date||"",t=e.end_date||n?.end_date||"",l=a&&t?`${a} → ${t}`:"Fechas por definir",r=`${p} ${Z(e.line_sell_price||0).toFixed(2)}`;return"golf"===e.service_type?`${l} · Jugadores: ${v||_} · ${r}`:"hotel"===e.service_type?`${l} · Pax: ${_} · ${r}`:["transfer","extra","package"].includes(e.service_type)?`Cantidad: ${W(null!==(i=e.quantity)&&void 0!==i?i:1,1)} · ${r}`:`${l} · ${r}`;var i})(e),m=c.hasMappingWarning?"Proveedor GIAV pendiente":"",b=c.issues.slice(0,2).join(" · "),h=c.fieldErrors||{};return(0,a.createElement)("div",{key:t,className:`service-card service-card--status-${u} ${o?"is-open":""} ${x===t?"is-error":""} ${I===t?"is-highlighted":""}`.trim(),"data-service-index":t},(0,a.createElement)("div",{className:"service-card__header"},(0,a.createElement)("div",{className:"service-card__title"},(0,a.createElement)("div",{className:"service-card__eyebrow"},"Servicio ",t+1),(0,a.createElement)("div",{className:"service-card__name"},H.find(a=>a.value===e.service_type)?.label||"Servicio"," ·"," ",e.title?.trim()||e.display_name?.trim()||"Sin título"),(0,a.createElement)("div",{className:"service-card__summary"},d),"pending"===u&&m&&(0,a.createElement)("div",{className:"service-card__missing"},m),"error"===u&&b&&(0,a.createElement)("div",{className:"service-card__missing"},b)),(0,a.createElement)("div",{className:"service-card__meta"},(0,a.createElement)("div",{className:`service-card__badge service-card__badge--${u}`},"completed"===u&&"✓ OK","pending"===u&&"Pendiente","error"===u&&`${c.issues.length} errores`),(0,a.createElement)(l.Button,{variant:"tertiary",className:"service-card__toggle",onClick:()=>A(o?null:t)},o?"Ocultar":"Ver detalle"),(0,a.createElement)("div",{className:"service-card__total"},(0,a.createElement)("span",null,"Total línea"),(0,a.createElement)("strong",null,p," ",Z(e.line_sell_price||0).toFixed(2))),(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>(e=>{ae(a=>a.filter((a,t)=>t!==e)),A(a=>null==a?a:a===e?Math.max(0,e-1):a>e?a-1:a)})(t),disabled:1===J.length},"Eliminar"))),o&&(0,a.createElement)("div",{className:"service-card__content"},(0,a.createElement)("div",{className:"service-card__section"},(0,a.createElement)("div",{className:"service-card__section-title"},"Selección y contexto"),(0,a.createElement)("div",{className:"service-card__grid service-card__grid--context"},(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.SelectControl,{label:"Tipo de servicio",value:e.service_type,options:H,onChange:e=>ce(t,{service_type:e})})),"hotel"===e.service_type||"golf"===e.service_type||"package"===e.service_type?(0,a.createElement)(a.Fragment,null,e.use_manual_entry?(0,a.createElement)("div",{className:"service-card__field "+(h.title?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"hotel"===e.service_type?"Hotel (manual) *":"Campo de golf (manual) *",value:e.display_name||"",onChange:e=>ce(t,{display_name:e,title:e}),placeholder:"hotel"===e.service_type?"Ej: Hotel X (fuera de catálogo)":"Ej: Campo Y (fuera de catálogo)"}),h.title&&(0,a.createElement)("div",{className:"service-card__field-error"},h.title)):(0,a.createElement)("div",{className:"service-card__field "+(h.title?"is-error":"")},(0,a.createElement)(V,{label:"hotel"===e.service_type?"Hotel":"package"===e.service_type?"Hotel (paquete)":"Campo de golf",type:"golf"===e.service_type?"golf":"hotel",valueTitle:e.title,onPick:async a=>{const l="golf"===e.service_type?"course":"hotel";ce(t,{title:a.title,display_name:a.title,wp_object_type:l,wp_object_id:a.id,supplier_override:!1});try{const e=await E({wp_object_type:l,wp_object_id:a.id});var n,r;e?.status&&"missing"!==e.status?ce(t,{giav_mapping_status:e.status,giav_entity_type:e.giav_entity_type,giav_entity_id:e.giav_entity_id,giav_supplier_id:null!==(n=e.giav_supplier_id)&&void 0!==n?n:j,giav_supplier_name:null!==(r=e.giav_supplier_name)&&void 0!==r?r:L}):ce(t,{giav_mapping_status:"needs_review",giav_entity_type:"supplier",giav_entity_id:j,giav_supplier_id:j,giav_supplier_name:L})}catch{ce(t,{giav_mapping_status:"needs_review",giav_entity_type:"supplier",giav_entity_id:j,giav_supplier_id:j,giav_supplier_name:L})}}}),h.title&&(0,a.createElement)("div",{className:"service-card__field-error"},h.title)),(0,a.createElement)("div",{className:"service-card__field service-card__field--toggle"},(0,a.createElement)(l.ToggleControl,{label:"Entrada manual (fuera de catálogo)",checked:!!e.use_manual_entry,onChange:()=>{if(e.use_manual_entry)ce(t,{use_manual_entry:!1,wp_object_type:null,wp_object_id:null,show_supplier_picker:!1,giav_mapping_status:"missing",supplier_override:!1,display_name:""});else{const a=e.display_name||e.title||"";ce(t,{use_manual_entry:!0,wp_object_type:"manual",wp_object_id:0,show_supplier_picker:!0,giav_entity_type:"supplier",giav_entity_id:e.giav_supplier_id||j,giav_mapping_status:e.giav_supplier_id===j?"needs_review":"active",giav_supplier_id:e.giav_supplier_id||j,giav_supplier_name:e.giav_supplier_name||L,supplier_override:!1,display_name:a,title:a})}}})),(0,a.createElement)("div",{className:"service-card__supplier"},!pe(e)&&(0,a.createElement)("div",{className:"service-card__supplier-actions"},(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>me(t)},"Cambiar proveedor")),pe(e)&&(0,a.createElement)(a.Fragment,null,!e.use_manual_entry&&(0,a.createElement)("div",{className:"service-card__field service-card__field--toggle"},(0,a.createElement)(l.ToggleControl,{label:"Proveedor (opcional)",checked:!!e.show_supplier_picker,onChange:()=>me(t)})),(0,a.createElement)(U,{selectedId:e.giav_supplier_id||j,selectedLabel:e.giav_supplier_name||L,disabled:!1,onPick:a=>{const l=String(a?.id||""),n=String(a?.label||"");l&&ce(t,{giav_entity_type:"supplier",giav_entity_id:l,giav_supplier_id:l,giav_supplier_name:n,giav_mapping_status:l===j?"needs_review":"active",supplier_override:!e.use_manual_entry})}}),h.supplier&&(0,a.createElement)("div",{className:"service-card__field-error"},h.supplier)))):(0,a.createElement)("div",{className:"service-card__field "+(h.title?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"T├¡tulo / descripci├│n *",value:e.title,onChange:e=>ce(t,{title:e})}),h.title&&(0,a.createElement)("div",{className:"service-card__field-error"},h.title)),"hotel"===e.service_type&&(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Tipo de habitación",value:e.hotel_room_type||"",onChange:e=>ce(t,{hotel_room_type:e}),placeholder:"Deluxe / Sea View..."})),"hotel"===e.service_type&&(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.SelectControl,{label:"Régimen",value:e.hotel_regimen||"",options:[{label:"Seleccionar",value:""},...z],onChange:e=>ce(t,{hotel_regimen:e})})))),(0,a.createElement)("div",{className:"service-card__section"},(0,a.createElement)("div",{className:"service-card__section-title"},"Fechas y ocupación"),(0,a.createElement)("div",{className:"service-card__date-status"},(0,a.createElement)("span",{className:"service-card__date-label "+(e.dates_inherited?"is-inherited":"is-custom")},e.dates_inherited?"Fechas del viaje":"Fechas personalizadas"),!e.dates_inherited&&(0,a.createElement)(l.Button,{variant:"tertiary",className:"service-card__date-reset",onClick:()=>(e=>{ce(e,{start_date:n?.start_date||"",end_date:n?.end_date||"",dates_inherited:!0})})(t)},"Restablecer fechas del viaje")),(0,a.createElement)("div",{className:"service-card__grid service-card__grid--dates"},(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Fecha inicio",type:"date",value:e.start_date,onChange:e=>((e,a)=>{ae(t=>{const l=[...t],r=l[e],i=a||"",s=r.end_date&&i&&r.end_date<i?i:r.end_date;return l[e]=re({...r,start_date:i,end_date:s,dates_inherited:!1},n,g),l}),window.setTimeout(()=>{const a=document.getElementById(`wp-travel-end-date-${e}`);if(a&&(a.focus(),"function"==typeof a.showPicker))try{a.showPicker()}catch(e){}},0)})(t,e),min:O,className:"service-card__date-start"})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{id:`wp-travel-end-date-${t}`,label:"Fecha fin",type:"date",value:e.end_date,onChange:e=>((e,a)=>ce(e,{end_date:a}))(t,e),min:e.start_date||void 0})),"hotel"===e.service_type?(0,a.createElement)(a.Fragment,null,(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Noches",type:"number",min:0,value:String(null!==(r=e.hotel_nights)&&void 0!==r?r:ee(e,n)),onChange:e=>((e,a)=>{const t=J[e].start_date||n?.start_date;if(t){const l=Q(t,W(a,1));ce(e,{end_date:l})}})(t,e)}))):"golf"===e.service_type?(0,a.createElement)(a.Fragment,null,(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Jugadores",type:"number",min:1,value:String(v||_),disabled:!0,help:"Definido en Datos basicos"})),(0,a.createElement)("div",{className:"service-card__field "+(h.greenFees?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"Green-fees por jugador *",type:"number",min:1,value:String(null!==(i=e.green_fees_per_person)&&void 0!==i?i:""),onChange:e=>ce(t,{green_fees_per_person:e})}),h.greenFees&&(0,a.createElement)("div",{className:"service-card__field-error"},h.greenFees)),(0,a.createElement)("div",{className:"service-card__golf-summary"},"Total green-fees (interno): ",W(v||_,1)," x ",W(e.green_fees_per_person,0)," ="," ",W(e.total_green_fees,0))):(0,a.createElement)("div",{className:"service-card__field "+(h.quantity?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"transfer"===e.service_type?"Cantidad (servicios)":"package"===e.service_type?"Cantidad (paquetes)":"Cantidad",type:"number",min:1,value:String(e.quantity),onChange:e=>ce(t,{quantity:e})}),h.quantity&&(0,a.createElement)("div",{className:"service-card__field-error"},h.quantity)))),(0,a.createElement)("div",{className:"service-card__section service-card__section--pricing"},(0,a.createElement)("div",{className:"service-card__section-title"},"Pricing"),h.pricing&&(0,a.createElement)("div",{className:"service-card__field-error service-card__field-error--inline"},h.pricing),"hotel"===e.service_type?(0,a.createElement)(ie,{item:e,idx:t,updateItem:ce,currency:p,pax:_,basics:n,globalMarkupPct:g}):"package"===e.service_type?(0,a.createElement)(oe,{item:e,idx:t,updateItem:ce,currency:p,pax:_,globalMarkupPct:g}):(0,a.createElement)("div",{className:"service-card__pricing"},(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Coste neto (unit.)",value:String(e.unit_cost_net),onChange:e=>ce(t,{unit_cost_net:e}),placeholder:"120"})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.ToggleControl,{label:"Usar margen",checked:!!e.use_markup,onChange:()=>ce(t,{use_markup:!e.use_markup})})),e.use_markup&&(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Margen (%)",type:"number",min:0,value:String(null!==(s=e.markup_pct)&&void 0!==s?s:g),onChange:e=>ce(t,{markup_pct:e})})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.ToggleControl,{label:"PVP manual",checked:!!e.lock_sell_price,onChange:()=>ce(t,{lock_sell_price:!e.lock_sell_price})})),(0,a.createElement)("div",{className:"service-card__field "+(h.unitSell?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"PVP (unit.)",value:String(e.unit_sell_price),onChange:e=>ce(t,{unit_sell_price:e}),placeholder:"165",disabled:!e.lock_sell_price}),h.unitSell&&(0,a.createElement)("div",{className:"service-card__field-error"},h.unitSell)))),"package"===e.service_type&&(0,a.createElement)("div",{className:"service-card__section service-card__section--package"},(0,a.createElement)("div",{className:"service-card__section-title"},"Detalle del paquete"),(0,a.createElement)("div",{className:"service-card__package"},(0,a.createElement)(l.TextareaControl,{label:"Incluye (una línea por ítem)",value:e.package_components_text||"",onChange:e=>ce(t,{package_components_text:e}),rows:4,placeholder:"3 noches\n2 green-fees\nDesayuno incluido"}))),"hotel"!==e.service_type&&(0,a.createElement)("div",{className:"service-card__section service-card__section--notes"},(0,a.createElement)("div",{className:"service-card__section-title"},"Notas"),(0,a.createElement)("details",{className:"service-card__notes-details"},(0,a.createElement)("summary",null,"Mostrar notas"),(0,a.createElement)("div",{className:"service-card__notes"},(0,a.createElement)(l.TextControl,{label:"Notas para el cliente (itinerario)",value:e.notes_public||"",onChange:e=>ce(t,{notes_public:e}),placeholder:"Incluye desayuno. Check-in 15:00."}),(0,a.createElement)(l.TextControl,{label:"Notas internas (solo uso interno)",value:e.notes_internal||"",onChange:e=>ce(t,{notes_internal:e}),placeholder:"Neto negociado, release 14D."}))))))})),(0,a.createElement)("div",{className:"services-add"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>{const e=J.length-1,a=e>=0?ue[e]:null;("error"!==a?.status||window.confirm("Tienes un servicio incompleto. ¿Crear otro igualmente?"))&&ae(e=>{const a=[...e,ne(n,g)],t=a.length-1;return A(t),R(t),a})}},"+ Añadir servicio")),(0,a.createElement)("div",{className:"services-summary"},(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Total viaje"),he(`${p} ${Z(le.totalTrip).toFixed(2)}`,{missing:te.totals_sell_price<=0,tooltip:"Completa servicios para calcular."}),(0,a.createElement)("div",{className:"services-summary__meta"},"Jugadores: ",le.playersCount," | No jugadores: ",le.nonPlayersCount)),le.playersCount>0&&(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Precio jugador en doble"),he(`${p} ${Z(le.pricePlayerDouble||0).toFixed(2)}`,{missing:le.playersCount<=0,tooltip:"Completa jugadores y servicios para calcular."})),le.nonPlayersCount>0&&(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Precio no jugador en doble"),he(`${p} ${Z(le.priceNonPlayerDouble||0).toFixed(2)}`,{missing:le.nonPlayersCount<=0,tooltip:"Completa no jugadores para calcular."})),le.hasSingleSupplement&&(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Suplemento individual"),he(`${p} ${Z(le.supplementSingle||0).toFixed(2)}`,{missing:!le.hasSingleSupplement,tooltip:"Completa habitaciones para calcular."}))),(0,a.createElement)("div",{className:"services-footer"},(f||D&&G.length>0)&&(0,a.createElement)("div",{className:"services-footer__errors"},(0,a.createElement)("div",{className:"services-footer__errors-header"},(0,a.createElement)("span",null,"Error summary"),(0,a.createElement)(l.Button,{variant:"link",onClick:()=>{q.current&&q.current.scrollIntoView({behavior:"smooth",block:"start"})}},"Ver arriba")),f&&(0,a.createElement)("div",{className:"services-footer__errors-message"},f),(0,a.createElement)("ul",null,(G.length>0?G:ge.serviceErrors).slice(0,3).map(e=>(0,a.createElement)("li",{key:e.index},(0,a.createElement)("button",{type:"button",onClick:()=>de(e.index)},e.title,": ",e.details)))),ge.serviceErrors.length>3&&(0,a.createElement)("div",{className:"services-footer__errors-more"},"+",ge.serviceErrors.length-3," más")),(0,a.createElement)("div",{className:"services-footer__bar"},(0,a.createElement)("div",{className:"services-footer__left"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:i},"Volver"),e&&(0,a.createElement)(l.Button,{variant:"secondary",onClick:async()=>{if(e){S(""),k(!0);try{await u(e,n),S("Cambios guardados.")}catch(e){N(e?.message||"Error guardando datos básicos.")}finally{k(!1)}}},disabled:w},"Guardar datos básicos")),(0,a.createElement)("div",{className:"services-footer__summary"},(0,a.createElement)("span",null,"Total viaje"),(0,a.createElement)("strong",null,p," ",Z(le.totalTrip).toFixed(2))),(0,a.createElement)("div",{className:"services-footer__right"},(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>{const{errors:e,serviceErrors:a}=_e();if($(!0),a.length>0||e.length>0){const t=a.length>0?`Faltan datos en ${a.length} servicios. Te llevo al primero.`:e[0];return N(t),F(a),void((e,a)=>{if(e.length>0)de(e[0].index);else if(a.length>0){T(null);const e=document.querySelector(".services-step");e&&(e.scrollIntoView({behavior:"smooth",block:"start"}),ve(e))}})(a,e)}N(""),F([]),T(null),s({items:J,totals:te})},disabled:be&&D,title:be?"Completa los campos obligatorios para continuar.":""},f?"Revisa los campos marcados":"Continuar"))))))}const ue="wp_travel_giav_proposal_id",de=()=>"undefined"!=typeof window&&void 0!==window.sessionStorage;function me(e){const a=parseFloat(e);return Number.isFinite(a)?Math.round(100*(a+Number.EPSILON))/100:0}function pe(e){const a=parseFloat(String(e).replace(",","."));return Number.isFinite(a)?a:0}function _e(e,a=0){const t=parseInt(e,10);return Number.isFinite(t)?t:a}const ve=[{key:"double",capacity:2},{key:"single",capacity:1}];function ge(e,a,t=!1){const l="single"===e?"Habitaciones individuales":"Habitaciones dobles",n=t?`${l} adicionales`:l;return a>0?`${n} (${a} hab.)`:n}function be(e,a,t,l){let n=a;return t>0&&(n+=` — Precio estimado por habitación: ${function(e,a){return`${a||"EUR"} ${me(e).toFixed(2)}`}(t,l)}`),e&&(n=`${e}: ${n}`),n}function he({proposalId:e,basics:n,items:r,totals:i,onBack:o,onSent:c,onProposalCreated:d,mode:m="create",versionNumber:v=1}){const[g,b]=(0,t.useState)(!1),[h,E]=(0,t.useState)(""),[y,f]=(0,t.useState)(""),[N,C]=(0,t.useState)(!1),S="undefined"!=typeof window&&window.CASANOVA_GESTION_RESERVAS?"wp-travel-giav-portal":"wp-travel-giav-admin",w=(0,t.useMemo)(()=>{const e={crm_customer_id:null,first_name:n.first_name,last_name:n.last_name,customer_name:I(n.first_name,n.last_name,n.customer_name),customer_email:n.customer_email,customer_country:n.customer_country,customer_language:n.customer_language,proposal_title:n.proposal_title,start_date:n.start_date,end_date:n.end_date,pax_total:n.pax_total,players_count:n.players_count,currency:n.currency,status:"sent"},a=(r||[]).map((e,a)=>{var t,l,n,r,i,s,o,c,u,d,m,p,_,v,g,b,h,E,y,f,N,C,S,w,k,x,T,I,P,M;return{day_index:null!==(t=e.day_index)&&void 0!==t?t:null,service_type:e.service_type,wp_object_type:null!==(l=e.wp_object_type)&&void 0!==l?l:null,wp_object_id:null!==(n=e.wp_object_id)&&void 0!==n?n:null,giav_entity_type:null!==(r=e.giav_entity_type)&&void 0!==r?r:null,giav_entity_id:null!==(i=e.giav_entity_id)&&void 0!==i?i:null,giav_supplier_id:null!==(s=e.giav_supplier_id)&&void 0!==s?s:null,giav_supplier_name:null!==(o=e.giav_supplier_name)&&void 0!==o?o:null,supplier_source:null!==(c=e.supplier_source)&&void 0!==c?c:null,supplier_resolution_chain:Array.isArray(e.supplier_resolution_chain)?e.supplier_resolution_chain:[],preflight_ok:null!==(u=e.preflight_ok)&&void 0!==u?u:null,warnings:Array.isArray(e.warnings)?e.warnings:[],blocking:Array.isArray(e.blocking)?e.blocking:[],supplier_override:!!e.supplier_override,title:null!==(d=e.title)&&void 0!==d?d:`Item ${a+1}`,display_name:null!==(m=e.display_name)&&void 0!==m?m:null,start_date:e.start_date||null,end_date:e.end_date||null,quantity:null!==(p=e.quantity)&&void 0!==p?p:1,pax_quantity:null!==(_=e.pax_quantity)&&void 0!==_?_:null,hotel_rate_basis:null!==(v=e.hotel_rate_basis)&&void 0!==v?v:null,hotel_nights:null!==(g=e.hotel_nights)&&void 0!==g?g:null,hotel_rooms:null!==(b=e.hotel_rooms)&&void 0!==b?b:null,hotel_room_type:null!==(h=e.hotel_room_type)&&void 0!==h?h:"",hotel_regimen:null!==(E=e.hotel_regimen)&&void 0!==E?E:"",hotel_informative_quote:!!e.hotel_informative_quote,hotel_pricing_mode:null!==(y=null!==(f=e.hotel_pricing_mode)&&void 0!==f?f:e.hotel_rate_mode)&&void 0!==y?y:"simple",nightly_rates:Array.isArray(e.nightly_rates)?e.nightly_rates:Array.isArray(e.hotel_nightly_rates)?e.hotel_nightly_rates:null,room_pricing:null!==(N=e.room_pricing)&&void 0!==N?N:null,discounts:null!==(C=e.discounts)&&void 0!==C?C:null,giav_pricing:null!==(S=e.giav_pricing)&&void 0!==S?S:null,package_components:Array.isArray(e.package_components)?e.package_components:[],package_components_text:null!==(w=e.package_components_text)&&void 0!==w?w:"",green_fees_per_person:null!==(k=e.green_fees_per_person)&&void 0!==k?k:null,number_of_players:null!==(x=e.number_of_players)&&void 0!==x?x:null,total_green_fees:null!==(T=e.total_green_fees)&&void 0!==T?T:null,unit_cost_net:me(e.unit_cost_net),unit_sell_price:me(e.unit_sell_price),line_cost_net:me(e.line_cost_net),line_sell_price:me(e.line_sell_price),use_markup:!!e.use_markup,markup_pct:me(null!==(I=e.markup_pct)&&void 0!==I?I:0),lock_sell_price:!!e.lock_sell_price,notes_public:null!==(P=e.notes_public)&&void 0!==P?P:"",notes_internal:null!==(M=e.notes_internal)&&void 0!==M?M:""}}),t=i||{totals_cost_net:0,totals_sell_price:0,totals_margin_abs:0,totals_margin_pct:0};return{header:e,items:a,totals:{totals_cost_net:me(t.totals_cost_net),totals_sell_price:me(t.totals_sell_price),totals_margin_abs:me(t.totals_margin_abs),totals_margin_pct:me(t.totals_margin_pct)},template_id:null,terms_version:null,metadata:{created_at:(new Date).toISOString(),created_by:null,source:S,schema_version:"v2"}}},[n,r,i]),k=w?.header||{},x=I(k.first_name,k.last_name,k.customer_name),T=w?.totals||{},P=Array.isArray(w?.items)?w.items:[],M=(0,t.useMemo)(()=>{let e=0,a=0;return P.forEach(t=>{const l=Array.isArray(t?.warnings)?t.warnings:[],n=Array.isArray(t?.blocking)?t.blocking:[];e+=l.length,a+=n.length}),{warningCount:e,blockingCount:a}},[P]),A=M.blockingCount>0?"error":M.warningCount>0?"warning":"success",B=M.blockingCount>0?`Hay ${M.blockingCount} servicios con errores`:M.warningCount>0?`Hay ${M.warningCount} avisos en servicios`:"Servicios listos para enviar",R=(0,t.useMemo)(()=>{var e,a,t;const l=Math.max(0,_e(null!==(e=k?.pax_total)&&void 0!==e?e:0,0)),n=_e(null!==(a=null!==(t=k?.players_count)&&void 0!==t?t:l)&&void 0!==a?a:0,0),r=Math.min(Math.max(n,0),l),i={paxTotal:l,playersCount:r,nonPlayersCount:Math.max(0,l-r),golfTotal:0,totalDouble:0,totalSingle:0,doubleRooms:0,singleRooms:0};P.forEach(e=>{if("golf"===e.service_type&&(i.golfTotal+=pe(e.line_sell_price||0)),"hotel"===e.service_type){const l=e.room_pricing||{};var a,t;l.double?.enabled&&(i.totalDouble+=pe(l.double?.total_pvp||0),i.doubleRooms+=Math.max(0,_e(null!==(a=l.double?.rooms)&&void 0!==a?a:0,0))),l.single?.enabled&&(i.totalSingle+=pe(l.single?.total_pvp||0),i.singleRooms+=Math.max(0,_e(null!==(t=l.single?.rooms)&&void 0!==t?t:0,0)))}});const s=pe(T?.totals_sell_price||0),o=s,c=i.doubleRooms>0?i.totalDouble/(2*i.doubleRooms):0,u=i.singleRooms>0?i.totalSingle/i.singleRooms:0,d=s-(i.totalDouble+i.totalSingle)-i.golfTotal,m=i.paxTotal>0?d/i.paxTotal:0,p=i.doubleRooms>0?"double":i.singleRooms>0?"single":"double",_=("double"===p?c:u)+m,v=i.playersCount>0?_+i.golfTotal/i.playersCount:null,g=i.doubleRooms>0&&i.singleRooms>0;let b=null;return g&&(b=Math.max(0,u-c)),{...i,totalTrip:s,baseTotal:o,baseRoomType:p,priceNonPlayerBase:_,pricePlayerBase:v,supplementSingle:b,hasSingleSupplement:g}},[k?.pax_total,k?.players_count,P,T?.totals_sell_price]),{includeRoomLines:D,informativeExtras:$}=(0,t.useMemo)(()=>{const e=[],a=[],t=Math.max(0,R.paxTotal),l=k.currency||"EUR";return P.forEach((n,r)=>{if("hotel"!==n.service_type)return;const i=n.display_name||n.title||"Alojamiento",s=function(e={},a=0){let t=Math.max(0,a);const l={types:{},hasExtra:!1};return ve.forEach(({key:a,capacity:n})=>{var r,i;const s=e[a]||{},o=Boolean(s.enabled)?Math.max(0,_e(null!==(r=s.rooms)&&void 0!==r?r:0,0)):0,c=pe(null!==(i=s.total_pvp)&&void 0!==i?i:0),u=o>0?c/o:0;let d=0,m=0;for(let e=0;e<o;e+=1)t>0?(d+=1,t-=n):m+=1;m>0&&(l.hasExtra=!0),l.types[a]={rooms:o,needed:d,extra:m,capacity:n,perRoomPrice:u,totalPvp:c}}),l}(n.room_pricing||{},t),o=s.types.double||{needed:0,extra:0,rooms:0,perRoomPrice:0},c=s.types.single||{needed:0,extra:0,rooms:0,perRoomPrice:0},u=(a,t)=>{e.push({key:`${r}-${a}`,text:i?`${i} · ${t}`:t})};n.hotel_informative_quote?(o.needed>0&&u("double-needed",ge("double",o.needed)),c.needed>0&&u("single-needed",ge("single",c.needed)),s.hasExtra&&(o.extra>0&&a.push({key:`${r}-double-extra`,text:be(i,ge("double",o.extra,!0),o.perRoomPrice,l)}),c.extra>0&&a.push({key:`${r}-single-extra`,text:be(i,ge("single",c.extra,!0),c.perRoomPrice,l)}))):(o.rooms>0&&u("double-total",ge("double",o.rooms)),c.rooms>0&&u("single-total",ge("single",c.rooms)))}),{includeRoomLines:e,informativeExtras:a}},[P,R.paxTotal,k.currency]),G=Boolean(k.customer_email),F="edit"===m?"Guardar nueva versión":G?"Compartir propuesta":"Crear enlace público",q=()=>{const a=e&&Number(e)>0?Number(e):null;if(a)return a;const t=(()=>{try{const e=window.location.search||"";if(!e)return null;const a=new URLSearchParams(e),t=["proposal_id","id","proposalId","proposalId"];for(let e of t){const t=a.get(e);if(t){const e=parseInt(t,10);if(Number.isFinite(e)&&e>0)return e}}}catch(e){}return null})();if(t)return t;return function(){if(!de())return null;const e=window.sessionStorage.getItem(ue);if(!e)return null;const a=parseInt(e,10);return Number.isFinite(a)&&a>0?a:null}()||null},V=e=>{const a=String(e||"es").trim();if(!a)return"es";const t=a.split(/[-_]/)[0]||a;return t?t.slice(0,2):"es"},U=async()=>{const e=q();if(e&&Number.isFinite(e)&&e>0)return e;if(!n)return null;const a=(()=>{var e,a;const t=I(n.first_name,n.last_name,n.customer_name);return{...n,customer_name:t,customer_language:V(n.customer_language),pax_total:Math.max(1,_e(null!==(e=n.pax_total)&&void 0!==e?e:1,1)),players_count:Math.max(0,_e(null!==(a=n.players_count)&&void 0!==a?a:0,0)),customer_country:n.customer_country?String(n.customer_country).toUpperCase():""}})(),t=await s(a),l=Number(t?.proposal_id||0);return l>0?(d?.({proposalId:l,basics:a}),l):null},j=async()=>{b(!0),E("");const e=await U();try{"undefined"!=typeof process&&process&&process.env}catch(e){}if(!e||Number(e)<=0)return b(!1),void E("No se pudo continuar: falta el identificador de propuesta válido (proposalId).");try{const a=await _(e,w,v);c({versionId:a.version_id,publicToken:a.public_token,publicUrl:a.public_url,status:a.status,snapshot:w})}catch(e){E(e?.message||"Error guardando la versión.")}finally{b(!1)}},L=async()=>{b(!0),E("");const e=await U();if(!e||Number(e)<=0)return b(!1),void E("No se pudo compartir: falta el identificador de propuesta válido (proposalId).");if(window.confirm("¿Marcar como enviada y generar enlace público? (Esto no envía emails automáticamente)"))try{const a=await p(e,w,v);c({versionId:a.version_id,publicToken:a.public_token,publicUrl:a.public_url,status:a.status||"sent",snapshot:w})}catch(e){E(e?.message||"Error compartiendo la propuesta.")}finally{b(!1)}else b(!1)};return(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Preview y envío")),(0,a.createElement)(l.CardBody,null,y&&(0,a.createElement)(l.Notice,{status:"success",isDismissible:!0,onRemove:()=>f("")},y),h&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>E("")},h),(0,a.createElement)(l.Notice,{status:A,isDismissible:!1},B),(0,a.createElement)(l.Notice,{status:"info",isDismissible:!1},"El cliente vera solo el total del paquete. El desglose por lineas queda guardado internamente en la version."),(0,a.createElement)("div",{className:"proposal-preview"},(0,a.createElement)("div",{className:"proposal-preview__header"},(0,a.createElement)("div",{className:"proposal-preview__name"},x||"—"),(0,a.createElement)("div",{className:"proposal-preview__meta"},k.start_date," - ",k.end_date," | Pax: ",k.pax_total," | Moneda: ",k.currency)),(0,a.createElement)("div",{className:"proposal-preview__includes"},(0,a.createElement)("div",{className:"proposal-preview__includes-title"},"Incluye"),D.length>0&&(0,a.createElement)("div",{className:"proposal-preview__includes-lines"},D.map(e=>(0,a.createElement)("div",{key:e.key,className:"proposal-preview__includes-line"},e.text))),(0,a.createElement)("div",{className:"preview-items"},P.map((e,t)=>{const l=Array.isArray(e?.warnings)?e.warnings:[],n=Array.isArray(e?.blocking)?e.blocking:[],r=e.display_name||e.title||`Item ${t+1}`,i=e.giav_supplier_name||"Proveedor no especificado",s=n.length>0,o=l.length>0;return(0,a.createElement)("div",{key:t,className:"preview-item"},(0,a.createElement)("div",{className:"preview-item__main"},(0,a.createElement)("div",{className:"preview-item__title"},(0,a.createElement)("strong",null,e.service_type?.toUpperCase())," - ",r),(0,a.createElement)("div",{className:"preview-item__supplier"},"Proveedor: ",i),"hotel"===e.service_type&&e.hotel_room_type?(0,a.createElement)("div",{className:"preview-item__meta"},"Habitacion: ",e.hotel_room_type):null,"package"===e.service_type&&e.package_components_text?(0,a.createElement)("div",{className:"preview-item__meta"},"Incluye: ",e.package_components_text.split("\n").filter(Boolean).join(", ")):null,"package"===e.service_type&&"per_person"===(e.package_pricing_basis||"per_person")?((t,l,n,r,i,s)=>{const o=k.currency||"EUR";if("per_room"==("per_room"===e.package_pricing_basis?"per_room":"per_person")){var c,u,d,m,p,_;const t=pe(null!==(c=null!==(u=e.package_room_double)&&void 0!==u?u:e.unit_sell_price)&&void 0!==c?c:0),l="supplement"===e.package_single_room_mode?"supplement":"price",n=pe(null!==(d=null!==(m=e.package_room_single)&&void 0!==m?m:e.unit_sell_price_single_room)&&void 0!==d?d:0),r=pe(null!==(p=null!==(_=e.package_room_single_supplement)&&void 0!==_?_:e.package_single_room_supplement_sell)&&void 0!==p?p:0),i=n>0||"supplement"===l&&r>0;return(0,a.createElement)("div",{className:"preview-item__meta"},"Precio paquete por habitación (doble): ",o," ",me(t).toFixed(2),i&&(0,a.createElement)(a.Fragment,null," · ","supplement"===l?`Suplemento habitación individual: ${o} ${me(r).toFixed(2)}`:`Precio habitación individual: ${o} ${me(n).toFixed(2)}`))}const v=pe(null!==(t=null!==(l=e.package_pp_double)&&void 0!==l?l:e.unit_sell_price)&&void 0!==t?t:0),g="supplement"===e.package_individual_mode?"supplement":"price",b=pe(null!==(n=null!==(r=e.package_single_supplement)&&void 0!==r?r:e.package_single_supplement_sell)&&void 0!==n?n:0),h="supplement"===g?v+b:pe(null!==(i=null!==(s=e.package_pp_single)&&void 0!==s?s:e.unit_sell_price_individual)&&void 0!==i?i:0),E=h>0&&("supplement"!==g||b>=0),y=E?Math.max(0,h-v):null;return(0,a.createElement)("div",{className:"preview-item__meta"},"Precio paquete por persona (doble): ",o," ",me(v).toFixed(2),E&&(0,a.createElement)(a.Fragment,null," · ","supplement"===g?`Suplemento individual: ${o} ${me(y||0).toFixed(2)}`:`Precio en individual: ${o} ${me(h).toFixed(2)}`))})():null,s&&(0,a.createElement)("div",{className:"preview-item__blocking"},(0,a.createElement)("span",{className:"preview-item__badge preview-item__badge--error"},"Error"),"Este servicio impide la confirmacion."),s&&(0,a.createElement)("details",{className:"preview-item__details"},(0,a.createElement)("summary",null,"Ver motivos"),(0,a.createElement)("ul",null,n.map((e,t)=>(0,a.createElement)("li",{key:t},e?.message||"Revision requerida")))),o&&(0,a.createElement)("details",{className:"preview-item__details"},(0,a.createElement)("summary",null,(0,a.createElement)("span",{className:"preview-item__badge preview-item__badge--warning"},"Aviso"),"Ver avisos (",l.length,")"),(0,a.createElement)("ul",null,l.map((e,t)=>(0,a.createElement)("li",{key:t},e?.message||"Aviso"))))))})),$.length>0&&(0,a.createElement)("div",{className:"proposal-preview__informative-block"},(0,a.createElement)("div",{className:"proposal-preview__informative-title"},"Cotización informativa"),(0,a.createElement)("div",{className:"proposal-preview__informative-lines"},$.map(e=>(0,a.createElement)("div",{key:e.key,className:"proposal-preview__informative-line"},e.text))))),(0,a.createElement)("div",{className:"proposal-preview__totals"},(0,a.createElement)("div",{className:"proposal-preview__totals-label"},"Total viaje"),(0,a.createElement)("div",{className:"proposal-preview__totals-value"},k.currency," ",me(R.totalTrip).toFixed(2)),R.playersCount>0&&(0,a.createElement)("div",{className:"proposal-preview__totals-line"},"Precio jugador en ","single"===R.baseRoomType?"individual":"doble",": ",k.currency," ",me(R.pricePlayerBase||0).toFixed(2)),(0,a.createElement)("div",{className:"proposal-preview__totals-line"},"Precio no jugador en ","single"===R.baseRoomType?"individual":"doble",": ",k.currency," ",me(R.priceNonPlayerBase||0).toFixed(2)),R.hasSingleSupplement&&(0,a.createElement)("div",{className:"proposal-preview__totals-line"},"Suplemento individual: ",k.currency," ",me(R.supplementSingle||0).toFixed(2)),(0,a.createElement)("div",{className:"proposal-preview__totals-note"},R.hasSingleSupplement?"Precios por persona. El suplemento individual aplica por persona alojada en habitación individual.":"single"===R.baseRoomType?"Precios por persona en habitación individual.":"Precios por persona en habitación doble."))),(0,a.createElement)("div",{className:"proposal-preview__actions"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:o,disabled:g},"Volver"),q()&&(0,a.createElement)(l.Button,{variant:"secondary",onClick:async()=>{const e=q();if(e){f(""),C(!0);try{await u(e,n||{}),f("Cambios guardados.")}catch(e){E(e?.message||"Error guardando datos básicos.")}finally{C(!1)}}},disabled:g||N},"Guardar datos básicos"),"edit"===m?(0,a.createElement)(a.Fragment,null,(0,a.createElement)(l.Button,{variant:"secondary",onClick:j,disabled:g},"Guardar nueva versión"),(0,a.createElement)(l.Button,{variant:"primary",onClick:L,disabled:g},"Compartir propuesta")):(0,a.createElement)(a.Fragment,null,G&&(0,a.createElement)(l.Button,{variant:"secondary",onClick:j,disabled:g},"Guardar borrador"),(0,a.createElement)(l.Button,{variant:"primary",onClick:G?L:j,disabled:g},F)),g&&(0,a.createElement)(l.Spinner,null))))}const Ee={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",queued:"En cola",synced:"Sincronizada",error:"Error",revoked:"Revocada",lost:"Perdida"},ye=e=>{const a=String(e||"").trim();return a?"es"===a?"es_ES":"en"===a?"en_US":a:"es_ES"},fe=e=>{if(!e)return"-";const a=String(e),t=a.includes("T")?a:a.replace(" ","T"),l=new Date(t);return Number.isNaN(l.getTime())?e:new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short"}).format(l)};function Ne({onExit:e,mode:n="create",initialProposal:r=null,initialSnapshot:i=null,nextVersionNumber:s=1,showStepper:o=!1}){const[c,u]=(0,t.useState)(1),[d,m]=(0,t.useState)(r?.id||null),[p,_]=(0,t.useState)(r?.status||"draft"),[v]=(0,t.useState)(r?.accepted_at||""),[g]=(0,t.useState)(r?.proposal_token||""),[b,h]=(0,t.useState)(r?.public_url||""),[E,y]=(0,t.useState)(null),[f,N]=(0,t.useState)(!1),C="undefined"!=typeof window&&!!window.CASANOVA_GESTION_RESERVAS,S=(0,t.useMemo)(()=>{if(!r&&!i)return null;const e=i?.header||{},a=e.customer_name||"",t=r?.customer_name||"",l=P(a),n=P(t),s=(e.first_name||l.firstName,e.last_name||l.lastName,e.first_name||r?.first_name||l.firstName||n.firstName||""),o=e.last_name||r?.last_name||l.lastName||n.lastName||"";return{proposal_title:e.proposal_title||r?.proposal_title||"",first_name:s,last_name:o,customer_name:I(s,o,e.customer_name||r?.customer_name||""),customer_email:e.customer_email||r?.customer_email||"",customer_country:e.customer_country||r?.customer_country||"",customer_language:ye(e.customer_language||r?.customer_language||"es_ES"),start_date:e.start_date||r?.start_date||"",end_date:e.end_date||r?.end_date||"",pax_total:e.pax_total||r?.pax_total||1,currency:e.currency||r?.currency||"EUR"}},[r,i]),[w,k]=(0,t.useState)(S),x=(0,t.useMemo)(()=>{const e=r?.source_meta_json;if(e)try{const a=JSON.parse(e);if(a?.intentions)return a.intentions}catch(e){}return i?.intentions||null},[r?.source_meta_json,i?.intentions]),[T,M]=(0,t.useState)(i?.items||[]),[A,B]=(0,t.useState)(i?.totals||null),[R,D]=(0,t.useState)(null),[$,G]=(0,t.useState)(null);(0,t.useEffect)(()=>{var e;e=d,de()&&(e&&Number.isFinite(e)&&e>0?window.sessionStorage.setItem(ue,String(Math.floor(e))):window.sessionStorage.removeItem(ue))},[d]),(0,t.useEffect)(()=>()=>{de()&&window.sessionStorage.removeItem(ue)},[]);let F=null;if(1===c)F=(0,a.createElement)(q,{initialValues:w||{customer_language:"es_ES",currency:"EUR",pax_total:1},onNext:({basics:e})=>{k(e),M(a=>se(a,e)),u(2)},onCreated:({proposalId:e,basics:a})=>{m(e),k(a),M(e=>se(e,a)),u(2)},proposalId:d});else if(2===c)F=(0,a.createElement)(ce,{proposalId:d,basics:w,initialItems:T,onDraftChange:({items:e,totals:a})=>{M(e),B(a)},onBack:()=>u(1),onNext:({items:e,totals:a})=>{M(e),B(a),u(3)},requestIntentions:x});else if(3===c)F=(0,a.createElement)(he,{proposalId:d,basics:w,items:T,totals:A,mode:n,versionNumber:s,onBack:()=>u(2),onSent:({versionId:e,snapshot:a,publicUrl:t,publicToken:l,status:n})=>{G(e),D(a||null),t&&h(t),l&&y(l),n&&_(n),u(4)},onProposalCreated:({proposalId:e,basics:a})=>{e&&Number.isFinite(e)&&m(e),a&&k(a)}});else if(4===c){const t=b||((e,a)=>{if(!e)return"";const t=`${window.location.origin}/travel-proposal/${e}/`;return a?`${window.location.origin}/travel-proposal/${e}/v/${a}/`:t})(g,E),r=Ee[p]||p||"-",i=v?`Aceptada el ${fe(v)}`:"Pendiente",s=(({email:e,name:a,publicUrl:t})=>{if(!e||!t)return"";const l=`${a?`Hola ${a},`:"Hola,"}\n\nAquí tienes el enlace a tu propuesta:\n${t}\n\nQuedamos a tu disposición para cualquier duda.`;return`mailto:${e}?subject=${encodeURIComponent("Tu propuesta de viaje")}&body=${encodeURIComponent(l)}`})({email:w?.customer_email,name:w?.customer_name,publicUrl:t}),o=(e=>{if("undefined"==typeof window)return"";const a=window.CASANOVA_GESTION_RESERVAS;return a?.pageBase&&e?`${a.pageBase.replace(/\/$/,"")}#/propuesta/${e}`:""})(d)||((e={})=>{const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.delete("proposal_id"),a.searchParams.delete("action"),Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t?a.searchParams.set(e,t):a.searchParams.delete(e)}),a.toString()})({proposal_id:d}),c=C?"Ver detalle en portal":"Ir al repositorio / ver detalle",u=async()=>{await async function(e){if(!e)return!1;try{if(navigator.clipboard?.writeText)return await navigator.clipboard.writeText(e),!0}catch(e){}const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.top="-1000px",document.body.appendChild(a),a.focus(),a.select();const t=document.execCommand("copy");return document.body.removeChild(a),t}(t)&&(N(!0),window.setTimeout(()=>N(!1),1500))};F=(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Preview y compartir")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)(l.Notice,{status:"success",isDismissible:!1},"edit"===n?"Nueva versión creada:":"Propuesta compartida (marcada como enviada). Versión creada:"," ",(0,a.createElement)("strong",null,$)),"accepted"===p&&v?(0,a.createElement)(l.Notice,{status:"info",isDismissible:!1},"Aceptada el ",fe(v),"."):null,(0,a.createElement)("div",{className:"proposal-wizard__final-meta"},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Estado:")," ",r),(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Aceptacion:")," ",i),(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"GIAV:")," El expediente se creara tras la aceptacion del cliente.")),(0,a.createElement)("div",{className:"proposal-wizard__final-actions"},"accepted"!==p?(0,a.createElement)(l.Button,{variant:"primary",onClick:u,disabled:!t},f?"Enlace copiado":"Copiar enlace publico"):null,s?(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.location.assign(s)},"Preparar email al cliente"):null,t?(0,a.createElement)(l.Button,{variant:"link",href:t,target:"_blank",rel:"noopener noreferrer"},"Abrir vista publica"):null,o?(0,a.createElement)(l.Button,{variant:"link",href:o},c):null,(0,a.createElement)(l.Button,{variant:"tertiary",onClick:e},"Salir"))))}if(!F)return null;if(!o)return F;const V=c>3?3:c;return(0,a.createElement)("div",{className:"proposal-wizard"},(0,a.createElement)("div",{className:"proposal-wizard__stepper"},[{title:"Datos basicos",subtitle:"Identidad y fechas"},{title:"Servicios y precios",subtitle:"Hotel, golf y extras"},{title:"Vista previa y envio",subtitle:"Resumen final"}].map((e,t)=>{const l=t+1,n=V===l?"is-active":V>l?"is-complete":"is-upcoming";return(0,a.createElement)("div",{key:e.title,className:`proposal-wizard__step ${n}`.trim()},(0,a.createElement)("div",{className:"proposal-wizard__step-index"},l),(0,a.createElement)("div",{className:"proposal-wizard__step-text"},(0,a.createElement)("div",{className:"proposal-wizard__step-title"},e.title),(0,a.createElement)("div",{className:"proposal-wizard__step-subtitle"},e.subtitle)))})),(0,a.createElement)("div",{className:"proposal-wizard__content"},F))}function Ce({selectedId:e,selectedLabel:n,onPick:r,disabled:i}){const[s,o]=(0,t.useState)(n||""),[c,u]=(0,t.useState)([]),[d,m]=(0,t.useState)(!1),[p,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(""),b=(0,t.useRef)(null);(0,t.useEffect)(()=>{(n||"")!==s&&n&&o(n)},[n]);const h=e?"Seleccionado: "+(n?`${n} (#${e})`:`#${e}`):"Se valida en GIAV al guardar (Proveedor_GET).";return(0,a.createElement)("div",{style:{position:"relative"}},(0,a.createElement)(l.TextControl,{value:s,onChange:function(e){o(e),clearTimeout(b.current),b.current=setTimeout(()=>async function(e){const a=(e||"").trim();if(a.length<2)return u([]),g(""),void m(!1);_(!0),g("");try{const e=await w({q:a,pageSize:20,pageIndex:0,includeDisabled:!1}),t=(Array.isArray(e)?e:Array.isArray(e?.items)?e.items:[]).map(e=>{var a,t,l,n,r,i,s,o;return{id:String(null!==(a=null!==(t=null!==(l=null!==(n=e.id)&&void 0!==n?n:e.ID)&&void 0!==l?l:e.Id)&&void 0!==t?t:e.proveedorId)&&void 0!==a?a:""),label:String(null!==(r=null!==(i=null!==(s=null!==(o=e.label)&&void 0!==o?o:e.NombreAlias)&&void 0!==s?s:e.Nombre)&&void 0!==i?i:e.title)&&void 0!==r?r:"")}}).filter(e=>e.id&&e.label);u(t),m(t.length>0)}catch(e){g(e?.message||"No se pudo buscar en GIAV."),u([]),m(!1)}finally{_(!1)}}(e),250)},onFocus:()=>{c.length>0&&m(!0)},placeholder:"Busca por nombre (mín. 2 letras)…",disabled:i,help:h}),p&&(0,a.createElement)("div",{style:{marginTop:6}},(0,a.createElement)(l.Spinner,null)),v&&(0,a.createElement)("div",{style:{marginTop:6,color:"#b32d2e",fontSize:12}},v),d&&c.length>0&&(0,a.createElement)("div",{style:{position:"absolute",zIndex:30,left:0,right:0,top:"100%",background:"#fff",border:"1px solid #ddd",borderTop:"none",maxHeight:260,overflow:"auto"}},c.map(e=>(0,a.createElement)("div",{key:e.id,onMouseDown:a=>{a.preventDefault(),function(e){o(e.label),u([]),m(!1),g(""),r?.(e)}(e)},style:{padding:"10px 12px",cursor:"pointer",borderBottom:"1px solid #f0f0f0"}},(0,a.createElement)("div",{style:{fontWeight:600}},e.label),(0,a.createElement)("div",{style:{fontSize:12,opacity:.75}},"ID: ",e.id)))))}function Se({status:e}){let t="⚠️ missing";return"active"===e&&(t="✅ active"),"needs_review"===e&&(t="🟠 needs_review"),"deprecated"===e&&(t="⛔ deprecated"),(0,a.createElement)("span",{style:{whiteSpace:"nowrap"}},t)}const we="1734698";function ke(){const[e,n]=(0,t.useState)("hotel"),[r,i]=(0,t.useState)(""),[s,o]=(0,t.useState)(!1),[c,u]=(0,t.useState)(null),[d,m]=(0,t.useState)({items:[],total:0}),[p,_]=(0,t.useState)(50),[v,g]=(0,t.useState)(0),[b,h]=(0,t.useState)({}),[E,C]=(0,t.useState)(null),[S,w]=(0,t.useState)({}),[k,x]=(0,t.useState)({id:"",label:""}),[T,I]=(0,t.useState)(!1),[P,M]=(0,t.useState)(!1),A=(0,t.useMemo)(()=>d.items||[],[d]),B=(0,t.useMemo)(()=>Object.keys(S).filter(e=>S[e]),[S]),R=(0,t.useMemo)(()=>A.length>0&&A.every(e=>S[j(e)]),[A,S]),D=(0,t.useMemo)(()=>A.reduce((e,a)=>{const t=j(a),l=b[t];return l?.providerId&&e.push({key:t,row:a,edit:l}),e},[]),[A,b]),$=D.length,G=Number(d?.total||0),F=(G>0&&Math.ceil(G/p),0===G?0:v*p+1),q=0===G?0:Math.min(G,(v+1)*p),V=v>0,U=G>0&&(v+1)*p<G;function j(e){return`${e.wp_object_type}:${e.wp_object_id}`}function L(e){var a,t,l;const n=j(e),r=b[n]||{},i=e.mapping||{status:"missing"};return{providerId:null!==(a=r.providerId)&&void 0!==a?a:i.giav_entity_id?String(i.giav_entity_id):"",providerName:null!==(t=r.providerName)&&void 0!==t?t:i.giav_supplier_name?String(i.giav_supplier_name):"",status:null!==(l=r.status)&&void 0!==l?l:i.status||"missing"}}async function O({silent:a=!1,pageIndexOverride:t}={}){o(!0),a||u(null);try{const a=(Number.isInteger(t)?t:v)*p,l=await y({type:e,q:r,limit:p,offset:a});return m(l||{items:[],total:0}),{ok:!0}}catch(e){return a||u({status:"error",message:e?.message||"No se pudo cargar el mapeo."}),m({items:[],total:0}),{ok:!1,error:e}}finally{o(!1)}}return(0,t.useEffect)(()=>{g(0),O({pageIndexOverride:0})},[e]),(0,a.createElement)("div",{style:{maxWidth:1100,margin:"24px auto"}},(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"GIAV Mapping")),(0,a.createElement)(l.CardBody,null,c&&(0,a.createElement)(l.Notice,{status:c.status,isDismissible:!0,onRemove:()=>u(null)},c.message),(0,a.createElement)("div",{style:{display:"flex",gap:12,alignItems:"flex-end",marginBottom:12}},(0,a.createElement)(l.SelectControl,{label:"Tipo",value:e,options:[{label:"Hoteles",value:"hotel"},{label:"Campos",value:"golf"}],onChange:e=>n(e)}),(0,a.createElement)(l.TextControl,{label:"Buscar",value:r,onChange:e=>{i(e),g(0)},placeholder:"hotel"===e?"Nombre del hotel…":"Nombre del campo…"}),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>O(),disabled:s},s?(0,a.createElement)(l.Spinner,null):"Actualizar")),(0,a.createElement)("div",{style:{display:"flex",gap:12,alignItems:"flex-end",marginBottom:12,justifyContent:"space-between"}},(0,a.createElement)(l.SelectControl,{label:"Por página",value:String(p),options:[{label:"25",value:"25"},{label:"50",value:"50"},{label:"100",value:"100"},{label:"200",value:"200"}],onChange:e=>{const a=Math.max(1,Math.min(200,parseInt(e,10)||50));_(a),g(0),O({pageIndexOverride:0})}}),(0,a.createElement)("div",{style:{display:"flex",gap:8,alignItems:"flex-end"}},(0,a.createElement)("div",{style:{fontSize:12,opacity:.8,marginBottom:6}},G>0?`Mostrando ${F}–${q} de ${G}`:"Sin resultados"),(0,a.createElement)(l.Button,{variant:"secondary",disabled:s||!V,onClick:()=>{const e=Math.max(0,v-1);g(e),O({pageIndexOverride:e})}},"←"),(0,a.createElement)(l.Button,{variant:"secondary",disabled:s||!U,onClick:()=>{const e=v+1;g(e),O({pageIndexOverride:e})}},"→"))),(0,a.createElement)("div",{style:{display:"flex",gap:12,alignItems:"flex-end",marginBottom:12}},(0,a.createElement)("div",{style:{flex:1}},(0,a.createElement)("label",{style:{display:"block",fontSize:12,marginBottom:4,opacity:.8}},"Aplicar proveedor a seleccionados"),(0,a.createElement)(Ce,{selectedId:k?.id,selectedLabel:k?.label,disabled:T,onPick:({id:e,label:a})=>x({id:e,label:a})})),(0,a.createElement)(l.Button,{variant:"primary",onClick:async function(){const a="hotel"===e?"hotel":"course",t=B;if(k?.id)if(0!==t.length){I(!0),u(null);try{var l,n;const e=t.map(e=>{const a=String(e).split(":");return{wp_object_id:parseInt(a[1],10)}}).filter(e=>e.wp_object_id>0),r=await N({wp_object_type:a,giav_supplier_id:String(k.id),items:e,status:"active",match_type:"batch"}),i=`Mapeo en lote aplicado. Creados: ${null!==(l=r?.created)&&void 0!==l?l:0}, actualizados: ${null!==(n=r?.updated)&&void 0!==n?n:0}${r?.errors?.length?`, errores: ${r.errors.length}`:""}.`;u({status:!1===r?.ok?"warning":"success",message:i}),w({}),await O()}catch(e){u({status:"error",message:e?.message||"No se pudo aplicar el mapeo en lote."})}finally{I(!1)}}else u({status:"warning",message:"Selecciona al menos una fila para aplicar el mapeo en lote."});else u({status:"warning",message:"Selecciona un proveedor para aplicar en lote."})},isBusy:T,disabled:T},"Aplicar en lote (",B.length,")"),(0,a.createElement)(l.Button,{variant:"secondary",onClick:async function(){if(0===$)return void u({status:"warning",message:"Asigna al menos un proveedor antes de guardar."});M(!0),u(null);const e=[],a=[];try{for(const{key:t,row:l,edit:n}of D){const r=String(n.providerId)===we;try{await f({wp_object_type:l.wp_object_type,wp_object_id:l.wp_object_id,giav_entity_type:"supplier",giav_entity_id:String(n.providerId),giav_supplier_id:String(n.providerId),giav_supplier_name:n.providerName||null,status:r?"needs_review":"active",match_type:r?"auto_generic":"manual"}),e.push(t)}catch(e){const n=l.title||`${l.wp_object_type} #${l.wp_object_id}`;a.push({key:t,title:n,message:e?.message||"No se pudo guardar el mapeo."})}}h(a=>{const t={...a};return e.forEach(e=>{delete t[e]}),t});const t=await O({silent:!0}),l=e.length,n=a.length;let r;const i=[];if(0===n?(r="success",i.push(`Guardado de ${l} fila${1===l?"":"s"} completado.`)):0===l?(r="error",i.push("No se pudo guardar ninguna fila.")):(r="warning",i.push(`Guardado parcial: ${l} OK, ${n} error(es).`)),n>0){const e=a.map(e=>e.title).join(", ");i.push(`Errores: ${e}.`)}if(!t.ok){const e=t.error?.message?`: ${t.error.message}`:" después del guardado";i.push(`Falló la recarga${e}.`),"success"===r&&(r="warning")}u({status:r,message:i.join(" ")})}catch(e){u({status:"error",message:e?.message||"No se pudieron guardar las asignaciones."})}finally{M(!1)}},isBusy:P,disabled:P||0===$},"Guardar asignaciones (",$,")")),(0,a.createElement)("div",{style:{overflowX:"auto"}},(0,a.createElement)("table",{className:"widefat striped"},(0,a.createElement)("thead",null,(0,a.createElement)("tr",null,(0,a.createElement)("th",{style:{width:30}},(0,a.createElement)("input",{type:"checkbox",checked:R,onChange:e=>function(e){const a={};A.forEach(t=>{a[j(t)]=!!e}),w(a)}(e.target.checked)})),(0,a.createElement)("th",null,"Objeto"),(0,a.createElement)("th",null,"Estado"),(0,a.createElement)("th",null,"Proveedor (GIAV)"),(0,a.createElement)("th",null,"Acción"))),(0,a.createElement)("tbody",null,s&&(0,a.createElement)("tr",null,(0,a.createElement)("td",{colSpan:"4",style:{padding:16,textAlign:"center"}},(0,a.createElement)(l.Spinner,null))),!s&&A.map(e=>{const t=j(e),n=L(e);return(0,a.createElement)("tr",{key:t},(0,a.createElement)("td",null,(0,a.createElement)("input",{type:"checkbox",checked:!!S[t],onChange:a=>function(e,a){const t=j(e);w(e=>({...e,[t]:!!a}))}(e,a.target.checked)})),(0,a.createElement)("td",null,(0,a.createElement)("div",{style:{fontWeight:600}},e.title),(0,a.createElement)("div",{style:{opacity:.7,fontSize:12}},e.wp_object_type," #",e.wp_object_id)),(0,a.createElement)("td",null,(0,a.createElement)(Se,{status:e.mapping?.status||"missing"})),(0,a.createElement)("td",null,(0,a.createElement)(Ce,{selectedId:n.providerId,selectedLabel:n.providerName||e.mapping?.giav_supplier_name||"",disabled:E&&E!==t,onPick:({id:a,label:t})=>function(e,a){const t=j(e);h(e=>({...e,[t]:{...e[t]||{},...a}}))}(e,{providerId:a,providerName:t,status:"active"})}),e.mapping?.giav_entity_id&&(0,a.createElement)("div",{style:{opacity:.7,fontSize:12,marginTop:4}},"Actual: #",e.mapping.giav_entity_id," ",e.mapping?.giav_supplier_name?(0,a.createElement)("span",null,"(",e.mapping.giav_supplier_name,")"):null," ","(",e.mapping.status,")")),(0,a.createElement)("td",null,(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>async function(e){const a=j(e),t=L(e);if(!t.providerId)return void u({status:"warning",message:"Selecciona un proveedor de GIAV."});C(a),u(null);const l=String(t.providerId)===we;try{await f({wp_object_type:e.wp_object_type,wp_object_id:e.wp_object_id,giav_entity_type:"supplier",giav_entity_id:String(t.providerId),giav_supplier_id:String(t.providerId),giav_supplier_name:t.providerName||null,status:l?"needs_review":"active",match_type:l?"auto_generic":"manual"}),u({status:"success",message:"Mapeo guardado (validado en GIAV)."}),h(e=>{const t={...e};return delete t[a],t}),await O()}catch(e){u({status:"error",message:e?.message||"No se pudo guardar el mapeo."})}finally{C(null)}}(e),isBusy:E===t,disabled:E&&E!==t},"Guardar")))}),!s&&0===(d.items||[]).length&&(0,a.createElement)("tr",null,(0,a.createElement)("td",{colSpan:"4",style:{padding:16,textAlign:"center",opacity:.7}},"Sin resultados."))))))))}const xe=[{key:"package",label:"Paquete"},{key:"first_name",label:"Nombre"},{key:"last_name",label:"Apellido"},{key:"email",label:"Email"},{key:"telefono",label:"Tel�fono"},{key:"fecha_llegada",label:"Fecha llegada"},{key:"fecha_regreso",label:"Fecha regreso"},{key:"green_fees_per_player",label:"Green-fees por jugador"},{key:"jugadores",label:"Jugadores"},{key:"no_jugadores",label:"No jugadores"},{key:"vuelos_checkbox",label:"Checkbox vuelos"},{key:"aeropuerto_salida",label:"Aeropuerto salida"},{key:"mas_info",label:"M�s info"}];function Te(){const[e,n]=(0,t.useState)({es_form_id:"",en_form_id:""}),[r,i]=(0,t.useState)({}),[s,o]=(0,t.useState)({}),[c,u]=(0,t.useState)(!0),[d,m]=(0,t.useState)(null),[p,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(null),b=async()=>{u(!0),m(null);try{const e=await k();n({es_form_id:e.forms?.es_form_id||"",en_form_id:e.forms?.en_form_id||""}),o(e.mappings||{}),i(e.fields||{})}catch(e){m({status:"error",message:e.message||"No se pudo cargar la configuración."})}finally{u(!1)}};(0,t.useEffect)(()=>{b()},[]);const h=(e,a)=>{n(t=>({...t,[e]:a}))},E=(0,t.useMemo)(()=>[{label:"Formulario ES",key:"es_form_id",id:e.es_form_id},{label:"Formulario EN",key:"en_form_id",id:e.en_form_id}],[e]);return(0,a.createElement)("div",{style:{maxWidth:1100,margin:"24px auto"}},(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Solicitudes recibidas (Gravity Forms)")),(0,a.createElement)(l.CardBody,null,d&&(0,a.createElement)(l.Notice,{status:d.status,isDismissible:!0,onRemove:()=>m(null)},d.message),(0,a.createElement)("div",{style:{display:"grid",gap:12,marginBottom:18}},(0,a.createElement)("p",{style:{margin:0,color:"#475569"}},"Configura los IDs de los formularios en español y en inglés para que el plugin pueda sincronizar las entradas."),(0,a.createElement)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:12}},(0,a.createElement)(l.TextControl,{label:"Form ID (ES)",value:e.es_form_id,onChange:e=>h("es_form_id",e),placeholder:"Id del formulario en español"}),(0,a.createElement)(l.TextControl,{label:"Form ID (EN)",value:e.en_form_id,onChange:e=>h("en_form_id",e),placeholder:"Id del formulario en inglés"})),(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{_(!0),m(null);try{await x({es_form_id:e.es_form_id,en_form_id:e.en_form_id}),m({status:"success",message:"IDs guardados correctamente."}),await b()}catch(e){m({status:"error",message:e.message||"No se pudieron guardar los IDs."})}finally{_(!1)}},isBusy:p,disabled:p},"Guardar formularios")),c?(0,a.createElement)("div",{style:{textAlign:"center",padding:32}},(0,a.createElement)(l.Spinner,null)):E.map(e=>{if(!e.id)return(0,a.createElement)("div",{key:e.key,style:{padding:16,border:"1px solid #e5e7eb",borderRadius:12,marginBottom:16}},(0,a.createElement)("strong",null,e.label),(0,a.createElement)("p",{style:{marginTop:4,color:"#6b7280"}},"Configura primero el ID del formulario para ver el mapping."));const t=r[e.id]||[],n=s[e.id]||{};return(0,a.createElement)("div",{key:e.id,style:{marginBottom:24,borderRadius:16,border:"1px solid #e5e7eb",padding:16,background:"#f8fafc"}},(0,a.createElement)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,e.label),(0,a.createElement)("p",{style:{margin:"4px 0 0",color:"#475569"}},"Form ID #",e.id)),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>(async e=>{g(e),m(null);try{const a={};xe.forEach(t=>{s[e]?.[t.key]&&(a[t.key]=s[e][t.key])}),await T(e,a),m({status:"success",message:"Mapeo guardado."}),g(null),await b()}catch(e){m({status:"error",message:e.message||"No se pudo guardar el mapeo."}),g(null)}})(e.id),isBusy:v===e.id,disabled:v===e.id},"Guardar mapeo")),(0,a.createElement)("div",{style:{marginTop:16,display:"grid",gap:12}},xe.map(t=>(0,a.createElement)(l.TextControl,{key:t.key,label:`${t.label} - ID del campo`,value:n[t.key]||"",onChange:a=>((e,a,t)=>{o(l=>({...l,[e]:{...l[e]||{},[a]:t}}))})(e.id,t.key,a),placeholder:`ID del campo ${t.label}`}))),t.length?(0,a.createElement)("details",{style:{marginTop:16}},(0,a.createElement)("summary",{style:{cursor:"pointer",fontWeight:600,color:"#1d4ed8"}},"Campos disponibles (ID / etiqueta)"),(0,a.createElement)("div",{style:{display:"grid",gap:6,marginTop:8}},t.map(t=>(0,a.createElement)("div",{key:`${e.id}-${t.id}`,style:{fontSize:13,color:"#475569"}},"#",t.id," — ",t.label||"Sin etiqueta"," ",(0,a.createElement)("small",null,"(",t.type,")"))))):(0,a.createElement)("p",{style:{marginTop:16,color:"#6b7280"}},"Sin campos registrados para este formulario."))}))))}const Ie={new:"Nueva",contacted:"Contactado",quoting:"Cotizando",proposal_sent:"Propuesta enviada",won:"Ganada",lost:"Perdida",archived:"Archivada"},Pe=()=>{const[e,n]=(0,t.useState)({es_form_id:"",en_form_id:""}),[r,i]=(0,t.useState)(!0),[s,o]=(0,t.useState)(!0),[c,u]=(0,t.useState)(""),[d,m]=(0,t.useState)([]),[p,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(""),[b,h]=(0,t.useState)(null),[E,y]=(0,t.useState)({status:"",lang:"",q:"",page:1}),[f,N]=(0,t.useState)({total_pages:1,page:1,total:0}),[w,x]=(0,t.useState)(null),T=(0,t.useRef)(E),I=Boolean(e.es_form_id||e.en_form_id),P=(0,t.useMemo)(()=>{const e=new URL(window.location.href);return e.searchParams.set("page","wp-travel-giav-requests-settings"),e.toString()},[]);(0,t.useEffect)(()=>{T.current=E},[E]);const M=(0,t.useCallback)(async()=>{o(!0),u("");try{const e=await k();n({es_form_id:e.forms?.es_form_id||"",en_form_id:e.forms?.en_form_id||""}),i(!0)}catch(e){503===e?.status?(i(!1),u("Gravity Forms no está activo o no responde.")):u(e?.message||"No se pudo cargar la configuración.")}finally{o(!1)}},[]);(0,t.useEffect)(()=>{M()},[M]);const A=(0,t.useCallback)(async()=>{if(!p&&r&&I){_(!0),g("");try{const e=T.current,a=await C({status:e.status||void 0,lang:e.lang||void 0,q:e.q?.trim()||void 0,page:e.page,per_page:20}),t=Array.isArray(a?.items)?a.items:[];m(t),N({total_pages:a.total_pages||1,page:a.page||e.page,total:a.total||t.length})}catch(e){g(e?.message||"No se pudieron cargar las solicitudes."),m([])}finally{_(!1)}}},[r,I]);(0,t.useEffect)(()=>{!s&&r&&I&&A()},[s,r,I,A]);const B=(e,a)=>{y(t=>{const l={...t,[e]:a};return"page"!==e&&(l.page=1),T.current=l,l})},R=(0,t.useMemo)(()=>[{value:"",label:"Todos los estados"},...Object.entries(Ie).map(([e,a])=>({value:e,label:a}))],[]),D=e=>{const a="next"===e?f.page+1:f.page-1;a<1||a>(f.total_pages||1)||(B("page",a),A())};return(0,a.createElement)("div",{className:"wp-travel-giav-app"},(0,a.createElement)("div",{className:"requests-list-admin"},(0,a.createElement)("header",{className:"requests-list-admin__header"},(0,a.createElement)("div",null,(0,a.createElement)("h1",null,"Solicitudes recibidas"),(0,a.createElement)("p",null,"Sincroniza Gravity Forms, filtra y convierte solicitudes en propuestas.")),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>window.location.href=P},"Configurar formularios")),s&&(0,a.createElement)("div",{className:"requests-list-admin__loading"},(0,a.createElement)(l.Spinner,null)),!s&&!r&&(0,a.createElement)(l.Notice,{status:"error"},"Gravity Forms no está activo. Instala o actívalo para continuar.",(0,a.createElement)("div",{style:{marginTop:8}},(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>window.location.href=P},"Configurar formularios"))),!s&&r&&!I&&(0,a.createElement)(l.Notice,{status:"warning"},"No hay formularios configurados. Asigna los IDs ES/EN para sincronizar las solicitudes.",(0,a.createElement)("div",{style:{marginTop:8}},(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>window.location.href=P},"Configurar formularios"))),c&&r&&(0,a.createElement)(l.Notice,{status:"error"},c),b&&(0,a.createElement)(l.Notice,{status:b.status,isDismissible:!0,onRemove:()=>h(null)},b.message),v&&(0,a.createElement)(l.Notice,{status:"error"},v),r&&I&&(0,a.createElement)(a.Fragment,null,(0,a.createElement)("div",{className:"requests-list-admin__filters"},(0,a.createElement)(l.TextControl,{label:"Buscar",value:E.q,onChange:e=>B("q",e),placeholder:"Cliente, email o ID"}),(0,a.createElement)(l.SelectControl,{label:"Estado",value:E.status,options:R,onChange:e=>B("status",e)}),(0,a.createElement)(l.SelectControl,{label:"Idioma",value:E.lang,options:[{value:"",label:"Todos los idiomas"},{value:"es",label:"Español"},{value:"en",label:"English"}],onChange:e=>B("lang",e)}),(0,a.createElement)(l.Button,{variant:"primary",onClick:A,disabled:p},"Actualizar listado")),(0,a.createElement)("div",{className:"requests-list-admin__table"},(0,a.createElement)("div",{className:"requests-list-admin__row requests-list-admin__row--header"},(0,a.createElement)("span",null,"Fecha"),(0,a.createElement)("span",null,"Cliente"),(0,a.createElement)("span",null,"Email"),(0,a.createElement)("span",null,"Fechas"),(0,a.createElement)("span",null,"PAX"),(0,a.createElement)("span",null,"Idioma / Estado"),(0,a.createElement)("span",null,"Acciones")),p&&(0,a.createElement)("div",{className:"requests-list-admin__row requests-list-admin__row--loading"},(0,a.createElement)(l.Spinner,null),(0,a.createElement)("span",null,"Cargando solicitudes…")),!p&&0===d.length&&(0,a.createElement)("div",{className:"requests-list-admin__empty"},"No hay solicitudes registradas para los filtros actuales."),!p&&d.map(e=>{const t=e.mapped||{},n=e.status||"new",r=t.pax_total||(t.jugadores||0)+(t.no_jugadores||0);return(0,a.createElement)("div",{key:e.id,className:"requests-list-admin__row"},(0,a.createElement)("span",null,(e=>{if(!e)return"—";const a=new Date(e);return Number.isNaN(a.getTime())?e:a.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:"numeric"})})(e.created_at)),(0,a.createElement)("span",null,(0,a.createElement)("strong",null,((e={})=>[e.first_name||e.nombre||"",e.last_name||e.apellido||""].filter(Boolean).join(" ")||(e.customer_name?e.customer_name:"Sin nombre"))(t)),(0,a.createElement)("br",null),(0,a.createElement)("small",null,"ID GF #",e.entry_id)),(0,a.createElement)("span",null,t.email||"—"),(0,a.createElement)("span",null,t.fecha_llegada||"—"," – ",t.fecha_regreso||"—"),(0,a.createElement)("span",null,r),(0,a.createElement)("span",null,(0,a.createElement)("span",{className:`requests-list-admin__status requests-list-admin__status--${n}`},Ie[n]||n),(0,a.createElement)("br",null),(0,a.createElement)("small",null,e.lang?.toUpperCase()||"ES")),(0,a.createElement)("span",{className:"requests-list-admin__actions"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>(async e=>{x(e),h(null);try{const a=await S(e);if(a?.admin_edit_url)return void window.location.assign(a.admin_edit_url);if(a?.edit_url)return void window.location.assign(a.edit_url);h({status:"success",message:"Propuesta creada correctamente."}),A()}catch(e){h({status:"error",message:e?.message||"No se pudo convertir la solicitud."})}finally{x(null)}})(e.id),disabled:w===e.id,isBusy:w===e.id},"Convertir"),e.proposal_id&&(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>window.location.assign((e=>{if(!e)return"";const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.set("proposal_id",e),a.searchParams.delete("action"),a.toString()})(e.proposal_id))},"Abrir propuesta")))})),(0,a.createElement)("div",{className:"requests-list-admin__pagination"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>D("prev"),disabled:f.page<=1},"Anterior"),(0,a.createElement)("span",null,"Página ",f.page," de ",f.total_pages||1),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>D("next"),disabled:f.page>=(f.total_pages||1)},"Siguiente")))))};function Me(e){if(!e)return"-";const a=new Date(e);return Number.isNaN(a.getTime())?e:new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short"}).format(a)}const Ae={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",queued:"En cola",synced:"Sincronizada",error:"Error",revoked:"Revocada",lost:"Perdida"},Be={client:"Cliente",admin:"Admin"},Re={pending:"Pendiente",confirmed:"Confirmada"},De={none:"No iniciado",pending:"En proceso",ok:"Creado",error:"Error"};function $e(e={}){const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.delete("proposal_id"),a.searchParams.delete("action"),Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t?a.searchParams.set(e,t):a.searchParams.delete(e)}),a.toString()}function Ge({proposalId:e}){var n;const[r,i]=(0,t.useState)(!1),[s,o]=(0,t.useState)(""),[u,d]=(0,t.useState)(null),[m,p]=(0,t.useState)(!1),[_,h]=(0,t.useState)(null),[E,y]=(0,t.useState)(""),[f,N]=(0,t.useState)(!1),[C,S]=(0,t.useState)(!1),w=async()=>{i(!0),o("");try{const a=await c(e);d(a)}catch(e){o(e?.message||"No se pudo cargar la propuesta.")}finally{i(!1)}};if((0,t.useEffect)(()=>{if(!e)return d(null),void o("Propuesta no encontrada.");w()},[e]),(0,t.useEffect)(()=>{if(u?.proposal){const e=u.proposal.current_version_id;y(e?String(e):"")}},[u?.proposal?.current_version_id]),r&&!u)return(0,a.createElement)(l.Spinner,null);if(!u?.proposal&&s)return(0,a.createElement)("div",{style:{display:"grid",gap:12}},(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>o("")},s),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.location.href=$e()},"Volver al listado"));if(!u?.proposal)return(0,a.createElement)("div",{style:{display:"grid",gap:12}},(0,a.createElement)(l.Notice,{status:"warning",isDismissible:!1},"Propuesta no encontrada."),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.location.href=$e()},"Volver al listado"));const{proposal:k,versions:x=[]}=u,T=Re[k.confirmation_status]||("accepted"===k.status?"Pendiente":"-"),P=x.find(e=>Number(e.id)===Number(k.accepted_version_id)),M=x.find(e=>String(e.id)===String(E)),A=x.map(e=>{var a;return{label:`#${null!==(a=e.version_number)&&void 0!==a?a:e.id} · ${Me(e.created_at)}`,value:String(e.id)}}),B=Ae[k.status]||k.status||"-",R=k.giav_sync_status||"none",D=De[R]||R||"-",$="accepted"===k.status,G=Boolean(k.giav_expediente_id),F="error"===R,q="pending"===R,V=[{label:"ID cliente",value:k.giav_client_id},{label:"ID expediente",value:k.giav_expediente_id},{label:"ID reserva PQ",value:k.giav_pq_reserva_id}].filter(e=>e.value),U=I(k.first_name,k.last_name,k.customer_name)||"-";return(0,a.createElement)("div",{style:{display:"grid",gap:16}},s&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>o("")},s),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-detail__header"},(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__eyebrow"},"Detalle de propuesta · #",k.id),(0,a.createElement)("div",{className:"proposal-detail__title-row"},(0,a.createElement)("h2",{className:"proposal-detail__title"},k.proposal_title||"Propuesta sin título"),(0,a.createElement)("span",{className:`proposal-status proposal-status--${k.status||"draft"} proposal-status--large`},B))),(0,a.createElement)("div",{className:"proposal-detail__actions"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>{window.location.href=$e({proposal_id:k.id,action:"edit"})}},"Editar propuesta"),k.public_url?(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>window.open(k.public_url,"_blank","noopener")},"Abrir vista pública"):null,(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>{window.location.href=$e()}},"Volver al listado")))),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{className:"proposal-detail__summary"},(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Cliente"),(0,a.createElement)("div",{className:"proposal-detail__value"},U)),(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Email"),(0,a.createElement)("div",{className:"proposal-detail__value"},k.customer_email||"-")),(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Fechas"),(0,a.createElement)("div",{className:"proposal-detail__value"},k.start_date," - ",k.end_date)),(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Última actualización"),(0,a.createElement)("div",{className:"proposal-detail__value"},Me(k.updated_at)))))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Enlace para cliente")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{className:"proposal-detail__block"},(0,a.createElement)(l.TextControl,{label:"URL pública",value:k.public_url||"",readOnly:!0}),(0,a.createElement)("p",{className:"proposal-detail__helper"},"Este es el enlace que verá el cliente."),(0,a.createElement)("div",{className:"proposal-detail__button-row"},(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{await async function(e){if(!e)return!1;try{if(navigator.clipboard?.writeText)return await navigator.clipboard.writeText(e),!0}catch(e){}const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.top="-1000px",document.body.appendChild(a),a.focus(),a.select();const t=document.execCommand("copy");return document.body.removeChild(a),t}(k.public_url)&&(p(!0),window.setTimeout(()=>p(!1),1500))}},m?"Enlace copiado":"Copiar"),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.open(k.public_url,"_blank","noopener")},"Abrir"))))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-detail__section-title"},(0,a.createElement)("strong",null,"Estado de aceptación"),(0,a.createElement)("span",{className:"proposal-detail__pill "+($?"proposal-detail__pill--success":"proposal-detail__pill--warning")},$?"Aceptada":"Pendiente de aceptación"))),(0,a.createElement)(l.CardBody,null,$?(0,a.createElement)("div",{className:"proposal-detail__grid"},(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Fecha de aceptación"),(0,a.createElement)("div",{className:"proposal-detail__value"},Me(k.accepted_at))),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Aceptada por"),(0,a.createElement)("div",{className:"proposal-detail__value"},Be[k.accepted_by]||"-")),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Versión aceptada"),(0,a.createElement)("div",{className:"proposal-detail__value"},P?`#${null!==(n=P.version_number)&&void 0!==n?n:P.id}`:k.accepted_version_id||"-")),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Confirmación"),(0,a.createElement)("div",{className:"proposal-detail__value"},T))):(0,a.createElement)("div",{className:"proposal-detail__block"},(0,a.createElement)(l.SelectControl,{label:"Versión a aceptar",value:E,options:A,onChange:e=>y(e),disabled:f||0===A.length}),(0,a.createElement)("div",{className:"proposal-detail__button-row"},(0,a.createElement)(l.Button,{variant:"primary",disabled:f||!M,onClick:async()=>{N(!0),o("");try{await g(k.id,M.id),await w()}catch(e){o(e?.message||"No se pudo marcar como aceptada.")}finally{N(!1)}}},"Marcar como aceptada"))))),(k.traveler_full_name||k.traveler_dni)&&(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Datos del viajero")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{style:{display:"grid",gap:8}},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Nombre completo:")," ",k.traveler_full_name||"-"),(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"DNI:")," ",k.traveler_dni||"-")))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-detail__section-title"},(0,a.createElement)("strong",null,"Integración GIAV"),(0,a.createElement)("span",{className:"proposal-detail__pill proposal-detail__pill--"+("ok"===R?"success":"error"===R?"danger":"pending"===R?"warning":"neutral")},D))),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{className:"proposal-detail__block"},V.length>0?(0,a.createElement)("div",{className:"proposal-detail__grid"},V.map(e=>(0,a.createElement)("div",{key:e.label},(0,a.createElement)("div",{className:"proposal-detail__label"},e.label),(0,a.createElement)("div",{className:"proposal-detail__value"},e.value))),k.giav_sync_updated_at?(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Última actualización"),(0,a.createElement)("div",{className:"proposal-detail__value"},Me(k.giav_sync_updated_at))):null):(0,a.createElement)("p",{className:"proposal-detail__helper"},"Aún no hay identificadores de GIAV vinculados."),k.giav_sync_error?(0,a.createElement)("div",{className:"proposal-detail__error"},(0,a.createElement)("strong",null,"Error:")," ",k.giav_sync_error):null,(0,a.createElement)("div",{className:"proposal-detail__cta"},$?F&&!G?(0,a.createElement)(l.Button,{variant:"primary",disabled:C,onClick:async()=>{S(!0),o("");try{await b(k.id),await w()}catch(e){o(e?.message||"No se pudo reintentar GIAV.")}finally{S(!1)}}},"Reintentar GIAV"):G||q?q?(0,a.createElement)("span",{className:"proposal-detail__helper"},"En proceso de creación en GIAV."):(0,a.createElement)("span",{className:"proposal-detail__helper"},"Expediente creado y sincronizado."):(0,a.createElement)(l.Button,{variant:"primary",disabled:C,onClick:async()=>{S(!0),o("");try{await b(k.id),await w()}catch(e){o(e?.message||"No se pudo crear en GIAV.")}finally{S(!1)}}},"Crear expediente en GIAV"):(0,a.createElement)("span",{className:"proposal-detail__helper"},"Disponible tras aceptación."))))),"accepted"===k.status&&(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Siguiente paso")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("p",{style:{margin:0}},"Confirmar disponibilidad y servicios. Cuando esté confirmada, se invitará al portal (futuro)."))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Versiones")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("details",{className:"proposal-detail__versions",open:!0},(0,a.createElement)("summary",null,"Histórico de versiones (",x.length,")"),(0,a.createElement)("div",{className:"proposal-detail__table"},(0,a.createElement)("table",{className:"wp-list-table widefat fixed striped"},(0,a.createElement)("thead",null,(0,a.createElement)("tr",null,(0,a.createElement)("th",null,"ID"),(0,a.createElement)("th",null,"Versión"),(0,a.createElement)("th",null,"Fecha"),(0,a.createElement)("th",null,"Total comercial"),(0,a.createElement)("th",null,"Estado"),(0,a.createElement)("th",null,"Acciones"))),(0,a.createElement)("tbody",null,0===x.length?(0,a.createElement)("tr",null,(0,a.createElement)("td",{colSpan:6},"No hay versiones.")):x.map(e=>{var t,n;const r=Number(k.current_version_id)===Number(e.id),i=Number(k.accepted_version_id)===Number(e.id);return(0,a.createElement)("tr",{key:e.id,className:i?"proposal-detail__row--accepted":void 0},(0,a.createElement)("td",null,e.id),(0,a.createElement)("td",null,null!==(t=e.version_number)&&void 0!==t?t:"-"),(0,a.createElement)("td",null,Me(e.created_at)),(0,a.createElement)("td",null,null!==(n=e.totals_sell_price)&&void 0!==n?n:"-"),(0,a.createElement)("td",null,(0,a.createElement)("div",{className:"proposal-detail__version-badges"},r&&(0,a.createElement)("span",{className:"proposal-detail__pill proposal-detail__pill--info"},"Vigente"),i&&(0,a.createElement)("span",{className:"proposal-detail__pill proposal-detail__pill--success"},"Aceptada"),r||i?null:"—")),(0,a.createElement)("td",null,(0,a.createElement)("div",{className:"proposal-detail__action-stack"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.open(e.public_url||k.public_url,"_blank","noopener")},"Ver"),!r&&(0,a.createElement)(l.Button,{variant:"tertiary",disabled:_===e.id,onClick:async()=>{h(e.id);try{await v(k.id,e.id),await w()}catch(e){o(e?.message||"No se pudo actualizar la versión vigente.")}finally{h(null)}}},"Marcar vigente"))))}))))))))}const Fe={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",queued:"En cola",synced:"Sincronizada",error:"Error",revoked:"Revocada",lost:"Perdida"},qe=(e={})=>{const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.delete("proposal_id"),a.searchParams.delete("action"),Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t?a.searchParams.set(e,t):a.searchParams.delete(e)}),a.toString()};function Ve({page:e=""}={}){const n=new URLSearchParams(window.location.search||""),r=n.get("page")||"",i=e||r,s=n.get("proposal_id"),u=n.get("action");if("wp-travel-giav-requests"===i)return(0,a.createElement)(Pe,null);if("wp-travel-giav-requests-settings"===i)return(0,a.createElement)(Te,null);if("wp-travel-giav-mapping"===i)return(0,a.createElement)(ke,null);const[p,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(null),[b,h]=(0,t.useState)(!1),[E,y]=(0,t.useState)(""),[f,N]=(0,t.useState)([]),[C,S]=(0,t.useState)(!1),[w,k]=(0,t.useState)(""),[x,T]=(0,t.useState)(""),[P,M]=(0,t.useState)("updated_at"),[A,B]=(0,t.useState)("desc"),[R,D]=(0,t.useState)([]),$=s?parseInt(s,10):null,G=Number.isNaN($)?null:$,F="edit"===u&&G;(0,t.useEffect)(()=>{if(!F)return g(null),void y("");let e=!0;return(async()=>{h(!0),y("");try{const a=await c(G);e&&g(a)}catch(a){e&&y(a?.message||"No se pudo cargar la propuesta para editar.")}finally{e&&h(!1)}})(),()=>{e=!1}},[F,G]);const q=(0,t.useMemo)(()=>v?.proposal?{initialProposal:v.proposal,initialSnapshot:v.current_snapshot,nextVersionNumber:v.next_version_number||1}:null,[v]),V=async({nextSearch:e}={})=>{S(!0),k("");try{const a=void 0!==e?e:x,t=await o({orderBy:P,order:A,limit:50,offset:0,search:a?.trim()?a.trim():void 0}),l=Array.isArray(t?.items)?t.items:Array.isArray(t)?t:[];N(l),D(e=>e.filter(e=>l.some(a=>a.id===e)))}catch(e){k(e?.message||"No se pudo cargar el repositorio."),N([])}finally{S(!1)}};return(0,t.useEffect)(()=>{V()},[P,A]),p?(0,a.createElement)(Ne,{onExit:()=>_(!1)}):F?b?(0,a.createElement)("div",{style:{padding:16}},"Cargando..."):E?(0,a.createElement)("div",{style:{padding:16,color:"#b91c1c"}},E):q?(0,a.createElement)(Ne,{onExit:()=>{const e=new URL(window.location.href);e.searchParams.set("page","travel_proposals"),e.searchParams.set("proposal_id",G),e.searchParams.delete("action"),window.location.href=e.toString()},mode:"edit",...q}):null:G?(0,a.createElement)(Ge,{proposalId:G}):(0,a.createElement)("div",{className:"wp-travel-giav-app"},(0,a.createElement)(l.Card,{className:"proposal-list"},(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-list__header"},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Repositorio de propuestas"),(0,a.createElement)("div",{className:"proposal-list__subtitle"},"Gestiona propuestas creadas, revisa su estado y accede al detalle.")),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>_(!0)},"Nueva propuesta"))),(0,a.createElement)(l.CardBody,null,w?(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>k("")},w):null,(0,a.createElement)("div",{className:"proposal-list__filters"},(0,a.createElement)("div",{className:"proposal-list__search"},(0,a.createElement)("label",{className:"proposal-list__search-label",htmlFor:"proposal-search"},"Buscar cliente"),(0,a.createElement)("input",{id:"proposal-search",className:"proposal-list__search-input",type:"search",value:x,onChange:e=>T(e.target.value),placeholder:"Cliente, email o token"})),(0,a.createElement)(l.SelectControl,{label:"Ordenar por",value:P,options:[{label:"Última actualización",value:"updated_at"},{label:"ID",value:"id"}],onChange:e=>M(e)}),(0,a.createElement)(l.SelectControl,{label:"Orden",value:A,options:[{label:"Descendente",value:"desc"},{label:"Ascendente",value:"asc"}],onChange:e=>B(e)}),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>V({nextSearch:x}),disabled:C},"Buscar"),(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>{T(""),V({nextSearch:""})},disabled:C},"Limpiar filtros"),(0,a.createElement)(l.Button,{variant:"secondary",isDestructive:!0,onClick:async()=>{if(window.confirm(`¿Seguro que quieres eliminar ${R.length} propuestas?`)){S(!0),k("");try{await m(R),D([]),await V()}catch(e){k(e?.message||"No se pudieron eliminar las propuestas.")}finally{S(!1)}}},disabled:C||0===R.length},"Eliminar seleccionadas (",R.length,")")),(0,a.createElement)("div",{className:"proposal-list__table"},(0,a.createElement)("div",{className:"proposal-list__row proposal-list__row--header"},(0,a.createElement)("div",{className:"proposal-list__select"},(0,a.createElement)(l.CheckboxControl,{checked:R.length===f.length&&f.length>0,onChange:()=>{R.length!==f.length?D(f.map(e=>e.id)):D([])}})),(0,a.createElement)("div",null,"ID"),(0,a.createElement)("div",null,"Título"),(0,a.createElement)("div",null,"Cliente"),(0,a.createElement)("div",null,"Estado"),(0,a.createElement)("div",null,"Última actualización"),(0,a.createElement)("div",null,"Autor"),(0,a.createElement)("div",null,"Acciones")),C?(0,a.createElement)("div",{className:"proposal-list__row proposal-list__row--loading"},(0,a.createElement)(l.Spinner,null),(0,a.createElement)("span",null,"Cargando propuestas…")):null,C||0!==f.length?null:(0,a.createElement)("div",{className:"proposal-list__empty"},"No hay propuestas aún."),!C&&f.map(e=>{const t=Fe[e.status]||e.status||"—",n=e.display_title||e.proposal_title||"—";return(0,a.createElement)("div",{key:e.id,className:"proposal-list__row"},(0,a.createElement)("div",{className:"proposal-list__select"},(0,a.createElement)(l.CheckboxControl,{checked:R.includes(e.id),onChange:()=>(e=>{D(a=>a.includes(e)?a.filter(a=>a!==e):[...a,e])})(e.id)})),(0,a.createElement)("div",{className:"proposal-list__id"},"#",e.id),(0,a.createElement)("div",{className:"proposal-list__title"},n),(0,a.createElement)("div",{className:"proposal-list__customer"},(0,a.createElement)("div",{className:"proposal-list__customer-name"},I(e.first_name,e.last_name,e.customer_name)||"—"),(0,a.createElement)("div",{className:"proposal-list__customer-meta"},e.start_date||"—"," - ",e.end_date||"—")),(0,a.createElement)("div",null,(0,a.createElement)("span",{className:`proposal-status proposal-status--${e.status||"draft"}`},t)),(0,a.createElement)("div",null,(e=>{if(!e)return"—";const a=String(e),t=a.includes("T")?a:a.replace(" ","T"),l=new Date(t);return Number.isNaN(l.getTime())?e:l.toLocaleString("es-ES",{dateStyle:"medium",timeStyle:"short"})})(e.updated_at)),(0,a.createElement)("div",null,e.author_name||"—"),(0,a.createElement)("div",{className:"proposal-list__actions"},(0,a.createElement)(l.Button,{variant:"secondary",href:qe({proposal_id:e.id})},"Ver detalle"),(0,a.createElement)(l.DropdownMenu,{className:"proposal-list__actions-menu",icon:"ellipsis",label:"Más acciones",controls:[{title:"Editar",onClick:()=>{window.location.href=qe({proposal_id:e.id,action:"edit"})}},...e.public_url?[{title:"Vista pública",onClick:()=>{window.open(e.public_url,"_blank","noopener,noreferrer")}}]:[],{title:"Eliminar",isDestructive:!0,onClick:()=>(async e=>{if(window.confirm("¿Seguro que quieres eliminar esta propuesta?")){S(!0),k("");try{await d(e),D(a=>a.filter(a=>a!==e)),await V()}catch(e){k(e?.message||"No se pudo eliminar la propuesta.")}finally{S(!1)}}})(e.id)}]})))})))))}const Ue=document.getElementById("wp-travel-giav-admin"),je=document.getElementById("wp-travel-giav-requests"),Le=document.getElementById("wp-travel-giav-requests-settings"),Oe=(e,l="")=>{e&&(0,t.createRoot)(e).render((0,a.createElement)(Ve,{page:l}))};Oe(Ue),Oe(je,"wp-travel-giav-requests"),Oe(Le,"wp-travel-giav-requests-settings")})();