(()=>{"use strict";var e={n:a=>{var t=a&&a.__esModule?()=>a.default:()=>a;return e.d(t,{a:t}),t},d:(a,t)=>{for(var l in t)e.o(t,l)&&!e.o(a,l)&&Object.defineProperty(a,l,{enumerable:!0,get:t[l]})},o:(e,a)=>Object.prototype.hasOwnProperty.call(e,a)};const a=window.React,t=window.wp.element,l=window.wp.components,r=window.wp.apiFetch;var n=e.n(r);const i=window.WP_TRAVEL_GIAV||window.CASANOVA_GESTION_RESERVAS||{};if(!n().__WP_TRAVEL_GIAV_CONFIGURED){const e=i.nonce||"",a=(e=>{if(e.wpRestRoot)return e.wpRestRoot;const a=e.apiUrl||e.restUrl;return a?a.replace(/\/travel\/v1\/?$/,"/"):"/wp-json/"})(i);a&&n().use(n().createRootURLMiddleware(a)),e&&n().use(n().createNonceMiddleware(e)),n().__WP_TRAVEL_GIAV_CONFIGURED=!0}const s=e=>n()({path:"/travel/v1/proposals",method:"POST",data:e}),o=({orderBy:e="updated_at",order:a="desc",limit:t=50,offset:l=0,search:r,author:i,page:s,per_page:o}={})=>{const c=new URLSearchParams;return c.set("order_by",e),c.set("order",a),c.set("limit",t),c.set("offset",l),void 0!==r&&c.set("search",r),void 0!==i&&c.set("author",i),void 0!==s&&c.set("page",s),void 0!==o&&c.set("per_page",o),n()({path:`/travel/v1/proposals?${c.toString()}`,method:"GET"})},c=e=>n()({path:`/travel/v1/proposals/${e}/detail`,method:"GET"}),u=(e,a)=>n()({path:`/travel/v1/proposals/${e}`,method:"PUT",data:a}),d=e=>n()({path:`/travel/v1/proposals/${e}`,method:"DELETE"}),p=e=>n()({path:"/travel/v1/proposals/bulk-delete",method:"POST",data:{ids:e}}),m=(e,a,t)=>n()({path:`/travel/v1/proposals/${e}/send`,method:"POST",data:{snapshot:a,version_number:t}}),_=(e,a,t)=>n()({path:`/travel/v1/proposals/${e}/versions`,method:"POST",data:{snapshot:a,version_number:t}}),v=(e,a)=>n()({path:`/travel/v1/proposals/${e}/current-version`,method:"POST",data:{version_id:a}}),g=(e,a)=>n()({path:`/travel/v1/proposals/${e}/accept`,method:"POST",data:{version_id:a}}),b=e=>n()({path:`/travel/v1/proposals/${e}/giav-retry`,method:"POST"}),E=({type:e,q:a})=>n()({path:`/travel/v1/catalog/search?type=${encodeURIComponent(e)}&q=${encodeURIComponent(a||"")}`,method:"GET"}),h=({wp_object_type:e,wp_object_id:a})=>n()({path:`/travel/v1/giav-mapping?wp_object_type=${encodeURIComponent(e)}&wp_object_id=${encodeURIComponent(a)}`,method:"GET"}),y=({type:e,q:a,limit:t=50,offset:l=0})=>n()({path:`/travel/v1/giav-mapping/list?type=${encodeURIComponent(e)}&q=${encodeURIComponent(a||"")}&limit=${encodeURIComponent(t)}&offset=${encodeURIComponent(l)}`,method:"GET"}),f=e=>n()({path:"/travel/v1/giav-mapping/upsert",method:"POST",data:e}),N=({wp_object_type:e,giav_supplier_id:a,items:t,status:l="active",match_type:r="batch"})=>n()({path:"/travel/v1/giav-mapping/batch-upsert",method:"POST",data:{wp_object_type:e,giav_supplier_id:a,items:t,status:l,match_type:r}}),S=async({q:e,pageSize:a=20,pageIndex:t=0,includeDisabled:l=!1})=>{const r=await n()({path:`/travel/v1/giav/providers/search?q=${encodeURIComponent(e)}&pageSize=${encodeURIComponent(a)}&pageIndex=${encodeURIComponent(t)}&includeDisabled=${encodeURIComponent(l)}`,method:"GET"});return{items:(Array.isArray(r)?r:Array.isArray(r?.items)?r.items:[]).map(e=>{var a,t,l,r,n,i,s,o;return{id:String(null!==(a=null!==(t=null!==(l=null!==(r=e.id)&&void 0!==r?r:e.ID)&&void 0!==l?l:e.Id)&&void 0!==t?t:e.proveedorId)&&void 0!==a?a:""),label:String(null!==(n=null!==(i=null!==(s=null!==(o=e.label)&&void 0!==o?o:e.NombreAlias)&&void 0!==s?s:e.Nombre)&&void 0!==i?i:e.title)&&void 0!==n?n:""),raw:e}}).filter(e=>e.id&&e.label)}},C=()=>n()({path:"/travel/v1/requests/mapping",method:"GET"}),w=e=>n()({path:"/travel/v1/requests/mapping",method:"POST",data:e}),x=(e,a)=>n()({path:`/travel/v1/requests/mapping/${e}`,method:"POST",data:a}),k=[{label:"Español",value:"es"},{label:"English",value:"en"}],T=[{label:"EUR",value:"EUR"},{label:"USD",value:"USD"},{label:"GBP",value:"GBP"}],I=[{value:"AF",label:"Afghanistan (AF)"},{value:"AL",label:"Albania (AL)"},{value:"DZ",label:"Algeria (DZ)"},{value:"AS",label:"American Samoa (AS)"},{value:"AD",label:"Andorra (AD)"},{value:"AO",label:"Angola (AO)"},{value:"AI",label:"Anguilla (AI)"},{value:"AQ",label:"Antarctica (AQ)"},{value:"AG",label:"Antigua and Barbuda (AG)"},{value:"AR",label:"Argentina (AR)"},{value:"AM",label:"Armenia (AM)"},{value:"AW",label:"Aruba (AW)"},{value:"AU",label:"Australia (AU)"},{value:"AT",label:"Austria (AT)"},{value:"AZ",label:"Azerbaijan (AZ)"},{value:"BS",label:"Bahamas (BS)"},{value:"BH",label:"Bahrain (BH)"},{value:"BD",label:"Bangladesh (BD)"},{value:"BB",label:"Barbados (BB)"},{value:"BY",label:"Belarus (BY)"},{value:"BE",label:"Belgium (BE)"},{value:"BZ",label:"Belize (BZ)"},{value:"BJ",label:"Benin (BJ)"},{value:"BM",label:"Bermuda (BM)"},{value:"BT",label:"Bhutan (BT)"},{value:"BO",label:"Bolivia (BO)"},{value:"BQ",label:"Bonaire, Sint Eustatius and Saba (BQ)"},{value:"BA",label:"Bosnia and Herzegovina (BA)"},{value:"BW",label:"Botswana (BW)"},{value:"BV",label:"Bouvet Island (BV)"},{value:"BR",label:"Brazil (BR)"},{value:"IO",label:"British Indian Ocean Territory (IO)"},{value:"BN",label:"Brunei (BN)"},{value:"BG",label:"Bulgaria (BG)"},{value:"BF",label:"Burkina Faso (BF)"},{value:"BI",label:"Burundi (BI)"},{value:"KH",label:"Cambodia (KH)"},{value:"CM",label:"Cameroon (CM)"},{value:"CA",label:"Canada (CA)"},{value:"CV",label:"Cape Verde (CV)"},{value:"KY",label:"Cayman Islands (KY)"},{value:"CF",label:"Central African Republic (CF)"},{value:"TD",label:"Chad (TD)"},{value:"CL",label:"Chile (CL)"},{value:"CN",label:"China (CN)"},{value:"CX",label:"Christmas Island (CX)"},{value:"CC",label:"Cocos (Keeling) Islands (CC)"},{value:"CO",label:"Colombia (CO)"},{value:"KM",label:"Comoros (KM)"},{value:"CG",label:"Congo (CG)"},{value:"CD",label:"Congo (Democratic Republic) (CD)"},{value:"CK",label:"Cook Islands (CK)"},{value:"CR",label:"Costa Rica (CR)"},{value:"CI",label:"Côte d’Ivoire (CI)"},{value:"HR",label:"Croatia (HR)"},{value:"CU",label:"Cuba (CU)"},{value:"CW",label:"Curaçao (CW)"},{value:"CY",label:"Cyprus (CY)"},{value:"CZ",label:"Czechia (CZ)"},{value:"DK",label:"Denmark (DK)"},{value:"DJ",label:"Djibouti (DJ)"},{value:"DM",label:"Dominica (DM)"},{value:"DO",label:"Dominican Republic (DO)"},{value:"EC",label:"Ecuador (EC)"},{value:"EG",label:"Egypt (EG)"},{value:"SV",label:"El Salvador (SV)"},{value:"GQ",label:"Equatorial Guinea (GQ)"},{value:"ER",label:"Eritrea (ER)"},{value:"EE",label:"Estonia (EE)"},{value:"ET",label:"Ethiopia (ET)"},{value:"FK",label:"Falkland Islands (FK)"},{value:"FO",label:"Faroe Islands (FO)"},{value:"FJ",label:"Fiji (FJ)"},{value:"FI",label:"Finland (FI)"},{value:"FR",label:"France (FR)"},{value:"GF",label:"French Guiana (GF)"},{value:"PF",label:"French Polynesia (PF)"},{value:"TF",label:"French Southern Territories (TF)"},{value:"GA",label:"Gabon (GA)"},{value:"GM",label:"Gambia (GM)"},{value:"GE",label:"Georgia (GE)"},{value:"DE",label:"Germany (DE)"},{value:"GH",label:"Ghana (GH)"},{value:"GI",label:"Gibraltar (GI)"},{value:"GR",label:"Greece (GR)"},{value:"GL",label:"Greenland (GL)"},{value:"GD",label:"Grenada (GD)"},{value:"GP",label:"Guadeloupe (GP)"},{value:"GU",label:"Guam (GU)"},{value:"GT",label:"Guatemala (GT)"},{value:"GG",label:"Guernsey (GG)"},{value:"GN",label:"Guinea (GN)"},{value:"GW",label:"Guinea-Bissau (GW)"},{value:"GY",label:"Guyana (GY)"},{value:"HT",label:"Haiti (HT)"},{value:"HM",label:"Heard Island and McDonald Islands (HM)"},{value:"HN",label:"Honduras (HN)"},{value:"HK",label:"Hong Kong (HK)"},{value:"HU",label:"Hungary (HU)"},{value:"IS",label:"Iceland (IS)"},{value:"IN",label:"India (IN)"},{value:"ID",label:"Indonesia (ID)"},{value:"IR",label:"Iran (IR)"},{value:"IQ",label:"Iraq (IQ)"},{value:"IE",label:"Ireland (IE)"},{value:"IM",label:"Isle of Man (IM)"},{value:"IL",label:"Israel (IL)"},{value:"IT",label:"Italy (IT)"},{value:"JM",label:"Jamaica (JM)"},{value:"JP",label:"Japan (JP)"},{value:"JE",label:"Jersey (JE)"},{value:"JO",label:"Jordan (JO)"},{value:"KZ",label:"Kazakhstan (KZ)"},{value:"KE",label:"Kenya (KE)"},{value:"KI",label:"Kiribati (KI)"},{value:"KP",label:"Korea (North) (KP)"},{value:"KR",label:"Korea (South) (KR)"},{value:"KW",label:"Kuwait (KW)"},{value:"KG",label:"Kyrgyzstan (KG)"},{value:"LA",label:"Laos (LA)"},{value:"LV",label:"Latvia (LV)"},{value:"LB",label:"Lebanon (LB)"},{value:"LS",label:"Lesotho (LS)"},{value:"LR",label:"Liberia (LR)"},{value:"LY",label:"Libya (LY)"},{value:"LI",label:"Liechtenstein (LI)"},{value:"LT",label:"Lithuania (LT)"},{value:"LU",label:"Luxembourg (LU)"},{value:"MO",label:"Macao (MO)"},{value:"MG",label:"Madagascar (MG)"},{value:"MW",label:"Malawi (MW)"},{value:"MY",label:"Malaysia (MY)"},{value:"MV",label:"Maldives (MV)"},{value:"ML",label:"Mali (ML)"},{value:"MT",label:"Malta (MT)"},{value:"MH",label:"Marshall Islands (MH)"},{value:"MQ",label:"Martinique (MQ)"},{value:"MR",label:"Mauritania (MR)"},{value:"MU",label:"Mauritius (MU)"},{value:"YT",label:"Mayotte (YT)"},{value:"MX",label:"Mexico (MX)"},{value:"FM",label:"Micronesia (FM)"},{value:"MD",label:"Moldova (MD)"},{value:"MC",label:"Monaco (MC)"},{value:"MN",label:"Mongolia (MN)"},{value:"ME",label:"Montenegro (ME)"},{value:"MS",label:"Montserrat (MS)"},{value:"MA",label:"Morocco (MA)"},{value:"MZ",label:"Mozambique (MZ)"},{value:"MM",label:"Myanmar (MM)"},{value:"NA",label:"Namibia (NA)"},{value:"NR",label:"Nauru (NR)"},{value:"NP",label:"Nepal (NP)"},{value:"NL",label:"Netherlands (NL)"},{value:"NC",label:"New Caledonia (NC)"},{value:"NZ",label:"New Zealand (NZ)"},{value:"NI",label:"Nicaragua (NI)"},{value:"NE",label:"Niger (NE)"},{value:"NG",label:"Nigeria (NG)"},{value:"NU",label:"Niue (NU)"},{value:"NF",label:"Norfolk Island (NF)"},{value:"MK",label:"North Macedonia (MK)"},{value:"MP",label:"Northern Mariana Islands (MP)"},{value:"NO",label:"Norway (NO)"},{value:"OM",label:"Oman (OM)"},{value:"PK",label:"Pakistan (PK)"},{value:"PW",label:"Palau (PW)"},{value:"PS",label:"Palestine (PS)"},{value:"PA",label:"Panama (PA)"},{value:"PG",label:"Papua New Guinea (PG)"},{value:"PY",label:"Paraguay (PY)"},{value:"PE",label:"Peru (PE)"},{value:"PH",label:"Philippines (PH)"},{value:"PN",label:"Pitcairn (PN)"},{value:"PL",label:"Poland (PL)"},{value:"PT",label:"Portugal (PT)"},{value:"PR",label:"Puerto Rico (PR)"},{value:"QA",label:"Qatar (QA)"},{value:"RE",label:"Réunion (RE)"},{value:"RO",label:"Romania (RO)"},{value:"RU",label:"Russia (RU)"},{value:"RW",label:"Rwanda (RW)"},{value:"BL",label:"Saint Barthélemy (BL)"},{value:"SH",label:"Saint Helena (SH)"},{value:"KN",label:"Saint Kitts and Nevis (KN)"},{value:"LC",label:"Saint Lucia (LC)"},{value:"MF",label:"Saint Martin (MF)"},{value:"PM",label:"Saint Pierre and Miquelon (PM)"},{value:"VC",label:"Saint Vincent and the Grenadines (VC)"},{value:"WS",label:"Samoa (WS)"},{value:"SM",label:"San Marino (SM)"},{value:"ST",label:"São Tomé and Príncipe (ST)"},{value:"SA",label:"Saudi Arabia (SA)"},{value:"SN",label:"Senegal (SN)"},{value:"RS",label:"Serbia (RS)"},{value:"SC",label:"Seychelles (SC)"},{value:"SL",label:"Sierra Leone (SL)"},{value:"SG",label:"Singapore (SG)"},{value:"SX",label:"Sint Maarten (SX)"},{value:"SK",label:"Slovakia (SK)"},{value:"SI",label:"Slovenia (SI)"},{value:"SB",label:"Solomon Islands (SB)"},{value:"SO",label:"Somalia (SO)"},{value:"ZA",label:"South Africa (ZA)"},{value:"GS",label:"South Georgia and the South Sandwich Islands (GS)"},{value:"SS",label:"South Sudan (SS)"},{value:"ES",label:"Spain (ES)"},{value:"LK",label:"Sri Lanka (LK)"},{value:"SD",label:"Sudan (SD)"},{value:"SR",label:"Suriname (SR)"},{value:"SJ",label:"Svalbard and Jan Mayen (SJ)"},{value:"SE",label:"Sweden (SE)"},{value:"CH",label:"Switzerland (CH)"},{value:"SY",label:"Syria (SY)"},{value:"TW",label:"Taiwan (TW)"},{value:"TJ",label:"Tajikistan (TJ)"},{value:"TZ",label:"Tanzania (TZ)"},{value:"TH",label:"Thailand (TH)"},{value:"TL",label:"Timor-Leste (TL)"},{value:"TG",label:"Togo (TG)"},{value:"TK",label:"Tokelau (TK)"},{value:"TO",label:"Tonga (TO)"},{value:"TT",label:"Trinidad and Tobago (TT)"},{value:"TN",label:"Tunisia (TN)"},{value:"TR",label:"Turkey (TR)"},{value:"TM",label:"Turkmenistan (TM)"},{value:"TC",label:"Turks and Caicos Islands (TC)"},{value:"TV",label:"Tuvalu (TV)"},{value:"UG",label:"Uganda (UG)"},{value:"UA",label:"Ukraine (UA)"},{value:"AE",label:"United Arab Emirates (AE)"},{value:"GB",label:"United Kingdom (GB)"},{value:"US",label:"United States (US)"},{value:"UM",label:"United States Minor Outlying Islands (UM)"},{value:"UY",label:"Uruguay (UY)"},{value:"UZ",label:"Uzbekistan (UZ)"},{value:"VU",label:"Vanuatu (VU)"},{value:"VA",label:"Vatican City (VA)"},{value:"VE",label:"Venezuela (VE)"},{value:"VN",label:"Vietnam (VN)"},{value:"VG",label:"Virgin Islands (British) (VG)"},{value:"VI",label:"Virgin Islands (US) (VI)"},{value:"WF",label:"Wallis and Futuna (WF)"},{value:"EH",label:"Western Sahara (EH)"},{value:"YE",label:"Yemen (YE)"},{value:"ZM",label:"Zambia (ZM)"},{value:"ZW",label:"Zimbabwe (ZW)"}];function M(){return(new Date).toISOString().slice(0,10)}function P({id:e,label:r,value:n,onChange:i,className:s="",fieldRef:o}){const[c,u]=(0,t.useState)(!1),[d,p]=(0,t.useState)(null),m=function(e){if(!e)return"";const[a,t,l]=e.split("-");return a&&t&&l?`${l}/${t}/${a}`:e}(n);return(0,a.createElement)("div",{className:`proposal-basics__field ${s}`.trim(),ref:e=>{"function"==typeof o&&o(e)}},(0,a.createElement)(l.TextControl,{id:e,label:r,value:m,onClick:e=>{p(e.currentTarget),u(!0)},onFocus:e=>{p(e.currentTarget),u(!0)},readOnly:!0,placeholder:"DD/MM/AAAA"}),c&&d&&(0,a.createElement)(l.Popover,{anchor:d,placement:"bottom-start",className:"proposal-basics__date-popover",onClose:()=>{u(!1),p(null)}},(0,a.createElement)(l.DatePicker,{currentDate:n||M(),onChange:e=>{const a=function(e){if(!e)return"";if(e instanceof Date&&!Number.isNaN(e.getTime()))return e.toISOString().slice(0,10);if("string"==typeof e){if(e.includes("/")){const[a,t,l]=e.split("/");if(a&&t&&l)return`${l.padStart(4,"0")}-${t.padStart(2,"0")}-${a.padStart(2,"0")}`}return e.slice(0,10)}return""}(e);a&&i(a),u(!1)},minDate:M()})))}function A({initialValues:e={},onCreated:r,onNext:n,proposalId:i}){var o;const c=(0,t.useMemo)(()=>{var a,t;return{proposal_title:"",customer_name:"",customer_email:"",customer_country:"",customer_language:"es",start_date:M(),end_date:M(),pax_total:1,players_count:null!==(a=null!==(t=e.players_count)&&void 0!==t?t:e.pax_total)&&void 0!==a?a:1,currency:"EUR",...e}},[e]),[d,p]=(0,t.useState)(c),[m,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(""),[b,E]=(0,t.useState)(""),[h,y]=(0,t.useState)(""),f=(0,t.useRef)({});(0,t.useEffect)(()=>{p(e=>({...e,...c}))},[c]),(0,t.useEffect)(()=>(window.fillProposalBasics=(e={})=>{p(a=>({...a,proposal_title:"string"==typeof e.title?e.title:a.proposal_title,customer_name:"string"==typeof e.name?e.name:a.customer_name,customer_email:"string"==typeof e.email?e.email:a.customer_email,customer_country:"string"==typeof e.country?e.country.toUpperCase():a.customer_country,customer_language:"string"==typeof e.language?e.language:a.customer_language}))},()=>{delete window.fillProposalBasics}),[]);const N=e=>a=>{p(t=>({...t,[e]:a})),E(a=>a===e?"":a)},S=e=>a=>{a&&(f.current[e]=a)},C=(0,t.useMemo)(()=>{if(!h)return I;const e=h.toLowerCase();return I.filter(a=>a.label.toLowerCase().includes(e)||a.value.toLowerCase().includes(e))},[h]),w=parseInt(d.pax_total,10),x=parseInt(d.players_count,10),A=Number.isFinite(w)?Math.max(0,w-(Number.isFinite(x)?x:0)):0;return(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Datos básicos")),(0,a.createElement)(l.CardBody,null,v&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>{g(""),E("")}},v),(0,a.createElement)("div",{className:"proposal-basics"},(0,a.createElement)("div",{className:"proposal-basics__section"},(0,a.createElement)("div",{className:"proposal-basics__section-title"},"Identidad de la propuesta"),(0,a.createElement)("div",{className:"proposal-basics__grid"},(0,a.createElement)("div",{className:("proposal-basics__field proposal-basics__field--full "+("proposal_title"===b?"is-error":"")).trim(),ref:S("proposal_title")},(0,a.createElement)(l.TextControl,{label:"Título de la propuesta",value:d.proposal_title,onChange:N("proposal_title"),placeholder:"Escapada a la Costa del Sol"})),(0,a.createElement)("div",{className:("proposal-basics__field "+("customer_name"===b?"is-error":"")).trim(),ref:S("customer_name")},(0,a.createElement)(l.TextControl,{label:"Nombre del cliente *",value:d.customer_name,onChange:N("customer_name"),placeholder:"John Smith"})),(0,a.createElement)("div",{className:("proposal-basics__field "+("customer_email"===b?"is-error":"")).trim(),ref:S("customer_email")},(0,a.createElement)(l.TextControl,{label:"Email",value:d.customer_email,onChange:N("customer_email"),placeholder:"john@email.com"})))),(0,a.createElement)("div",{className:"proposal-basics__section"},(0,a.createElement)("div",{className:"proposal-basics__section-title"},"Fechas y pasajeros"),(0,a.createElement)("div",{className:"proposal-basics__grid proposal-basics__grid--dates"},(0,a.createElement)(P,{label:"Fecha inicio *",value:d.start_date,onChange:e=>{p(a=>{const t={...a,start_date:e};return t.end_date&&e&&t.end_date<e&&(t.end_date=e),t}),window.setTimeout(()=>{const e=document.getElementById("wp-travel-end-date");if(e&&(e.focus(),"function"==typeof e.showPicker))try{e.showPicker()}catch(e){}},0)},className:"start_date"===b?"is-error":"",fieldRef:S("start_date")}),(0,a.createElement)("div",{className:"proposal-basics__date-arrow","aria-hidden":"true"},"→"),(0,a.createElement)(P,{id:"wp-travel-end-date",label:"Fecha fin *",value:d.end_date,onChange:e=>{p(a=>a.start_date&&e&&e<a.start_date?{...a,end_date:a.start_date}:{...a,end_date:e})},className:"end_date"===b?"is-error":"",fieldRef:S("end_date")}),(0,a.createElement)("div",{className:("proposal-basics__field proposal-basics__field--pax "+("pax_total"===b?"is-error":"")).trim(),ref:S("pax_total")},(0,a.createElement)(l.TextControl,{label:"Pax *",type:"number",min:1,value:String(d.pax_total),onChange:N("pax_total")})),(0,a.createElement)("div",{className:("proposal-basics__field proposal-basics__field--pax "+("players_count"===b?"is-error":"")).trim(),ref:S("players_count")},(0,a.createElement)(l.TextControl,{label:"Jugadores",type:"number",min:0,value:String(null!==(o=d.players_count)&&void 0!==o?o:""),onChange:N("players_count"),help:`No jugadores: ${A}`})))),(0,a.createElement)("div",{className:"proposal-basics__section"},(0,a.createElement)("div",{className:"proposal-basics__section-title"},"Preferencias"),(0,a.createElement)("div",{className:"proposal-basics__grid"},(0,a.createElement)("div",{className:("proposal-basics__field "+("customer_language"===b?"is-error":"")).trim(),ref:S("customer_language")},(0,a.createElement)(l.SelectControl,{label:"Idioma",value:d.customer_language,options:k,onChange:N("customer_language")})),(0,a.createElement)("div",{className:("proposal-basics__field "+("customer_country"===b?"is-error":"")).trim(),ref:S("customer_country")},(0,a.createElement)(l.ComboboxControl,{label:"País",value:d.customer_country,options:C,onFilterValueChange:y,onChange:e=>N("customer_country")(e?e.toUpperCase():""),placeholder:"Busca país o código"})),(0,a.createElement)("div",{className:("proposal-basics__field "+("currency"===b?"is-error":"")).trim(),ref:S("currency")},(0,a.createElement)(l.SelectControl,{label:"Moneda",value:d.currency,options:T,onChange:N("currency")}))))),(0,a.createElement)("div",{className:"proposal-basics__actions"},(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{const e=(()=>{if(!d.customer_name?.trim())return{message:"El nombre del cliente es obligatorio.",field:"customer_name"};if(!d.start_date)return{message:"La fecha de inicio es obligatoria.",field:"start_date"};if(!d.end_date)return{message:"La fecha de fin es obligatoria.",field:"end_date"};if(d.end_date<d.start_date)return{message:"La fecha fin no puede ser anterior a la fecha inicio.",field:"end_date"};const e=parseInt(d.pax_total,10);if(Number.isNaN(e)||e<1)return{message:"Pax debe ser un numero >= 1.",field:"pax_total"};const a=parseInt(d.players_count,10);return Number.isNaN(a)||a<0?{message:"Jugadores debe ser un numero >= 0.",field:"players_count"}:a>e?{message:"Jugadores no puede ser mayor que Pax.",field:"players_count"}:d.customer_email&&!/^\S+@\S+\.\S+$/.test(d.customer_email)?{message:"El email no parece valido (si lo rellenas, que sea correcto).",field:"customer_email"}:d.customer_country&&2!==d.customer_country.length?{message:"Pais debe ser ISO2 (2 letras) o vacio.",field:"customer_country"}:null})();if(e)return g(e.message),E(e.field||""),void(e=>{const a=f.current[e];if(!a)return;a.scrollIntoView({behavior:"smooth",block:"center"});const t=a.querySelector("input, select, textarea, button");t&&"function"==typeof t.focus&&t.focus()})(e.field);_(!0),g("");const a={...d,pax_total:parseInt(d.pax_total,10),players_count:Math.max(0,parseInt(d.players_count,10)),customer_country:d.customer_country?d.customer_country.toUpperCase():""};try{if(i)return await u(i,a),void n?.({basics:a});const e=await s(a);r?.({proposalId:e.proposal_id,basics:a})}catch(e){g(e?.message||"Error creando la propuesta.")}finally{_(!1)}},disabled:m},v?"Revisa los campos marcados":"Continuar"),m&&(0,a.createElement)(l.Spinner,null))))}function B({label:e,type:r,valueTitle:n,onPick:i}){const[s,o]=(0,t.useState)(n||""),[c,u]=(0,t.useState)(!1),[d,p]=(0,t.useState)(!1),[m,_]=(0,t.useState)([]);return(0,t.useEffect)(()=>{o(n||"")},[n]),(0,t.useEffect)(()=>{if(!c)return;let e=!0;return p(!0),E({type:r,q:s}).then(a=>e&&_(Array.isArray(a)?a:[])).catch(()=>e&&_([])).finally(()=>e&&p(!1)),()=>{e=!1}},[s,c,r]),(0,a.createElement)("div",{style:{position:"relative",width:"100%",maxWidth:320,minWidth:0}},(0,a.createElement)(l.TextControl,{label:e,value:s,onChange:e=>{o(e),u(!0)},onFocus:()=>u(!0),placeholder:"hotel"===r?"Buscar hotel…":"Buscar campo…"}),c&&(0,a.createElement)("div",{style:{position:"absolute",zIndex:30,background:"#fff",border:"1px solid #ddd",borderRadius:8,width:"100%",maxHeight:220,overflow:"auto",boxShadow:"0 6px 18px rgba(0,0,0,.08)"}},d&&(0,a.createElement)("div",{style:{padding:8}},(0,a.createElement)(l.Spinner,null)),!d&&0===m.length&&(0,a.createElement)("div",{style:{padding:8,fontSize:12,opacity:.6}},"Sin resultados"),!d&&m.map(e=>(0,a.createElement)("button",{key:e.id,type:"button",onClick:()=>{i(e),u(!1)},style:{display:"block",width:"100%",padding:"8px 10px",border:0,background:"transparent",textAlign:"left",cursor:"pointer"}},e.title))))}function R({valueId:e,valueLabel:t,onSelect:l,disabled:r=!1,placeholder:n="Buscar proveedor en GIAV..."}){const[i,s]=(0,a.useState)(t||""),[o,c]=(0,a.useState)([]),[u,d]=(0,a.useState)(!1),[p,m]=(0,a.useState)(!1),[_,v]=(0,a.useState)(""),g=(0,a.useRef)(null);(0,a.useEffect)(()=>{t&&t!==i&&s(t)},[t]);return(0,a.createElement)("div",{style:{position:"relative"}},(0,a.createElement)("input",{type:"text",value:i,onChange:e=>{return a=e.target.value,s(a),d(!0),clearTimeout(g.current),void(g.current=setTimeout(()=>(async e=>{const a=(e||"").trim();if(a.length<2)return c([]),v(""),void d(!1);m(!0),v("");try{const e=await S({q:a,pageSize:20,pageIndex:0,includeDisabled:!1}),t=(Array.isArray(e)?e:Array.isArray(e?.items)?e.items:[]).map(e=>{var a,t,l,r,n,i,s,o;return{id:String(null!==(a=null!==(t=null!==(l=null!==(r=e.id)&&void 0!==r?r:e.Id)&&void 0!==l?l:e.ID)&&void 0!==t?t:e.proveedorId)&&void 0!==a?a:""),label:String(null!==(n=null!==(i=null!==(s=null!==(o=e.label)&&void 0!==o?o:e.NombreAlias)&&void 0!==s?s:e.Nombre)&&void 0!==i?i:e.title)&&void 0!==n?n:"")}}).filter(e=>e.id&&e.label);c(t),d(t.length>0)}catch(e){v(e?.message||"Error buscando proveedores en GIAV"),c([]),d(!1)}finally{m(!1)}})(a),250));var a},onFocus:()=>{o.length>0&&d(!0)},placeholder:n,disabled:r,style:{width:"100%"}}),(0,a.createElement)("div",{style:{fontSize:12,marginTop:6,opacity:.8}},e?(0,a.createElement)(a.Fragment,null,"ID seleccionado: ",(0,a.createElement)("strong",null,e)):null,p?(0,a.createElement)("span",{style:{marginLeft:10}},"Buscando…"):null,_?(0,a.createElement)("span",{style:{marginLeft:10,color:"crimson"}},_):null),u&&o.length>0&&(0,a.createElement)("div",{style:{position:"absolute",zIndex:20,top:"100%",left:0,right:0,background:"#fff",border:"1px solid #ddd",borderTop:"none",maxHeight:260,overflow:"auto"}},o.map(e=>(0,a.createElement)("div",{key:e.id,onMouseDown:a=>{a.preventDefault(),(e=>{s(e.label),d(!1),c([]),v(""),l?.(e)})(e)},style:{padding:"10px 12px",cursor:"pointer",borderBottom:"1px solid #f0f0f0"}},(0,a.createElement)("div",{style:{fontWeight:600}},e.label),(0,a.createElement)("div",{style:{fontSize:12,opacity:.75}},"ID: ",e.id)))))}const D="1734698",G="Proveedores varios",$=(new Date).toISOString().slice(0,10),F=[{label:"Hotel",value:"hotel"},{label:"Golf",value:"golf"},{label:"Transfer",value:"transfer"},{label:"Extra",value:"extra"},{label:"Paquete",value:"package"}],V=[{label:"Alojamiento y Desayuno",value:"AD"},{label:"Solo Alojamiento",value:"SA"},{label:"Media Pensión",value:"MP"},{label:"Pensión Completa",value:"PC"},{label:"Todo Incluido",value:"TI"},{label:"Según Programa",value:"SP"}];function L(e){const a=parseFloat(String(e).replace(",","."));return Number.isFinite(a)?a:0}function U(e,a=1){const t=parseInt(e,10);return Number.isFinite(t)?t:a}function j(e){return Math.round(100*(e+Number.EPSILON))/100}function q(e,a){return function(e,a){if(!e||!a)return 0;const t=new Date(`${e}T00:00:00`),l=new Date(`${a}T00:00:00`)-t;return!Number.isFinite(l)||l<=0?0:Math.round(l/864e5)}(e.start_date||a?.start_date||"",e.end_date||a?.end_date||"")}function O(e=0){return{double:{enabled:!0,rooms:1,pricing_basis:"per_room",net_price_per_night:"",margin_pct:e,pvp_manual_enabled:!1,pvp_price_per_night:"",nights_payable:0,free_nights_applied:0,discount_pct_applied:0,total_net:0,total_pvp:0},single:{enabled:!1,rooms:0,pricing_basis:"per_room",net_price_per_night:"",margin_pct:e,pvp_manual_enabled:!1,pvp_price_per_night:"",nights_payable:0,free_nights_applied:0,discount_pct_applied:0,total_net:0,total_pvp:0}}}function H(e,a,t){const l=Math.max(0,U(null!=a?a:0,0)),r=Math.max(0,U(null!=t?t:0,0));if(l<=0||r<=0||e<=0)return{freeNights:0,nightsPayable:Math.max(0,e)};const n=Math.floor(e/l),i=Math.min(e,n*r);return{freeNights:i,nightsPayable:Math.max(0,e-i)}}function z(e,a=0){var t,l;const r=e?.start_date||"",n=e?.end_date||"",i=O(a);return{service_type:"hotel",title:"",start_date:r,end_date:n,hotel_room_type:"",hotel_regimen:"",hotel_rooms:0,hotel_rate_basis:null,hotel_regimen:"",quantity:1,green_fees_per_person:1,number_of_players:null!==(t=null!==(l=e?.players_count)&&void 0!==l?l:e?.pax_total)&&void 0!==t?t:1,total_green_fees:0,unit_cost_net:"",unit_sell_price:"",use_markup:!0,markup_pct:a,lock_sell_price:!1,notes_public:"",notes_internal:"",package_components_text:"",display_name:"",use_manual_entry:!1,wp_object_type:null,wp_object_id:null,giav_entity_type:null,giav_entity_id:null,giav_supplier_id:D,giav_supplier_name:G,giav_mapping_status:"needs_review",show_supplier_picker:!1,supplier_override:!1,dates_inherited:!0,room_pricing:i,discounts:{discount_pct:0,free_nights_every:"",free_nights_count:""},giav_pricing:{giav_total_pvp:0,giav_total_net:0,giav_source:"double",giav_locked:!1}}}function K(e,a,t){var l,r;const n={...e};n.start_date||(n.start_date=a?.start_date||""),n.end_date||(n.end_date=a?.end_date||""),n.quantity=Math.max(1,U(n.quantity,1)),void 0!==n.hotel_rooms&&(n.hotel_rooms=Math.max(0,U(n.hotel_rooms,0))),n.unit_cost_net=Math.max(0,L(n.unit_cost_net));const i=n.use_markup?Math.max(0,L(null!==(l=null!==(r=n.markup_pct)&&void 0!==r?r:t)&&void 0!==l?l:0)):0;var s,o;if(n.markup_pct=i,n.lock_sell_price?n.unit_sell_price=Math.max(0,L(n.unit_sell_price)):n.unit_sell_price=(s=n.unit_cost_net,o=i,j(Math.max(0,L(s))*(1+Math.max(0,L(o))/100))),"hotel"===n.service_type){const e=q(n,a);n.hotel_nights=e;const t=function(e,a,t){var l,r,n,i,s;const o=q(e,a),c=Math.max(0,U(null!==(l=e.hotel_rooms)&&void 0!==l?l:0,0)),u=function(e={}){var a,t,l,r;return{discount_pct:(r=L(null!==(a=e.discount_pct)&&void 0!==a?a:0),Number.isFinite(r)?Math.min(50,Math.max(0,r)):0),free_nights_every:Math.max(0,U(null!==(t=e.free_nights_every)&&void 0!==t?t:0,0))||"",free_nights_count:Math.max(0,U(null!==(l=e.free_nights_count)&&void 0!==l?l:0,0))||""}}(e.discounts),{freeNights:d,nightsPayable:p}=H(o,u.free_nights_every,u.free_nights_count),m=e.use_markup?L(null!==(r=null!==(n=e.markup_pct)&&void 0!==n?n:t)&&void 0!==r?r:0):0,_=e.room_pricing||O(t),v=(e,a)=>{var t,l,r;const n=_?.[e]||{},i=null!==(t=a.net_price_per_night)&&void 0!==t?t:0,s=null!==(l=a.pvp_price_per_night)&&void 0!==l?l:0,o=void 0!==n.net_price_per_night&&""!==n.net_price_per_night,c=void 0!==n.pvp_price_per_night&&""!==n.pvp_price_per_night,d=void 0!==n.margin_pct&&""!==n.margin_pct,p=void 0!==n.rooms&&""!==n.rooms;return{enabled:"boolean"==typeof n.enabled?n.enabled:a.enabled,rooms:p?Math.max(0,U(null!==(r=n.rooms)&&void 0!==r?r:0,0)):a.rooms,pricing_basis:n.pricing_basis||a.pricing_basis,net_price_per_night:o?L(n.net_price_per_night):i,margin_pct:d?L(n.margin_pct):a.margin_pct,pvp_manual_enabled:"boolean"==typeof n.pvp_manual_enabled?n.pvp_manual_enabled:a.pvp_manual_enabled,pvp_price_per_night:c?L(n.pvp_price_per_night):s,nights_payable:0,free_nights_applied:0,discount_pct_applied:u.discount_pct,total_net:0,total_pvp:0}},g={enabled:!1,rooms:0,pricing_basis:"per_room",net_price_per_night:0,margin_pct:m,pvp_manual_enabled:!1,pvp_price_per_night:0},b={double:v("double",{enabled:!0,rooms:c>0?c:1,pricing_basis:"per_room",net_price_per_night:null!==(i=e.unit_cost_net)&&void 0!==i?i:0,margin_pct:m,pvp_manual_enabled:!!e.lock_sell_price,pvp_price_per_night:null!==(s=e.unit_sell_price)&&void 0!==s?s:0}),single:v("single",g)},E=["double","single"].map(e=>{var a;const t=b[e];if(!t.enabled)return{totalNet:0,totalPvp:0};const l=Math.max(0,U(null!==(a=t.rooms)&&void 0!==a?a:0,0)),r="double"===e&&t.pricing_basis||"per_room",n="per_person"===r?2*l:l,i=Math.max(0,t.net_price_per_night)*p*n*(1-u.discount_pct/100),s=t.pvp_manual_enabled?Math.max(0,t.pvp_price_per_night)*p*n:i*(1+Math.max(0,t.margin_pct)/100);return b[e]={...t,pricing_basis:r,nights_payable:p,free_nights_applied:d,discount_pct_applied:u.discount_pct,total_net:j(i),total_pvp:j(s)},{totalNet:j(i),totalPvp:j(s)}}),h=E.reduce((e,a)=>e+a.totalNet,0),y=E.reduce((e,a)=>e+a.totalPvp,0),f=["double","single"].filter(e=>b[e].enabled),N=1===f.length?f[0]:"custom",S={...e.giav_pricing,giav_total_net:j(h),giav_total_pvp:e.giav_pricing?.giav_locked?j(L(e.giav_pricing?.giav_total_pvp)):j(y),giav_source:e.giav_pricing?.giav_locked?"custom":N,giav_locked:!!e.giav_pricing?.giav_locked};return{discounts:u,roomPricing:b,giavPricing:S,totals:{nights:o,nightsPayable:p,freeNights:d,totalNet:j(h),totalPvp:j(y)}}}(n,a,i);n.room_pricing=t.roomPricing,n.discounts=t.discounts,n.giav_pricing=t.giavPricing,n.line_cost_net=t.totals.totalNet,n.line_sell_price=t.giavPricing.giav_total_pvp,n.quantity=1,n.unit_cost_net=t.totals.totalNet,n.unit_sell_price=t.giavPricing.giav_total_pvp}else if("golf"===n.service_type){var c;const e=Math.max(0,U(null!==(c=a?.players_count)&&void 0!==c?c:0,0)),t=e>0?e:1,{greenFeesPerPerson:l,totalGreenFees:r}=function(e={},a=1){var t,l,r;const n=Math.max(1,U(a,1));let i=Math.max(0,U(null!==(t=e.green_fees_per_person)&&void 0!==t?t:0,0)),s=Math.max(0,U(null!==(l=e.total_green_fees)&&void 0!==l?l:0,0));const o=Math.max(0,U(null!==(r=e.quantity)&&void 0!==r?r:0,0));return i>0?s=i*n:s>0?(i=Math.max(1,Math.round(s/n)),s=i*n):o>0?(s=o,i=Math.max(1,Math.round(s/n)),s=i*n):(i=1,s=i*n),{greenFeesPerPerson:i,totalGreenFees:s}}(n,t);n.number_of_players=e,n.green_fees_per_person=l,n.total_green_fees=r,n.quantity=r,n.line_cost_net=j(r*n.unit_cost_net),n.line_sell_price=j(r*n.unit_sell_price)}else n.line_cost_net=j(n.quantity*n.unit_cost_net),n.line_sell_price=j(n.quantity*n.unit_sell_price);return n}function W({item:e,idx:t,updateItem:r,currency:n,pax:i,basics:s,globalMarkupPct:o}){var c,u,d,p,m,_,v;const g=e.room_pricing||O(o),b=O(o),E=e=>g[e]||b[e],h=Math.max(0,U(null!==(c=E("double").rooms)&&void 0!==c?c:0,0)),y=Math.max(0,U(null!==(u=E("single").rooms)&&void 0!==u?u:0,0)),f=(E("double").enabled?2*h:0)+(E("single").enabled?y:0),N=f-i,S=N<0?`Faltan ${Math.abs(N)} pax por asignar a habitaciones`:N>0?`Sobran ${N} pax asignados`:"",C=Math.max(0,U(null!==(d=e.hotel_nights)&&void 0!==d?d:q(e,s),0)),{nightsPayable:w}=H(C,e.discounts?.free_nights_every,e.discounts?.free_nights_count),x=function(e={}){var a,t,l;const r=Math.max(0,L(null!==(a=e.discount_pct)&&void 0!==a?a:0)),n=Math.max(0,U(null!==(t=e.free_nights_every)&&void 0!==t?t:0,0)),i=Math.max(0,U(null!==(l=e.free_nights_count)&&void 0!==l?l:0,0)),s=[];return r>0&&s.push(`-${j(r)}%`),n>0&&i>0&&s.push(`+${i} gratis cada ${n}`),s.length>0?s.join(" "):"Sin descuentos"}(e.discounts),k=e.notes_public||e.notes_internal?"Ver notas":"Sin notas",T=(a,l)=>{const n=e.room_pricing||{},i={...n[a]||{},...l},s={...n,[a]:i};r(t,{room_pricing:s})},I=(a,l)=>{const n=e.discounts||{};r(t,{discounts:{...n,[a]:l}})};return(0,a.createElement)("div",{className:"service-card__hotel-panel"},(0,a.createElement)("div",{className:"service-card__hotel-occupancy"},["double","single"].map(e=>{var t,r,i,s;const c="double"===e?"Doble":"Individual",u=E(e);return(0,a.createElement)("div",{key:e,className:"service-card__hotel-occupancy-card"},(0,a.createElement)("div",{className:"service-card__hotel-occupancy-header"},(0,a.createElement)(l.ToggleControl,{label:`Cotizar ${c.toLowerCase()}`,checked:!!u.enabled,onChange:()=>T(e,{enabled:!u.enabled})}),(0,a.createElement)("span",{className:"service-card__hotel-occupancy-label"},c)),u.enabled&&(0,a.createElement)("div",{className:"service-card__hotel-occupancy-body"},(0,a.createElement)(l.TextControl,{label:`Habitaciones ${c.toLowerCase()}`,type:"number",min:1,value:String(null!==(t=u.rooms)&&void 0!==t?t:""),onChange:a=>T(e,{rooms:a})}),"double"===e&&(0,a.createElement)(l.SelectControl,{label:"Precio",value:u.pricing_basis||"per_room",options:[{label:"Por habitación",value:"per_room"},{label:"Por persona",value:"per_person"}],onChange:e=>T("double",{pricing_basis:e})}),(0,a.createElement)(l.TextControl,{label:`Neto por noche (${c.toLowerCase()})`,value:String(null!==(r=u.net_price_per_night)&&void 0!==r?r:""),onChange:a=>T(e,{net_price_per_night:a}),placeholder:"120"}),(0,a.createElement)("details",{className:"service-card__hotel-mode-details"},(0,a.createElement)("summary",null,"Margen y PVP"),(0,a.createElement)("div",{className:"service-card__hotel-mode-details-grid"},(0,a.createElement)(l.ToggleControl,{label:"PVP manual",checked:!!u.pvp_manual_enabled,onChange:()=>T(e,{pvp_manual_enabled:!u.pvp_manual_enabled})}),u.pvp_manual_enabled?(0,a.createElement)(l.TextControl,{label:`PVP por noche (${c.toLowerCase()})`,value:String(null!==(i=u.pvp_price_per_night)&&void 0!==i?i:""),onChange:a=>T(e,{pvp_price_per_night:a}),placeholder:"165"}):(0,a.createElement)(l.TextControl,{label:"Margen (%)",type:"number",min:0,value:String(null!==(s=u.margin_pct)&&void 0!==s?s:o),onChange:a=>T(e,{margin_pct:a})}))),(0,a.createElement)("div",{className:"service-card__hotel-total"},"Total hab. ",c.toLowerCase(),": ",n," ",j(u.total_pvp||0).toFixed(2))))})),(0,a.createElement)("div",{className:"service-card__hotel-allocation"},(0,a.createElement)("div",{className:"service-card__hotel-allocation-text"},"Personas asignadas: ",f," de ",i),S&&(0,a.createElement)(l.Notice,{status:"warning",isDismissible:!1},S)),(0,a.createElement)("div",{className:"service-card__subcard"},(0,a.createElement)("details",{className:"service-card__hotel-discounts-collapse"},(0,a.createElement)("summary",{className:"service-card__section-summary"},(0,a.createElement)("span",{className:"service-card__section-summary-title"},"Descuentos"),(0,a.createElement)("span",{className:"service-card__section-summary-meta"},x)),(0,a.createElement)("div",{className:"service-card__hotel-discounts"},(0,a.createElement)("div",{className:"service-card__hotel-discounts-grid"},(0,a.createElement)(l.TextControl,{label:"Descuento (%)",type:"number",min:0,max:50,value:String(null!==(p=e.discounts?.discount_pct)&&void 0!==p?p:0),onChange:e=>I("discount_pct",e)}),(0,a.createElement)(l.TextControl,{label:"Noches gratis (cada)",type:"number",min:0,value:String(null!==(m=e.discounts?.free_nights_every)&&void 0!==m?m:""),onChange:e=>I("free_nights_every",e)}),(0,a.createElement)(l.TextControl,{label:"Noches gratis (cantidad)",type:"number",min:0,value:String(null!==(_=e.discounts?.free_nights_count)&&void 0!==_?_:""),onChange:e=>I("free_nights_count",e)})),C>0&&(0,a.createElement)("div",{className:"service-card__hotel-discount-summary"},"Se cobran ",w," noches de ",C)))),(0,a.createElement)("div",{className:"service-card__subcard service-card__subcard--giav"},(0,a.createElement)("div",{className:"service-card__hotel-giav"},(0,a.createElement)("div",{className:"service-card__hotel-subtitle"},"Total para GIAV"),(0,a.createElement)("div",{className:"service-card__hotel-giav-grid"},(0,a.createElement)("div",{className:"service-card__hotel-giav-total"},(0,a.createElement)("div",{className:"service-card__hotel-giav-label"},"Total alojamiento (para GIAV)"),(0,a.createElement)("div",{className:"service-card__hotel-giav-value"},n," ",j(e.giav_pricing?.giav_total_pvp||0).toFixed(2))),(0,a.createElement)(l.ToggleControl,{label:"Editar total para GIAV",checked:!!e.giav_pricing?.giav_locked,onChange:()=>{const a=e.giav_pricing||{};r(t,{giav_pricing:{...a,giav_locked:!a.giav_locked}})}}),(0,a.createElement)(l.TextControl,{label:"Total editable",value:String(null!==(v=e.giav_pricing?.giav_total_pvp)&&void 0!==v?v:""),onChange:a=>(a=>{const l=e.giav_pricing||{};r(t,{giav_pricing:{...l,giav_total_pvp:a}})})(a),disabled:!e.giav_pricing?.giav_locked}),e.giav_pricing?.giav_locked&&(0,a.createElement)(l.Notice,{status:"warning",isDismissible:!1},"Este total se enviará a GIAV. No se recalculará automáticamente.")))),(0,a.createElement)("div",{className:"service-card__subcard"},(0,a.createElement)("details",{className:"service-card__hotel-notes"},(0,a.createElement)("summary",{className:"service-card__section-summary"},(0,a.createElement)("span",{className:"service-card__section-summary-title"},"Notas"),(0,a.createElement)("span",{className:"service-card__section-summary-meta"},k)),(0,a.createElement)("div",{className:"service-card__hotel-notes-grid"},(0,a.createElement)(l.TextControl,{label:"Notas para el cliente (itinerario)",value:e.notes_public||"",onChange:e=>r(t,{notes_public:e}),placeholder:"Incluye desayuno. Check-in 15:00."}),(0,a.createElement)(l.TextControl,{label:"Notas internas (solo uso interno)",value:e.notes_internal||"",onChange:e=>r(t,{notes_internal:e}),placeholder:"Neto negociado, release 14D."})))))}function J(e=[],a={}){if(!Array.isArray(e)||!e.length)return e;const t=a?.start_date||"",l=a?.end_date||"";let r=!1;const n=e.map(e=>e&&e.dates_inherited?e.start_date===t&&e.end_date===l?e:(r=!0,{...e,start_date:t,end_date:l,dates_inherited:!0}):e);return r?n:e}function Z({basics:e,initialItems:r=[],onBack:n,onNext:i,onDraftChange:s,requestIntentions:o=null}){var c,u;const d=e?.currency||"EUR",p=Math.max(1,U(null!==(c=e?.pax_total)&&void 0!==c?c:1,1)),m=Math.max(0,U(null!==(u=e?.players_count)&&void 0!==u?u:0,0)),[_,v]=(0,t.useState)(20),[g,b]=(0,t.useState)(!0),[E,y]=(0,t.useState)(""),[f,N]=(0,t.useState)(null),[S,C]=(0,t.useState)(null),[w,x]=(0,t.useState)(0),[k,T]=(0,t.useState)(null),[I,M]=(0,t.useState)(!1),[P,A]=(0,t.useState)([]),O=(0,t.useRef)(null),[H,Z]=(0,t.useState)(()=>(r.length?r:[z(e,20)]).map(a=>{const t={...a},l="boolean"==typeof t.dates_inherited,r=t.start_date||e?.start_date||"",n=t.end_date||e?.end_date||"";return t.start_date||(t.start_date=r),t.end_date||(t.end_date=n),t.dates_inherited=l?t.dates_inherited:r===(e?.start_date||"")&&n===(e?.end_date||""),K(t,e,20)})),Y=(0,t.useMemo)(()=>function(e){const a=e.reduce((e,a)=>(e.cost+=a.line_cost_net||0,e.sell+=a.line_sell_price||0,e),{cost:0,sell:0}),t=j(a.sell-a.cost),l=a.sell>0?j(t/a.sell*100):0;return{totals_cost_net:j(a.cost),totals_sell_price:j(a.sell),totals_margin_abs:t,totals_margin_pct:l}}(H),[H]);(0,t.useEffect)(()=>{if(!s)return;const e=window.setTimeout(()=>{s({items:H,totals:Y})},200);return()=>window.clearTimeout(e)},[H,Y,s]);const Q=(0,t.useMemo)(()=>{var a,t,l;const r=Math.max(0,U(null!==(a=e?.pax_total)&&void 0!==a?a:0,0)),n=U(null!==(t=null!==(l=e?.players_count)&&void 0!==l?l:r)&&void 0!==t?t:0,0),i=Math.min(Math.max(n,0),r),s={paxTotal:r,playersCount:i,nonPlayersCount:Math.max(0,r-i),golfTotal:0,totalDouble:0,totalSingle:0,doubleRooms:0,singleRooms:0};H.forEach(e=>{if("golf"===e.service_type&&(s.golfTotal+=L(e.line_sell_price||0)),"hotel"===e.service_type){const l=e.room_pricing||{};var a,t;l.double?.enabled&&(s.totalDouble+=L(l.double?.total_pvp||0),s.doubleRooms+=Math.max(0,U(null!==(a=l.double?.rooms)&&void 0!==a?a:0,0))),l.single?.enabled&&(s.totalSingle+=L(l.single?.total_pvp||0),s.singleRooms+=Math.max(0,U(null!==(t=l.single?.rooms)&&void 0!==t?t:0,0)))}});const o=L(Y.totals_sell_price||0),c=o,u=s.doubleRooms>0?s.totalDouble/(2*s.doubleRooms):0,d=s.singleRooms>0?s.totalSingle/s.singleRooms:0,p=s.totalDouble||0,m=s.totalSingle||0,_=s.golfTotal||0,v=o-(p+m)-_,g=u+(s.paxTotal>0?v/s.paxTotal:0),b=s.playersCount>0?g+_/s.playersCount:null,E=s.doubleRooms>0&&s.singleRooms>0;let h=null;return E&&(h=Math.max(0,d-u)),{...s,totalTrip:o,baseTotal:c,priceNonPlayerDouble:g,pricePlayerDouble:b,supplementSingle:h,hasSingleSupplement:E}},[e?.pax_total,e?.players_count,H,Y.totals_sell_price]);(0,t.useEffect)(()=>{Z(a=>{const t=J(a,e);return t===a?a:t.map((t,l)=>t===a[l]?t:K(t,e,_))})},[e?.start_date,e?.end_date,_,e]),(0,t.useEffect)(()=>{Z(a=>a.map(a=>K(a,e,_)))},[p]),(0,t.useEffect)(()=>{null!=w&&w>=H.length&&x(H.length?H.length-1:null)},[H.length,w]),(0,t.useEffect)(()=>{if(null==k)return;const e=document.querySelector(`[data-service-index="${k}"]`);if(!e)return;e.scrollIntoView({behavior:"smooth",block:"start"}),((e,a)=>{if(!e)return;if(!a?.service_type){const a=e.querySelector("select");if(a&&"function"==typeof a.focus)return void a.focus()}const t=e.querySelector(".service-card__grid--context input");t&&"function"==typeof t.focus?t.focus():ne(e)})(e,H[k]),C(k);const a=window.setTimeout(()=>C(null),1200);return T(null),()=>window.clearTimeout(a)},[k,H]);const X=(a,t)=>{Z(l=>{const r=[...l],n={...r[a],...t};return r[a]=K(n,e,_),r})},ee=(0,t.useMemo)(()=>H.map((e,a)=>(e=>{const a=[],t={};if((e.title||e.display_name||"").trim()||(a.push("Falta título"),t.title="Completa el título."),"hotel"!==e.service_type&&"golf"!==e.service_type||e.giav_supplier_id||(a.push("Falta proveedor"),t.supplier="Selecciona un proveedor."),"hotel"===e.service_type){var l,r,n;const i=e.room_pricing||{},s=!!i.double?.enabled,o=!!i.single?.enabled;s||o||(a.push("Activa doble/individual"),t.pricing="Activa doble y/o individual.");const c=(e,a)=>{var t;const l=i[e]||{};return l.enabled?U(null!==(t=l.rooms)&&void 0!==t?t:0,0)<1?`Habitaciones ${a} < 1`:L(l.net_price_per_night)<=0?`Neto ${a} faltante`:l.pvp_manual_enabled&&L(l.pvp_price_per_night)<=0?`PVP manual ${a} faltante`:"":""},u=c("double","doble"),d=c("single","individual");(u||d)&&(a.push(u||d),t.pricing="Revisa pricing de habitaciones.");const m=s?Math.max(0,U(null!==(l=i.double?.rooms)&&void 0!==l?l:0,0)):0,_=o?Math.max(0,U(null!==(r=i.single?.rooms)&&void 0!==r?r:0,0)):0;(s?2*m:0)+(o?_:0)!==p&&(a.push("Pax no cuadra"),t.pricing="Ajusta pax doble/individual."),L(null!==(n=e.giav_pricing?.giav_total_pvp)&&void 0!==n?n:0)<=0&&(a.push("Total GIAV faltante"),t.pricing="Completa total GIAV.")}"golf"===e.service_type&&U(e.green_fees_per_person,1)<1&&(a.push("Green-fees faltante"),t.greenFees="Define green-fees por jugador."),["transfer","extra","package"].includes(e.service_type)&&U(e.quantity,1)<1&&(a.push("Cantidad inválida"),t.quantity="Cantidad debe ser >= 1."),L(e.unit_sell_price)<=0&&(a.push("PVP unitario faltante"),t.unitSell="Define PVP unitario.");const i=("hotel"===e.service_type||"golf"===e.service_type)&&["needs_review","missing"].includes(e.giav_mapping_status);return{issues:a,fieldErrors:t,status:a.length>0?"error":i?"pending":"completed",hasMappingWarning:i}})(e)),[H,p]),ae=e=>{x(e),N(e),window.setTimeout(()=>{const a=document.querySelector(`[data-service-index="${e}"]`);a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),ne(a))},50)},te=e=>{X(e,{show_supplier_picker:!H[e].show_supplier_picker})},le=e=>!!e.show_supplier_picker,re=()=>{const e=[],a=[];return ee.forEach((e,t)=>{e.issues.length>0&&a.push({index:t,title:`Servicio ${t+1}`,details:e.issues.slice(0,2).join(" · ")})}),H.some(e=>"golf"===e.service_type)&&m<=0&&e.push('Define "Jugadores" en Datos básicos.'),Y.totals_sell_price<=0&&e.push("El PVP total debe ser > 0."),{errors:e,serviceErrors:a}},ne=e=>{if(!e)return;const a=e.querySelector("input, select, textarea, button");a&&"function"==typeof a.focus&&a.focus()},ie=(0,t.useMemo)(()=>re(),[ee,H,m,Y.totals_sell_price]),se=ie.serviceErrors.length>0||ie.errors.length>0,oe=(e,{missing:t,tooltip:l}={})=>t?(0,a.createElement)("span",{className:"services-summary__value services-summary__value--missing",title:l},"—"):(0,a.createElement)("span",{className:"services-summary__value"},e);return(0,t.useEffect)(()=>{I&&(se||(y(""),A([])))},[I,se]),(0,a.createElement)(l.Card,{className:"services-step"},(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"services-step__title"},(0,a.createElement)("strong",null,"Servicios & precios"),(0,a.createElement)("span",{className:"services-step__subtitle"},"Añade servicios con detalle, márgenes y proveedor."))),(0,a.createElement)(l.CardBody,{ref:O},o&&(0,a.createElement)("div",{className:"services-intention-banner"},(0,a.createElement)("strong",null,"Intenciones detectadas"),o.golf?.requested&&(0,a.createElement)("span",null,"Solicitud indica ",o.golf.green_fees_per_player||"—"," green-fees por jugador."),o.flights?.requested&&(0,a.createElement)("span",null,"Requiere vuelos desde ",o.flights.departure_airport||"—","."),o.package&&(0,a.createElement)("span",null,"Paquete sugerido: ",o.package),o.more_info&&(0,a.createElement)("span",null,"Más info: ",o.more_info)),(0,a.createElement)("div",{className:"services-toolbar"},(0,a.createElement)("div",{className:"services-toolbar__controls"},(0,a.createElement)(l.TextControl,{label:"Margen por defecto (%)",type:"number",min:0,value:String(_),onChange:e=>v(L(e))}),(0,a.createElement)(l.ToggleControl,{label:"Aplicar a nuevas líneas",checked:g,onChange:()=>b(e=>!e)}),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>{Z(a=>a.map(a=>K({...a,markup_pct:_},e,_)))}},"Aplicar a todas")),(0,a.createElement)("div",{className:"services-toolbar__summary"},(0,a.createElement)("div",{className:"services-toolbar__label"},"PVP total"),(0,a.createElement)("div",{className:"services-toolbar__value"},d," ",Y.totals_sell_price.toFixed(2)))),(0,a.createElement)("div",{className:"services-items"},H.map((t,r)=>{var n,i,s;const o=w===r,c=ee[r]||{issues:[],status:"pending",hasMappingWarning:!1,fieldErrors:{}},u=c.status,v=(a=>{const t=a.start_date||e?.start_date||"",l=a.end_date||e?.end_date||"",r=t&&l?`${t} → ${l}`:"Fechas por definir",n=`${d} ${j(a.line_sell_price||0).toFixed(2)}`;return"golf"===a.service_type?`${r} · Jugadores: ${m||p} · ${n}`:"hotel"===a.service_type?`${r} · Pax: ${p} · ${n}`:["transfer","extra","package"].includes(a.service_type)?`Cantidad: ${U(null!==(i=a.quantity)&&void 0!==i?i:1,1)} · ${n}`:`${r} · ${n}`;var i})(t),g=c.hasMappingWarning?"Proveedor GIAV pendiente":"",b=c.issues.slice(0,2).join(" · "),E=c.fieldErrors||{};return(0,a.createElement)("div",{key:r,className:`service-card service-card--status-${u} ${o?"is-open":""} ${f===r?"is-error":""} ${S===r?"is-highlighted":""}`.trim(),"data-service-index":r},(0,a.createElement)("div",{className:"service-card__header"},(0,a.createElement)("div",{className:"service-card__title"},(0,a.createElement)("div",{className:"service-card__eyebrow"},"Servicio ",r+1),(0,a.createElement)("div",{className:"service-card__name"},F.find(e=>e.value===t.service_type)?.label||"Servicio"," ·"," ",t.title?.trim()||t.display_name?.trim()||"Sin título"),(0,a.createElement)("div",{className:"service-card__summary"},v),"pending"===u&&g&&(0,a.createElement)("div",{className:"service-card__missing"},g),"error"===u&&b&&(0,a.createElement)("div",{className:"service-card__missing"},b)),(0,a.createElement)("div",{className:"service-card__meta"},(0,a.createElement)("div",{className:`service-card__badge service-card__badge--${u}`},"completed"===u&&"✓ OK","pending"===u&&"Pendiente","error"===u&&`${c.issues.length} errores`),(0,a.createElement)(l.Button,{variant:"tertiary",className:"service-card__toggle",onClick:()=>x(o?null:r)},o?"Ocultar":"Ver detalle"),(0,a.createElement)("div",{className:"service-card__total"},(0,a.createElement)("span",null,"Total línea"),(0,a.createElement)("strong",null,d," ",j(t.line_sell_price||0).toFixed(2))),(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>(e=>{Z(a=>a.filter((a,t)=>t!==e)),x(a=>null==a?a:a===e?Math.max(0,e-1):a>e?a-1:a)})(r),disabled:1===H.length},"Eliminar"))),o&&(0,a.createElement)("div",{className:"service-card__content"},(0,a.createElement)("div",{className:"service-card__section"},(0,a.createElement)("div",{className:"service-card__section-title"},"Selección y contexto"),(0,a.createElement)("div",{className:"service-card__grid service-card__grid--context"},(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.SelectControl,{label:"Tipo de servicio",value:t.service_type,options:F,onChange:e=>X(r,{service_type:e})})),"hotel"===t.service_type||"golf"===t.service_type?(0,a.createElement)(a.Fragment,null,t.use_manual_entry?(0,a.createElement)("div",{className:"service-card__field "+(E.title?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"hotel"===t.service_type?"Hotel (manual) *":"Campo de golf (manual) *",value:t.display_name||"",onChange:e=>X(r,{display_name:e,title:e}),placeholder:"hotel"===t.service_type?"Ej: Hotel X (fuera de cat├ílogo)":"Ej: Campo Y (fuera de cat├ílogo)"}),E.title&&(0,a.createElement)("div",{className:"service-card__field-error"},E.title)):(0,a.createElement)("div",{className:"service-card__field "+(E.title?"is-error":"")},(0,a.createElement)(B,{label:"hotel"===t.service_type?"Hotel":"Campo de golf",type:"hotel"===t.service_type?"hotel":"golf",valueTitle:t.title,onPick:async e=>{const a="hotel"===t.service_type?"hotel":"course";X(r,{title:e.title,display_name:e.title,wp_object_type:a,wp_object_id:e.id,supplier_override:!1});try{const t=await h({wp_object_type:a,wp_object_id:e.id});var l,n;t?.status&&"missing"!==t.status?X(r,{giav_mapping_status:t.status,giav_entity_type:t.giav_entity_type,giav_entity_id:t.giav_entity_id,giav_supplier_id:null!==(l=t.giav_supplier_id)&&void 0!==l?l:D,giav_supplier_name:null!==(n=t.giav_supplier_name)&&void 0!==n?n:G}):X(r,{giav_mapping_status:"needs_review",giav_entity_type:"supplier",giav_entity_id:D,giav_supplier_id:D,giav_supplier_name:G})}catch{X(r,{giav_mapping_status:"needs_review",giav_entity_type:"supplier",giav_entity_id:D,giav_supplier_id:D,giav_supplier_name:G})}}}),E.title&&(0,a.createElement)("div",{className:"service-card__field-error"},E.title)),(0,a.createElement)("div",{className:"service-card__field service-card__field--toggle"},(0,a.createElement)(l.ToggleControl,{label:"Entrada manual (fuera de catálogo)",checked:!!t.use_manual_entry,onChange:()=>{if(t.use_manual_entry)X(r,{use_manual_entry:!1,wp_object_type:null,wp_object_id:null,show_supplier_picker:!1,giav_mapping_status:"missing",supplier_override:!1,display_name:""});else{const e=t.display_name||t.title||"";X(r,{use_manual_entry:!0,wp_object_type:"manual",wp_object_id:0,show_supplier_picker:!0,giav_entity_type:"supplier",giav_entity_id:t.giav_supplier_id||D,giav_mapping_status:t.giav_supplier_id===D?"needs_review":"active",giav_supplier_id:t.giav_supplier_id||D,giav_supplier_name:t.giav_supplier_name||G,supplier_override:!1,display_name:e,title:e})}}})),(0,a.createElement)("div",{className:"service-card__supplier"},!le(t)&&(0,a.createElement)("div",{className:"service-card__supplier-actions"},(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>te(r)},"Cambiar proveedor")),le(t)&&(0,a.createElement)(a.Fragment,null,!t.use_manual_entry&&(0,a.createElement)("div",{className:"service-card__field service-card__field--toggle"},(0,a.createElement)(l.ToggleControl,{label:"Proveedor (opcional)",checked:!!t.show_supplier_picker,onChange:()=>te(r)})),(0,a.createElement)(R,{selectedId:t.giav_supplier_id||D,selectedLabel:t.giav_supplier_name||G,disabled:!1,onPick:e=>{const a=String(e?.id||""),l=String(e?.label||"");a&&X(r,{giav_entity_type:"supplier",giav_entity_id:a,giav_supplier_id:a,giav_supplier_name:l,giav_mapping_status:a===D?"needs_review":"active",supplier_override:!t.use_manual_entry})}}),E.supplier&&(0,a.createElement)("div",{className:"service-card__field-error"},E.supplier)))):(0,a.createElement)("div",{className:"service-card__field "+(E.title?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"T├¡tulo / descripci├│n *",value:t.title,onChange:e=>X(r,{title:e})}),E.title&&(0,a.createElement)("div",{className:"service-card__field-error"},E.title)),"hotel"===t.service_type&&(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Tipo de habitación",value:t.hotel_room_type||"",onChange:e=>X(r,{hotel_room_type:e}),placeholder:"Deluxe / Sea View..."})),"hotel"===t.service_type&&(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.SelectControl,{label:"Régimen",value:t.hotel_regimen||"",options:[{label:"Seleccionar",value:""},...V],onChange:e=>X(r,{hotel_regimen:e})})))),(0,a.createElement)("div",{className:"service-card__section"},(0,a.createElement)("div",{className:"service-card__section-title"},"Fechas y ocupación"),(0,a.createElement)("div",{className:"service-card__date-status"},(0,a.createElement)("span",{className:"service-card__date-label "+(t.dates_inherited?"is-inherited":"is-custom")},t.dates_inherited?"Fechas del viaje":"Fechas personalizadas"),!t.dates_inherited&&(0,a.createElement)(l.Button,{variant:"tertiary",className:"service-card__date-reset",onClick:()=>(a=>{X(a,{start_date:e?.start_date||"",end_date:e?.end_date||"",dates_inherited:!0})})(r)},"Restablecer fechas del viaje")),(0,a.createElement)("div",{className:"service-card__grid service-card__grid--dates"},(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Fecha inicio",type:"date",value:t.start_date,onChange:a=>((a,t)=>{Z(l=>{const r=[...l],n=r[a],i=t||"",s=n.end_date&&i&&n.end_date<i?i:n.end_date;return r[a]=K({...n,start_date:i,end_date:s,dates_inherited:!1},e,_),r}),window.setTimeout(()=>{const e=document.getElementById(`wp-travel-end-date-${a}`);if(e&&(e.focus(),"function"==typeof e.showPicker))try{e.showPicker()}catch(e){}},0)})(r,a),min:$,className:"service-card__date-start"})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{id:`wp-travel-end-date-${r}`,label:"Fecha fin",type:"date",value:t.end_date,onChange:e=>((e,a)=>X(e,{end_date:a}))(r,e),min:t.start_date||void 0})),"hotel"===t.service_type?(0,a.createElement)(a.Fragment,null,(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Noches",type:"number",min:0,value:String(null!==(n=t.hotel_nights)&&void 0!==n?n:q(t,e)),onChange:a=>((a,t)=>{const l=H[a].start_date||e?.start_date;if(l){const e=function(e,a){if(!e)return"";const t=new Date(`${e}T00:00:00`);return Number.isFinite(t.getTime())?(t.setDate(t.getDate()+Math.max(0,a)),t.toISOString().slice(0,10)):""}(l,U(t,1));X(a,{end_date:e})}})(r,a)}))):"golf"===t.service_type?(0,a.createElement)(a.Fragment,null,(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Jugadores",type:"number",min:1,value:String(m||p),disabled:!0,help:"Definido en Datos basicos"})),(0,a.createElement)("div",{className:"service-card__field "+(E.greenFees?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"Green-fees por jugador *",type:"number",min:1,value:String(null!==(i=t.green_fees_per_person)&&void 0!==i?i:""),onChange:e=>X(r,{green_fees_per_person:e})}),E.greenFees&&(0,a.createElement)("div",{className:"service-card__field-error"},E.greenFees)),(0,a.createElement)("div",{className:"service-card__golf-summary"},"Total green-fees (interno): ",U(m||p,1)," x ",U(t.green_fees_per_person,0)," ="," ",U(t.total_green_fees,0))):(0,a.createElement)("div",{className:"service-card__field "+(E.quantity?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"transfer"===t.service_type?"Cantidad (servicios)":"package"===t.service_type?"Cantidad (paquetes)":"Cantidad",type:"number",min:1,value:String(t.quantity),onChange:e=>X(r,{quantity:e})}),E.quantity&&(0,a.createElement)("div",{className:"service-card__field-error"},E.quantity)))),(0,a.createElement)("div",{className:"service-card__section service-card__section--pricing"},(0,a.createElement)("div",{className:"service-card__section-title"},"Pricing"),E.pricing&&(0,a.createElement)("div",{className:"service-card__field-error service-card__field-error--inline"},E.pricing),"hotel"===t.service_type?(0,a.createElement)(W,{item:t,idx:r,updateItem:X,currency:d,pax:p,basics:e,globalMarkupPct:_}):(0,a.createElement)("div",{className:"service-card__pricing"},(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Coste neto (unit.)",value:String(t.unit_cost_net),onChange:e=>X(r,{unit_cost_net:e}),placeholder:"120"})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.ToggleControl,{label:"Usar margen",checked:!!t.use_markup,onChange:()=>X(r,{use_markup:!t.use_markup})})),t.use_markup&&(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.TextControl,{label:"Margen (%)",type:"number",min:0,value:String(null!==(s=t.markup_pct)&&void 0!==s?s:_),onChange:e=>X(r,{markup_pct:e})})),(0,a.createElement)("div",{className:"service-card__field"},(0,a.createElement)(l.ToggleControl,{label:"PVP manual",checked:!!t.lock_sell_price,onChange:()=>X(r,{lock_sell_price:!t.lock_sell_price})})),(0,a.createElement)("div",{className:"service-card__field "+(E.unitSell?"is-error":"")},(0,a.createElement)(l.TextControl,{label:"PVP (unit.)",value:String(t.unit_sell_price),onChange:e=>X(r,{unit_sell_price:e}),placeholder:"165",disabled:!t.lock_sell_price}),E.unitSell&&(0,a.createElement)("div",{className:"service-card__field-error"},E.unitSell)))),"package"===t.service_type&&(0,a.createElement)("div",{className:"service-card__section service-card__section--package"},(0,a.createElement)("div",{className:"service-card__section-title"},"Detalle del paquete"),(0,a.createElement)("div",{className:"service-card__package"},(0,a.createElement)(l.TextControl,{label:"Incluye (una l├¡nea por item)",value:t.package_components_text||"",onChange:e=>X(r,{package_components_text:e}),placeholder:"3 noches\n2 green-fees\nDesayuno incluido"}))),"hotel"!==t.service_type&&(0,a.createElement)("div",{className:"service-card__section service-card__section--notes"},(0,a.createElement)("div",{className:"service-card__section-title"},"Notas"),(0,a.createElement)("details",{className:"service-card__notes-details"},(0,a.createElement)("summary",null,"Mostrar notas"),(0,a.createElement)("div",{className:"service-card__notes"},(0,a.createElement)(l.TextControl,{label:"Notas para el cliente (itinerario)",value:t.notes_public||"",onChange:e=>X(r,{notes_public:e}),placeholder:"Incluye desayuno. Check-in 15:00."}),(0,a.createElement)(l.TextControl,{label:"Notas internas (solo uso interno)",value:t.notes_internal||"",onChange:e=>X(r,{notes_internal:e}),placeholder:"Neto negociado, release 14D."}))))))})),(0,a.createElement)("div",{className:"services-add"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>{const a=H.length-1,t=a>=0?ee[a]:null;("error"!==t?.status||window.confirm("Tienes un servicio incompleto. ¿Crear otro igualmente?"))&&Z(a=>{const t=[...a,z(e,_)],l=t.length-1;return x(l),T(l),t})}},"+ Añadir servicio")),(0,a.createElement)("div",{className:"services-summary"},(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Total viaje"),oe(`${d} ${j(Q.totalTrip).toFixed(2)}`,{missing:Y.totals_sell_price<=0,tooltip:"Completa servicios para calcular."}),(0,a.createElement)("div",{className:"services-summary__meta"},"Jugadores: ",Q.playersCount," | No jugadores: ",Q.nonPlayersCount)),Q.playersCount>0&&(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Precio jugador en doble"),oe(`${d} ${j(Q.pricePlayerDouble||0).toFixed(2)}`,{missing:Q.playersCount<=0,tooltip:"Completa jugadores y servicios para calcular."})),Q.nonPlayersCount>0&&(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Precio no jugador en doble"),oe(`${d} ${j(Q.priceNonPlayerDouble||0).toFixed(2)}`,{missing:Q.nonPlayersCount<=0,tooltip:"Completa no jugadores para calcular."})),Q.hasSingleSupplement&&(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"services-summary__label"},"Suplemento individual"),oe(`${d} ${j(Q.supplementSingle||0).toFixed(2)}`,{missing:!Q.hasSingleSupplement,tooltip:"Completa habitaciones para calcular."}))),(0,a.createElement)("div",{className:"services-footer"},(E||I&&P.length>0)&&(0,a.createElement)("div",{className:"services-footer__errors"},(0,a.createElement)("div",{className:"services-footer__errors-header"},(0,a.createElement)("span",null,"Error summary"),(0,a.createElement)(l.Button,{variant:"link",onClick:()=>{O.current&&O.current.scrollIntoView({behavior:"smooth",block:"start"})}},"Ver arriba")),E&&(0,a.createElement)("div",{className:"services-footer__errors-message"},E),(0,a.createElement)("ul",null,(P.length>0?P:ie.serviceErrors).slice(0,3).map(e=>(0,a.createElement)("li",{key:e.index},(0,a.createElement)("button",{type:"button",onClick:()=>ae(e.index)},e.title,": ",e.details)))),ie.serviceErrors.length>3&&(0,a.createElement)("div",{className:"services-footer__errors-more"},"+",ie.serviceErrors.length-3," más")),(0,a.createElement)("div",{className:"services-footer__bar"},(0,a.createElement)("div",{className:"services-footer__left"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:n},"Volver")),(0,a.createElement)("div",{className:"services-footer__summary"},(0,a.createElement)("span",null,"Total viaje"),(0,a.createElement)("strong",null,d," ",j(Q.totalTrip).toFixed(2))),(0,a.createElement)("div",{className:"services-footer__right"},(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>{const{errors:e,serviceErrors:a}=re();if(M(!0),a.length>0||e.length>0){const t=a.length>0?`Faltan datos en ${a.length} servicios. Te llevo al primero.`:e[0];return y(t),A(a),void((e,a)=>{if(e.length>0)ae(e[0].index);else if(a.length>0){N(null);const e=document.querySelector(".services-step");e&&(e.scrollIntoView({behavior:"smooth",block:"start"}),ne(e))}})(a,e)}y(""),A([]),N(null),i({items:H,totals:Y})},disabled:se&&I,title:se?"Completa los campos obligatorios para continuar.":""},E?"Revisa los campos marcados":"Continuar"))))))}function Y(e){const a=parseFloat(e);return Number.isFinite(a)?Math.round(100*(a+Number.EPSILON))/100:0}function Q(e){const a=parseFloat(String(e).replace(",","."));return Number.isFinite(a)?a:0}function X(e,a=0){const t=parseInt(e,10);return Number.isFinite(t)?t:a}function ee({proposalId:e,basics:r,items:n,totals:i,onBack:s,onSent:o,mode:c="create",versionNumber:u=1}){const[d,p]=(0,t.useState)(!1),[v,g]=(0,t.useState)(""),b="undefined"!=typeof window&&window.CASANOVA_GESTION_RESERVAS?"wp-travel-giav-portal":"wp-travel-giav-admin",E=(0,t.useMemo)(()=>{const e={crm_customer_id:null,customer_name:r.customer_name,customer_email:r.customer_email,customer_country:r.customer_country,customer_language:r.customer_language,proposal_title:r.proposal_title,start_date:r.start_date,end_date:r.end_date,pax_total:r.pax_total,players_count:r.players_count,currency:r.currency,status:"sent"},a=(n||[]).map((e,a)=>{var t,l,r,n,i,s,o,c,u,d,p,m,_,v,g,b,E,h,y,f,N,S,C,w,x,k,T,I;return{day_index:null!==(t=e.day_index)&&void 0!==t?t:null,service_type:e.service_type,wp_object_type:null!==(l=e.wp_object_type)&&void 0!==l?l:null,wp_object_id:null!==(r=e.wp_object_id)&&void 0!==r?r:null,giav_entity_type:null!==(n=e.giav_entity_type)&&void 0!==n?n:null,giav_entity_id:null!==(i=e.giav_entity_id)&&void 0!==i?i:null,giav_supplier_id:null!==(s=e.giav_supplier_id)&&void 0!==s?s:null,giav_supplier_name:null!==(o=e.giav_supplier_name)&&void 0!==o?o:null,supplier_source:null!==(c=e.supplier_source)&&void 0!==c?c:null,supplier_resolution_chain:Array.isArray(e.supplier_resolution_chain)?e.supplier_resolution_chain:[],preflight_ok:null!==(u=e.preflight_ok)&&void 0!==u?u:null,warnings:Array.isArray(e.warnings)?e.warnings:[],blocking:Array.isArray(e.blocking)?e.blocking:[],supplier_override:!!e.supplier_override,title:null!==(d=e.title)&&void 0!==d?d:`Item ${a+1}`,display_name:null!==(p=e.display_name)&&void 0!==p?p:null,start_date:e.start_date||null,end_date:e.end_date||null,quantity:null!==(m=e.quantity)&&void 0!==m?m:1,pax_quantity:null!==(_=e.pax_quantity)&&void 0!==_?_:null,hotel_rate_basis:null!==(v=e.hotel_rate_basis)&&void 0!==v?v:null,hotel_nights:null!==(g=e.hotel_nights)&&void 0!==g?g:null,hotel_rooms:null!==(b=e.hotel_rooms)&&void 0!==b?b:null,hotel_room_type:null!==(E=e.hotel_room_type)&&void 0!==E?E:"",hotel_regimen:null!==(h=e.hotel_regimen)&&void 0!==h?h:"",room_pricing:null!==(y=e.room_pricing)&&void 0!==y?y:null,discounts:null!==(f=e.discounts)&&void 0!==f?f:null,giav_pricing:null!==(N=e.giav_pricing)&&void 0!==N?N:null,package_components:Array.isArray(e.package_components)?e.package_components:[],package_components_text:null!==(S=e.package_components_text)&&void 0!==S?S:"",green_fees_per_person:null!==(C=e.green_fees_per_person)&&void 0!==C?C:null,number_of_players:null!==(w=e.number_of_players)&&void 0!==w?w:null,total_green_fees:null!==(x=e.total_green_fees)&&void 0!==x?x:null,unit_cost_net:Y(e.unit_cost_net),unit_sell_price:Y(e.unit_sell_price),line_cost_net:Y(e.line_cost_net),line_sell_price:Y(e.line_sell_price),use_markup:!!e.use_markup,markup_pct:Y(null!==(k=e.markup_pct)&&void 0!==k?k:0),lock_sell_price:!!e.lock_sell_price,notes_public:null!==(T=e.notes_public)&&void 0!==T?T:"",notes_internal:null!==(I=e.notes_internal)&&void 0!==I?I:""}}),t=i||{totals_cost_net:0,totals_sell_price:0,totals_margin_abs:0,totals_margin_pct:0};return{header:e,items:a,totals:{totals_cost_net:Y(t.totals_cost_net),totals_sell_price:Y(t.totals_sell_price),totals_margin_abs:Y(t.totals_margin_abs),totals_margin_pct:Y(t.totals_margin_pct)},template_id:null,terms_version:null,metadata:{created_at:(new Date).toISOString(),created_by:null,source:b,schema_version:"v2"}}},[r,n,i]),h=E?.header||{},y=E?.totals||{},f=Array.isArray(E?.items)?E.items:[],N=(0,t.useMemo)(()=>{let e=0,a=0;return f.forEach(t=>{const l=Array.isArray(t?.warnings)?t.warnings:[],r=Array.isArray(t?.blocking)?t.blocking:[];e+=l.length,a+=r.length}),{warningCount:e,blockingCount:a}},[f]),S=N.blockingCount>0?"error":N.warningCount>0?"warning":"success",C=N.blockingCount>0?`Hay ${N.blockingCount} servicios con errores`:N.warningCount>0?`Hay ${N.warningCount} avisos en servicios`:"Servicios listos para enviar",w=(0,t.useMemo)(()=>{var e,a,t;const l=Math.max(0,X(null!==(e=h?.pax_total)&&void 0!==e?e:0,0)),r=X(null!==(a=null!==(t=h?.players_count)&&void 0!==t?t:l)&&void 0!==a?a:0,0),n=Math.min(Math.max(r,0),l),i={paxTotal:l,playersCount:n,nonPlayersCount:Math.max(0,l-n),golfTotal:0,totalDouble:0,totalSingle:0,doubleRooms:0,singleRooms:0};f.forEach(e=>{if("golf"===e.service_type&&(i.golfTotal+=Q(e.line_sell_price||0)),"hotel"===e.service_type){const l=e.room_pricing||{};var a,t;l.double?.enabled&&(i.totalDouble+=Q(l.double?.total_pvp||0),i.doubleRooms+=Math.max(0,X(null!==(a=l.double?.rooms)&&void 0!==a?a:0,0))),l.single?.enabled&&(i.totalSingle+=Q(l.single?.total_pvp||0),i.singleRooms+=Math.max(0,X(null!==(t=l.single?.rooms)&&void 0!==t?t:0,0)))}});const s=Q(y?.totals_sell_price||0),o=s,c=i.doubleRooms>0?i.totalDouble/(2*i.doubleRooms):0,u=i.singleRooms>0?i.totalSingle/i.singleRooms:0,d=s-(i.totalDouble+i.totalSingle)-i.golfTotal,p=c+(i.paxTotal>0?d/i.paxTotal:0),m=i.playersCount>0?p+i.golfTotal/i.playersCount:null,_=i.doubleRooms>0&&i.singleRooms>0;let v=null;return _&&(v=Math.max(0,u-c)),{...i,totalTrip:s,baseTotal:o,priceNonPlayerDouble:p,pricePlayerDouble:m,supplementSingle:v,hasSingleSupplement:_}},[h?.pax_total,h?.players_count,f,y?.totals_sell_price]),x="edit"===c?"Guardar nueva versión":h.customer_email?"Enviar propuesta":"Crear enlace";return(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Preview y envío")),(0,a.createElement)(l.CardBody,null,v&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>g("")},v),(0,a.createElement)(l.Notice,{status:S,isDismissible:!1},C),(0,a.createElement)(l.Notice,{status:"info",isDismissible:!1},"El cliente vera solo el total del paquete. El desglose por lineas queda guardado internamente en la version."),(0,a.createElement)("div",{className:"proposal-preview"},(0,a.createElement)("div",{className:"proposal-preview__header"},(0,a.createElement)("div",{className:"proposal-preview__name"},h.customer_name),(0,a.createElement)("div",{className:"proposal-preview__meta"},h.start_date," - ",h.end_date," | Pax: ",h.pax_total," | Moneda: ",h.currency)),(0,a.createElement)("div",{className:"proposal-preview__includes"},(0,a.createElement)("div",{className:"proposal-preview__includes-title"},"Incluye"),(0,a.createElement)("div",{className:"preview-items"},f.map((e,t)=>{const l=Array.isArray(e?.warnings)?e.warnings:[],r=Array.isArray(e?.blocking)?e.blocking:[],n=e.display_name||e.title||`Item ${t+1}`,i=e.giav_supplier_name||"Proveedor no especificado",s=r.length>0,o=l.length>0;return(0,a.createElement)("div",{key:t,className:"preview-item"},(0,a.createElement)("div",{className:"preview-item__main"},(0,a.createElement)("div",{className:"preview-item__title"},(0,a.createElement)("strong",null,e.service_type?.toUpperCase())," - ",n),(0,a.createElement)("div",{className:"preview-item__supplier"},"Proveedor: ",i),"hotel"===e.service_type&&e.hotel_room_type?(0,a.createElement)("div",{className:"preview-item__meta"},"Habitacion: ",e.hotel_room_type):null,"package"===e.service_type&&e.package_components_text?(0,a.createElement)("div",{className:"preview-item__meta"},"Incluye: ",e.package_components_text.split("\n").filter(Boolean).join(", ")):null,s&&(0,a.createElement)("div",{className:"preview-item__blocking"},(0,a.createElement)("span",{className:"preview-item__badge preview-item__badge--error"},"Error"),"Este servicio impide la confirmacion."),s&&(0,a.createElement)("details",{className:"preview-item__details"},(0,a.createElement)("summary",null,"Ver motivos"),(0,a.createElement)("ul",null,r.map((e,t)=>(0,a.createElement)("li",{key:t},e?.message||"Revision requerida")))),o&&(0,a.createElement)("details",{className:"preview-item__details"},(0,a.createElement)("summary",null,(0,a.createElement)("span",{className:"preview-item__badge preview-item__badge--warning"},"Aviso"),"Ver avisos (",l.length,")"),(0,a.createElement)("ul",null,l.map((e,t)=>(0,a.createElement)("li",{key:t},e?.message||"Aviso"))))))}))),(0,a.createElement)("div",{className:"proposal-preview__totals"},(0,a.createElement)("div",{className:"proposal-preview__totals-label"},"Total viaje"),(0,a.createElement)("div",{className:"proposal-preview__totals-value"},h.currency," ",Y(w.totalTrip).toFixed(2)),w.playersCount>0&&(0,a.createElement)("div",{className:"proposal-preview__totals-line"},"Precio jugador en doble: ",h.currency," ",Y(w.pricePlayerDouble||0).toFixed(2)),(0,a.createElement)("div",{className:"proposal-preview__totals-line"},"Precio no jugador en doble: ",h.currency," ",Y(w.priceNonPlayerDouble||0).toFixed(2)),w.hasSingleSupplement&&(0,a.createElement)("div",{className:"proposal-preview__totals-line"},"Suplemento individual: ",h.currency," ",Y(w.supplementSingle||0).toFixed(2)),(0,a.createElement)("div",{className:"proposal-preview__totals-note"},"Precios por persona. El suplemento individual aplica por persona alojada en habitacion individual."))),(0,a.createElement)("div",{className:"proposal-preview__actions"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:s,disabled:d},"Volver"),(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{p(!0),g("");const a=function(){const a=e&&Number(e)>0?Number(e):null;if(a)return a;return(()=>{try{const e=window.location.search||"";if(!e)return null;const a=new URLSearchParams(e),t=["proposal_id","id","proposalId","proposalId"];for(let e of t){const t=a.get(e);if(t){const e=parseInt(t,10);if(Number.isFinite(e)&&e>0)return e}}}catch(e){}return null})()||null}();try{"undefined"!=typeof process&&process&&process.env}catch(e){}if(!a||Number(a)<=0)return p(!1),void g("No se pudo enviar: falta el identificador de propuesta válido (proposalId).");if("Enviar propuesta"!==x||window.confirm("Confirmar envio de la propuesta?"))try{const e="edit"===c?await _(a,E,u):await m(a,E,u);o({versionId:e.version_id,publicToken:e.public_token,publicUrl:e.public_url,status:e.status,snapshot:E})}catch(e){g(e?.message||"Error enviando la propuesta.")}finally{p(!1)}else p(!1)},disabled:d},x),d&&(0,a.createElement)(l.Spinner,null))))}const ae={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",queued:"En cola",synced:"Sincronizada",error:"Error",revoked:"Revocada",lost:"Perdida"},te=e=>{if(!e)return"-";const a=String(e),t=a.includes("T")?a:a.replace(" ","T"),l=new Date(t);return Number.isNaN(l.getTime())?e:new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short"}).format(l)};function le({onExit:e,mode:r="create",initialProposal:n=null,initialSnapshot:i=null,nextVersionNumber:s=1,showStepper:o=!1}){const[c,u]=(0,t.useState)(1),[d,p]=(0,t.useState)(n?.id||null),[m,_]=(0,t.useState)(n?.status||"draft"),[v]=(0,t.useState)(n?.accepted_at||""),[g]=(0,t.useState)(n?.proposal_token||""),[b,E]=(0,t.useState)(n?.public_url||""),[h,y]=(0,t.useState)(null),[f,N]=(0,t.useState)(!1),S="undefined"!=typeof window&&!!window.CASANOVA_GESTION_RESERVAS,C=(0,t.useMemo)(()=>{if(!n&&!i)return null;const e=i?.header||{};return{proposal_title:e.proposal_title||n?.proposal_title||"",customer_name:e.customer_name||n?.customer_name||"",customer_email:e.customer_email||n?.customer_email||"",customer_country:e.customer_country||n?.customer_country||"",customer_language:e.customer_language||n?.customer_language||"en",start_date:e.start_date||n?.start_date||"",end_date:e.end_date||n?.end_date||"",pax_total:e.pax_total||n?.pax_total||1,currency:e.currency||n?.currency||"EUR"}},[n,i]),[w,x]=(0,t.useState)(C),k=(0,t.useMemo)(()=>{const e=n?.source_meta_json;if(e)try{const a=JSON.parse(e);if(a?.intentions)return a.intentions}catch(e){}return i?.intentions||null},[n?.source_meta_json,i?.intentions]),[T,I]=(0,t.useState)(i?.items||[]),[M,P]=(0,t.useState)(i?.totals||null),[B,R]=(0,t.useState)(null),[D,G]=(0,t.useState)(null);let $=null;if(1===c)$=(0,a.createElement)(A,{initialValues:w||{customer_language:"en",currency:"EUR",pax_total:1},onNext:({basics:e})=>{x(e),I(a=>J(a,e)),u(2)},onCreated:({proposalId:e,basics:a})=>{p(e),x(a),I(e=>J(e,a)),u(2)},proposalId:d});else if(2===c)$=(0,a.createElement)(Z,{basics:w,initialItems:T,onDraftChange:({items:e,totals:a})=>{I(e),P(a)},onBack:()=>u(1),onNext:({items:e,totals:a})=>{I(e),P(a),u(3)},requestIntentions:k});else if(3===c)$=(0,a.createElement)(ee,{proposalId:d,basics:w,items:T,totals:M,mode:r,versionNumber:s,onBack:()=>u(2),onSent:({versionId:e,snapshot:a,publicUrl:t,publicToken:l,status:r})=>{G(e),R(a||null),t&&E(t),l&&y(l),r&&_(r),u(4)}});else if(4===c){const t=b||((e,a)=>{if(!e)return"";const t=`${window.location.origin}/travel-proposal/${e}/`;return a?`${window.location.origin}/travel-proposal/${e}/v/${a}/`:t})(g,h),n=ae[m]||m||"-",i=v?`Aceptada el ${te(v)}`:"Pendiente",s=(({email:e,name:a,publicUrl:t})=>{if(!e||!t)return"";const l=`${a?`Hola ${a},`:"Hola,"}\n\nAquí tienes el enlace a tu propuesta:\n${t}\n\nQuedamos a tu disposición para cualquier duda.`;return`mailto:${e}?subject=${encodeURIComponent("Tu propuesta de viaje")}&body=${encodeURIComponent(l)}`})({email:w?.customer_email,name:w?.customer_name,publicUrl:t}),o=(e=>{if("undefined"==typeof window)return"";const a=window.CASANOVA_GESTION_RESERVAS;return a?.pageBase&&e?`${a.pageBase.replace(/\/$/,"")}#/propuesta/${e}`:""})(d)||((e={})=>{const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.delete("proposal_id"),a.searchParams.delete("action"),Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t?a.searchParams.set(e,t):a.searchParams.delete(e)}),a.toString()})({proposal_id:d}),c=S?"Ver detalle en portal":"Ir al repositorio / ver detalle",u=async()=>{await async function(e){if(!e)return!1;try{if(navigator.clipboard?.writeText)return await navigator.clipboard.writeText(e),!0}catch(e){}const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.top="-1000px",document.body.appendChild(a),a.focus(),a.select();const t=document.execCommand("copy");return document.body.removeChild(a),t}(t)&&(N(!0),window.setTimeout(()=>N(!1),1500))};$=(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Preview y envio")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)(l.Notice,{status:"success",isDismissible:!1},"edit"===r?"Nueva version creada:":"Propuesta enviada. Version creada:"," ",(0,a.createElement)("strong",null,D)),"accepted"===m&&v?(0,a.createElement)(l.Notice,{status:"info",isDismissible:!1},"Aceptada el ",te(v),"."):null,(0,a.createElement)("div",{className:"proposal-wizard__final-meta"},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Estado:")," ",n),(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Aceptacion:")," ",i),(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"GIAV:")," El expediente se creara tras la aceptacion del cliente.")),(0,a.createElement)("div",{className:"proposal-wizard__final-actions"},"accepted"!==m?(0,a.createElement)(l.Button,{variant:"primary",onClick:u,disabled:!t},f?"Enlace copiado":"Copiar enlace publico"):null,s?(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.location.assign(s)},"Enviar email al cliente"):null,t?(0,a.createElement)(l.Button,{variant:"link",href:t,target:"_blank",rel:"noopener noreferrer"},"Abrir vista publica"):null,o?(0,a.createElement)(l.Button,{variant:"link",href:o},c):null,(0,a.createElement)(l.Button,{variant:"tertiary",onClick:e},"Salir"))))}if(!$)return null;if(!o)return $;const F=c>3?3:c;return(0,a.createElement)("div",{className:"proposal-wizard"},(0,a.createElement)("div",{className:"proposal-wizard__stepper"},[{title:"Datos basicos",subtitle:"Identidad y fechas"},{title:"Servicios y precios",subtitle:"Hotel, golf y extras"},{title:"Vista previa y envio",subtitle:"Resumen final"}].map((e,t)=>{const l=t+1,r=F===l?"is-active":F>l?"is-complete":"is-upcoming";return(0,a.createElement)("div",{key:e.title,className:`proposal-wizard__step ${r}`.trim()},(0,a.createElement)("div",{className:"proposal-wizard__step-index"},l),(0,a.createElement)("div",{className:"proposal-wizard__step-text"},(0,a.createElement)("div",{className:"proposal-wizard__step-title"},e.title),(0,a.createElement)("div",{className:"proposal-wizard__step-subtitle"},e.subtitle)))})),(0,a.createElement)("div",{className:"proposal-wizard__content"},$))}function re({selectedId:e,selectedLabel:r,onPick:n,disabled:i}){const[s,o]=(0,t.useState)(r||""),[c,u]=(0,t.useState)([]),[d,p]=(0,t.useState)(!1),[m,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(""),b=(0,t.useRef)(null);(0,t.useEffect)(()=>{(r||"")!==s&&r&&o(r)},[r]);const E=e?"Seleccionado: "+(r?`${r} (#${e})`:`#${e}`):"Se valida en GIAV al guardar (Proveedor_GET).";return(0,a.createElement)("div",{style:{position:"relative"}},(0,a.createElement)(l.TextControl,{value:s,onChange:function(e){o(e),clearTimeout(b.current),b.current=setTimeout(()=>async function(e){const a=(e||"").trim();if(a.length<2)return u([]),g(""),void p(!1);_(!0),g("");try{const e=await S({q:a,pageSize:20,pageIndex:0,includeDisabled:!1}),t=(Array.isArray(e)?e:Array.isArray(e?.items)?e.items:[]).map(e=>{var a,t,l,r,n,i,s,o;return{id:String(null!==(a=null!==(t=null!==(l=null!==(r=e.id)&&void 0!==r?r:e.ID)&&void 0!==l?l:e.Id)&&void 0!==t?t:e.proveedorId)&&void 0!==a?a:""),label:String(null!==(n=null!==(i=null!==(s=null!==(o=e.label)&&void 0!==o?o:e.NombreAlias)&&void 0!==s?s:e.Nombre)&&void 0!==i?i:e.title)&&void 0!==n?n:"")}}).filter(e=>e.id&&e.label);u(t),p(t.length>0)}catch(e){g(e?.message||"No se pudo buscar en GIAV."),u([]),p(!1)}finally{_(!1)}}(e),250)},onFocus:()=>{c.length>0&&p(!0)},placeholder:"Busca por nombre (mín. 2 letras)…",disabled:i,help:E}),m&&(0,a.createElement)("div",{style:{marginTop:6}},(0,a.createElement)(l.Spinner,null)),v&&(0,a.createElement)("div",{style:{marginTop:6,color:"#b32d2e",fontSize:12}},v),d&&c.length>0&&(0,a.createElement)("div",{style:{position:"absolute",zIndex:30,left:0,right:0,top:"100%",background:"#fff",border:"1px solid #ddd",borderTop:"none",maxHeight:260,overflow:"auto"}},c.map(e=>(0,a.createElement)("div",{key:e.id,onMouseDown:a=>{a.preventDefault(),function(e){o(e.label),u([]),p(!1),g(""),n?.(e)}(e)},style:{padding:"10px 12px",cursor:"pointer",borderBottom:"1px solid #f0f0f0"}},(0,a.createElement)("div",{style:{fontWeight:600}},e.label),(0,a.createElement)("div",{style:{fontSize:12,opacity:.75}},"ID: ",e.id)))))}function ne({status:e}){let t="⚠️ missing";return"active"===e&&(t="✅ active"),"needs_review"===e&&(t="🟠 needs_review"),"deprecated"===e&&(t="⛔ deprecated"),(0,a.createElement)("span",{style:{whiteSpace:"nowrap"}},t)}function ie(){const[e,r]=(0,t.useState)("hotel"),[n,i]=(0,t.useState)(""),[s,o]=(0,t.useState)(!1),[c,u]=(0,t.useState)(null),[d,p]=(0,t.useState)({items:[],total:0}),[m,_]=(0,t.useState)({}),[v,g]=(0,t.useState)(null),[b,E]=(0,t.useState)({}),[h,S]=(0,t.useState)({id:"",label:""}),[C,w]=(0,t.useState)(!1),x=(0,t.useMemo)(()=>d.items||[],[d]),k=(0,t.useMemo)(()=>Object.keys(b).filter(e=>b[e]),[b]),T=(0,t.useMemo)(()=>x.length>0&&x.every(e=>b[I(e)]),[x,b]);function I(e){return`${e.wp_object_type}:${e.wp_object_id}`}function M(e){var a,t,l;const r=I(e),n=m[r]||{},i=e.mapping||{status:"missing"};return{providerId:null!==(a=n.providerId)&&void 0!==a?a:i.giav_entity_id?String(i.giav_entity_id):"",providerName:null!==(t=n.providerName)&&void 0!==t?t:i.giav_supplier_name?String(i.giav_supplier_name):"",status:null!==(l=n.status)&&void 0!==l?l:i.status||"missing"}}async function P(){o(!0),u(null);try{const a=await y({type:e,q:n});p(a||{items:[],total:0})}catch(e){u({status:"error",message:e?.message||"No se pudo cargar el mapeo."}),p({items:[],total:0})}finally{o(!1)}}return(0,t.useEffect)(()=>{P()},[e]),(0,a.createElement)("div",{style:{maxWidth:1100,margin:"24px auto"}},(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"GIAV Mapping")),(0,a.createElement)(l.CardBody,null,c&&(0,a.createElement)(l.Notice,{status:c.status,isDismissible:!0,onRemove:()=>u(null)},c.message),(0,a.createElement)("div",{style:{display:"flex",gap:12,alignItems:"flex-end",marginBottom:12}},(0,a.createElement)(l.SelectControl,{label:"Tipo",value:e,options:[{label:"Hoteles",value:"hotel"},{label:"Campos",value:"golf"}],onChange:e=>r(e)}),(0,a.createElement)(l.TextControl,{label:"Buscar",value:n,onChange:e=>i(e),placeholder:"hotel"===e?"Nombre del hotel…":"Nombre del campo…"}),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>P(),disabled:s},s?(0,a.createElement)(l.Spinner,null):"Actualizar")),(0,a.createElement)("div",{style:{display:"flex",gap:12,alignItems:"flex-end",marginBottom:12}},(0,a.createElement)("div",{style:{flex:1}},(0,a.createElement)("label",{style:{display:"block",fontSize:12,marginBottom:4,opacity:.8}},"Aplicar proveedor a seleccionados"),(0,a.createElement)(re,{selectedId:h?.id,selectedLabel:h?.label,disabled:C,onPick:({id:e,label:a})=>S({id:e,label:a})})),(0,a.createElement)(l.Button,{variant:"primary",onClick:async function(){const a="hotel"===e?"hotel":"course",t=k;if(h?.id)if(0!==t.length){w(!0),u(null);try{var l,r;const e=t.map(e=>{const a=String(e).split(":");return{wp_object_id:parseInt(a[1],10)}}).filter(e=>e.wp_object_id>0),n=await N({wp_object_type:a,giav_supplier_id:String(h.id),items:e,status:"active",match_type:"batch"}),i=`Mapeo en lote aplicado. Creados: ${null!==(l=n?.created)&&void 0!==l?l:0}, actualizados: ${null!==(r=n?.updated)&&void 0!==r?r:0}${n?.errors?.length?`, errores: ${n.errors.length}`:""}.`;u({status:!1===n?.ok?"warning":"success",message:i}),E({}),await P()}catch(e){u({status:"error",message:e?.message||"No se pudo aplicar el mapeo en lote."})}finally{w(!1)}}else u({status:"warning",message:"Selecciona al menos una fila para aplicar el mapeo en lote."});else u({status:"warning",message:"Selecciona un proveedor para aplicar en lote."})},isBusy:C,disabled:C},"Aplicar en lote (",k.length,")")),(0,a.createElement)("div",{style:{overflowX:"auto"}},(0,a.createElement)("table",{className:"widefat striped"},(0,a.createElement)("thead",null,(0,a.createElement)("tr",null,(0,a.createElement)("th",{style:{width:30}},(0,a.createElement)("input",{type:"checkbox",checked:T,onChange:e=>function(e){const a={};x.forEach(t=>{a[I(t)]=!!e}),E(a)}(e.target.checked)})),(0,a.createElement)("th",null,"Objeto"),(0,a.createElement)("th",null,"Estado"),(0,a.createElement)("th",null,"Proveedor (GIAV)"),(0,a.createElement)("th",null,"Acción"))),(0,a.createElement)("tbody",null,s&&(0,a.createElement)("tr",null,(0,a.createElement)("td",{colSpan:"4",style:{padding:16,textAlign:"center"}},(0,a.createElement)(l.Spinner,null))),!s&&x.map(e=>{const t=I(e),r=M(e);return(0,a.createElement)("tr",{key:t},(0,a.createElement)("td",null,(0,a.createElement)("input",{type:"checkbox",checked:!!b[t],onChange:a=>function(e,a){const t=I(e);E(e=>({...e,[t]:!!a}))}(e,a.target.checked)})),(0,a.createElement)("td",null,(0,a.createElement)("div",{style:{fontWeight:600}},e.title),(0,a.createElement)("div",{style:{opacity:.7,fontSize:12}},e.wp_object_type," #",e.wp_object_id)),(0,a.createElement)("td",null,(0,a.createElement)(ne,{status:e.mapping?.status||"missing"})),(0,a.createElement)("td",null,(0,a.createElement)(re,{selectedId:r.providerId,selectedLabel:r.providerName||e.mapping?.giav_supplier_name||"",disabled:v&&v!==t,onPick:({id:a,label:t})=>function(e,a){const t=I(e);_(e=>({...e,[t]:{...e[t]||{},...a}}))}(e,{providerId:a,providerName:t,status:"active"})}),e.mapping?.giav_entity_id&&(0,a.createElement)("div",{style:{opacity:.7,fontSize:12,marginTop:4}},"Actual: #",e.mapping.giav_entity_id," ",e.mapping?.giav_supplier_name?(0,a.createElement)("span",null,"(",e.mapping.giav_supplier_name,")"):null," ","(",e.mapping.status,")")),(0,a.createElement)("td",null,(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>async function(e){const a=I(e),t=M(e);if(!t.providerId)return void u({status:"warning",message:"Selecciona un proveedor de GIAV."});g(a),u(null);const l="1734698"===String(t.providerId);try{await f({wp_object_type:e.wp_object_type,wp_object_id:e.wp_object_id,giav_entity_type:"supplier",giav_entity_id:String(t.providerId),giav_supplier_id:String(t.providerId),giav_supplier_name:t.providerName||null,status:l?"needs_review":"active",match_type:l?"auto_generic":"manual"}),u({status:"success",message:"Mapeo guardado (validado en GIAV)."}),_(e=>{const t={...e};return delete t[a],t}),await P()}catch(e){u({status:"error",message:e?.message||"No se pudo guardar el mapeo."})}finally{g(null)}}(e),isBusy:v===t,disabled:v&&v!==t},"Guardar")))}),!s&&0===(d.items||[]).length&&(0,a.createElement)("tr",null,(0,a.createElement)("td",{colSpan:"4",style:{padding:16,textAlign:"center",opacity:.7}},"Sin resultados."))))))))}const se=[{key:"package",label:"Paquete"},{key:"nombre",label:"Nombre"},{key:"apellido",label:"Apellido"},{key:"email",label:"Email"},{key:"telefono",label:"Teléfono"},{key:"fecha_llegada",label:"Fecha llegada"},{key:"fecha_regreso",label:"Fecha regreso"},{key:"green_fees_per_player",label:"Green-fees por jugador"},{key:"jugadores",label:"Jugadores"},{key:"no_jugadores",label:"No jugadores"},{key:"vuelos_checkbox",label:"Checkbox vuelos"},{key:"aeropuerto_salida",label:"Aeropuerto salida"},{key:"mas_info",label:"Más info"}];function oe(){const[e,r]=(0,t.useState)({es_form_id:"",en_form_id:""}),[n,i]=(0,t.useState)({}),[s,o]=(0,t.useState)({}),[c,u]=(0,t.useState)(!0),[d,p]=(0,t.useState)(null),[m,_]=(0,t.useState)(!1),[v,g]=(0,t.useState)(null),b=async()=>{u(!0),p(null);try{const e=await C();r({es_form_id:e.forms?.es_form_id||"",en_form_id:e.forms?.en_form_id||""}),o(e.mappings||{}),i(e.fields||{})}catch(e){p({status:"error",message:e.message||"No se pudo cargar la configuración."})}finally{u(!1)}};(0,t.useEffect)(()=>{b()},[]);const E=(e,a)=>{r(t=>({...t,[e]:a}))},h=(0,t.useMemo)(()=>[{label:"Formulario ES",key:"es_form_id",id:e.es_form_id},{label:"Formulario EN",key:"en_form_id",id:e.en_form_id}],[e]);return(0,a.createElement)("div",{style:{maxWidth:1100,margin:"24px auto"}},(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Solicitudes recibidas (Gravity Forms)")),(0,a.createElement)(l.CardBody,null,d&&(0,a.createElement)(l.Notice,{status:d.status,isDismissible:!0,onRemove:()=>p(null)},d.message),(0,a.createElement)("div",{style:{display:"grid",gap:12,marginBottom:18}},(0,a.createElement)("p",{style:{margin:0,color:"#475569"}},"Configura los IDs de los formularios en español y en inglés para que el plugin pueda sincronizar las entradas."),(0,a.createElement)("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:12}},(0,a.createElement)(l.TextControl,{label:"Form ID (ES)",value:e.es_form_id,onChange:e=>E("es_form_id",e),placeholder:"Id del formulario en español"}),(0,a.createElement)(l.TextControl,{label:"Form ID (EN)",value:e.en_form_id,onChange:e=>E("en_form_id",e),placeholder:"Id del formulario en inglés"})),(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{_(!0),p(null);try{await w({es_form_id:e.es_form_id,en_form_id:e.en_form_id}),p({status:"success",message:"IDs guardados correctamente."}),await b()}catch(e){p({status:"error",message:e.message||"No se pudieron guardar los IDs."})}finally{_(!1)}},isBusy:m,disabled:m},"Guardar formularios")),c?(0,a.createElement)("div",{style:{textAlign:"center",padding:32}},(0,a.createElement)(l.Spinner,null)):h.map(e=>{if(!e.id)return(0,a.createElement)("div",{key:e.key,style:{padding:16,border:"1px solid #e5e7eb",borderRadius:12,marginBottom:16}},(0,a.createElement)("strong",null,e.label),(0,a.createElement)("p",{style:{marginTop:4,color:"#6b7280"}},"Configura primero el ID del formulario para ver el mapping."));const t=n[e.id]||[],r=s[e.id]||{};return(0,a.createElement)("div",{key:e.id,style:{marginBottom:24,borderRadius:16,border:"1px solid #e5e7eb",padding:16,background:"#f8fafc"}},(0,a.createElement)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,e.label),(0,a.createElement)("p",{style:{margin:"4px 0 0",color:"#475569"}},"Form ID #",e.id)),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>(async e=>{g(e),p(null);try{const a={};se.forEach(t=>{s[e]?.[t.key]&&(a[t.key]=s[e][t.key])}),await x(e,a),p({status:"success",message:"Mapeo guardado."}),g(null),await b()}catch(e){p({status:"error",message:e.message||"No se pudo guardar el mapeo."}),g(null)}})(e.id),isBusy:v===e.id,disabled:v===e.id},"Guardar mapeo")),(0,a.createElement)("div",{style:{marginTop:16,display:"grid",gap:12}},se.map(t=>(0,a.createElement)(l.TextControl,{key:t.key,label:`${t.label} - ID del campo`,value:r[t.key]||"",onChange:a=>((e,a,t)=>{o(l=>({...l,[e]:{...l[e]||{},[a]:t}}))})(e.id,t.key,a),placeholder:`ID del campo ${t.label}`}))),t.length?(0,a.createElement)("details",{style:{marginTop:16}},(0,a.createElement)("summary",{style:{cursor:"pointer",fontWeight:600,color:"#1d4ed8"}},"Campos disponibles (ID / etiqueta)"),(0,a.createElement)("div",{style:{display:"grid",gap:6,marginTop:8}},t.map(t=>(0,a.createElement)("div",{key:`${e.id}-${t.id}`,style:{fontSize:13,color:"#475569"}},"#",t.id," — ",t.label||"Sin etiqueta"," ",(0,a.createElement)("small",null,"(",t.type,")"))))):(0,a.createElement)("p",{style:{marginTop:16,color:"#6b7280"}},"Sin campos registrados para este formulario."))}))))}function ce(e){if(!e)return"-";const a=new Date(e);return Number.isNaN(a.getTime())?e:new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short"}).format(a)}const ue={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",queued:"En cola",synced:"Sincronizada",error:"Error",revoked:"Revocada",lost:"Perdida"},de={client:"Cliente",admin:"Admin"},pe={pending:"Pendiente",confirmed:"Confirmada"},me={none:"No iniciado",pending:"En proceso",ok:"Creado",error:"Error"};function _e(e={}){const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.delete("proposal_id"),a.searchParams.delete("action"),Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t?a.searchParams.set(e,t):a.searchParams.delete(e)}),a.toString()}function ve({proposalId:e}){var r;const[n,i]=(0,t.useState)(!1),[s,o]=(0,t.useState)(""),[u,d]=(0,t.useState)(null),[p,m]=(0,t.useState)(!1),[_,E]=(0,t.useState)(null),[h,y]=(0,t.useState)(""),[f,N]=(0,t.useState)(!1),[S,C]=(0,t.useState)(!1),w=async()=>{i(!0),o("");try{const a=await c(e);d(a)}catch(e){o(e?.message||"No se pudo cargar la propuesta.")}finally{i(!1)}};if((0,t.useEffect)(()=>{if(!e)return d(null),void o("Propuesta no encontrada.");w()},[e]),(0,t.useEffect)(()=>{if(u?.proposal){const e=u.proposal.current_version_id;y(e?String(e):"")}},[u?.proposal?.current_version_id]),n&&!u)return(0,a.createElement)(l.Spinner,null);if(!u?.proposal&&s)return(0,a.createElement)("div",{style:{display:"grid",gap:12}},(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>o("")},s),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.location.href=_e()},"Volver al listado"));if(!u?.proposal)return(0,a.createElement)("div",{style:{display:"grid",gap:12}},(0,a.createElement)(l.Notice,{status:"warning",isDismissible:!1},"Propuesta no encontrada."),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.location.href=_e()},"Volver al listado"));const{proposal:x,versions:k=[]}=u,T=pe[x.confirmation_status]||("accepted"===x.status?"Pendiente":"-"),I=k.find(e=>Number(e.id)===Number(x.accepted_version_id)),M=k.find(e=>String(e.id)===String(h)),P=k.map(e=>{var a;return{label:`#${null!==(a=e.version_number)&&void 0!==a?a:e.id} · ${ce(e.created_at)}`,value:String(e.id)}}),A=ue[x.status]||x.status||"-",B=x.giav_sync_status||"none",R=me[B]||B||"-",D="accepted"===x.status,G=Boolean(x.giav_expediente_id),$="error"===B,F="pending"===B,V=[{label:"ID cliente",value:x.giav_client_id},{label:"ID expediente",value:x.giav_expediente_id},{label:"ID reserva PQ",value:x.giav_pq_reserva_id}].filter(e=>e.value);return(0,a.createElement)("div",{style:{display:"grid",gap:16}},s&&(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>o("")},s),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-detail__header"},(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__eyebrow"},"Detalle de propuesta · #",x.id),(0,a.createElement)("div",{className:"proposal-detail__title-row"},(0,a.createElement)("h2",{className:"proposal-detail__title"},x.proposal_title||"Propuesta sin título"),(0,a.createElement)("span",{className:`proposal-status proposal-status--${x.status||"draft"} proposal-status--large`},A))),(0,a.createElement)("div",{className:"proposal-detail__actions"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>{window.location.href=_e({proposal_id:x.id,action:"edit"})}},"Editar propuesta"),x.public_url?(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>window.open(x.public_url,"_blank","noopener")},"Abrir vista pública"):null,(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>{window.location.href=_e()}},"Volver al listado")))),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{className:"proposal-detail__summary"},(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Cliente"),(0,a.createElement)("div",{className:"proposal-detail__value"},x.customer_name||"-")),(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Email"),(0,a.createElement)("div",{className:"proposal-detail__value"},x.customer_email||"-")),(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Fechas"),(0,a.createElement)("div",{className:"proposal-detail__value"},x.start_date," - ",x.end_date)),(0,a.createElement)("div",{className:"proposal-detail__summary-item"},(0,a.createElement)("div",{className:"proposal-detail__label"},"Última actualización"),(0,a.createElement)("div",{className:"proposal-detail__value"},ce(x.updated_at)))))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Enlace para cliente")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{className:"proposal-detail__block"},(0,a.createElement)(l.TextControl,{label:"URL pública",value:x.public_url||"",readOnly:!0}),(0,a.createElement)("p",{className:"proposal-detail__helper"},"Este es el enlace que verá el cliente."),(0,a.createElement)("div",{className:"proposal-detail__button-row"},(0,a.createElement)(l.Button,{variant:"primary",onClick:async()=>{await async function(e){if(!e)return!1;try{if(navigator.clipboard?.writeText)return await navigator.clipboard.writeText(e),!0}catch(e){}const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.top="-1000px",document.body.appendChild(a),a.focus(),a.select();const t=document.execCommand("copy");return document.body.removeChild(a),t}(x.public_url)&&(m(!0),window.setTimeout(()=>m(!1),1500))}},p?"Enlace copiado":"Copiar"),(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.open(x.public_url,"_blank","noopener")},"Abrir"))))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-detail__section-title"},(0,a.createElement)("strong",null,"Estado de aceptación"),(0,a.createElement)("span",{className:"proposal-detail__pill "+(D?"proposal-detail__pill--success":"proposal-detail__pill--warning")},D?"Aceptada":"Pendiente de aceptación"))),(0,a.createElement)(l.CardBody,null,D?(0,a.createElement)("div",{className:"proposal-detail__grid"},(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Fecha de aceptación"),(0,a.createElement)("div",{className:"proposal-detail__value"},ce(x.accepted_at))),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Aceptada por"),(0,a.createElement)("div",{className:"proposal-detail__value"},de[x.accepted_by]||"-")),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Versión aceptada"),(0,a.createElement)("div",{className:"proposal-detail__value"},I?`#${null!==(r=I.version_number)&&void 0!==r?r:I.id}`:x.accepted_version_id||"-")),(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Confirmación"),(0,a.createElement)("div",{className:"proposal-detail__value"},T))):(0,a.createElement)("div",{className:"proposal-detail__block"},(0,a.createElement)(l.SelectControl,{label:"Versión a aceptar",value:h,options:P,onChange:e=>y(e),disabled:f||0===P.length}),(0,a.createElement)("div",{className:"proposal-detail__button-row"},(0,a.createElement)(l.Button,{variant:"primary",disabled:f||!M,onClick:async()=>{N(!0),o("");try{await g(x.id,M.id),await w()}catch(e){o(e?.message||"No se pudo marcar como aceptada.")}finally{N(!1)}}},"Marcar como aceptada"))))),(x.traveler_full_name||x.traveler_dni)&&(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Datos del viajero")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{style:{display:"grid",gap:8}},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Nombre completo:")," ",x.traveler_full_name||"-"),(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"DNI:")," ",x.traveler_dni||"-")))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-detail__section-title"},(0,a.createElement)("strong",null,"Integración GIAV"),(0,a.createElement)("span",{className:"proposal-detail__pill proposal-detail__pill--"+("ok"===B?"success":"error"===B?"danger":"pending"===B?"warning":"neutral")},R))),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("div",{className:"proposal-detail__block"},V.length>0?(0,a.createElement)("div",{className:"proposal-detail__grid"},V.map(e=>(0,a.createElement)("div",{key:e.label},(0,a.createElement)("div",{className:"proposal-detail__label"},e.label),(0,a.createElement)("div",{className:"proposal-detail__value"},e.value))),x.giav_sync_updated_at?(0,a.createElement)("div",null,(0,a.createElement)("div",{className:"proposal-detail__label"},"Última actualización"),(0,a.createElement)("div",{className:"proposal-detail__value"},ce(x.giav_sync_updated_at))):null):(0,a.createElement)("p",{className:"proposal-detail__helper"},"Aún no hay identificadores de GIAV vinculados."),x.giav_sync_error?(0,a.createElement)("div",{className:"proposal-detail__error"},(0,a.createElement)("strong",null,"Error:")," ",x.giav_sync_error):null,(0,a.createElement)("div",{className:"proposal-detail__cta"},D?$&&!G?(0,a.createElement)(l.Button,{variant:"primary",disabled:S,onClick:async()=>{C(!0),o("");try{await b(x.id),await w()}catch(e){o(e?.message||"No se pudo reintentar GIAV.")}finally{C(!1)}}},"Reintentar GIAV"):G||F?F?(0,a.createElement)("span",{className:"proposal-detail__helper"},"En proceso de creación en GIAV."):(0,a.createElement)("span",{className:"proposal-detail__helper"},"Expediente creado y sincronizado."):(0,a.createElement)(l.Button,{variant:"primary",disabled:S,onClick:async()=>{C(!0),o("");try{await b(x.id),await w()}catch(e){o(e?.message||"No se pudo crear en GIAV.")}finally{C(!1)}}},"Crear expediente en GIAV"):(0,a.createElement)("span",{className:"proposal-detail__helper"},"Disponible tras aceptación."))))),"accepted"===x.status&&(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Siguiente paso")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("p",{style:{margin:0}},"Confirmar disponibilidad y servicios. Cuando esté confirmada, se invitará al portal (futuro)."))),(0,a.createElement)(l.Card,null,(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("strong",null,"Versiones")),(0,a.createElement)(l.CardBody,null,(0,a.createElement)("details",{className:"proposal-detail__versions",open:!0},(0,a.createElement)("summary",null,"Histórico de versiones (",k.length,")"),(0,a.createElement)("div",{className:"proposal-detail__table"},(0,a.createElement)("table",{className:"wp-list-table widefat fixed striped"},(0,a.createElement)("thead",null,(0,a.createElement)("tr",null,(0,a.createElement)("th",null,"ID"),(0,a.createElement)("th",null,"Versión"),(0,a.createElement)("th",null,"Fecha"),(0,a.createElement)("th",null,"Total comercial"),(0,a.createElement)("th",null,"Estado"),(0,a.createElement)("th",null,"Acciones"))),(0,a.createElement)("tbody",null,0===k.length?(0,a.createElement)("tr",null,(0,a.createElement)("td",{colSpan:6},"No hay versiones.")):k.map(e=>{var t,r;const n=Number(x.current_version_id)===Number(e.id),i=Number(x.accepted_version_id)===Number(e.id);return(0,a.createElement)("tr",{key:e.id,className:i?"proposal-detail__row--accepted":void 0},(0,a.createElement)("td",null,e.id),(0,a.createElement)("td",null,null!==(t=e.version_number)&&void 0!==t?t:"-"),(0,a.createElement)("td",null,ce(e.created_at)),(0,a.createElement)("td",null,null!==(r=e.totals_sell_price)&&void 0!==r?r:"-"),(0,a.createElement)("td",null,(0,a.createElement)("div",{className:"proposal-detail__version-badges"},n&&(0,a.createElement)("span",{className:"proposal-detail__pill proposal-detail__pill--info"},"Vigente"),i&&(0,a.createElement)("span",{className:"proposal-detail__pill proposal-detail__pill--success"},"Aceptada"),n||i?null:"—")),(0,a.createElement)("td",null,(0,a.createElement)("div",{className:"proposal-detail__action-stack"},(0,a.createElement)(l.Button,{variant:"secondary",onClick:()=>window.open(e.public_url||x.public_url,"_blank","noopener")},"Ver"),!n&&(0,a.createElement)(l.Button,{variant:"tertiary",disabled:_===e.id,onClick:async()=>{E(e.id);try{await v(x.id,e.id),await w()}catch(e){o(e?.message||"No se pudo actualizar la versión vigente.")}finally{E(null)}}},"Marcar vigente"))))}))))))))}const ge={draft:"Borrador",sent:"Enviada",accepted:"Aceptada",queued:"En cola",synced:"Sincronizada",error:"Error",revoked:"Revocada",lost:"Perdida"},be=(e={})=>{const a=new URL(window.location.href);return a.searchParams.set("page","travel_proposals"),a.searchParams.delete("proposal_id"),a.searchParams.delete("action"),Object.entries(e).forEach(([e,t])=>{null!=t&&""!==t?a.searchParams.set(e,t):a.searchParams.delete(e)}),a.toString()},Ee=document.getElementById("wp-travel-giav-admin"),he=document.getElementById("wp-travel-giav-requests"),ye=Ee||he;ye&&(0,t.createRoot)(ye).render((0,a.createElement)(function(){const e=new URLSearchParams(window.location.search||""),r=e.get("page")||"",n=e.get("proposal_id"),i=e.get("action");if("wp-travel-giav-requests"===r)return(0,a.createElement)(oe,null);if("wp-travel-giav-mapping"===r)return(0,a.createElement)(ie,null);const[s,u]=(0,t.useState)(!1),[m,_]=(0,t.useState)(null),[v,g]=(0,t.useState)(!1),[b,E]=(0,t.useState)(""),[h,y]=(0,t.useState)([]),[f,N]=(0,t.useState)(!1),[S,C]=(0,t.useState)(""),[w,x]=(0,t.useState)(""),[k,T]=(0,t.useState)("updated_at"),[I,M]=(0,t.useState)("desc"),[P,A]=(0,t.useState)([]),B=n?parseInt(n,10):null,R=Number.isNaN(B)?null:B,D="edit"===i&&R;(0,t.useEffect)(()=>{if(!D)return _(null),void E("");let e=!0;return(async()=>{g(!0),E("");try{const a=await c(R);e&&_(a)}catch(a){e&&E(a?.message||"No se pudo cargar la propuesta para editar.")}finally{e&&g(!1)}})(),()=>{e=!1}},[D,R]);const G=(0,t.useMemo)(()=>m?.proposal?{initialProposal:m.proposal,initialSnapshot:m.current_snapshot,nextVersionNumber:m.next_version_number||1}:null,[m]),$=async({nextSearch:e}={})=>{N(!0),C("");try{const a=void 0!==e?e:w,t=await o({orderBy:k,order:I,limit:50,offset:0,search:a?.trim()?a.trim():void 0}),l=Array.isArray(t?.items)?t.items:Array.isArray(t)?t:[];y(l),A(e=>e.filter(e=>l.some(a=>a.id===e)))}catch(e){C(e?.message||"No se pudo cargar el repositorio."),y([])}finally{N(!1)}};return(0,t.useEffect)(()=>{$()},[k,I]),s?(0,a.createElement)(le,{onExit:()=>u(!1)}):D?v?(0,a.createElement)("div",{style:{padding:16}},"Cargando..."):b?(0,a.createElement)("div",{style:{padding:16,color:"#b91c1c"}},b):G?(0,a.createElement)(le,{onExit:()=>{const e=new URL(window.location.href);e.searchParams.set("page","travel_proposals"),e.searchParams.set("proposal_id",R),e.searchParams.delete("action"),window.location.href=e.toString()},mode:"edit",...G}):null:R?(0,a.createElement)(ve,{proposalId:R}):(0,a.createElement)("div",{className:"wp-travel-giav-app"},(0,a.createElement)(l.Card,{className:"proposal-list"},(0,a.createElement)(l.CardHeader,null,(0,a.createElement)("div",{className:"proposal-list__header"},(0,a.createElement)("div",null,(0,a.createElement)("strong",null,"Repositorio de propuestas"),(0,a.createElement)("div",{className:"proposal-list__subtitle"},"Gestiona propuestas creadas, revisa su estado y accede al detalle.")),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>u(!0)},"Nueva propuesta"))),(0,a.createElement)(l.CardBody,null,S?(0,a.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>C("")},S):null,(0,a.createElement)("div",{className:"proposal-list__filters"},(0,a.createElement)("div",{className:"proposal-list__search"},(0,a.createElement)("label",{className:"proposal-list__search-label",htmlFor:"proposal-search"},"Buscar cliente"),(0,a.createElement)("input",{id:"proposal-search",className:"proposal-list__search-input",type:"search",value:w,onChange:e=>x(e.target.value),placeholder:"Cliente, email o token"})),(0,a.createElement)(l.SelectControl,{label:"Ordenar por",value:k,options:[{label:"Última actualización",value:"updated_at"},{label:"ID",value:"id"}],onChange:e=>T(e)}),(0,a.createElement)(l.SelectControl,{label:"Orden",value:I,options:[{label:"Descendente",value:"desc"},{label:"Ascendente",value:"asc"}],onChange:e=>M(e)}),(0,a.createElement)(l.Button,{variant:"primary",onClick:()=>$({nextSearch:w}),disabled:f},"Buscar"),(0,a.createElement)(l.Button,{variant:"tertiary",onClick:()=>{x(""),$({nextSearch:""})},disabled:f},"Limpiar filtros"),(0,a.createElement)(l.Button,{variant:"secondary",isDestructive:!0,onClick:async()=>{if(window.confirm(`¿Seguro que quieres eliminar ${P.length} propuestas?`)){N(!0),C("");try{await p(P),A([]),await $()}catch(e){C(e?.message||"No se pudieron eliminar las propuestas.")}finally{N(!1)}}},disabled:f||0===P.length},"Eliminar seleccionadas (",P.length,")")),(0,a.createElement)("div",{className:"proposal-list__table"},(0,a.createElement)("div",{className:"proposal-list__row proposal-list__row--header"},(0,a.createElement)("div",{className:"proposal-list__select"},(0,a.createElement)(l.CheckboxControl,{checked:P.length===h.length&&h.length>0,onChange:()=>{P.length!==h.length?A(h.map(e=>e.id)):A([])}})),(0,a.createElement)("div",null,"ID"),(0,a.createElement)("div",null,"Título"),(0,a.createElement)("div",null,"Cliente"),(0,a.createElement)("div",null,"Estado"),(0,a.createElement)("div",null,"Última actualización"),(0,a.createElement)("div",null,"Autor"),(0,a.createElement)("div",null,"Acciones")),f?(0,a.createElement)("div",{className:"proposal-list__row proposal-list__row--loading"},(0,a.createElement)(l.Spinner,null),(0,a.createElement)("span",null,"Cargando propuestas…")):null,f||0!==h.length?null:(0,a.createElement)("div",{className:"proposal-list__empty"},"No hay propuestas aún."),!f&&h.map(e=>{const t=ge[e.status]||e.status||"—",r=e.display_title||e.proposal_title||"—";return(0,a.createElement)("div",{key:e.id,className:"proposal-list__row"},(0,a.createElement)("div",{className:"proposal-list__select"},(0,a.createElement)(l.CheckboxControl,{checked:P.includes(e.id),onChange:()=>(e=>{A(a=>a.includes(e)?a.filter(a=>a!==e):[...a,e])})(e.id)})),(0,a.createElement)("div",{className:"proposal-list__id"},"#",e.id),(0,a.createElement)("div",{className:"proposal-list__title"},r),(0,a.createElement)("div",{className:"proposal-list__customer"},(0,a.createElement)("div",{className:"proposal-list__customer-name"},e.customer_name||"—"),(0,a.createElement)("div",{className:"proposal-list__customer-meta"},e.start_date||"—"," - ",e.end_date||"—")),(0,a.createElement)("div",null,(0,a.createElement)("span",{className:`proposal-status proposal-status--${e.status||"draft"}`},t)),(0,a.createElement)("div",null,(e=>{if(!e)return"—";const a=String(e),t=a.includes("T")?a:a.replace(" ","T"),l=new Date(t);return Number.isNaN(l.getTime())?e:l.toLocaleString("es-ES",{dateStyle:"medium",timeStyle:"short"})})(e.updated_at)),(0,a.createElement)("div",null,e.author_name||"—"),(0,a.createElement)("div",{className:"proposal-list__actions"},(0,a.createElement)(l.Button,{variant:"secondary",href:be({proposal_id:e.id})},"Ver detalle"),(0,a.createElement)(l.DropdownMenu,{className:"proposal-list__actions-menu",icon:"ellipsis",label:"Más acciones",controls:[{title:"Editar",onClick:()=>{window.location.href=be({proposal_id:e.id,action:"edit"})}},...e.public_url?[{title:"Vista pública",onClick:()=>{window.open(e.public_url,"_blank","noopener,noreferrer")}}]:[],{title:"Eliminar",isDestructive:!0,onClick:()=>(async e=>{if(window.confirm("¿Seguro que quieres eliminar esta propuesta?")){N(!0),C("");try{await d(e),A(a=>a.filter(a=>a!==e)),await $()}catch(e){C(e?.message||"No se pudo eliminar la propuesta.")}finally{N(!1)}}})(e.id)}]})))})))))},null))})();